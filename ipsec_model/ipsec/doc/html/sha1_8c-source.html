<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>sha1.c</h1><a href="sha1_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec       </span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00053 <span class="preprocessor">#include &lt;string.h&gt;</span>
00054 
00055 <span class="preprocessor">#include "<a class="code" href="sha1_8h.html">ipsec/sha1.h</a>"</span>
00056 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00057 
00058 
<a name="l00059"></a><a class="code" href="sha1_8c.html#a29">00059</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="sha1_8c.html#a29">SHA1</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *d, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *md)
00060 {
00061         <a class="code" href="structSHAstate__st.html">SHA_CTX</a> c;
00062         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> m[<a class="code" href="sha1_8h.html#a2">SHA_DIGEST_LENGTH</a>];
00063 
00064         <span class="keywordflow">if</span> (md == NULL) md=m;
00065         <a class="code" href="sha1_8c.html#a35">SHA1_Init</a>(&amp;c);
00066         <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;c,d,n);
00067         <a class="code" href="sha1_8c.html#a34">SHA1_Final</a>(md,&amp;c);
00068         memset(&amp;c,0,<span class="keyword">sizeof</span>(c));
00069         <span class="keywordflow">return</span>(md);
00070 }
00071 
00072 
<a name="l00073"></a><a class="code" href="sha1_8c.html#a0">00073</a> <span class="preprocessor">#define Xupdate(a,ix,ia,ib,ic,id)       ( (a)=(ia^ib^ic^id),    \</span>
00074 <span class="preprocessor">                                          ix=(a)=ROTATE((a),1)  \</span>
00075 <span class="preprocessor">                                        )</span>
00076 <span class="preprocessor"></span>
00077 <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a30">sha1_block_host_order</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *p,<span class="keywordtype">int</span> num);
00078 <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a31">sha1_block_data_order</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *p,<span class="keywordtype">int</span> num);
00079 
00080 
00081 
<a name="l00082"></a><a class="code" href="sha1_8c.html#a1">00082</a> <span class="preprocessor">#define SHA_CBLOCK      (SHA_LBLOCK*4)  </span><span class="comment">/* SHA treats input data as a</span>
00083 <span class="comment">                                         * contiguous array of 32 bit</span>
00084 <span class="comment">                                         * wide big-endian values. */</span>
<a name="l00085"></a><a class="code" href="sha1_8c.html#a2">00085</a> <span class="preprocessor">#define SHA_LAST_BLOCK  (SHA_CBLOCK-8)</span>
00086 <span class="preprocessor"></span>
00087 
00088 
00089 
00090 <span class="preprocessor">#ifndef SHA_LBLOCK</span>
<a name="l00091"></a><a class="code" href="sha1_8c.html#a3">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define SHA_LBLOCK      (SHA_CBLOCK/4)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00093 <span class="preprocessor"></span>
00094 
00095 <span class="comment">/*</span>
00096 <span class="comment"> * Engage compiler specific rotate intrinsic function if available.</span>
00097 <span class="comment"> */</span>
00098 
00099 <span class="preprocessor">#undef ROTATE</span>
00100 <span class="preprocessor"></span>
00101 <span class="comment">// *** Keil C166 ***</span>
00102 <span class="preprocessor">#ifdef __C166__</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#include &lt;intrins.h&gt;</span>
00104 <span class="preprocessor">#define ROTATE(a,n)     _lrol_(a,n)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00106 <span class="preprocessor"></span>
00107 
00108 <span class="comment">/* A nice byte order reversal from Wei Dai &lt;weidai@eskimo.com&gt; */</span>
00109 <span class="preprocessor">#ifdef ROTATE</span>
00110 <span class="preprocessor"></span><span class="comment">/* 5 instructions with rotate instruction, else 9 */</span>
00111 <span class="preprocessor">#define REVERSE_FETCH32(a,l)    (                                       \</span>
00112 <span class="preprocessor">                l=*(const SHA_LONG *)(a),                               \</span>
00113 <span class="preprocessor">                ((ROTATE(l,8)&amp;0x00FF00FF)|(ROTATE((l&amp;0x00FF00FF),24)))  \</span>
00114 <span class="preprocessor">                                )</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117 
00118 <span class="comment">// #if defined(DATA_ORDER_IS_BIG_ENDIAN)</span>
<a name="l00119"></a><a class="code" href="sha1_8c.html#a4">00119</a> <span class="preprocessor">#define HOST_c2l(c,l)   (l =(((unsigned long)(*((c)++)))&lt;&lt;24),          \</span>
00120 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))&lt;&lt;16),          \</span>
00121 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))&lt;&lt; 8),          \</span>
00122 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))    ),          \</span>
00123 <span class="preprocessor">                         l)</span>
<a name="l00124"></a><a class="code" href="sha1_8c.html#a5">00124</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_p_c2l(c,l,n)       {                                       \</span>
00125 <span class="preprocessor">                        switch (n) {                                    \</span>
00126 <span class="preprocessor">                        case 0: l =((unsigned long)(*((c)++)))&lt;&lt;24;     \</span>
00127 <span class="preprocessor">                        case 1: l|=((unsigned long)(*((c)++)))&lt;&lt;16;     \</span>
00128 <span class="preprocessor">                        case 2: l|=((unsigned long)(*((c)++)))&lt;&lt; 8;     \</span>
00129 <span class="preprocessor">                        case 3: l|=((unsigned long)(*((c)++)));         \</span>
00130 <span class="preprocessor">                                } }</span>
<a name="l00131"></a><a class="code" href="sha1_8c.html#a6">00131</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_p_c2l_p(c,l,sc,len) {                                      \</span>
00132 <span class="preprocessor">                        switch (sc) {                                   \</span>
00133 <span class="preprocessor">                        case 0: l =((unsigned long)(*((c)++)))&lt;&lt;24;     \</span>
00134 <span class="preprocessor">                                if (--len == 0) break;                  \</span>
00135 <span class="preprocessor">                        case 1: l|=((unsigned long)(*((c)++)))&lt;&lt;16;     \</span>
00136 <span class="preprocessor">                                if (--len == 0) break;                  \</span>
00137 <span class="preprocessor">                        case 2: l|=((unsigned long)(*((c)++)))&lt;&lt; 8;     \</span>
00138 <span class="preprocessor">                                } }</span>
00139 <span class="preprocessor"></span><span class="comment">// NOTE the pointer is not incremented at the end of this</span>
<a name="l00140"></a><a class="code" href="sha1_8c.html#a7">00140</a> <span class="preprocessor">#define HOST_c2l_p(c,l,n)       {                                       \</span>
00141 <span class="preprocessor">                        l=0; (c)+=n;                                    \</span>
00142 <span class="preprocessor">                        switch (n) {                                    \</span>
00143 <span class="preprocessor">                        case 3: l =((unsigned long)(*(--(c))))&lt;&lt; 8;     \</span>
00144 <span class="preprocessor">                        case 2: l|=((unsigned long)(*(--(c))))&lt;&lt;16;     \</span>
00145 <span class="preprocessor">                        case 1: l|=((unsigned long)(*(--(c))))&lt;&lt;24;     \</span>
00146 <span class="preprocessor">                                } }</span>
<a name="l00147"></a><a class="code" href="sha1_8c.html#a8">00147</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_l2c(l,c)   (*((c)++)=(unsigned char)(((l)&gt;&gt;24)&amp;0xff),      \</span>
00148 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;16)&amp;0xff),      \</span>
00149 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt; 8)&amp;0xff),      \</span>
00150 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)    )&amp;0xff),      \</span>
00151 <span class="preprocessor">                         l)</span>
00152 <span class="preprocessor"></span>
00153 
00154 <span class="comment">/*</span>
00155 <span class="comment"> * Time for some action:-)</span>
00156 <span class="comment"> */</span>
00157 
<a name="l00158"></a><a class="code" href="sha1_8c.html#a32">00158</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a32">SHA1_Update</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data_, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len)
00159 {
00160         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data=data_;
00161         <a class="code" href="sha1_8h.html#a0">SHA_LONG</a> * p;
00162         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l;
00163         <span class="keywordtype">int</span> sw,sc,ew,ec;
00164 
00165         <span class="keywordflow">if</span> (len==0) <span class="keywordflow">return</span>;
00166 
00167         l=(c-&gt;<a class="code" href="structSHAstate__st.html#o5">Nl</a>+(len&lt;&lt;3))&amp;0xffffffffL;
00168         <span class="comment">/* 95-05-24 eay Fixed a bug with the overflow handling, thanks to</span>
00169 <span class="comment">         * Wei Dai &lt;weidai@eskimo.com&gt; for pointing it out. */</span>
00170         <span class="keywordflow">if</span> (l &lt; c-&gt;<a class="code" href="structSHAstate__st.html#o5">Nl</a>) <span class="comment">/* overflow */</span>
00171                 c-&gt;<a class="code" href="structSHAstate__st.html#o6">Nh</a>++;
00172         c-&gt;<a class="code" href="structSHAstate__st.html#o6">Nh</a>+=(len&gt;&gt;29);
00173         c-&gt;<a class="code" href="structSHAstate__st.html#o5">Nl</a>=l;
00174 
00175         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a> != 0)
00176                 {
00177                 p=c-&gt;<a class="code" href="structSHAstate__st.html#o7">data</a>;
00178                 sw=c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&gt;&gt;2;
00179                 sc=c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&amp;0x03;
00180 
00181                 <span class="keywordflow">if</span> ((c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>+len) &gt;= <a class="code" href="sha1_8c.html#a1">SHA_CBLOCK</a>)
00182                         {
00183                         l=p[sw]; <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(data,l,sc); p[sw++]=l;
00184                         <span class="keywordflow">for</span> (; sw&lt;<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>; sw++)
00185                                 {
00186                                 <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); p[sw]=l;
00187                                 }
00188                         <a class="code" href="sha1_8c.html#a30">sha1_block_host_order</a> (c,p,1);
00189                         len-=(<a class="code" href="sha1_8c.html#a1">SHA_CBLOCK</a>-c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>);
00190                         c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>=0;
00191                         <span class="comment">/* drop through and do the rest */</span>
00192                         }
00193                 <span class="keywordflow">else</span>
00194                         {
00195                         c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>+=len;
00196                         <span class="keywordflow">if</span> ((sc+len) &lt; 4) <span class="comment">/* ugly, add char's to a word */</span>
00197                                 {
00198                                 l=p[sw]; <a class="code" href="md5_8c.html#a6">HOST_p_c2l_p</a>(data,l,sc,len); p[sw]=l;
00199                                 }
00200                         <span class="keywordflow">else</span>
00201                                 {
00202                                 ew=(c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&gt;&gt;2);
00203                                 ec=(c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&amp;0x03);
00204                                 l=p[sw]; <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(data,l,sc); p[sw++]=l;
00205                                 <span class="keywordflow">for</span> (; sw &lt; ew; sw++)
00206                                         {
00207                                         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); p[sw]=l;
00208                                         }
00209                                 <span class="keywordflow">if</span> (ec)
00210                                         {
00211                                         <a class="code" href="md5_8c.html#a7">HOST_c2l_p</a>(data,l,ec); p[sw]=l;
00212                                         }
00213                                 }
00214                         <span class="keywordflow">return</span>;
00215                         }
00216                 }
00217 
00218         sw=(<span class="keywordtype">int</span>)(len/<a class="code" href="sha1_8c.html#a1">SHA_CBLOCK</a>);
00219         <span class="keywordflow">if</span> (sw &gt; 0)
00220                 {
00221                         {
00222                         <a class="code" href="sha1_8c.html#a31">sha1_block_data_order</a>(c,data,sw);
00223                         sw*=<a class="code" href="sha1_8c.html#a1">SHA_CBLOCK</a>;
00224                         data+=sw;
00225                         len-=sw;
00226                         }
00227                 }
00228 
00229         <span class="keywordflow">if</span> (len!=0)
00230                 {
00231                 p = c-&gt;<a class="code" href="structSHAstate__st.html#o7">data</a>;
00232                 c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a> = (<span class="keywordtype">int</span>)len;
00233                 ew=(<span class="keywordtype">int</span>)(len&gt;&gt;2);       <span class="comment">/* words to copy */</span>
00234                 ec=(<span class="keywordtype">int</span>)(len&amp;0x03);
00235                 <span class="keywordflow">for</span> (; ew; ew--,p++)
00236                         {
00237                         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); *p=l;
00238                         }
00239                 <a class="code" href="md5_8c.html#a7">HOST_c2l_p</a>(data,l,ec);
00240                 *p=l;
00241                 }
00242 }
00243 
00244 
<a name="l00245"></a><a class="code" href="sha1_8c.html#a33">00245</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a33">SHA1_Transform</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data)
00246 {
00247         <a class="code" href="sha1_8c.html#a31">sha1_block_data_order</a> (c,data,1);
00248 }
00249 
00250 
<a name="l00251"></a><a class="code" href="sha1_8c.html#a34">00251</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a34">SHA1_Final</a> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *md, <a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c)
00252 {
00253         <a class="code" href="sha1_8h.html#a0">SHA_LONG</a> *p;
00254         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l;
00255         <span class="keywordtype">int</span> i,j;
00256         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> end[4]={0x80,0x00,0x00,0x00};
00257         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp=end;
00258 
00259         <span class="comment">/* c-&gt;num should definitly have room for at least one more byte. */</span>
00260         p=c-&gt;<a class="code" href="structSHAstate__st.html#o7">data</a>;
00261         i=c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&gt;&gt;2;
00262         j=c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>&amp;0x03;
00263 
00264         l = (j==0) ? 0 : p[i];
00265 
00266         <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(cp,l,j); p[i++]=l; <span class="comment">/* i is the next 'undefined word' */</span>
00267 
00268         <span class="keywordflow">if</span> (i&gt;(<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>-2)) <span class="comment">/* save room for Nl and Nh */</span>
00269                 {
00270                 <span class="keywordflow">if</span> (i&lt;<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>) p[i]=0;
00271                 <a class="code" href="sha1_8c.html#a30">sha1_block_host_order</a> (c,p,1);
00272                 i=0;
00273                 }
00274         <span class="keywordflow">for</span> (; i&lt;(<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>-2); i++)
00275                 p[i]=0;
00276 
00277         p[<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>-2]=c-&gt;<a class="code" href="structSHAstate__st.html#o6">Nh</a>;
00278         p[<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>-1]=c-&gt;<a class="code" href="structSHAstate__st.html#o5">Nl</a>;
00279 
00280         <a class="code" href="sha1_8c.html#a30">sha1_block_host_order</a> (c,p,1);
00281 
00282         <span class="comment">// HASH_MAKE_STRING(c,md);</span>
00283         <span class="keywordflow">do</span> {
00284         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ll;
00285         ll=(c)-&gt;h0; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));
00286         ll=(c)-&gt;h1; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));
00287         ll=(c)-&gt;h2; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));
00288         ll=(c)-&gt;h3; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));
00289         ll=(c)-&gt;h4; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));
00290         } <span class="keywordflow">while</span> (0);
00291 
00292         c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>=0;
00293         <span class="comment">/* clear stuff, HASH_BLOCK may be leaving some stuff on the stack</span>
00294 <span class="comment">         * but I'm not worried :-)</span>
00295 <span class="comment">        memset((void *)c,0,sizeof(SHA_CTX));</span>
00296 <span class="comment">         */</span>
00297 }
00298 
00299 
00300 
<a name="l00301"></a><a class="code" href="sha1_8c.html#a9">00301</a> <span class="preprocessor">#define INIT_DATA_h0 0x67452301UL</span>
<a name="l00302"></a><a class="code" href="sha1_8c.html#a10">00302</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_h1 0xefcdab89UL</span>
<a name="l00303"></a><a class="code" href="sha1_8c.html#a11">00303</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_h2 0x98badcfeUL</span>
<a name="l00304"></a><a class="code" href="sha1_8c.html#a12">00304</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_h3 0x10325476UL</span>
<a name="l00305"></a><a class="code" href="sha1_8c.html#a13">00305</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_h4 0xc3d2e1f0UL</span>
00306 <span class="preprocessor"></span>
<a name="l00307"></a><a class="code" href="sha1_8c.html#a35">00307</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a35">SHA1_Init</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c)
00308 {
00309         c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>=<a class="code" href="sha1_8c.html#a9">INIT_DATA_h0</a>;
00310         c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>=<a class="code" href="sha1_8c.html#a10">INIT_DATA_h1</a>;
00311         c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>=<a class="code" href="sha1_8c.html#a11">INIT_DATA_h2</a>;
00312         c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>=<a class="code" href="sha1_8c.html#a12">INIT_DATA_h3</a>;
00313         c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>=<a class="code" href="sha1_8c.html#a13">INIT_DATA_h4</a>;
00314         c-&gt;<a class="code" href="structSHAstate__st.html#o5">Nl</a>=0;
00315         c-&gt;<a class="code" href="structSHAstate__st.html#o6">Nh</a>=0;
00316         c-&gt;<a class="code" href="structSHAstate__st.html#o8">num</a>=0;
00317 }
00318 
<a name="l00319"></a><a class="code" href="sha1_8c.html#a14">00319</a> <span class="preprocessor">#define K_00_19 0x5a827999UL</span>
<a name="l00320"></a><a class="code" href="sha1_8c.html#a15">00320</a> <span class="preprocessor"></span><span class="preprocessor">#define K_20_39 0x6ed9eba1UL</span>
<a name="l00321"></a><a class="code" href="sha1_8c.html#a16">00321</a> <span class="preprocessor"></span><span class="preprocessor">#define K_40_59 0x8f1bbcdcUL</span>
<a name="l00322"></a><a class="code" href="sha1_8c.html#a17">00322</a> <span class="preprocessor"></span><span class="preprocessor">#define K_60_79 0xca62c1d6UL</span>
00323 <span class="preprocessor"></span>
00324 <span class="comment">/* As  pointed out by Wei Dai &lt;weidai@eskimo.com&gt;, F() below can be</span>
00325 <span class="comment"> * simplified to the code in F_00_19.  Wei attributes these optimisations</span>
00326 <span class="comment"> * to Peter Gutmann's SHS code, and he attributes it to Rich Schroeppel.</span>
00327 <span class="comment"> * #define F(x,y,z) (((x) &amp; (y))  |  ((~(x)) &amp; (z)))</span>
00328 <span class="comment"> * I've just become aware of another tweak to be made, again from Wei Dai,</span>
00329 <span class="comment"> * in F_40_59, (x&amp;a)|(y&amp;a) -&gt; (x|y)&amp;a</span>
00330 <span class="comment"> */</span>
<a name="l00331"></a><a class="code" href="sha1_8c.html#a18">00331</a> <span class="preprocessor">#define F_00_19(b,c,d)  ((((c) ^ (d)) &amp; (b)) ^ (d))</span>
<a name="l00332"></a><a class="code" href="sha1_8c.html#a19">00332</a> <span class="preprocessor"></span><span class="preprocessor">#define F_20_39(b,c,d)  ((b) ^ (c) ^ (d))</span>
<a name="l00333"></a><a class="code" href="sha1_8c.html#a20">00333</a> <span class="preprocessor"></span><span class="preprocessor">#define F_40_59(b,c,d)  (((b) &amp; (c)) | (((b)|(c)) &amp; (d)))</span>
<a name="l00334"></a><a class="code" href="sha1_8c.html#a21">00334</a> <span class="preprocessor"></span><span class="preprocessor">#define F_60_79(b,c,d)  F_20_39(b,c,d)</span>
00335 <span class="preprocessor"></span>
<a name="l00336"></a><a class="code" href="sha1_8c.html#a22">00336</a> <span class="preprocessor">#define BODY_00_15(i,a,b,c,d,e,f,xi) \</span>
00337 <span class="preprocessor">        (f)=xi+(e)+K_00_19+ROTATE((a),5)+F_00_19((b),(c),(d)); \</span>
00338 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00339 <span class="preprocessor"></span>
<a name="l00340"></a><a class="code" href="sha1_8c.html#a23">00340</a> <span class="preprocessor">#define BODY_16_19(i,a,b,c,d,e,f,xi,xa,xb,xc,xd) \</span>
00341 <span class="preprocessor">        Xupdate(f,xi,xa,xb,xc,xd); \</span>
00342 <span class="preprocessor">        (f)+=(e)+K_00_19+ROTATE((a),5)+F_00_19((b),(c),(d)); \</span>
00343 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00344 <span class="preprocessor"></span>
<a name="l00345"></a><a class="code" href="sha1_8c.html#a24">00345</a> <span class="preprocessor">#define BODY_20_31(i,a,b,c,d,e,f,xi,xa,xb,xc,xd) \</span>
00346 <span class="preprocessor">        Xupdate(f,xi,xa,xb,xc,xd); \</span>
00347 <span class="preprocessor">        (f)+=(e)+K_20_39+ROTATE((a),5)+F_20_39((b),(c),(d)); \</span>
00348 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00349 <span class="preprocessor"></span>
<a name="l00350"></a><a class="code" href="sha1_8c.html#a25">00350</a> <span class="preprocessor">#define BODY_32_39(i,a,b,c,d,e,f,xa,xb,xc,xd) \</span>
00351 <span class="preprocessor">        Xupdate(f,xa,xa,xb,xc,xd); \</span>
00352 <span class="preprocessor">        (f)+=(e)+K_20_39+ROTATE((a),5)+F_20_39((b),(c),(d)); \</span>
00353 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00354 <span class="preprocessor"></span>
<a name="l00355"></a><a class="code" href="sha1_8c.html#a26">00355</a> <span class="preprocessor">#define BODY_40_59(i,a,b,c,d,e,f,xa,xb,xc,xd) \</span>
00356 <span class="preprocessor">        Xupdate(f,xa,xa,xb,xc,xd); \</span>
00357 <span class="preprocessor">        (f)+=(e)+K_40_59+ROTATE((a),5)+F_40_59((b),(c),(d)); \</span>
00358 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00359 <span class="preprocessor"></span>
<a name="l00360"></a><a class="code" href="sha1_8c.html#a27">00360</a> <span class="preprocessor">#define BODY_60_79(i,a,b,c,d,e,f,xa,xb,xc,xd) \</span>
00361 <span class="preprocessor">        Xupdate(f,xa,xa,xb,xc,xd); \</span>
00362 <span class="preprocessor">        (f)=xa+(e)+K_60_79+ROTATE((a),5)+F_60_79((b),(c),(d)); \</span>
00363 <span class="preprocessor">        (b)=ROTATE((b),30);</span>
00364 <span class="preprocessor"></span>
00365 
<a name="l00366"></a><a class="code" href="sha1_8c.html#a28">00366</a> <span class="preprocessor">#define X(i)    XX##i</span>
00367 <span class="preprocessor"></span>
<a name="l00368"></a><a class="code" href="sha1_8c.html#a30">00368</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a30">sha1_block_host_order</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *d, <span class="keywordtype">int</span> num)
00369 {
00370         <span class="keyword">const</span> <a class="code" href="sha1_8h.html#a0">SHA_LONG</a> *W=d;
00371         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> A,B,C,D,E,T;
00372         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   XX0, XX1, XX2, XX3, XX4, XX5, XX6, XX7,
00373                         XX8, XX9,XX10,XX11,XX12,XX13,XX14,XX15;
00374 
00375         A=c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>;
00376         B=c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>;
00377         C=c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>;
00378         D=c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>;
00379         E=c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>;
00380 
00381         <span class="keywordflow">for</span> (;;)
00382                 {
00383         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 0,A,B,C,D,E,T,W[ 0]);
00384         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 1,T,A,B,C,D,E,W[ 1]);
00385         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 2,E,T,A,B,C,D,W[ 2]);
00386         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 3,D,E,T,A,B,C,W[ 3]);
00387         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 4,C,D,E,T,A,B,W[ 4]);
00388         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 5,B,C,D,E,T,A,W[ 5]);
00389         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 6,A,B,C,D,E,T,W[ 6]);
00390         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 7,T,A,B,C,D,E,W[ 7]);
00391         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 8,E,T,A,B,C,D,W[ 8]);
00392         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 9,D,E,T,A,B,C,W[ 9]);
00393         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(10,C,D,E,T,A,B,W[10]);
00394         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(11,B,C,D,E,T,A,W[11]);
00395         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(12,A,B,C,D,E,T,W[12]);
00396         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(13,T,A,B,C,D,E,W[13]);
00397         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(14,E,T,A,B,C,D,W[14]);
00398         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(15,D,E,T,A,B,C,W[15]);
00399 
00400         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(16,C,D,E,T,A,B,X( 0),W[ 0],W[ 2],W[ 8],W[13]);
00401         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(17,B,C,D,E,T,A,X( 1),W[ 1],W[ 3],W[ 9],W[14]);
00402         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(18,A,B,C,D,E,T,X( 2),W[ 2],W[ 4],W[10],W[15]);
00403         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(19,T,A,B,C,D,E,X( 3),W[ 3],W[ 5],W[11],X( 0));
00404 
00405         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(20,E,T,A,B,C,D,X( 4),W[ 4],W[ 6],W[12],X( 1));
00406         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(21,D,E,T,A,B,C,X( 5),W[ 5],W[ 7],W[13],X( 2));
00407         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(22,C,D,E,T,A,B,X( 6),W[ 6],W[ 8],W[14],X( 3));
00408         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(23,B,C,D,E,T,A,X( 7),W[ 7],W[ 9],W[15],X( 4));
00409         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(24,A,B,C,D,E,T,X( 8),W[ 8],W[10],X( 0),X( 5));
00410         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(25,T,A,B,C,D,E,X( 9),W[ 9],W[11],X( 1),X( 6));
00411         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(26,E,T,A,B,C,D,X(10),W[10],W[12],X( 2),X( 7));
00412         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(27,D,E,T,A,B,C,X(11),W[11],W[13],X( 3),X( 8));
00413         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(28,C,D,E,T,A,B,X(12),W[12],W[14],X( 4),X( 9));
00414         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(29,B,C,D,E,T,A,X(13),W[13],W[15],X( 5),X(10));
00415         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(30,A,B,C,D,E,T,X(14),W[14],X( 0),X( 6),X(11));
00416         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(31,T,A,B,C,D,E,X(15),W[15],X( 1),X( 7),X(12));
00417 
00418         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(32,E,T,A,B,C,D,X( 0),X( 2),X( 8),X(13));
00419         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(33,D,E,T,A,B,C,X( 1),X( 3),X( 9),X(14));
00420         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(34,C,D,E,T,A,B,X( 2),X( 4),X(10),X(15));
00421         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(35,B,C,D,E,T,A,X( 3),X( 5),X(11),X( 0));
00422         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(36,A,B,C,D,E,T,X( 4),X( 6),X(12),X( 1));
00423         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(37,T,A,B,C,D,E,X( 5),X( 7),X(13),X( 2));
00424         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(38,E,T,A,B,C,D,X( 6),X( 8),X(14),X( 3));
00425         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(39,D,E,T,A,B,C,X( 7),X( 9),X(15),X( 4));
00426 
00427         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(40,C,D,E,T,A,B,X( 8),X(10),X( 0),X( 5));
00428         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(41,B,C,D,E,T,A,X( 9),X(11),X( 1),X( 6));
00429         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(42,A,B,C,D,E,T,X(10),X(12),X( 2),X( 7));
00430         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(43,T,A,B,C,D,E,X(11),X(13),X( 3),X( 8));
00431         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(44,E,T,A,B,C,D,X(12),X(14),X( 4),X( 9));
00432         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(45,D,E,T,A,B,C,X(13),X(15),X( 5),X(10));
00433         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(46,C,D,E,T,A,B,X(14),X( 0),X( 6),X(11));
00434         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(47,B,C,D,E,T,A,X(15),X( 1),X( 7),X(12));
00435         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(48,A,B,C,D,E,T,X( 0),X( 2),X( 8),X(13));
00436         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(49,T,A,B,C,D,E,X( 1),X( 3),X( 9),X(14));
00437         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(50,E,T,A,B,C,D,X( 2),X( 4),X(10),X(15));
00438         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(51,D,E,T,A,B,C,X( 3),X( 5),X(11),X( 0));
00439         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(52,C,D,E,T,A,B,X( 4),X( 6),X(12),X( 1));
00440         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(53,B,C,D,E,T,A,X( 5),X( 7),X(13),X( 2));
00441         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(54,A,B,C,D,E,T,X( 6),X( 8),X(14),X( 3));
00442         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(55,T,A,B,C,D,E,X( 7),X( 9),X(15),X( 4));
00443         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(56,E,T,A,B,C,D,X( 8),X(10),X( 0),X( 5));
00444         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(57,D,E,T,A,B,C,X( 9),X(11),X( 1),X( 6));
00445         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(58,C,D,E,T,A,B,X(10),X(12),X( 2),X( 7));
00446         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(59,B,C,D,E,T,A,X(11),X(13),X( 3),X( 8));
00447 
00448         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(60,A,B,C,D,E,T,X(12),X(14),X( 4),X( 9));
00449         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(61,T,A,B,C,D,E,X(13),X(15),X( 5),X(10));
00450         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(62,E,T,A,B,C,D,X(14),X( 0),X( 6),X(11));
00451         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(63,D,E,T,A,B,C,X(15),X( 1),X( 7),X(12));
00452         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(64,C,D,E,T,A,B,X( 0),X( 2),X( 8),X(13));
00453         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(65,B,C,D,E,T,A,X( 1),X( 3),X( 9),X(14));
00454         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(66,A,B,C,D,E,T,X( 2),X( 4),X(10),X(15));
00455         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(67,T,A,B,C,D,E,X( 3),X( 5),X(11),X( 0));
00456         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(68,E,T,A,B,C,D,X( 4),X( 6),X(12),X( 1));
00457         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(69,D,E,T,A,B,C,X( 5),X( 7),X(13),X( 2));
00458         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(70,C,D,E,T,A,B,X( 6),X( 8),X(14),X( 3));
00459         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(71,B,C,D,E,T,A,X( 7),X( 9),X(15),X( 4));
00460         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(72,A,B,C,D,E,T,X( 8),X(10),X( 0),X( 5));
00461         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(73,T,A,B,C,D,E,X( 9),X(11),X( 1),X( 6));
00462         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(74,E,T,A,B,C,D,X(10),X(12),X( 2),X( 7));
00463         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(75,D,E,T,A,B,C,X(11),X(13),X( 3),X( 8));
00464         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(76,C,D,E,T,A,B,X(12),X(14),X( 4),X( 9));
00465         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(77,B,C,D,E,T,A,X(13),X(15),X( 5),X(10));
00466         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(78,A,B,C,D,E,T,X(14),X( 0),X( 6),X(11));
00467         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(79,T,A,B,C,D,E,X(15),X( 1),X( 7),X(12));
00468 
00469         c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>+E)&amp;0xffffffffL;
00470         c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>+T)&amp;0xffffffffL;
00471         c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>+A)&amp;0xffffffffL;
00472         c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>+B)&amp;0xffffffffL;
00473         c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>+C)&amp;0xffffffffL;
00474 
00475         <span class="keywordflow">if</span> (--num &lt;= 0) <span class="keywordflow">break</span>;
00476 
00477         A=c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>;
00478         B=c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>;
00479         C=c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>;
00480         D=c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>;
00481         E=c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>;
00482 
00483         W+=<a class="code" href="sha1_8c.html#a3">SHA_LBLOCK</a>;
00484         }
00485 }
00486 
<a name="l00487"></a><a class="code" href="sha1_8c.html#a31">00487</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a31">sha1_block_data_order</a> (<a class="code" href="structSHAstate__st.html">SHA_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *p, <span class="keywordtype">int</span> num)
00488 {
00489         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data=p;
00490         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> A,B,C,D,E,T,l;
00491         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   XX0, XX1, XX2, XX3, XX4, XX5, XX6, XX7,
00492                         XX8, XX9,XX10,XX11,XX12,XX13,XX14,XX15;
00493 
00494         A=c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>;
00495         B=c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>;
00496         C=c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>;
00497         D=c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>;
00498         E=c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>;
00499 
00500         <span class="keywordflow">for</span> (;;)
00501                 {
00502 
00503         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 0)=l;              <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 1)=l;
00504         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 0,A,B,C,D,E,T,X( 0));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 2)=l;
00505         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 1,T,A,B,C,D,E,X( 1));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 3)=l;
00506         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 2,E,T,A,B,C,D,X( 2));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 4)=l;
00507         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 3,D,E,T,A,B,C,X( 3));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 5)=l;
00508         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 4,C,D,E,T,A,B,X( 4));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 6)=l;
00509         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 5,B,C,D,E,T,A,X( 5));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 7)=l;
00510         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 6,A,B,C,D,E,T,X( 6));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 8)=l;
00511         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 7,T,A,B,C,D,E,X( 7));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 9)=l;
00512         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 8,E,T,A,B,C,D,X( 8));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(10)=l;
00513         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>( 9,D,E,T,A,B,C,X( 9));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(11)=l;
00514         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(10,C,D,E,T,A,B,X(10));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(12)=l;
00515         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(11,B,C,D,E,T,A,X(11));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(13)=l;
00516         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(12,A,B,C,D,E,T,X(12));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(14)=l;
00517         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(13,T,A,B,C,D,E,X(13));       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(15)=l;
00518         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(14,E,T,A,B,C,D,X(14));
00519         <a class="code" href="sha1_8c.html#a22">BODY_00_15</a>(15,D,E,T,A,B,C,X(15));
00520 
00521         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(16,C,D,E,T,A,B,X( 0),X( 0),X( 2),X( 8),X(13));
00522         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(17,B,C,D,E,T,A,X( 1),X( 1),X( 3),X( 9),X(14));
00523         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(18,A,B,C,D,E,T,X( 2),X( 2),X( 4),X(10),X(15));
00524         <a class="code" href="sha1_8c.html#a23">BODY_16_19</a>(19,T,A,B,C,D,E,X( 3),X( 3),X( 5),X(11),X( 0));
00525 
00526         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(20,E,T,A,B,C,D,X( 4),X( 4),X( 6),X(12),X( 1));
00527         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(21,D,E,T,A,B,C,X( 5),X( 5),X( 7),X(13),X( 2));
00528         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(22,C,D,E,T,A,B,X( 6),X( 6),X( 8),X(14),X( 3));
00529         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(23,B,C,D,E,T,A,X( 7),X( 7),X( 9),X(15),X( 4));
00530         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(24,A,B,C,D,E,T,X( 8),X( 8),X(10),X( 0),X( 5));
00531         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(25,T,A,B,C,D,E,X( 9),X( 9),X(11),X( 1),X( 6));
00532         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(26,E,T,A,B,C,D,X(10),X(10),X(12),X( 2),X( 7));
00533         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(27,D,E,T,A,B,C,X(11),X(11),X(13),X( 3),X( 8));
00534         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(28,C,D,E,T,A,B,X(12),X(12),X(14),X( 4),X( 9));
00535         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(29,B,C,D,E,T,A,X(13),X(13),X(15),X( 5),X(10));
00536         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(30,A,B,C,D,E,T,X(14),X(14),X( 0),X( 6),X(11));
00537         <a class="code" href="sha1_8c.html#a24">BODY_20_31</a>(31,T,A,B,C,D,E,X(15),X(15),X( 1),X( 7),X(12));
00538 
00539         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(32,E,T,A,B,C,D,X( 0),X( 2),X( 8),X(13));
00540         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(33,D,E,T,A,B,C,X( 1),X( 3),X( 9),X(14));
00541         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(34,C,D,E,T,A,B,X( 2),X( 4),X(10),X(15));
00542         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(35,B,C,D,E,T,A,X( 3),X( 5),X(11),X( 0));
00543         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(36,A,B,C,D,E,T,X( 4),X( 6),X(12),X( 1));
00544         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(37,T,A,B,C,D,E,X( 5),X( 7),X(13),X( 2));
00545         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(38,E,T,A,B,C,D,X( 6),X( 8),X(14),X( 3));
00546         <a class="code" href="sha1_8c.html#a25">BODY_32_39</a>(39,D,E,T,A,B,C,X( 7),X( 9),X(15),X( 4));
00547 
00548         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(40,C,D,E,T,A,B,X( 8),X(10),X( 0),X( 5));
00549         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(41,B,C,D,E,T,A,X( 9),X(11),X( 1),X( 6));
00550         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(42,A,B,C,D,E,T,X(10),X(12),X( 2),X( 7));
00551         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(43,T,A,B,C,D,E,X(11),X(13),X( 3),X( 8));
00552         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(44,E,T,A,B,C,D,X(12),X(14),X( 4),X( 9));
00553         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(45,D,E,T,A,B,C,X(13),X(15),X( 5),X(10));
00554         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(46,C,D,E,T,A,B,X(14),X( 0),X( 6),X(11));
00555         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(47,B,C,D,E,T,A,X(15),X( 1),X( 7),X(12));
00556         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(48,A,B,C,D,E,T,X( 0),X( 2),X( 8),X(13));
00557         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(49,T,A,B,C,D,E,X( 1),X( 3),X( 9),X(14));
00558         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(50,E,T,A,B,C,D,X( 2),X( 4),X(10),X(15));
00559         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(51,D,E,T,A,B,C,X( 3),X( 5),X(11),X( 0));
00560         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(52,C,D,E,T,A,B,X( 4),X( 6),X(12),X( 1));
00561         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(53,B,C,D,E,T,A,X( 5),X( 7),X(13),X( 2));
00562         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(54,A,B,C,D,E,T,X( 6),X( 8),X(14),X( 3));
00563         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(55,T,A,B,C,D,E,X( 7),X( 9),X(15),X( 4));
00564         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(56,E,T,A,B,C,D,X( 8),X(10),X( 0),X( 5));
00565         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(57,D,E,T,A,B,C,X( 9),X(11),X( 1),X( 6));
00566         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(58,C,D,E,T,A,B,X(10),X(12),X( 2),X( 7));
00567         <a class="code" href="sha1_8c.html#a26">BODY_40_59</a>(59,B,C,D,E,T,A,X(11),X(13),X( 3),X( 8));
00568 
00569         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(60,A,B,C,D,E,T,X(12),X(14),X( 4),X( 9));
00570         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(61,T,A,B,C,D,E,X(13),X(15),X( 5),X(10));
00571         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(62,E,T,A,B,C,D,X(14),X( 0),X( 6),X(11));
00572         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(63,D,E,T,A,B,C,X(15),X( 1),X( 7),X(12));
00573         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(64,C,D,E,T,A,B,X( 0),X( 2),X( 8),X(13));
00574         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(65,B,C,D,E,T,A,X( 1),X( 3),X( 9),X(14));
00575         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(66,A,B,C,D,E,T,X( 2),X( 4),X(10),X(15));
00576         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(67,T,A,B,C,D,E,X( 3),X( 5),X(11),X( 0));
00577         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(68,E,T,A,B,C,D,X( 4),X( 6),X(12),X( 1));
00578         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(69,D,E,T,A,B,C,X( 5),X( 7),X(13),X( 2));
00579         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(70,C,D,E,T,A,B,X( 6),X( 8),X(14),X( 3));
00580         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(71,B,C,D,E,T,A,X( 7),X( 9),X(15),X( 4));
00581         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(72,A,B,C,D,E,T,X( 8),X(10),X( 0),X( 5));
00582         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(73,T,A,B,C,D,E,X( 9),X(11),X( 1),X( 6));
00583         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(74,E,T,A,B,C,D,X(10),X(12),X( 2),X( 7));
00584         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(75,D,E,T,A,B,C,X(11),X(13),X( 3),X( 8));
00585         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(76,C,D,E,T,A,B,X(12),X(14),X( 4),X( 9));
00586         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(77,B,C,D,E,T,A,X(13),X(15),X( 5),X(10));
00587         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(78,A,B,C,D,E,T,X(14),X( 0),X( 6),X(11));
00588         <a class="code" href="sha1_8c.html#a27">BODY_60_79</a>(79,T,A,B,C,D,E,X(15),X( 1),X( 7),X(12));
00589 
00590         c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>+E)&amp;0xffffffffL;
00591         c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>+T)&amp;0xffffffffL;
00592         c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>+A)&amp;0xffffffffL;
00593         c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>+B)&amp;0xffffffffL;
00594         c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>=(c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>+C)&amp;0xffffffffL;
00595 
00596         <span class="keywordflow">if</span> (--num &lt;= 0) <span class="keywordflow">break</span>;
00597 
00598         A=c-&gt;<a class="code" href="structSHAstate__st.html#o0">h0</a>;
00599         B=c-&gt;<a class="code" href="structSHAstate__st.html#o1">h1</a>;
00600         C=c-&gt;<a class="code" href="structSHAstate__st.html#o2">h2</a>;
00601         D=c-&gt;<a class="code" href="structSHAstate__st.html#o3">h3</a>;
00602         E=c-&gt;<a class="code" href="structSHAstate__st.html#o4">h4</a>;
00603 
00604         }
00605 }
00606 
00607 
00608 
00609 
00610 <span class="comment">/*</span>
00611 <span class="comment"> * Function: RFC 2104 hmac_sha1 </span>
00612 <span class="comment"> *</span>
00613 <span class="comment"> *   unsigned char*  text          pointer to data stream</span>
00614 <span class="comment"> *   int             text_len      length of data stream</span>
00615 <span class="comment"> *   unsigned char*  key           pointer to authentication key</span>
00616 <span class="comment"> *   int             key_len       length of authentication key</span>
00617 <span class="comment"> *   unsigned char*  digest        caller digest to be filled in</span>
00618 <span class="comment"> *</span>
00619 <span class="comment"> */</span>
<a name="l00620"></a><a class="code" href="sha1_8c.html#a36">00620</a> <span class="keywordtype">void</span> <a class="code" href="sha1_8c.html#a36">hmac_sha1</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* text, <span class="keywordtype">int</span> text_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  key, <span class="keywordtype">int</span> key_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  digest)
00621 {
00622     <a class="code" href="structSHAstate__st.html">SHA_CTX</a> context;
00623     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_ipad[65];    <span class="comment">/* inner padding - key XORd with ipad */</span>
00624     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_opad[65];    <span class="comment">/* outer padding - key XORd with opad */</span>
00625     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tk[20];                <span class="comment">/* L=20 for SHA1 (RFC 2141, 2. Definition of HMAC) */</span>
00626     <span class="keywordtype">int</span> i;
00627 
00628         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00629                       <span class="stringliteral">"hmac_sha1"</span>, 
00630                                   (<span class="stringliteral">"text=%p, text_len=%d, key=%p, key_len=%d, digest=%p"</span>,
00631                               (<span class="keywordtype">void</span> *)text, text_len, (<span class="keywordtype">void</span> *)key, key_len, (<span class="keywordtype">void</span> *)digest)
00632                                  );
00633 
00634     <span class="comment">/* if key is longer than 64 bytes reset it to key=SHA1(key) */</span>
00635     <span class="keywordflow">if</span> (key_len &gt; 64) {
00636 
00637             <a class="code" href="structSHAstate__st.html">SHA_CTX</a>      tctx;
00638 
00639             <a class="code" href="sha1_8c.html#a35">SHA1_Init</a>(&amp;tctx);
00640             <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;tctx, key, key_len);
00641             <a class="code" href="sha1_8c.html#a34">SHA1_Final</a>(tk, &amp;tctx);
00642 
00643             key = tk;
00644             key_len = 20;
00645     }
00646 
00647     <span class="comment">/*</span>
00648 <span class="comment">     * the HMAC_SHA1 transform looks like:</span>
00649 <span class="comment">     *</span>
00650 <span class="comment">     * SHA1(K XOR opad, SHA1(K XOR ipad, text))</span>
00651 <span class="comment">     *</span>
00652 <span class="comment">     * where K is an n byte key</span>
00653 <span class="comment">     * ipad is the byte 0x36 repeated 64 times</span>
00654 <span class="comment">     * opad is the byte 0x5c repeated 64 times</span>
00655 <span class="comment">     * and text is the data being protected</span>
00656 <span class="comment">     */</span>
00657 
00658     <span class="comment">/* start out by storing key in pads */</span>
00659     memset(k_ipad, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(k_ipad));  
00660     memset(k_opad, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(k_opad));  
00661     memcpy(k_ipad, key, key_len);                  
00662     memcpy(k_opad, key, key_len);                  
00663 
00664 
00665     <span class="comment">/* XOR key with ipad and opad values */</span>
00666     <span class="keywordflow">for</span> (i=0; i&lt;64; i++) {
00667             k_ipad[i] ^= 0x36;
00668             k_opad[i] ^= 0x5c;
00669     }
00670     <span class="comment">/*</span>
00671 <span class="comment">     * perform inner MD5</span>
00672 <span class="comment">     */</span>
00673     <a class="code" href="sha1_8c.html#a35">SHA1_Init</a>(&amp;context);                 <span class="comment">/* init context for 1st pass */</span>
00674     <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;context, k_ipad, 64);   <span class="comment">/* start with inner pad */</span>
00675     <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;context, text, text_len);<span class="comment">/* then text of datagram */</span>
00676     <a class="code" href="sha1_8c.html#a34">SHA1_Final</a>(digest, &amp;context);         <span class="comment">/* finish up 1st pass */</span>
00677     <span class="comment">/*</span>
00678 <span class="comment">     * perform outer MD5</span>
00679 <span class="comment">     */</span>
00680     <a class="code" href="sha1_8c.html#a35">SHA1_Init</a>(&amp;context);                 <span class="comment">/* init context for 2nd</span>
00681 <span class="comment">                                          * pass */</span>
00682     <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;context, k_opad, 64);   <span class="comment">/* start with outer pad */</span>
00683     <a class="code" href="sha1_8c.html#a32">SHA1_Update</a>(&amp;context, digest, 20);   <span class="comment">/* then results of 1st hash */</span>
00684     <a class="code" href="sha1_8c.html#a34">SHA1_Final</a>(digest, &amp;context);        <span class="comment">/* finish up 2nd pass */</span>
00685 
00686         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"hmac_sha1"</span>, (<span class="stringliteral">"void"</span>) );
00687 }
00688 
00689 
00690 
00691 
00692 
00693 
00694 
00695 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
