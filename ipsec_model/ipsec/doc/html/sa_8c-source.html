<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>sa.c</h1><a href="sa_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec</span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00081 <span class="preprocessor">#include &lt;string.h&gt;</span>
00082 
00083 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00084 <span class="preprocessor">#include "<a class="code" href="util_8h.html">ipsec/util.h</a>"</span>
00085 
00086 <span class="preprocessor">#include "<a class="code" href="sa_8h.html">ipsec/sa.h</a>"</span>
00087 <span class="preprocessor">#include "<a class="code" href="ah_8h.html">ipsec/ah.h</a>"</span>
00088 <span class="preprocessor">#include "<a class="code" href="esp_8h.html">ipsec/esp.h</a>"</span>
00089 
00090 
<a name="l00096"></a><a class="code" href="sa_8c.html#a0">00096</a> <a class="code" href="structdb__set__netif__struct.html">db_set_netif</a>    <a class="code" href="sa_8c.html#a0">db_sets</a>[<a class="code" href="sa_8h.html#a14">IPSEC_NR_NETIFS</a>] ;
00097 
<a name="l00098"></a><a class="code" href="structipsec__in__ip__struct.html">00098</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip_struct</a> 
00099 {
<a name="l00100"></a><a class="code" href="structipsec__in__ip__struct.html#o0">00100</a>         <a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>          <a class="code" href="structipsec__in__ip__struct.html#o0">ip</a> ;   
00101         <span class="keyword">union </span>
00102 <span class="keyword">        </span>{
<a name="l00103"></a><a class="code" href="structipsec__in__ip__struct.html#o1">00103</a>                 <a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a>  <a class="code" href="structipsec__in__ip__struct.html#o1">ah</a> ;   
<a name="l00104"></a><a class="code" href="structipsec__in__ip__struct.html#o2">00104</a>                 <a class="code" href="structipsec__esp__header__struct.html">ipsec_esp_header</a> <a class="code" href="structipsec__in__ip__struct.html#o2">esp</a> ;  
<a name="l00105"></a><a class="code" href="structipsec__in__ip__struct.html#o3">00105</a>                 <a class="code" href="structipsec__tcp__hdr__struct.html">ipsec_tcp_header</a> <a class="code" href="structipsec__in__ip__struct.html#o3">tcp</a> ;  
<a name="l00106"></a><a class="code" href="structipsec__in__ip__struct.html#o4">00106</a>                 <a class="code" href="structipsec__udp__hdr__struct.html">ipsec_udp_header</a> <a class="code" href="structipsec__in__ip__struct.html#o4">udp</a> ;  
00107         } <a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a> ;        
00108 } <a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip</a> ;
00109 
00110 
00111 
<a name="l00136"></a><a class="code" href="sa_8c.html#a2">00136</a> <a class="code" href="structdb__set__netif__struct.html">db_set_netif</a>    *<a class="code" href="sa_8c.html#a2">ipsec_spd_load_dbs</a>(<a class="code" href="structspd__entry__struct.html">spd_entry</a> *inbound_spd_data, <a class="code" href="structspd__entry__struct.html">spd_entry</a> *outbound_spd_data, <a class="code" href="structsa__entry__struct.html">sad_entry</a> *inbound_sad_data, <a class="code" href="structsa__entry__struct.html">sad_entry</a> *outbound_sad_data)
00137 {
00138         <span class="keywordtype">int</span> netif ;
00139         <span class="keywordtype">int</span> index ;
00140         <a class="code" href="structspd__entry__struct.html">spd_entry</a>       *sp, *sp_next, *sp_prev ;
00141         <a class="code" href="structsa__entry__struct.html">sad_entry</a>       *sa, *sa_next, *sa_prev ;
00142 
00143         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00144                       <span class="stringliteral">"ipsec_spd_load_dbs"</span>, 
00145                                   (<span class="stringliteral">"inbound_spd_data=%p, outbound_spd_data=%p, inbound_sad_data=%p, outbound_sad_data=%p"</span>,
00146                               (<span class="keywordtype">void</span> *)inbound_spd_data, (<span class="keywordtype">void</span> *)outbound_spd_data, (<span class="keywordtype">void</span> *)inbound_sad_data, (<span class="keywordtype">void</span> *)outbound_sad_data)
00147                                  );
00148         
00149         <span class="comment">/* get free entry */</span>
00150         <span class="keywordflow">for</span>(netif=0; netif &lt; <a class="code" href="sa_8h.html#a14">IPSEC_NR_NETIFS</a>; netif++)
00151         {
00152                 <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o4">use_flag</a> == <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a>) <span class="keywordflow">break</span> ;
00153         }
00154         <span class="keywordflow">if</span>(netif &gt;= <a class="code" href="sa_8h.html#a14">IPSEC_NR_NETIFS</a>)
00155         {
00156                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_load_dbs"</span>, (<span class="stringliteral">"%p"</span>, (<span class="keywordtype">void</span> *)NULL) );
00157                 <span class="keywordflow">return</span> NULL;
00158         }
00159 
00160         <span class="comment">/* index points now the a free entry which is filled with the initialization data */</span>
00161         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a> = inbound_spd_data ;
00162         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a> = outbound_spd_data ;
00163         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a> = inbound_sad_data ;
00164         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a> = outbound_sad_data ;
00165 
00166         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o4">use_flag</a> = <a class="code" href="sa_8h.html#a3">IPSEC_USED</a> ;
00167 
00168         <span class="comment">/* set none used entries from the tables to FREE */</span>
00169         <span class="keywordflow">for</span>(index=0; index &lt; <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>; index++)
00170                 <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a>[index].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00171                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a>[index].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00172 
00173         <span class="keywordflow">for</span>(index=0; index &lt; <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>; index++)
00174                 <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a>[index].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00175                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a>[index].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00176         
00177         <span class="keywordflow">for</span>(index=0; index &lt; <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>; index++)
00178                 <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a>[index].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00179                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a>[index].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00180 
00181         <span class="keywordflow">for</span>(index=0; index &lt; <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>; index++)
00182                 <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a>[index].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00183                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a>[index].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00184 
00185         <span class="comment">/* link the database entries together */</span>
00186 
00187         <span class="comment">/* inbound spd data */</span>
00188         sp = inbound_spd_data ;
00189         <span class="comment">/* if first entry is IPSEC_FREE, then there is nothing */</span>
00190         <span class="keywordflow">if</span>(sp-&gt;<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00191         {
00192                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = sp ; 
00193         
00194                 <span class="keywordflow">if</span> ((sp+1)-&gt;use_flag == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00195                 {
00196                         sp_next = (sp+1) ;
00197                 }
00198                 <span class="keywordflow">else</span>
00199                 {
00200                         sp_next = NULL ;
00201                 }
00202         
00203                 <span class="keywordflow">for</span>(index=0, sp_prev=NULL;
00204                         (index &lt; <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>) &amp;&amp; (sp[index+1].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>);
00205                     sp_prev = &amp;sp[index], sp_next = &amp;sp[index+2], index++)
00206                         {
00207                                 sp[index].<a class="code" href="structspd__entry__struct.html#o10">prev</a> = sp_prev ;
00208                                 sp[index].<a class="code" href="structspd__entry__struct.html#o9">next</a> = sp_next ;
00209                         }
00210         
00211                         sp[index].<a class="code" href="structspd__entry__struct.html#o9">next</a> = NULL ;
00212                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = &amp;sp[index] ;  
00213         }
00214         <span class="keywordflow">else</span>
00215         {
00216                 <span class="comment">/* there was no data */</span>
00217                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
00218                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = NULL ;
00219         }
00220 
00221         <span class="comment">/* outbound spd data */</span>
00222         sp = outbound_spd_data ;
00223         <span class="comment">/* if first entry is IPSEC_FREE, then there is nothing */</span>
00224         <span class="keywordflow">if</span>(sp-&gt;<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00225         {
00226                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = sp ;        
00227         
00228                 <span class="keywordflow">if</span> ((sp+1)-&gt;use_flag == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00229                 {
00230                         sp_next = (sp+1) ;
00231                 }
00232                 <span class="keywordflow">else</span>
00233                 {
00234                         sp_next = NULL ;
00235                 }
00236         
00237                 <span class="keywordflow">for</span>(index=0, sp_prev=NULL;
00238                         (index &lt; <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>) &amp;&amp; (sp[index+1].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>);
00239                     sp_prev = &amp;sp[index], sp_next = &amp;sp[index+2], index++)
00240                         {
00241                                 sp[index].<a class="code" href="structspd__entry__struct.html#o10">prev</a> = sp_prev ;
00242                                 sp[index].<a class="code" href="structspd__entry__struct.html#o9">next</a> = sp_next ;
00243                         }
00244         
00245                         sp[index].<a class="code" href="structspd__entry__struct.html#o9">next</a> = NULL ;
00246                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = &amp;sp[index] ; 
00247         }
00248         <span class="keywordflow">else</span>
00249         {
00250                 <span class="comment">/* there was no data */</span>
00251                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
00252                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = NULL ;
00253         }
00254 
00255 
00256         <span class="comment">/* inbound sad data */</span>
00257         sa = inbound_sad_data ;
00258         <span class="comment">/* if first entry is IPSEC_FREE, then there is nothing */</span>
00259         <span class="keywordflow">if</span>(sa-&gt;<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00260         {
00261                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = sa ; 
00262         
00263                 <span class="keywordflow">if</span> ((sa+1)-&gt;use_flag == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00264                 {
00265                         sa_next = (sa+1) ;
00266                 }
00267                 <span class="keywordflow">else</span>
00268                 {
00269                         sa_next = NULL ;
00270                 }
00271         
00272                 <span class="keywordflow">for</span>(index=0, sa_prev=NULL;
00273                         (index &lt; <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>) &amp;&amp; (sa[index+1].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>);
00274                     sa_prev = &amp;sa[index], sa_next = &amp;sa[index+2], index++)
00275                         {
00276                                 sa[index].<a class="code" href="structsa__entry__struct.html#o14">prev</a> = sa_prev ;
00277                                 sa[index].<a class="code" href="structsa__entry__struct.html#o13">next</a> = sa_next ;
00278                         }
00279         
00280                         sa[index].<a class="code" href="structsa__entry__struct.html#o13">next</a> = NULL ;
00281                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = &amp;sa[index] ;  
00282         }
00283         <span class="keywordflow">else</span>
00284         {
00285                 <span class="comment">/* there was no data */</span>
00286                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
00287                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = NULL ;
00288         }
00289 
00290         <span class="comment">/* outbound sad data */</span>
00291         sa = outbound_sad_data ;
00292         <span class="comment">/* if first entry is IPSEC_FREE, then there is nothing */</span>
00293         <span class="keywordflow">if</span>(sa-&gt;<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00294         {
00295                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = sa ;        
00296         
00297                 <span class="keywordflow">if</span> ((sa+1)-&gt;use_flag == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00298                 {
00299                         sa_next = (sa+1) ;
00300                 }
00301                 <span class="keywordflow">else</span>
00302                 {
00303                         sa_next = NULL ;
00304                 }
00305         
00306                 <span class="keywordflow">for</span>(index=0, sa_prev=NULL;
00307                         (index &lt; <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>) &amp;&amp; (sa[index+1].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> == <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>);
00308                     sa_prev = &amp;sa[index], sa_next = &amp;sa[index+2], index++)
00309                         {
00310                                 sa[index].<a class="code" href="structsa__entry__struct.html#o14">prev</a> = sa_prev ;
00311                                 sa[index].<a class="code" href="structsa__entry__struct.html#o13">next</a> = sa_next ;
00312                         }
00313         
00314                         sa[index].<a class="code" href="structsa__entry__struct.html#o13">next</a> = NULL ;
00315                         <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = &amp;sa[index] ; 
00316         }
00317         <span class="keywordflow">else</span>
00318         {
00319                 <span class="comment">/* there was no data */</span>
00320                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
00321                 <a class="code" href="sa_8c.html#a0">db_sets</a>[netif].<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = NULL ;
00322         }
00323 
00324         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_load_dbs"</span>, (<span class="stringliteral">"&amp;db_sets[netif] = %p"</span>, &amp;<a class="code" href="sa_8c.html#a0">db_sets</a>[netif]) );
00325         <span class="keywordflow">return</span> &amp;<a class="code" href="sa_8c.html#a0">db_sets</a>[netif] ;
00326 }
00327 
<a name="l00336"></a><a class="code" href="sa_8c.html#a3">00336</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a3">ipsec_spd_release_dbs</a>(<a class="code" href="structdb__set__netif__struct.html">db_set_netif</a> *dbs)
00337 {
00338         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00339                       <span class="stringliteral">"ipsec_spd_release_dbs"</span>, 
00340                                   (<span class="stringliteral">"dbs=%p"</span>,
00341                               (<span class="keywordtype">void</span> *)dbs)
00342                                  );
00343 
00344         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
00345         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = NULL ;
00346         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a> = NULL ;
00347 
00348         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
00349         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o2">last</a> = NULL ;
00350         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>.<a class="code" href="structspd__table__struct.html#o0">table</a> = NULL ;
00351 
00352         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
00353         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = NULL ;
00354         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o2">inbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a> = NULL ;
00355 
00356         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
00357         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o2">last</a> = NULL ;
00358         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o3">outbound_sad</a>.<a class="code" href="structsad__table__struct.html#o0">table</a> = NULL ;
00359 
00360         dbs-&gt;<a class="code" href="structdb__set__netif__struct.html#o4">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00361 
00362         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_load_dbs"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>));
00363         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
00364 }
00365 
<a name="l00375"></a><a class="code" href="sa_8c.html#a4">00375</a> <a class="code" href="structspd__entry__struct.html">spd_entry</a> *<a class="code" href="sa_8c.html#a4">ipsec_spd_get_free</a>(<a class="code" href="structspd__table__struct.html">spd_table</a> *table)
00376 {
00377         <span class="keywordtype">int</span> index ;
00378         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00379                       <span class="stringliteral">"ipsec_spd_get_free"</span>, 
00380                                   (<span class="stringliteral">"table=%p"</span>,
00381                               (<span class="keywordtype">void</span> *)table)
00382                                  );
00383 
00384         <span class="comment">/* find first free entry */</span>
00385         <span class="keywordflow">for</span>(index = 0; index &lt; <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>; index++)
00386         {
00387                 <span class="keywordflow">if</span> (table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a>[index].<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> == <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a>)
00388                         <span class="keywordflow">break</span> ;
00389         }
00390         <span class="comment">/* if no free entry */</span>
00391         <span class="keywordflow">if</span> (index &gt;= <a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>)
00392         {
00393                 <span class="keywordflow">return</span> NULL ;
00394         }
00395 
00396         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_get_free"</span>, (<span class="stringliteral">"&amp;table-&gt;table[index] = %p"</span>, &amp;table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a>[index]));
00397         <span class="keywordflow">return</span> &amp;table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a>[index] ;
00398 }
00399 
<a name="l00428"></a><a class="code" href="sa_8c.html#a5">00428</a> <a class="code" href="structspd__entry__struct.html">spd_entry</a> *<a class="code" href="sa_8c.html#a5">ipsec_spd_add</a>(<a class="code" href="types_8h.html#a4">__u32</a> src, <a class="code" href="types_8h.html#a4">__u32</a> src_net, <a class="code" href="types_8h.html#a4">__u32</a> dst, <a class="code" href="types_8h.html#a4">__u32</a> dst_net, <a class="code" href="types_8h.html#a0">__u8</a> proto, <a class="code" href="types_8h.html#a2">__u16</a> src_port, <a class="code" href="types_8h.html#a2">__u16</a> dst_port, <a class="code" href="types_8h.html#a0">__u8</a> policy, <a class="code" href="structspd__table__struct.html">spd_table</a> *table)
00429 {
00430         <a class="code" href="structspd__entry__struct.html">spd_entry</a>       *free_entry ;
00431         <a class="code" href="structspd__entry__struct.html">spd_entry</a>       *tmp_entry ;
00432         <span class="keywordtype">int</span>                     table_size ;
00433 
00434         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00435               <span class="stringliteral">"ipsec_spd_add"</span>, 
00436                           (<span class="stringliteral">"src=%lu, src_net=%lu, dst=%lu, dst_net=%lu, proto=%u, src_port=%u, dst_port=%u, policy=%u, table=%p"</span>,
00437                       src, src_net, dst, dst_net, proto, src_port, dst_port, policy, (<span class="keywordtype">void</span> *)table)
00438                          );
00439 
00440         table_size = table-&gt;<a class="code" href="structspd__table__struct.html#o3">size</a> ;
00441 
00442         free_entry = <a class="code" href="sa_8c.html#a4">ipsec_spd_get_free</a>(table) ;
00443         <span class="keywordflow">if</span> (free_entry == NULL) 
00444         {
00445                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_add"</span>, (<span class="stringliteral">"%p"</span>, (<span class="keywordtype">void</span> *)NULL) );
00446                 <span class="keywordflow">return</span> NULL ;
00447         }
00448 
00449         <span class="comment">/* add the fields to the entry */</span>
00450         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o0">src</a> = src ;
00451         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o1">src_netaddr</a> = src_net ;
00452         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o2">dest</a> = dst ;
00453         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o3">dest_netaddr</a> = dst_net ;
00454 
00455         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a> = proto ;
00456         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a> = src_port ;
00457         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a> = dst_port ;
00458         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o7">policy</a> = policy ;
00459 
00460         free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> = <a class="code" href="sa_8h.html#a3">IPSEC_USED</a> ;
00461 
00462         <span class="comment">/* re-link entry */</span>
00465         <span class="comment">/* if added first entry in array */</span>
00466         <span class="keywordflow">if</span>(table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> == NULL)
00467         {
00468                 table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> = free_entry ;
00469                 table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> = NULL ;
00470                 table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>-&gt;<a class="code" href="structspd__entry__struct.html#o10">prev</a> = NULL ;
00471                 table-&gt;<a class="code" href="structspd__table__struct.html#o2">last</a> = free_entry ;
00472         }
00473         <span class="keywordflow">else</span>
00474         {
00475                 <span class="comment">/* go till end of list */</span>
00476                 <span class="keywordflow">for</span>(tmp_entry = table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>; tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> != NULL; tmp_entry = tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a>)
00477                 {
00478                 }
00479 
00480                 <span class="comment">/* inset at end */</span>
00481                 free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o10">prev</a> = tmp_entry ;
00482                 tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> = free_entry ;
00483                 free_entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> = NULL ;
00484         }
00485 
00486         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_add"</span>, (<span class="stringliteral">"free_entry=%p"</span>, (<span class="keywordtype">void</span> *)free_entry) );
00487         <span class="keywordflow">return</span> free_entry ;
00488 }
<a name="l00496"></a><a class="code" href="sa_8c.html#a6">00496</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a6">ipsec_spd_add_sa</a>(<a class="code" href="structspd__entry__struct.html">spd_entry</a> *entry, <a class="code" href="structsa__entry__struct.html">sad_entry</a> *sa)
00497 {
00498         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00499               <span class="stringliteral">"ipsec_spd_add_sa"</span>, 
00500                           (<span class="stringliteral">"entry=%p, sa=%p"</span>,
00501                       (<span class="keywordtype">void</span> *)entry, (<span class="keywordtype">void</span> *)sa)
00502                          );
00503 
00504         entry-&gt;sa = sa ;
00505 
00506         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_add_sa"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>) );
00507         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
00508 }
00509 
<a name="l00523"></a><a class="code" href="sa_8c.html#a7">00523</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a7">ipsec_spd_del</a>(<a class="code" href="structspd__entry__struct.html">spd_entry</a> *entry, <a class="code" href="structspd__table__struct.html">spd_table</a> *table)
00524 {
00525         <a class="code" href="structspd__entry__struct.html">spd_entry</a>               *next_ptr ;
00526         <a class="code" href="structspd__entry__struct.html">spd_entry</a>               *prev_ptr ;
00527 
00528         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00529               <span class="stringliteral">"ipsec_spd_del"</span>, 
00530                           (<span class="stringliteral">"entry=%p, table=%p"</span>,
00531                       (<span class="keywordtype">void</span> *)entry, (<span class="keywordtype">void</span> *)table)
00532                          );
00533 
00534         <span class="comment">/* check range */</span>               
00535         <span class="keywordflow">if</span>((entry &gt;= table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a> ) &amp;&amp; (entry &lt;= (table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a> + (<a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>*<span class="keyword">sizeof</span>(<a class="code" href="structspd__entry__struct.html">spd_entry</a>)))))
00536         {
00537                 <span class="comment">/* first clear associated SA if there is one */</span>
00540                 <span class="comment">/* relink table */</span>
00541         
00542                 <span class="keywordflow">if</span>(entry-&gt;use_flag != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00543                 {
00544                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00545                         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a> ;
00546                 }
00547 
00548                 <span class="comment">/* relink previous with next */</span>
00549                 prev_ptr = entry-&gt;<a class="code" href="structspd__entry__struct.html#o10">prev</a> ;
00550                 next_ptr = entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> ;
00551                 <span class="keywordflow">if</span>(prev_ptr)
00552                         prev_ptr-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> = next_ptr ;
00553                 <span class="keywordflow">if</span>(next_ptr)
00554                         next_ptr-&gt;<a class="code" href="structspd__entry__struct.html#o10">prev</a> = prev_ptr ;
00555 
00556                 <span class="comment">/* if removed last entry */</span>
00557                 <span class="keywordflow">if</span>(entry-&gt;next == NULL)
00558                 {
00559                         table-&gt;<a class="code" href="structspd__table__struct.html#o2">last</a> == entry-&gt;<a class="code" href="structspd__entry__struct.html#o10">prev</a> ;
00560                 }
00561 
00562                 <span class="comment">/* if removed first entry */</span>
00563                 <span class="keywordflow">if</span>(entry == table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>)
00564                 {
00565                         table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> = entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a> ;
00566                 }
00567 
00568                 <span class="comment">/* clear field */</span>
00569                 entry-&gt;<a class="code" href="structspd__entry__struct.html#o11">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00570 
00571                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>) );
00572                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
00573         }
00574 
00575         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00576         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a> ;
00577 }
00578 
<a name="l00597"></a><a class="code" href="sa_8c.html#a8">00597</a> <a class="code" href="structspd__entry__struct.html">spd_entry</a> *<a class="code" href="sa_8c.html#a8">ipsec_spd_lookup</a>(<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *header, <a class="code" href="structspd__table__struct.html">spd_table</a> *table)
00598 {
00599         <a class="code" href="structspd__entry__struct.html">spd_entry</a>       *tmp_entry ;
00600         <a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip</a>     *ip ;
00601 
00602         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00603               <span class="stringliteral">"ipsec_spd_lookup"</span>, 
00604                           (<span class="stringliteral">"header=%p, table=%p"</span>,
00605                       (<span class="keywordtype">void</span> *)header, (<span class="keywordtype">void</span> *)table)
00606                          );
00607 
00608         ip = (<a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip</a>*) header ;
00609 
00610         <span class="comment">/* compare and return when all fields match */</span>
00611         <span class="keywordflow">for</span>(tmp_entry = table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>; tmp_entry != NULL; tmp_entry = tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a>)
00612         {
00613                 <span class="keywordflow">if</span>(<a class="code" href="util_8h.html#a7">ipsec_ip_addr_maskcmp</a>(header-&gt;src, tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o0">src</a>, tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o1">src_netaddr</a>))
00614                 {
00615                         <span class="keywordflow">if</span>(<a class="code" href="util_8h.html#a7">ipsec_ip_addr_maskcmp</a>(header-&gt;dest, tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o2">dest</a>, tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o3">dest_netaddr</a>))
00616                         {
00617                                 <span class="keywordflow">if</span>((tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a> == 0) || tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a> == header-&gt;protocol)
00618                                 {
00619                                         <span class="keywordflow">if</span>(header-&gt;protocol == <a class="code" href="types_8h.html#a40a34">IPSEC_PROTO_TCP</a>)
00620                                         {
00621                                                 <span class="keywordflow">if</span>((tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a> == 0) || (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a> == ip-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.tcp.src)) 
00622                                                         <span class="keywordflow">if</span>( (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a> == 0) || (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a> == ip-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.tcp.dest)) 
00623                                                         {
00624                                                                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_lookup"</span>, (<span class="stringliteral">"tmp_entry = %p"</span>, (<span class="keywordtype">void</span> *) tmp_entry) );
00625                                                                 <span class="keywordflow">return</span> tmp_entry ;
00626                                                         }
00627                                         }
00628                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(header-&gt;protocol == <a class="code" href="types_8h.html#a40a35">IPSEC_PROTO_UDP</a>)
00629                                         {
00630                                                         <span class="keywordflow">if</span>((tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a> == 0) || (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a> == ip-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.udp.src)) 
00631                                                                 <span class="keywordflow">if</span>( (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a> == 0) || (tmp_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a> == ip-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.udp.dest)) 
00632                                                                 {
00633                                                                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_lookup"</span>, (<span class="stringliteral">"tmp_entry = %p"</span>, (<span class="keywordtype">void</span> *) tmp_entry) );
00634                                                                         <span class="keywordflow">return</span> tmp_entry ;
00635                                                                 }
00636                                         } 
00637                                         <span class="keywordflow">else</span>
00638                                         {
00639                                                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_lookup"</span>, (<span class="stringliteral">"tmp_entry = %p"</span>, (<span class="keywordtype">void</span> *) tmp_entry) );
00640                                                 <span class="keywordflow">return</span> tmp_entry ;
00641                                         }
00642                                 }
00643                         }
00644                 }
00645         }
00646         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_spd_lookup"</span>, (<span class="stringliteral">"return = %p"</span>, (<span class="keywordtype">void</span> *) NULL) );
00647         <span class="keywordflow">return</span> NULL ;
00648 }
00649 
<a name="l00656"></a><a class="code" href="sa_8c.html#a9">00656</a> <span class="keywordtype">void</span> <a class="code" href="sa_8c.html#a9">ipsec_spd_print_single</a>(<a class="code" href="structspd__entry__struct.html">spd_entry</a> *entry)
00657 {
00658         <span class="keywordtype">char</span>            log_message[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00659         <span class="keywordtype">char</span>            ip_addr1[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00660         <span class="keywordtype">char</span>            ip_addr2[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00661         <span class="keywordtype">char</span>            ip_addr3[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00662         <span class="keywordtype">char</span>            ip_addr4[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00663         <span class="keywordtype">char</span>            protocol[10+1] ;
00664         <span class="keywordtype">char</span>            policy[10+1] ;
00665 
00666         strcpy(ip_addr1, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o0">src</a>)) ;
00667         strcpy(ip_addr2, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o1">src_netaddr</a>)) ;
00668         strcpy(ip_addr3, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o2">dest</a>)) ;
00669         strcpy(ip_addr4, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o3">dest_netaddr</a>)) ;
00670 
00671         <span class="keywordflow">switch</span>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a>)
00672         {
00673                 <span class="keywordflow">case</span> <a class="code" href="types_8h.html#a40a34">IPSEC_PROTO_TCP</a>:
00674                         strcpy(protocol, <span class="stringliteral">" TCP"</span>) ;
00675                         <span class="keywordflow">break</span> ;
00676                 <span class="keywordflow">case</span> <a class="code" href="types_8h.html#a40a35">IPSEC_PROTO_UDP</a>:
00677                         strcpy(protocol, <span class="stringliteral">" UDP"</span>) ;
00678                         <span class="keywordflow">break</span> ;
00679                 <span class="keywordflow">case</span> <a class="code" href="types_8h.html#a40a37">IPSEC_PROTO_AH</a>:
00680                         strcpy(protocol, <span class="stringliteral">"  AH"</span>) ;
00681                         <span class="keywordflow">break</span> ;
00682                 <span class="keywordflow">case</span> <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a>:
00683                         strcpy(protocol, <span class="stringliteral">" ESP"</span>) ;
00684                         <span class="keywordflow">break</span> ;
00685                 <span class="keywordflow">case</span> <a class="code" href="types_8h.html#a40a33">IPSEC_PROTO_ICMP</a>:
00686                         strcpy(protocol, <span class="stringliteral">"ICMP"</span>) ;
00687                         <span class="keywordflow">break</span> ;
00688                 <span class="keywordflow">default</span> :
00689                         sprintf(protocol, <span class="stringliteral">"%4d"</span>, entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a>) ;
00690         }
00691 
00692         <span class="keywordflow">switch</span>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o7">policy</a>)
00693         {
00694                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a4">POLICY_APPLY</a>:
00695                         strcpy(policy, <span class="stringliteral">"  APPLY"</span>) ; 
00696                         <span class="keywordflow">break</span> ;
00697                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a5">POLICY_BYPASS</a>:
00698                         strcpy(policy, <span class="stringliteral">" BYPASS"</span>) ; 
00699                         <span class="keywordflow">break</span> ;
00700                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a6">POLICY_DISCARD</a>:
00701                         strcpy(policy, <span class="stringliteral">"DISCARD"</span>) ; 
00702                         <span class="keywordflow">break</span> ;
00703                 <span class="keywordflow">default</span>:
00704                         strcpy(policy, <span class="stringliteral">"UNKNOWN"</span>) ;
00705         }
00706 
00707         sprintf(log_message,    <span class="stringliteral">"%15s/%15s   %15s/%15s %3s %5u %5u    %7s  0x%p"</span>,
00708                                                 ip_addr1, ip_addr2, ip_addr3, ip_addr4,
00709                                                         protocol,
00710                                                         <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a>),
00711                                                         <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a>),
00712                                                         policy,
00713                                                         entry-&gt;<a class="code" href="structspd__entry__struct.html#o8">sa</a>) ;
00714 
00715         printf(<span class="stringliteral">"    %s\n"</span>, log_message) ;
00716 
00717         <span class="keywordflow">return</span> ;
00718 }
00719 
<a name="l00726"></a><a class="code" href="sa_8c.html#a10">00726</a> <span class="keywordtype">void</span> <a class="code" href="sa_8c.html#a10">ipsec_spd_print</a>(<a class="code" href="structspd__table__struct.html">spd_table</a> *table)
00727 {
00728         <a class="code" href="structspd__entry__struct.html">spd_entry</a>       *tmp_ptr ;
00729 
00730         <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsec_spd_print"</span>, (<span class="stringliteral">"Printf Security Policy Database"</span>)) ;
00731         printf(<span class="stringliteral">"      src-addr/net-addr               dst-addr/net-addr                proto prt:src/dest  policy  SA\n"</span>) ;
00732 
00733         <span class="keywordflow">if</span>(table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> == NULL)
00734         {
00735                 printf(<span class="stringliteral">"      SPD table is empty\n"</span>) ;
00736         }
00737 
00738         <span class="comment">/* loop over all entries and print them */</span>
00739         <span class="keywordflow">for</span>(tmp_ptr = table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a>; tmp_ptr != NULL; tmp_ptr = tmp_ptr-&gt;<a class="code" href="structspd__entry__struct.html#o9">next</a>)
00740         {
00741                 <a class="code" href="sa_8c.html#a9">ipsec_spd_print_single</a>(tmp_ptr) ;
00742         }
00743 
00744         <span class="keywordflow">return</span> ;
00745 }
00746 
<a name="l00756"></a><a class="code" href="sa_8c.html#a11">00756</a> <a class="code" href="structsa__entry__struct.html">sad_entry</a> *<a class="code" href="sa_8c.html#a11">ipsec_sad_get_free</a>(<a class="code" href="structsad__table__struct.html">sad_table</a> *table)
00757 {
00758         <span class="keywordtype">int</span> index ;
00759 
00760         <span class="comment">/* find first free entry */</span>
00761         <span class="keywordflow">for</span>(index = 0; index &lt; <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>; index++)
00762         {
00763                 <span class="keywordflow">if</span> (table-&gt;<a class="code" href="structsad__table__struct.html#o0">table</a>[index].<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> == <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a>)
00764                         <span class="keywordflow">break</span> ;
00765         }
00766         <span class="comment">/* if no free entry */</span>
00767         <span class="keywordflow">if</span> (index &gt;= <a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>)
00768         {
00769                 <span class="keywordflow">return</span> NULL ;
00770         }
00771 
00772         <span class="keywordflow">return</span> &amp;table-&gt;<a class="code" href="structsad__table__struct.html#o0">table</a>[index] ;
00773 }
00774 
<a name="l00796"></a><a class="code" href="sa_8c.html#a12">00796</a> <a class="code" href="structsa__entry__struct.html">sad_entry</a> *<a class="code" href="sa_8c.html#a12">ipsec_sad_add</a>(<a class="code" href="structsa__entry__struct.html">sad_entry</a> *entry, <a class="code" href="structsad__table__struct.html">sad_table</a> *table) 
00797 {
00798         <a class="code" href="structsa__entry__struct.html">sad_entry</a>       *free_entry ;
00799         <a class="code" href="structsa__entry__struct.html">sad_entry</a>       *tmp_entry ;
00800 
00801         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00802                       <span class="stringliteral">"ipsec_sad_add"</span>, 
00803                                   (<span class="stringliteral">"entry=%p, table=%p"</span>,
00804                               (<span class="keywordtype">void</span> *)entry, (<span class="keywordtype">void</span> *)table )
00805                                  );
00806         free_entry = <a class="code" href="sa_8c.html#a11">ipsec_sad_get_free</a>(table) ;
00807         <span class="keywordflow">if</span> (free_entry == NULL) 
00808         {
00809                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_add"</span>, (<span class="stringliteral">"return = %p"</span>, (<span class="keywordtype">void</span> *) NULL) );
00810                 <span class="keywordflow">return</span> NULL ;
00811         }
00812 
00813         <span class="comment">/* copy the fields */</span>
00814         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o0">dest</a> = entry-&gt;dest ;
00815         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o1">dest_netaddr</a> = entry-&gt;dest_netaddr ;
00816         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o2">spi</a> = entry-&gt;spi ;
00817         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> = entry-&gt;protocol ;
00818         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o4">mode</a> = entry-&gt;mode ;
00819         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o5">sequence_number</a> = entry-&gt;sequence_number ;
00820         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o6">replay_win</a> = entry-&gt;replay_win ;
00821         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o7">lifetime</a> = entry-&gt;lifetime ;
00822         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o8">path_mtu</a> = entry-&gt;path_mtu ;
00823         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o9">enc_alg</a> = entry-&gt;enc_alg ;
00824         memcpy(free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o10">enckey</a>, entry-&gt;enckey, <a class="code" href="ipsec_8h.html#a2">IPSEC_MAX_ENCKEY_LEN</a>) ;
00825         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o11">auth_alg</a> = entry-&gt;auth_alg ;
00826         memcpy(free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o12">authkey</a>, entry-&gt;authkey, <a class="code" href="ipsec_8h.html#a6">IPSEC_MAX_AUTHKEY_LEN</a>) ;
00827 
00828         free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> = <a class="code" href="sa_8h.html#a3">IPSEC_USED</a> ;
00829 
00830         <span class="comment">/* re-link entry */</span>
00833         <span class="comment">/* if added first entry in array */</span>
00834         <span class="keywordflow">if</span>(table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> == NULL)
00835         {
00836                 table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> = free_entry ;
00837                 table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> = NULL ;
00838                 table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>-&gt;<a class="code" href="structsa__entry__struct.html#o14">prev</a> = NULL ;
00839                 table-&gt;<a class="code" href="structsad__table__struct.html#o2">last</a> = free_entry ;
00840         }
00841         <span class="keywordflow">else</span>
00842         {
00843                 <span class="comment">/* go till end of list */</span>
00844                 <span class="keywordflow">for</span>(tmp_entry = table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>; tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> != NULL; tmp_entry = tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a>)
00845                 {
00846                 }
00847                 <span class="comment">/* inset at end */</span>
00848                 free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o14">prev</a> = tmp_entry ;
00849                 tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> = free_entry ;
00850                 free_entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> = NULL ;
00851         }
00852 
00853         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_add"</span>, (<span class="stringliteral">"free_entry = %p"</span>, (<span class="keywordtype">void</span> *) free_entry) );
00854         <span class="keywordflow">return</span> free_entry ;
00855 }
00856 
<a name="l00870"></a><a class="code" href="sa_8c.html#a13">00870</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a13">ipsec_sad_del</a>(<a class="code" href="structsa__entry__struct.html">sad_entry</a> *entry, <a class="code" href="structsad__table__struct.html">sad_table</a> *table) 
00871 {
00872         <a class="code" href="structsa__entry__struct.html">sad_entry</a>               *next_ptr ;
00873         <a class="code" href="structsa__entry__struct.html">sad_entry</a>               *prev_ptr ;
00874 
00875         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00876                       <span class="stringliteral">"ipsec_sad_del"</span>, 
00877                                   (<span class="stringliteral">"entry=%p, table=%p"</span>,
00878                               (<span class="keywordtype">void</span> *)entry, (<span class="keywordtype">void</span> *)table )
00879                                  );
00880 
00881         <span class="comment">/* check range */</span>               
00882         <span class="keywordflow">if</span>((entry &gt;= table-&gt;<a class="code" href="structsad__table__struct.html#o0">table</a> ) &amp;&amp; (entry &lt;= (table-&gt;<a class="code" href="structsad__table__struct.html#o0">table</a> + (<a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>*<span class="keyword">sizeof</span>(<a class="code" href="structsa__entry__struct.html">sad_entry</a>)))))
00883         {
00884                 <span class="comment">/* relink table */</span>
00885         
00886                 <span class="keywordflow">if</span>(entry-&gt;use_flag != <a class="code" href="sa_8h.html#a3">IPSEC_USED</a>)
00887                 {
00888                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00889                         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a> ;
00890                 }
00891 
00892                 <span class="comment">/* relink previous with next */</span>
00893                 prev_ptr = entry-&gt;<a class="code" href="structsa__entry__struct.html#o14">prev</a> ;
00894                 next_ptr = entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> ;
00895                 <span class="keywordflow">if</span>(prev_ptr)
00896                         prev_ptr-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> = next_ptr ;
00897                 <span class="keywordflow">if</span>(next_ptr)
00898                         next_ptr-&gt;<a class="code" href="structsa__entry__struct.html#o14">prev</a> = prev_ptr ;
00899 
00900                 <span class="comment">/* if removed last entry */</span>
00901                 <span class="keywordflow">if</span>(entry-&gt;next == NULL)
00902                 {
00903                         table-&gt;<a class="code" href="structsad__table__struct.html#o2">last</a> == entry-&gt;<a class="code" href="structsa__entry__struct.html#o14">prev</a> ;
00904                 }
00905 
00906                 <span class="comment">/* if removed first entry */</span>
00907                 <span class="keywordflow">if</span>(entry == table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>)
00908                 {
00909                         table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> = entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a> ;
00910                 }
00911 
00912                 <span class="comment">/* clear field */</span>
00913                 entry-&gt;<a class="code" href="structsa__entry__struct.html#o15">use_flag</a> = <a class="code" href="sa_8h.html#a2">IPSEC_FREE</a> ;
00914 
00915 
00916                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>) );
00917                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
00918         }
00919 
00920         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_del"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00921         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a> ;
00922 }
00923 
<a name="l00940"></a><a class="code" href="sa_8c.html#a14">00940</a> <a class="code" href="structsa__entry__struct.html">sad_entry</a> *<a class="code" href="sa_8c.html#a14">ipsec_sad_lookup</a>(<a class="code" href="types_8h.html#a4">__u32</a> dest, <a class="code" href="types_8h.html#a0">__u8</a> proto, <a class="code" href="types_8h.html#a4">__u32</a> spi, <a class="code" href="structsad__table__struct.html">sad_table</a> *table)
00941 {
00942         <a class="code" href="structsa__entry__struct.html">sad_entry</a>       *tmp_entry ;
00943 
00944         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00945                       <span class="stringliteral">"ipsec_sad_lookup"</span>, 
00946                                   (<span class="stringliteral">"dest=%lu, proto=%d, spi=%lu, table=%p"</span>,
00947                               dest, proto, spi, (<span class="keywordtype">void</span> *)table ) 
00948                                  );
00949 
00950         <span class="comment">/* compare and return when all fields match */</span>
00951         <span class="keywordflow">for</span>(tmp_entry = table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>; tmp_entry != NULL; tmp_entry = tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a>)
00952         {
00953                 <span class="keywordflow">if</span>(<a class="code" href="util_8h.html#a7">ipsec_ip_addr_maskcmp</a>(dest, tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o0">dest</a>, tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o1">dest_netaddr</a>))
00954                 {
00955                         <span class="keywordflow">if</span>(tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == proto)
00956                         {
00957                                 <span class="keywordflow">if</span>(tmp_entry-&gt;<a class="code" href="structsa__entry__struct.html#o2">spi</a> == spi)
00958                                 {
00959                                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_lookup"</span>, (<span class="stringliteral">"tmp_entry = %p"</span>, (<span class="keywordtype">void</span> *)tmp_entry) );
00960                                         <span class="keywordflow">return</span> tmp_entry ;
00961                                 }
00962                         }
00963                 }
00964         }
00965         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_lookup"</span>, (<span class="stringliteral">"return = %p"</span>, (<span class="keywordtype">void</span> *)NULL) );
00966         <span class="keywordflow">return</span> NULL ;
00967 }
00968 
<a name="l00975"></a><a class="code" href="sa_8c.html#a15">00975</a> <span class="keywordtype">void</span> <a class="code" href="sa_8c.html#a15">ipsec_sad_print_single</a>(<a class="code" href="structsa__entry__struct.html">sad_entry</a> *entry)
00976 {
00977         <span class="keywordtype">char</span>            log_message[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00978         <span class="keywordtype">char</span>            dest[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00979         <span class="keywordtype">char</span>            dest_netaddr[<a class="code" href="debug_8h.html#a5">IPSEC_LOG_MESSAGE_SIZE</a>+1] ;
00980         <span class="keywordtype">char</span>            crypto[10+1] ;
00981 
00982         strcpy(dest, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structsa__entry__struct.html#o0">dest</a>)) ;
00983         strcpy(dest_netaddr, <a class="code" href="util_8c.html#a3">ipsec_inet_ntoa</a>(entry-&gt;<a class="code" href="structsa__entry__struct.html#o1">dest_netaddr</a>)) ;
00984 
00985         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == <a class="code" href="types_8h.html#a40a37">IPSEC_PROTO_AH</a>)
00986                 strcpy(crypto, entry-&gt;<a class="code" href="structsa__entry__struct.html#o11">auth_alg</a> == <a class="code" href="sa_8h.html#a12">IPSEC_HMAC_MD5</a> ? <span class="stringliteral">" MD5"</span> : <span class="stringliteral">"SHA1"</span>) ;
00987         <span class="keywordflow">else</span>
00988                 strcpy(crypto, entry-&gt;<a class="code" href="structsa__entry__struct.html#o9">enc_alg</a> == <a class="code" href="sa_8h.html#a9">IPSEC_DES</a> ? <span class="stringliteral">" DES"</span> : <span class="stringliteral">"3DES"</span>) ;
00989 
00990         sprintf(log_message,    <span class="stringliteral">"%15s/%15s %4s %5s  %4s   %10lu %5d %10lu %4d %8x 0x%p "</span>,
00991                                                 dest, 
00992                                                         dest_netaddr,
00993                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a> ? <span class="stringliteral">"ESP"</span> : <span class="stringliteral">" AH"</span>, 
00994                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o4">mode</a> == <a class="code" href="sa_8h.html#a7">IPSEC_TUNNEL</a> ? <span class="stringliteral">"  TUN"</span> : <span class="stringliteral">"TRANS"</span>, 
00995                                                         crypto,
00996                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o5">sequence_number</a>,
00997                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o6">replay_win</a>,
00998                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o7">lifetime</a>,
00999                                                         entry-&gt;<a class="code" href="structsa__entry__struct.html#o8">path_mtu</a>,
01000                                                         <a class="code" href="util_8c.html#a7">ipsec_ntohl</a>(entry-&gt;<a class="code" href="structsa__entry__struct.html#o2">spi</a>),
01001                                                         entry
01002                                                         ) ;
01003         printf(<span class="stringliteral">"     %s\n"</span>, log_message) ;
01004 
01005         <span class="keywordflow">return</span> ;
01006 }
01007 
<a name="l01014"></a><a class="code" href="sa_8c.html#a16">01014</a> <span class="keywordtype">void</span> <a class="code" href="sa_8c.html#a16">ipsec_sad_print</a>(<a class="code" href="structsad__table__struct.html">sad_table</a> *table)
01015 {
01016         <a class="code" href="structsa__entry__struct.html">sad_entry</a>       *tmp_ptr ;
01017 
01018         <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsec_sad_print"</span>, (<span class="stringliteral">"Print Security Association Database"</span>)) ;
01019         printf(<span class="stringliteral">"     dest/dest netaddr                proto mode crypto seq          win   ltime    mtu      spi  addr\n"</span>) ;
01020 
01021         <span class="keywordflow">if</span>(table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> == NULL)
01022         {
01023                 printf(<span class="stringliteral">"      SAD table is empty\n"</span>) ;
01024         }
01025 
01026         <span class="comment">/* loop over all entries and print them */</span>
01027         <span class="keywordflow">for</span>(tmp_ptr = table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a>; tmp_ptr != NULL; tmp_ptr = tmp_ptr-&gt;<a class="code" href="structsa__entry__struct.html#o13">next</a>)
01028         {
01029                 <a class="code" href="sa_8c.html#a15">ipsec_sad_print_single</a>(tmp_ptr) ;
01030         }
01031 }
01032 
<a name="l01040"></a><a class="code" href="sa_8c.html#a17">01040</a> <a class="code" href="types_8h.html#a4">__u32</a> <a class="code" href="sa_8c.html#a17">ipsec_sad_get_spi</a>(<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *header)
01041 {
01042         <a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip</a>     *ptr ;
01043 
01044         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
01045                       <span class="stringliteral">"ipsec_sad_get_spi"</span>, 
01046                                   (<span class="stringliteral">"header=%p"</span>,
01047                               (<span class="keywordtype">void</span> *)header)
01048                                  );
01049 
01050 
01051         ptr = (<a class="code" href="structipsec__in__ip__struct.html">ipsec_in_ip</a>*)header ;
01052 
01053         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o0">ip</a>.<a class="code" href="structipsec__ip__hdr__struct.html#o6">protocol</a> == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a>)
01054         {
01055                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_get_spi"</span>, (<span class="stringliteral">"ptr-&gt;inner_header.esp.spi = %ul"</span>, ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.esp.spi) );
01056                 <span class="keywordflow">return</span> ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.esp.spi ;
01057         }
01058 
01059         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o0">ip</a>.<a class="code" href="structipsec__ip__hdr__struct.html#o6">protocol</a> == <a class="code" href="types_8h.html#a40a37">IPSEC_PROTO_AH</a>)
01060         {
01061                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_get_spi"</span>, (<span class="stringliteral">"ptr-&gt;inner_header.ah.spi = %ul"</span>, ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.ah.spi) );
01062                 <span class="keywordflow">return</span> ptr-&gt;<a class="code" href="structipsec__in__ip__struct.html#o5">inner_header</a>.ah.spi ;
01063         }
01064 
01065         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_sad_get_spi"</span>, (<span class="stringliteral">"return = 0"</span>) );
01066         <span class="keywordflow">return</span> 0 ;
01067 }
01068 
<a name="l01078"></a><a class="code" href="sa_8c.html#a18">01078</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a18">ipsec_spd_flush</a>(<a class="code" href="structspd__table__struct.html">spd_table</a> *table, <a class="code" href="structspd__entry__struct.html">spd_entry</a> *def_entry)
01079 {
01080         memset(table-&gt;<a class="code" href="structspd__table__struct.html#o0">table</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structspd__entry__struct.html">spd_entry</a>)*<a class="code" href="sa_8h.html#a1">IPSEC_MAX_SPD_ENTRIES</a>) ;
01081         table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
01082         table-&gt;<a class="code" href="structspd__table__struct.html#o1">first</a> = NULL ;
01083 
01084         <span class="keywordflow">if</span>(<a class="code" href="sa_8c.html#a5">ipsec_spd_add</a>(       def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o0">src</a>,
01085                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o1">src_netaddr</a>,
01086                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o2">dest</a>,
01087                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o3">dest_netaddr</a>,
01088                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o4">protocol</a>,
01089                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o5">src_port</a>,
01090                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o6">dest_port</a>,
01091                                                 def_entry-&gt;<a class="code" href="structspd__entry__struct.html#o7">policy</a>,
01092                                                 table) == NULL)
01093                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a> ;
01094 
01095         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
01096 }
01097 
<a name="l01104"></a><a class="code" href="sa_8c.html#a19">01104</a> <a class="code" href="types_8h.html#a6">ipsec_status</a> <a class="code" href="sa_8c.html#a19">ipsec_sad_flush</a>(<a class="code" href="structsad__table__struct.html">sad_table</a> *table)
01105 {
01106         memset(table-&gt;<a class="code" href="structsad__table__struct.html#o0">table</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structspd__entry__struct.html">spd_entry</a>)*<a class="code" href="sa_8h.html#a0">IPSEC_MAX_SAD_ENTRIES</a>) ;
01107         table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
01108         table-&gt;<a class="code" href="structsad__table__struct.html#o1">first</a> = NULL ;
01109         
01110         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a> ;
01111 }
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
