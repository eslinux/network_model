<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>esp.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
This module contains the Encapsulating Security Payload code. 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Niklaus Schild &lt;<a href="mailto:n.schild@gmx.ch">n.schild@gmx.ch</a>&gt; <br>
</dd></dl>
<b>OUTLINE:</b><p>
<b>IMPLEMENTATION:</b> All functions work in-place (i.g. mainipulate directly the original packet without copying any data). For the encapsulation routine, the caller must ensure that space for the new IP and ESP header are available in front of the packet:<p>
<pre><div>
                              | pointer to packet header
     ________________________\/________________________________________________
    |          ¦       ¦      ¦                             ¦ padd       ¦ ev. |
    | Ethernet ¦ newIP ¦ ESP  ¦   original (inner) packet   ¦ next-proto ¦ ICV |
    |__________¦_______¦______¦_____________________________¦____________¦_____|
    ¦                         ¦                             ¦                  ¦ 
    ¦&lt;-room for new headers--&gt;¦                             ¦&lt;-   room tail  -&gt;¦ 
  </pre></div><p>
This document is part of <em>embedded IPsec<br>
 Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne<br>
 All rights reserved.<br>
 This file contains code from the OpenSSL Project<br>
 portions Copyright (c) 1998-2003 OpenSSL (www.openssl.org) </em><hr>

<p>
Definition in file <a class="el" href="esp_8c-source.html">esp.c</a>.
<p>
<code>#include &lt;string.h&gt;</code><br>
<code>#include "<a class="el" href="ipsec_8h-source.html">ipsec/ipsec.h</a>"</code><br>
<code>#include "<a class="el" href="util_8h-source.html">ipsec/util.h</a>"</code><br>
<code>#include "<a class="el" href="debug_8h-source.html">ipsec/debug.h</a>"</code><br>
<code>#include "<a class="el" href="sa_8h-source.html">ipsec/sa.h</a>"</code><br>
<code>#include "<a class="el" href="des_8h-source.html">ipsec/des.h</a>"</code><br>
<code>#include "<a class="el" href="md5_8h-source.html">ipsec/md5.h</a>"</code><br>
<code>#include "<a class="el" href="sha1_8h-source.html">ipsec/sha1.h</a>"</code><br>
<code>#include "<a class="el" href="esp_8h-source.html">ipsec/esp.h</a>"</code><br>

<p>
<a href="esp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a0">__u8</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="esp_8c.html#a2">ipsec_esp_get_padding</a> (int len)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a6">ipsec_status</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="esp_8c.html#a3">ipsec_esp_decapsulate</a> (<a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *packet, int *offset, int *len, <a class="el" href="structsa__entry__struct.html">sad_entry</a> *sa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a6">ipsec_status</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="esp_8c.html#a4">ipsec_esp_encapsulate</a> (<a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *packet, int *offset, int *len, <a class="el" href="structsa__entry__struct.html">sad_entry</a> *sa, <a class="el" href="types_8h.html#a4">__u32</a> src_addr, <a class="el" href="types_8h.html#a4">__u32</a> dest_addr)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="esp_8c.html#a0">ipsec_esp_bitmap</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="esp_8c.html#a1">ipsec_esp_lastSeq</a> = 0</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="esp.c::ipsec_esp_decapsulate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a6">ipsec_status</a> ipsec_esp_decapsulate </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structsa__entry__struct.html">sad_entry</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>sa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Decapsulates an IP packet containing an ESP header.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>packet</em>&nbsp;</td><td>pointer to the ESP header </td></tr>
    <tr><td valign=top><em>offset</em>&nbsp;</td><td>pointer to the offset which is passed back </td></tr>
    <tr><td valign=top><em>len</em>&nbsp;</td><td>pointer to the length of the decapsulated packet </td></tr>
    <tr><td valign=top><em>sa</em>&nbsp;</td><td>pointer to the SA </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>IPSEC_STATUS_SUCCESS if the packet could be decapsulated properly <p>
IPSEC_STATUS_FAILURE if the SA's authentication algorithm was invalid or if ICV comparison failed <p>
IPSEC_STATUS_BAD_PACKET if the decryption gave back a strange packet </dd></dl>

<p>
Definition at line <a class="el" href="esp_8c-source.html#l00111">111</a> of file <a class="el" href="esp_8c-source.html">esp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="esp.c::ipsec_esp_encapsulate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a6">ipsec_status</a> ipsec_esp_encapsulate </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structsa__entry__struct.html">sad_entry</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>sa</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>src_addr</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dest_addr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Encapsulates an IP packet into an ESP packet which will again be added to an IP packet.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>packet</em>&nbsp;</td><td>pointer to the IP packet </td></tr>
    <tr><td valign=top><em>offset</em>&nbsp;</td><td>pointer to the offset which will point to the new encapsulated packet </td></tr>
    <tr><td valign=top><em>len</em>&nbsp;</td><td>pointer to the length of the new encapsulated packet </td></tr>
    <tr><td valign=top><em>sa</em>&nbsp;</td><td>pointer to the SA </td></tr>
    <tr><td valign=top><em>src_addr</em>&nbsp;</td><td>source IP address of the outer IP header </td></tr>
    <tr><td valign=top><em>dest_addr</em>&nbsp;</td><td>destination IP address of the outer IP header </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>IPSEC_STATUS_SUCCESS if the packet was properly encapsulated <p>
IPSEC_STATUS_TTL_EXPIRED if the TTL expired <p>
IPSEC_STATUS_FAILURE if the SA contained a bad authentication algorithm</dd></dl>
<dl compact><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>fix TTL update and checksum calculation <p>
id must be generated properly and incremented</dd></dl>
<p>
1st packet needs to be sent out with squ = 1 
<p>
Definition at line <a class="el" href="esp_8c-source.html#l00230">230</a> of file <a class="el" href="esp_8c-source.html">esp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="esp.c::ipsec_esp_get_padding" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a0">__u8</a> ipsec_esp_get_padding </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>len</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Returns the number of padding needed for a certain ESP packet size<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>len</em>&nbsp;</td><td>the length of the packet </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>the length of padding needed </dd></dl>

<p>
Definition at line <a class="el" href="esp_8c-source.html#l00090">90</a> of file <a class="el" href="esp_8c-source.html">esp.c</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="esp.c::ipsec_esp_bitmap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a4">__u32</a> <a class="el" href="esp_8h.html#a6">ipsec_esp_bitmap</a> = 0
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
save session state to detect replays - must be 32 bits. Note: must be initialized with zero (0x00000000) when a new SA is established! 
<p>
Definition at line <a class="el" href="esp_8c-source.html#l00075">75</a> of file <a class="el" href="esp_8c-source.html">esp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="esp.c::ipsec_esp_lastSeq" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a4">__u32</a> <a class="el" href="esp_8h.html#a7">ipsec_esp_lastSeq</a> = 0
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
save session state to detect replays Note: must be initialized with zero (0x00000000) when a new SA is established! 
<p>
Definition at line <a class="el" href="esp_8c-source.html#l00078">78</a> of file <a class="el" href="esp_8c-source.html">esp.c</a>.    </td>
  </tr>
</table>
	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
