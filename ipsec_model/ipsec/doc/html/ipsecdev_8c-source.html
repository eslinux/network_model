<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ipsecdev.c</h1><a href="ipsecdev_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec</span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00069 <span class="preprocessor">#include "lwip/mem.h"</span>
00070 
00071 <span class="preprocessor">#include "<a class="code" href="ipsecdev_8h.html">netif/ipsecdev.h</a>"</span>
00072 
00073 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00074 <span class="preprocessor">#include "<a class="code" href="ipsec_8h.html">ipsec/ipsec.h</a>"</span>
00075 <span class="preprocessor">#include "<a class="code" href="util_8h.html">ipsec/util.h</a>"</span>
00076 <span class="preprocessor">#include "<a class="code" href="sa_8h.html">ipsec/sa.h</a>"</span>
00077 
00078 
<a name="l00079"></a><a class="code" href="ipsecdev_8c.html#a0">00079</a> <span class="preprocessor">#define IPSECDEV_NAME0 'i'              </span>
<a name="l00080"></a><a class="code" href="ipsecdev_8c.html#a1">00080</a> <span class="preprocessor">#define IPSECDEV_NAME1 's'              </span>
<a name="l00082"></a><a class="code" href="ipsecdev_8c.html#a2">00082</a> <span class="preprocessor">extern sad_entry inbound_sad_config[]; </span>
<a name="l00083"></a><a class="code" href="ipsecdev_8c.html#a3">00083</a> <span class="preprocessor">extern spd_entry inbound_spd_config[]; </span>
<a name="l00084"></a><a class="code" href="ipsecdev_8c.html#a4">00084</a> <span class="preprocessor">extern sad_entry outbound_sad_config[];</span>
<a name="l00085"></a><a class="code" href="ipsecdev_8c.html#a5">00085</a> <span class="preprocessor">extern spd_entry outbound_spd_config[];</span>
<a name="l00087"></a><a class="code" href="ipsecdev_8c.html#a6">00087</a> <span class="preprocessor">extern db_set_netif     db_sets[];</span>
<a name="l00088"></a><a class="code" href="ipsecdev_8c.html#a7">00088</a> <span class="preprocessor"></span><a class="code" href="structdb__set__netif__struct.html">db_set_netif</a>    *<a class="code" href="ipsecdev_8c.html#a7">databases</a>;     
<a name="l00089"></a><a class="code" href="ipsecdev_8c.html#a8">00089</a> <span class="keyword">struct </span>netif    <a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>;   
<a name="l00090"></a><a class="code" href="ipsecdev_8c.html#a9">00090</a> <a class="code" href="types_8h.html#a4">__u32</a>                   <a class="code" href="ipsecdev_8c.html#a9">tunnel_src_addr</a>;
<a name="l00091"></a><a class="code" href="ipsecdev_8c.html#a10">00091</a> <a class="code" href="types_8h.html#a4">__u32</a>                   <a class="code" href="ipsecdev_8c.html#a10">tunnel_dst_addr</a>;
<a name="l00100"></a><a class="code" href="ipsecdev_8c.html#a11">00100</a> <span class="keywordtype">void</span> <a class="code" href="ipsecdev_8c.html#a11">ipsecdev_service</a>(<span class="keyword">struct</span> netif *netif)
00101 {
00102         <span class="keyword">struct </span>netif *i ;
00103         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, <span class="stringliteral">"ipsecdev_service"</span>, (<span class="stringliteral">"netif=%p"</span>, (<span class="keywordtype">void</span> *)netif) );
00104         i = netif ;
00105         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_service"</span>, (<span class="stringliteral">"void"</span>) );
00106         <span class="keywordflow">return</span> ;
00107 }
00108 
00109 
<a name="l00123"></a><a class="code" href="ipsecdev_8c.html#a12">00123</a> err_t <a class="code" href="ipsecdev_8c.html#a12">ipsecdev_input</a>(<span class="keyword">struct</span> pbuf *p, <span class="keyword">struct</span> netif *inp)
00124 {
00125         <span class="keywordtype">int</span> retcode;
00126         <span class="keywordtype">int</span> payload_offset      = 0;
00127         <span class="keywordtype">int</span> payload_size        = 0;
00128         <a class="code" href="structspd__entry__struct.html">spd_entry</a>               *spd ;
00129 
00130         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00131                       <span class="stringliteral">"ipsecdev_input"</span>, 
00132                                   (<span class="stringliteral">"p=%p, inp=%p"</span>,
00133                               (<span class="keywordtype">void</span> *)p, (<span class="keywordtype">void</span> *)inp)
00134                                  );
00135 
00136         <a class="code" href="debug_8h.html#a13">IPSEC_DUMP_BUFFER</a>(<span class="stringliteral">"ipsecdev_input"</span>, p-&gt;payload, 0, p-&gt;len) ;
00137 
00138         <span class="keywordflow">if</span>(p == NULL || p-&gt;payload == NULL)
00139         {
00140                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"Packet has no payload. Can't pass it to higher level protocol stacks."</span>));
00141                 pbuf_free(p) ;
00142         }
00143         <span class="keywordflow">else</span> 
00144         {
00145 
00146                 <span class="comment">/* minimal sanity check of inbound data (packet buffer &amp; IP header fields must be &lt;= MTU) */</span>
00147                 <span class="keywordflow">if</span>((p-&gt;tot_len &gt; <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>) || (<a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)p-&gt;payload))-&gt;len) &gt; <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>))
00148                 {
00149                         <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"Packet to long (%d &gt; %d (IPSEC_MTU))"</span>, p-&gt;tot_len, <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>) );
00150                         <span class="comment">/* in case of error, free pbuf and return ERR_OK as lwIP does */</span>
00151                         pbuf_free(p) ;
00152                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_input"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_OK) );
00153                         <span class="keywordflow">return</span> ERR_OK;
00154                 }
00155 
00156                 <span class="keywordflow">if</span>(p-&gt;next != NULL)
00157                 {
00158                         <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"can not handle chained pbuf - (packet must be &lt; %d bytes )"</span>, PBUF_POOL_BUFSIZE - PBUF_LINK_HLEN - <a class="code" href="ipsecdev_8h.html#a0">IPSEC_HLEN</a>) );
00159                         <span class="comment">/* in case of error, free pbuf and return ERR_OK as lwIP does */</span>
00160                         pbuf_free(p) ;
00161                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_input"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_OK) );
00162                         <span class="keywordflow">return</span> ERR_OK;
00163                 }
00164 
00165 
00166                 <span class="keywordflow">if</span>( ((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>*)(p-&gt;payload))-&gt;protocol == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a> || ((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>*)(p-&gt;payload))-&gt;protocol == <a class="code" href="types_8h.html#a40a37">IPSEC_PROTO_AH</a>)
00167                 {
00168                         <span class="comment">/* we got an IPsec packet which must be handled by the IPsec engine */</span>
00169                         retcode = <a class="code" href="ipsec_8h.html#a9">ipsec_input</a>(p-&gt;payload, p-&gt;len, (<span class="keywordtype">int</span> *)&amp;payload_offset, (<span class="keywordtype">int</span> *)&amp;payload_size, <a class="code" href="ipsecdev_8c.html#a7">databases</a>);
00170 
00171                         <span class="keywordflow">if</span>(retcode == <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>)
00172                         {
00174                                 <span class="comment">/* remove obsolete ESP headers */</span>
00175                                 p-&gt;payload = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)(p-&gt;payload) + payload_offset;
00176                                 p-&gt;len = payload_size;
00177                                 p-&gt;tot_len = payload_size;
00178 
00179                                 <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsecdev_input"</span>, (<span class="stringliteral">"fwd decapsulated IPsec packet to ip_input()"</span>) );
00180                                 retcode = ip_input(p, inp);             
00181                                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_input"</span>, (<span class="stringliteral">"retcode = %d"</span>, retcode) );
00182                                 <span class="keywordflow">return</span> retcode;
00183 
00184                         }
00185                         <span class="keywordflow">else</span>
00186                         {
00187                                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_input"</span>, retcode, (<span class="stringliteral">"error on ipsec_input() processing (retcode = %d)"</span>, retcode));
00188                                 pbuf_free(p) ;
00189                         }                       
00190                 }
00191                 <span class="keywordflow">else</span>
00192                 {
00193                         <span class="comment">/* check what the policy says about non-IPsec traffic */</span>
00194                         spd = <a class="code" href="sa_8c.html#a8">ipsec_spd_lookup</a>(p-&gt;payload, &amp;<a class="code" href="ipsecdev_8c.html#a7">databases</a>-&gt;<a class="code" href="structdb__set__netif__struct.html#o0">inbound_spd</a>) ;
00195                         <span class="keywordflow">if</span>(spd == NULL)
00196                         {
00197                                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a17">IPSEC_STATUS_NO_POLICY_FOUND</a>, (<span class="stringliteral">"no matching SPD policy found"</span>)) ;
00198                                 pbuf_free(p) ;
00199                         }
00200                         <span class="keywordflow">else</span>
00201                         {
00202                                 <span class="keywordflow">switch</span>(spd-&gt;<a class="code" href="structspd__entry__struct.html#o7">policy</a>)
00203                                 {
00204                                         <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a4">POLICY_APPLY</a>:
00205                                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a39a27">IPSEC_AUDIT_APPLY</a>, (<span class="stringliteral">"POLICY_APPLY: got non-IPsec packet which should be one"</span>)) ;
00206                                                 pbuf_free(p) ;
00207                                                 <span class="keywordflow">break</span>;
00208                                         <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a6">POLICY_DISCARD</a>:
00209                                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a39a29">IPSEC_AUDIT_DISCARD</a>, (<span class="stringliteral">"POLICY_DISCARD: dropping packet"</span>)) ;
00210                                                 pbuf_free(p) ;
00211                                                 <span class="keywordflow">break</span>;
00212                                         <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a5">POLICY_BYPASS</a>:
00213                                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a39a28">IPSEC_AUDIT_BYPASS</a>, (<span class="stringliteral">"POLICY_BYPASS: forwarding packet to ip_input"</span>)) ;
00214                                                 ip_input(p, inp);
00215                                                 <span class="keywordflow">break</span>;
00216                                         <span class="keywordflow">default</span>:
00217                                                 pbuf_free(p) ;
00218                                                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"IPSEC_STATUS_FAILURE: dropping packet"</span>)) ;
00219                                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a39a26">IPSEC_AUDIT_FAILURE</a>, (<span class="stringliteral">"unknown Security Policy: dropping packet"</span>)) ;
00220                                 } 
00221                         }
00222                 }
00223         }
00224 
00225         <span class="comment">/* usually return ERR_OK as lwIP does */</span>
00226         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_input"</span>, (<span class="stringliteral">"retcode = %d"</span>, ERR_OK) );
00227         <span class="keywordflow">return</span> ERR_OK;
00228 }
00229 
00230 
<a name="l00243"></a><a class="code" href="ipsecdev_8c.html#a13">00243</a> err_t <a class="code" href="ipsecdev_8c.html#a13">ipsecdev_output</a>(<span class="keyword">struct</span> netif *netif, <span class="keyword">struct</span> pbuf *p, <span class="keyword">struct</span> ip_addr *ipaddr)
00244 {
00245         <span class="keyword">struct </span>pbuf *p_cpy = NULL;
00246         <span class="keywordtype">int</span> payload_size ;
00247         <span class="keywordtype">int</span> payload_offset ;
00248         <a class="code" href="structspd__entry__struct.html">spd_entry</a> *spd ;
00249         <a class="code" href="types_8h.html#a6">ipsec_status</a> status ;
00250         <span class="keyword">struct </span>ip_addr dest_addr;
00251         <span class="keywordtype">int</span> retcode;
00252 
00253         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00254                       <span class="stringliteral">"ipsecdev_output"</span>, 
00255                                   (<span class="stringliteral">"netif=%p, p=%p, ipaddr=%p"</span>, (<span class="keywordtype">void</span> *)netif, (<span class="keywordtype">void</span> *)p, (<span class="keywordtype">void</span> *)ipaddr ) 
00256                                  );
00257 
00258 
00259         <span class="comment">/* minimal sanity check of inbound data (packet buffer &amp; IP header fields must be &lt;= MTU) */</span>
00260         <span class="keywordflow">if</span>((p-&gt;tot_len &gt; <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>) || (<a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)p-&gt;payload))-&gt;len) &gt; <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>))
00261         {
00262                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"Packet to long (&gt; IPSEC_MTU) on interface '%c%c'"</span>, netif-&gt;name[0], netif-&gt;name[1]));
00263                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_CONN) );
00264                 <span class="keywordflow">return</span> ERR_CONN;
00265         }
00266 
00267         <span class="keywordflow">if</span>(p-&gt;next != NULL)
00268         {
00269                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"can not handle chained pbuf - use pbuf size of %d bytes"</span>, <a class="code" href="ipsecdev_8h.html#a1">IPSEC_MTU</a>));
00270                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_CONN) );
00271                 <span class="keywordflow">return</span> ERR_CONN;
00272         }
00273 
00274         <span class="keywordflow">if</span>(p-&gt;ref != 1)
00275         {
00276                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"can not handle pbuf-&gt;ref != 1 - p-&gt;ref == %d"</span>, p-&gt;ref));
00277                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_CONN) );
00278                 <span class="keywordflow">return</span> ERR_CONN;
00279         }
00280 
00281 
00283         memcpy(&amp;dest_addr, ipaddr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_addr));
00284 
00287         <span class="comment">/* RFC conform IPsec processing */</span>
00288         spd = <a class="code" href="sa_8c.html#a8">ipsec_spd_lookup</a>((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>*)p-&gt;payload, &amp;<a class="code" href="ipsecdev_8c.html#a7">databases</a>-&gt;<a class="code" href="structdb__set__netif__struct.html#o1">outbound_spd</a>) ;
00289         <span class="keywordflow">if</span>(spd == NULL)
00290         {
00291                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a38a17">IPSEC_STATUS_NO_POLICY_FOUND</a>, (<span class="stringliteral">"no matching SPD policy found"</span>)) ;
00292                 <span class="comment">/* free local pbuf here */</span>
00293                 pbuf_free(p);
00294                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"retcode = %d"</span>, ERR_CONN) );
00295                 <span class="keywordflow">return</span> ERR_CONN ;
00296         }
00297 
00298         <span class="keywordflow">switch</span>(spd-&gt;<a class="code" href="structspd__entry__struct.html#o7">policy</a>)
00299         {
00300                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a4">POLICY_APPLY</a>:                                                                                                                                              
00301                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a39a27">IPSEC_AUDIT_APPLY</a>, (<span class="stringliteral">"POLICY_APPLY: processing IPsec packet"</span>)) ;
00302 
00308                                 p_cpy = p;
00309                                 <span class="keywordflow">if</span>(spd-&gt;<a class="code" href="structspd__entry__struct.html#o8">sa</a>-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a>)
00310                                 {
00311                                         <span class="comment">// alloc 50 more bytes for ESP trailer and the optional ESP authentication data</span>
00312                                     p_cpy = pbuf_alloc(PBUF_RAW, p-&gt;len + 50, PBUF_POOL);
00313 
00314                                         <span class="keywordflow">if</span>(p_cpy != NULL) {
00315                                                 memcpy(p_cpy-&gt;payload, p-&gt;payload, p-&gt;len);
00316                                                 p_cpy-&gt;next = NULL;
00317                                                 p_cpy-&gt;len = p-&gt;len + 50;
00318                                                 p_cpy-&gt;tot_len = p-&gt;tot_len + 50;
00319                                                 p_cpy-&gt;ref = p-&gt;ref;
00320                                                 <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"lwIP ESP TCP workaround: successfully allocated new pbuf (tot_len = %d)"</span>, p_cpy-&gt;tot_len) );
00321                                         }
00322                                         <span class="keywordflow">else</span> {
00323                                                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a39a26">IPSEC_AUDIT_FAILURE</a>, (<span class="stringliteral">"can't alloc new pbuf for lwIP ESP TCP workaround!"</span>) ) ;
00324                                         }
00325                                 }
00326 
00327                                 status = <a class="code" href="ipsec_8h.html#a10">ipsec_output</a>(p_cpy-&gt;payload, p_cpy-&gt;len, &amp;payload_offset, &amp;payload_size, <a class="code" href="ipsecdev_8c.html#a9">tunnel_src_addr</a>, <a class="code" href="ipsecdev_8c.html#a10">tunnel_dst_addr</a>, spd) ;
00328 
00329                                 <span class="keywordflow">if</span>(status == <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>)
00330                                 {
00331                                         <span class="comment">/* adjust pbuf structure according to the real packet size */</span>
00332                                         p_cpy-&gt;payload = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)(p_cpy-&gt;payload) + payload_offset;
00333                                         p_cpy-&gt;len = payload_size;
00334                                         p_cpy-&gt;tot_len = payload_size;
00335 
00336                                         <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsec_output"</span>, (<span class="stringliteral">"fwd IPsec packet to HW mapped device"</span>) );
00337                                         retcode = <a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>.output(&amp;<a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>, p_cpy, (<span class="keywordtype">void</span> *)&amp;<a class="code" href="ipsecdev_8c.html#a10">tunnel_dst_addr</a>);
00338                                         <span class="keywordflow">if</span>(spd-&gt;<a class="code" href="structspd__entry__struct.html#o8">sa</a>-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a>) pbuf_free(p_cpy);
00339                                 }
00340                                 <span class="keywordflow">else</span> {
00341                                         <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_output"</span>, status, (<span class="stringliteral">"error on ipsec_output() processing"</span>));
00342                                         <span class="keywordflow">if</span>(spd-&gt;<a class="code" href="structspd__entry__struct.html#o8">sa</a>-&gt;<a class="code" href="structsa__entry__struct.html#o3">protocol</a> == <a class="code" href="types_8h.html#a40a36">IPSEC_PROTO_ESP</a>) pbuf_free(p_cpy);
00343                                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"retcode = %d"</span>, ERR_CONN) );
00344                                 }
00345 
00346                                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"retcode = %d"</span>, ERR_OK) );
00347                         <span class="keywordflow">return</span> ERR_OK;
00348                         <span class="keywordflow">break</span>;
00349                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a6">POLICY_DISCARD</a>:
00350                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a39a29">IPSEC_AUDIT_DISCARD</a>, (<span class="stringliteral">"POLICY_DISCARD: dropping packet"</span>)) ;
00351                         <span class="keywordflow">break</span>;
00352                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a5">POLICY_BYPASS</a>:
00353                                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_output"</span>, <a class="code" href="types_8h.html#a39a28">IPSEC_AUDIT_BYPASS</a>, (<span class="stringliteral">"POLICY_BYPASS: forwarding packet to ip_output"</span>)) ;
00354                                 retcode = <a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>.output(&amp;<a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>, p, &amp;dest_addr);
00355                                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"retcode = %d"</span>, retcode) );
00356                                 <span class="keywordflow">return</span> retcode;
00357                         <span class="keywordflow">break</span>;
00358                 <span class="keywordflow">default</span>:
00359                         <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"POLICY_DIRCARD: dropping packet"</span>)) ;
00360                         <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsecdev_input"</span>, <a class="code" href="types_8h.html#a39a26">IPSEC_AUDIT_FAILURE</a>, (<span class="stringliteral">"unknown Security Policy: dropping packet"</span>)) ;
00361         }
00362 
00363         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_output"</span>, (<span class="stringliteral">"return = %d"</span>, ERR_CONN) );
00364         <span class="keywordflow">return</span> ERR_CONN;
00365 }
00366 
00367 
<a name="l00378"></a><a class="code" href="ipsecdev_8c.html#a14">00378</a> err_t <a class="code" href="ipsecdev_8c.html#a14">ipsecdev_netlink_output</a>(<span class="keyword">struct</span> netif *netif, <span class="keyword">struct</span> pbuf *p)
00379 {
00380         <span class="keywordtype">int</span> retcode;
00381         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00382                       <span class="stringliteral">"ipsecdev_netlink_output"</span>, 
00383                                   (<span class="stringliteral">"netif=%p, p=%d"</span>, (<span class="keywordtype">void</span> *)netif, (<span class="keywordtype">void</span> *)p ) 
00384                                  );
00385         <a class="code" href="debug_8h.html#a8">IPSEC_LOG_MSG</a>(<span class="stringliteral">"ipsecdev_netlink_output"</span>, (<span class="stringliteral">"fwd from interface '%c%c' to real HW linkoutput"</span>,  netif-&gt;name[0], netif-&gt;name[1]) );
00386 
00387         retcode = <a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>.linkoutput(&amp;<a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>, p);
00388         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_netlink_output"</span>, (<span class="stringliteral">"retcode = %d"</span>, retcode) );
00389         <span class="keywordflow">return</span> retcode; 
00390 }
00391 
00392 
<a name="l00402"></a><a class="code" href="ipsecdev_8c.html#a15">00402</a> err_t <a class="code" href="ipsecdev_8c.html#a15">ipsecdev_init</a>(<span class="keyword">struct</span> netif *netif)
00403 {
00404         <span class="keyword">struct </span><a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a> *<a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a>;
00405 
00406         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00407                       <span class="stringliteral">"ipsecdev_init"</span>, 
00408                                   (<span class="stringliteral">"netif=%p"</span>, (<span class="keywordtype">void</span> *)netif ) 
00409                                  );
00410 
00411 
00412         <a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a> = mem_malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a>));
00413         <span class="keywordflow">if</span> (<a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a> == NULL)
00414         {
00415                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsecdev_init"</span>, <a class="code" href="types_8h.html#a38a15">IPSEC_STATUS_DATA_SIZE_ERROR</a>, (<span class="stringliteral">"out of memory for ipsecdev_stats"</span>));
00416                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_init"</span>, (<span class="stringliteral">"retcode = %d"</span>, ERR_MEM) );
00417                 <span class="keywordflow">return</span> ERR_MEM;
00418         }
00419 
00420         <span class="comment">/* set the name of this interface */</span>
00421         netif-&gt;name[0] = <a class="code" href="ipsecdev_8c.html#a0">IPSECDEV_NAME0</a>;
00422         netif-&gt;name[1] = <a class="code" href="ipsecdev_8c.html#a1">IPSECDEV_NAME1</a>;
00423 
00424         <span class="comment">/* use the same output function for all operations */</span>
00425         netif-&gt;output = (<span class="keywordtype">void</span> *)<a class="code" href="ipsecdev_8c.html#a13">ipsecdev_output</a>;                                <span class="comment">/* usually called if the IP module wants to send data */</span>
00426         netif-&gt;linkoutput = (<span class="keywordtype">void</span> *)<a class="code" href="ipsecdev_8c.html#a14">ipsecdev_netlink_output</a>;    <span class="comment">/* usually called if the ARP module wants to send data "as-is" */</span>
00427 
00429         <span class="comment">/* initialize the db_sets structure */</span>
00430         memset(<a class="code" href="sa_8c.html#a0">db_sets</a>, 0, <a class="code" href="sa_8h.html#a14">IPSEC_NR_NETIFS</a>*<span class="keyword">sizeof</span>(<a class="code" href="structdb__set__netif__struct.html">db_set_netif</a>)) ;
00431 
00432         <span class="comment">/* swap output devices */</span>
00434         <span class="comment">/* save mapped netif */</span>
00435         memcpy(&amp;<a class="code" href="ipsecdev_8c.html#a8">mapped_netif</a>, netif_list, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> netif)) ;
00436         netif_list-&gt;output = (<span class="keywordtype">void</span> *)<a class="code" href="ipsecdev_8c.html#a13">ipsecdev_output</a>;
00437 
00438         <span class="comment">/* setup ipsec databases/configuration */</span>
00439         <a class="code" href="ipsecdev_8c.html#a7">databases</a> = <a class="code" href="sa_8c.html#a2">ipsec_spd_load_dbs</a>(<a class="code" href="keil__1000__ah__md5_8h.html#a1">inbound_spd_config</a>, <a class="code" href="keil__1000__ah__md5_8h.html#a3">outbound_spd_config</a>, <a class="code" href="keil__1000__ah__md5_8h.html#a0">inbound_sad_config</a>, <a class="code" href="keil__1000__ah__md5_8h.html#a2">outbound_sad_config</a>) ;
00440         <span class="keywordflow">if</span> (<a class="code" href="ipsecdev_8c.html#a7">databases</a> == NULL)
00441         {
00442                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsecdev_init"</span>, -1, (<span class="stringliteral">"not able to load SPD and SA configuration for ipsec device"</span>)) ;
00443         }
00444 
00445         <a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a>-&gt;sentbytes = 0;                  <span class="comment">/* reset statistic */</span>
00446         netif-&gt;state = <a class="code" href="structipsecdev__stats.html">ipsecdev_stats</a>;                  <span class="comment">/* assign statistic */</span>
00447         netif-&gt;mtu = 1500;                                              <span class="comment">/* set MTU */</span>
00448         netif-&gt;flags = NETIF_FLAG_LINK_UP | NETIF_FLAG_BROADCAST;       <span class="comment">/* device is always connected and supports broadcasts */</span>
00449         netif-&gt;hwaddr_len = 6;                                  <span class="comment">/* set hardware address (MAC address) */</span>
00450 
00452 <span class="preprocessor">#ifdef PHYCORE167HSE </span>
00453 <span class="preprocessor"></span>        netif-&gt;hwaddr_len = 6;                                  <span class="comment">/* set hardware address (MAC address) */</span>
00454         netif-&gt;hwaddr[0] = 0xA4;
00455         netif-&gt;hwaddr[1] = 0xB4;
00456         netif-&gt;hwaddr[2] = 0xC4;
00457         netif-&gt;hwaddr[3] = 0xD4;
00458         netif-&gt;hwaddr[4] = 0xE4;
00459         netif-&gt;hwaddr[5] = 0xF4;
00460 <span class="preprocessor">#else</span>
00461 <span class="preprocessor"></span>        netif-&gt;hwaddr_len = 6;                                  <span class="comment">/* set hardware address (MAC address) */</span>
00462         netif-&gt;hwaddr[0] = 0xA3;
00463         netif-&gt;hwaddr[1] = 0xB3;
00464         netif-&gt;hwaddr[2] = 0xC3;
00465         netif-&gt;hwaddr[3] = 0xD3;
00466         netif-&gt;hwaddr[4] = 0xE3;
00467         netif-&gt;hwaddr[5] = 0xF3;
00468 <span class="preprocessor">#endif</span>
00469 <span class="preprocessor"></span>
00470         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsecdev_init"</span>, (<span class="stringliteral">"retcode = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>) );
00471         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>;
00472 }
00473 
<a name="l00481"></a><a class="code" href="ipsecdev_8c.html#a16">00481</a> <span class="keywordtype">void</span> <a class="code" href="ipsecdev_8c.html#a16">ipsec_set_tunnel</a>(<span class="keywordtype">char</span> *src, <span class="keywordtype">char</span> *dst)
00482 {
00483         <a class="code" href="ipsecdev_8c.html#a9">tunnel_src_addr</a> = <a class="code" href="util_8c.html#a1">ipsec_inet_addr</a>(src) ;
00484         <a class="code" href="ipsecdev_8c.html#a10">tunnel_dst_addr</a> = <a class="code" href="util_8c.html#a1">ipsec_inet_addr</a>(dst) ;
00485         <span class="keywordflow">return</span> ;
00486 }
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
