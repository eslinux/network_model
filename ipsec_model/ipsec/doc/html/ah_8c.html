<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ah.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
RFC2402 - IP Authentication Header (AH). 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Christian Scheurer &lt;<a href="http://www.christianscheurer.ch">http://www.christianscheurer.ch</a>&gt;</dd></dl>
<b>OUTLINE:</b> The AH functions are used to authenticate IPsec traffic.<p>
<b>IMPLEMENTATION:</b> All functions work in-place (i.g. manipulate directly the original packet without copying any data). For the encapsulation routine, the caller must ensure that space for the new IP and AH header are available in front of the packet:<p>
<pre><div>
                                  | pointer to packet header
     ____________________________\/_____________________________
    |          ¦       ¦         ¦                              |
    | Ethernet ¦ newIP ¦ AH, ICV ¦   original (inner) packet    |
    |__________¦_______¦_________¦______________________________|
    ¦                            ¦
    ¦&lt;-- room for new headers --&gt;¦
  </pre></div><p>
This document is part of <em>embedded IPsec<br>
 Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne<br>
 All rights reserved.<br>
 This file contains code from the OpenSSL Project<br>
 portions Copyright (c) 1998-2003 OpenSSL (www.openssl.org) </em><hr>

<p>
Definition in file <a class="el" href="ah_8c-source.html">ah.c</a>.
<p>
<code>#include &lt;string.h&gt;</code><br>
<code>#include "<a class="el" href="ipsec_8h-source.html">ipsec/ipsec.h</a>"</code><br>
<code>#include "<a class="el" href="util_8h-source.html">ipsec/util.h</a>"</code><br>
<code>#include "<a class="el" href="debug_8h-source.html">ipsec/debug.h</a>"</code><br>
<code>#include "<a class="el" href="sa_8h-source.html">ipsec/sa.h</a>"</code><br>
<code>#include "<a class="el" href="md5_8h-source.html">ipsec/md5.h</a>"</code><br>
<code>#include "<a class="el" href="sha1_8h-source.html">ipsec/sha1.h</a>"</code><br>
<code>#include "<a class="el" href="ah_8h-source.html">ipsec/ah.h</a>"</code><br>

<p>
<a href="ah_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ah_8c.html#a2">ipsec_ah_check</a> (<a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *outer_packet, int *payload_offset, int *payload_size, <a class="el" href="structsa__entry__struct.html">sad_entry</a> *sa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ah_8c.html#a3">ipsec_ah_encapsulate</a> (<a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *inner_packet, int *payload_offset, int *payload_size, <a class="el" href="structsa__entry__struct.html">sad_entry</a> *sa, <a class="el" href="types_8h.html#a4">__u32</a> src, <a class="el" href="types_8h.html#a4">__u32</a> dst)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ah_8c.html#a0">ipsec_ah_bitmap</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ah_8c.html#a1">ipsec_ah_lastSeq</a> = 0</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="ah.c::ipsec_ah_check" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int ipsec_ah_check </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>outer_packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structsa__entry__struct.html">sad_entry</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>sa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Checks AH header and ICV (RFC 2402). Mutable fields of the outer IP header are set to zero prior to the ICV calculation.<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>Extend function to support transport mode </dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>outer_packet</em>&nbsp;</td><td>pointer used to access the (outer) IP packet which hast to be checked </td></tr>
    <tr><td valign=top><em>payload_offset</em>&nbsp;</td><td>pointer used to return offset of inner (original) IP packet relative to the start of the outer header </td></tr>
    <tr><td valign=top><em>payload_size</em>&nbsp;</td><td>pointer used to return total size of the inner (original) IP packet </td></tr>
    <tr><td valign=top><em>sa</em>&nbsp;</td><td>pointer to security association holding the secret authentication key</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>IPSEC_STATUS_SUCCESS packet could be authenticated <p>
IPSEC_STATUS_FAILURE packet is corrupted or ICV does not match <p>
IPSEC_STATUS_NOT_IMPLEMENTED invalid mode (only IPSEC_TUNNEL mode is implemented) </dd></dl>

<p>
Definition at line <a class="el" href="ah_8c-source.html#l00100">100</a> of file <a class="el" href="ah_8c-source.html">ah.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ah.c::ipsec_ah_encapsulate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int ipsec_ah_encapsulate </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>inner_packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structsa__entry__struct.html">sad_entry</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>sa</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>src</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dst</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Adds AH and outer IP header, calculates ICV (RFC 2402).<p>
<dl compact><dt><b>Warning:</b></dt><dd>Attention: this function requires room (IPSEC_AH_HDR_SIZE + IPSEC_AUTH_ICV + IPSEC_MIN_IPHDR_SIZE) in front of the inner_packet pointer to add outer IP header and AH header. Depending on the TCP/IP stack implementation, additional space for the Link layer (Ethernet header) should be added).</dd></dl>
<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>Extend function to support transport mode </dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>inner_packet</em>&nbsp;</td><td>pointer used to access the (outer) IP packet which hast to be checked </td></tr>
    <tr><td valign=top><em>payload_offset</em>&nbsp;</td><td>pointer used to return offset of inner (original) IP packet relative to the start of the outer header </td></tr>
    <tr><td valign=top><em>payload_size</em>&nbsp;</td><td>pointer used to return total size of the inner (original) IP packet </td></tr>
    <tr><td valign=top><em>src</em>&nbsp;</td><td>IP address of the local tunnel start point (external IP address) </td></tr>
    <tr><td valign=top><em>dst</em>&nbsp;</td><td>IP address of the remote tunnel end point (external IP address) </td></tr>
    <tr><td valign=top><em>sa</em>&nbsp;</td><td>pointer to security association holding the secret authentication key </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>IPSEC_STATUS_SUCCESS packet could be authenticated <p>
IPSEC_STATUS_FAILURE packet is corrupted or ICV does not match <p>
IPSEC_STATUS_NOT_IMPLEMENTED invalid mode (only IPSEC_TUNNEL mode is implemented)</dd></dl>
<dl compact><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>fix TTL update and checksum calculation <p>
id must be generated properly and incremented</dd></dl>

<p>
Definition at line <a class="el" href="ah_8c-source.html#l00214">214</a> of file <a class="el" href="ah_8c-source.html">ah.c</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="ah.c::ipsec_ah_bitmap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a4">__u32</a> <a class="el" href="ah_8h.html#a2">ipsec_ah_bitmap</a> = 0
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
save session state to detect replays - must be 32 bits. Note: must be initialized with zero (0x00000000) when a new SA is established! 
<p>
Definition at line <a class="el" href="ah_8c-source.html#l00076">76</a> of file <a class="el" href="ah_8c-source.html">ah.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ah.c::ipsec_ah_lastSeq" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="types_8h.html#a4">__u32</a> <a class="el" href="ah_8h.html#a3">ipsec_ah_lastSeq</a> = 0
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
save session state to detect replays Note: must be initialized with zero (0x00000000) when a new SA is established! 
<p>
Definition at line <a class="el" href="ah_8c-source.html#l00079">79</a> of file <a class="el" href="ah_8c-source.html">ah.c</a>.    </td>
  </tr>
</table>
	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
