<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>md5.c</h1><a href="md5_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec       </span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00055 <span class="preprocessor">#include &lt;string.h&gt;</span>
00056 
00057 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">ipsec/md5.h</a>"</span>
00058 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00059 
<a name="l00060"></a><a class="code" href="md5_8c.html#a18">00060</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="md5_8c.html#a18">MD5</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *d, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *md)
00061 {
00062         <a class="code" href="structMD5state__st.html">MD5_CTX</a> c;
00063         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> m[<a class="code" href="md5_8h.html#a3">MD5_DIGEST_LENGTH</a>];
00064 
00065         <span class="keywordflow">if</span> (md == NULL) md=m;
00066         <a class="code" href="md5_8c.html#a19">MD5_Init</a>(&amp;c);
00067         <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;c,d,n);
00068         <a class="code" href="md5_8c.html#a24">MD5_Final</a>(md,&amp;c);
00069         memset(&amp;c,0,<span class="keyword">sizeof</span>(c)); <span class="comment">/* security consideration */</span>
00070         <span class="keywordflow">return</span>(md);
00071 }
00072 
00073 
<a name="l00074"></a><a class="code" href="md5_8c.html#a0">00074</a> <span class="preprocessor">#define INIT_DATA_A (unsigned long)0x67452301L</span>
<a name="l00075"></a><a class="code" href="md5_8c.html#a1">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_B (unsigned long)0xefcdab89L</span>
<a name="l00076"></a><a class="code" href="md5_8c.html#a2">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_C (unsigned long)0x98badcfeL</span>
<a name="l00077"></a><a class="code" href="md5_8c.html#a3">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_DATA_D (unsigned long)0x10325476L</span>
00078 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="md5_8c.html#a19">00079</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a19">MD5_Init</a>(<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c)
00080 {
00081         c-&gt;<a class="code" href="structMD5state__st.html#o0">A</a>=<a class="code" href="md5_8c.html#a0">INIT_DATA_A</a>;
00082         c-&gt;<a class="code" href="structMD5state__st.html#o1">B</a>=<a class="code" href="md5_8c.html#a1">INIT_DATA_B</a>;
00083         c-&gt;<a class="code" href="structMD5state__st.html#o2">C</a>=<a class="code" href="md5_8c.html#a2">INIT_DATA_C</a>;
00084         c-&gt;<a class="code" href="structMD5state__st.html#o3">D</a>=<a class="code" href="md5_8c.html#a3">INIT_DATA_D</a>;
00085         c-&gt;<a class="code" href="structMD5state__st.html#o4">Nl</a>=0;
00086         c-&gt;<a class="code" href="structMD5state__st.html#o5">Nh</a>=0;
00087         c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>=0;
00088 }
00089 
00090 
00091 <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *p,<span class="keywordtype">int</span> num);
00092 <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a21">md5_block_data_order</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *p,<span class="keywordtype">int</span> num);
00093 
00094 <span class="comment">/*</span>
00095 <span class="comment"> * Engage compiler specific rotate intrinsic function if available.</span>
00096 <span class="comment"> */</span>
00097 
00098 <span class="preprocessor">#undef ROTATE</span>
00099 <span class="preprocessor"></span>
00100 <span class="comment">// *** Keil C166 ***</span>
00101 <span class="preprocessor">#ifdef __C166__</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#include &lt;intrins.h&gt;</span>
00103 <span class="preprocessor">#define ROTATE(a,n)     _lrol_(a,n)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106 
00107 <span class="preprocessor">#ifdef ROTATE</span>
00108 <span class="preprocessor"></span><span class="comment">/* 5 instructions with rotate instruction, else 9 */</span>
00109 <span class="preprocessor">#define REVERSE_FETCH32(a,l)    (                                       \</span>
00110 <span class="preprocessor">                l=*(const MD5_LONG *)(a),                               \</span>
00111 <span class="preprocessor">                ((ROTATE(l,8)&amp;0x00FF00FF)|(ROTATE((l&amp;0x00FF00FF),24)))  \</span>
00112 <span class="preprocessor">                                )</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00114 <span class="preprocessor"></span>                                        
00115 
<a name="l00116"></a><a class="code" href="md5_8c.html#a4">00116</a> <span class="preprocessor">#define HOST_c2l(c,l)   (l =(((unsigned long)(*((c)++)))    ),          \</span>
00117 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))&lt;&lt; 8),          \</span>
00118 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))&lt;&lt;16),          \</span>
00119 <span class="preprocessor">                         l|=(((unsigned long)(*((c)++)))&lt;&lt;24),          \</span>
00120 <span class="preprocessor">                         l)</span>
<a name="l00121"></a><a class="code" href="md5_8c.html#a5">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_p_c2l(c,l,n)       {                                       \</span>
00122 <span class="preprocessor">                        switch (n) {                                    \</span>
00123 <span class="preprocessor">                        case 0: l =((unsigned long)(*((c)++)));         \</span>
00124 <span class="preprocessor">                        case 1: l|=((unsigned long)(*((c)++)))&lt;&lt; 8;     \</span>
00125 <span class="preprocessor">                        case 2: l|=((unsigned long)(*((c)++)))&lt;&lt;16;     \</span>
00126 <span class="preprocessor">                        case 3: l|=((unsigned long)(*((c)++)))&lt;&lt;24;     \</span>
00127 <span class="preprocessor">                                } }</span>
<a name="l00128"></a><a class="code" href="md5_8c.html#a6">00128</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_p_c2l_p(c,l,sc,len) {                                      \</span>
00129 <span class="preprocessor">                        switch (sc) {                                   \</span>
00130 <span class="preprocessor">                        case 0: l =((unsigned long)(*((c)++)));         \</span>
00131 <span class="preprocessor">                                if (--len == 0) break;                  \</span>
00132 <span class="preprocessor">                        case 1: l|=((unsigned long)(*((c)++)))&lt;&lt; 8;     \</span>
00133 <span class="preprocessor">                                if (--len == 0) break;                  \</span>
00134 <span class="preprocessor">                        case 2: l|=((unsigned long)(*((c)++)))&lt;&lt;16;     \</span>
00135 <span class="preprocessor">                                } }</span>
00136 <span class="preprocessor"></span><span class="comment">/* NOTE the pointer is not incremented at the end of this */</span>
<a name="l00137"></a><a class="code" href="md5_8c.html#a7">00137</a> <span class="preprocessor">#define HOST_c2l_p(c,l,n)       {                                       \</span>
00138 <span class="preprocessor">                        l=0; (c)+=n;                                    \</span>
00139 <span class="preprocessor">                        switch (n) {                                    \</span>
00140 <span class="preprocessor">                        case 3: l =((unsigned long)(*(--(c))))&lt;&lt;16;     \</span>
00141 <span class="preprocessor">                        case 2: l|=((unsigned long)(*(--(c))))&lt;&lt; 8;     \</span>
00142 <span class="preprocessor">                        case 1: l|=((unsigned long)(*(--(c))));         \</span>
00143 <span class="preprocessor">                                } }</span>
<a name="l00144"></a><a class="code" href="md5_8c.html#a8">00144</a> <span class="preprocessor"></span><span class="preprocessor">#define HOST_l2c(l,c)   (*((c)++)=(unsigned char)(((l)    )&amp;0xff),      \</span>
00145 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt; 8)&amp;0xff),      \</span>
00146 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;16)&amp;0xff),      \</span>
00147 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;24)&amp;0xff),      \</span>
00148 <span class="preprocessor">                         l)</span>
00149 <span class="preprocessor"></span>
00150 
00151 <span class="comment">/*</span>
00152 <span class="comment"> * Time for some action:-)</span>
00153 <span class="comment"> */</span>
00154 
<a name="l00155"></a><a class="code" href="md5_8c.html#a22">00155</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a22">MD5_Update</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data_, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len)
00156 {
00157         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data=data_;
00158         <a class="code" href="md5_8h.html#a0">MD5_LONG</a> * p;
00159         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l;
00160         <span class="keywordtype">int</span> sw,sc,ew,ec;
00161 
00162         <span class="keywordflow">if</span> (len==0) <span class="keywordflow">return</span>;
00163 
00164         l=(c-&gt;<a class="code" href="structMD5state__st.html#o4">Nl</a>+(len&lt;&lt;3))&amp;0xffffffffL;
00165         <span class="comment">/* 95-05-24 eay Fixed a bug with the overflow handling, thanks to</span>
00166 <span class="comment">         * Wei Dai &lt;weidai@eskimo.com&gt; for pointing it out. */</span>
00167         <span class="keywordflow">if</span> (l &lt; c-&gt;<a class="code" href="structMD5state__st.html#o4">Nl</a>) <span class="comment">/* overflow */</span>
00168                 c-&gt;<a class="code" href="structMD5state__st.html#o5">Nh</a>++;
00169         c-&gt;<a class="code" href="structMD5state__st.html#o5">Nh</a>+=(len&gt;&gt;29);
00170         c-&gt;<a class="code" href="structMD5state__st.html#o4">Nl</a>=l;
00171 
00172         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a> != 0)
00173                 {
00174                 p=c-&gt;<a class="code" href="structMD5state__st.html#o6">data</a>;
00175                 sw=c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&gt;&gt;2;
00176                 sc=c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&amp;0x03;
00177 
00178                 <span class="keywordflow">if</span> ((c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>+len) &gt;= <a class="code" href="md5_8h.html#a1">MD5_CBLOCK</a>)
00179                         {
00180                         l=p[sw]; <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(data,l,sc); p[sw++]=l;
00181                         <span class="keywordflow">for</span> (; sw&lt;<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>; sw++)
00182                                 {
00183                                 <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); p[sw]=l;
00184                                 }
00185                         <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (c,p,1);
00186                         len-=(<a class="code" href="md5_8h.html#a1">MD5_CBLOCK</a>-c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>);
00187                         c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>=0;
00188                         <span class="comment">/* drop through and do the rest */</span>
00189                         }
00190                 <span class="keywordflow">else</span>
00191                         {
00192                         c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>+=len;
00193                         <span class="keywordflow">if</span> ((sc+len) &lt; 4) <span class="comment">/* ugly, add char's to a word */</span>
00194                                 {
00195                                 l=p[sw]; <a class="code" href="md5_8c.html#a6">HOST_p_c2l_p</a>(data,l,sc,len); p[sw]=l;
00196                                 }
00197                         <span class="keywordflow">else</span>
00198                                 {
00199                                 ew=(c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&gt;&gt;2);
00200                                 ec=(c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&amp;0x03);
00201                                 l=p[sw]; <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(data,l,sc); p[sw++]=l;
00202                                 <span class="keywordflow">for</span> (; sw &lt; ew; sw++)
00203                                         {
00204                                         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); p[sw]=l;
00205                                         }
00206                                 <span class="keywordflow">if</span> (ec)
00207                                         {
00208                                         <a class="code" href="md5_8c.html#a7">HOST_c2l_p</a>(data,l,ec); p[sw]=l;
00209                                         }
00210                                 }
00211                         <span class="keywordflow">return</span>;
00212                         }
00213                 }
00214 
00215         sw=(<span class="keywordtype">int</span>) (len/<a class="code" href="md5_8h.html#a1">MD5_CBLOCK</a>);
00216         <span class="keywordflow">if</span> (sw &gt; 0)
00217                 {
00218                 <span class="keywordflow">if</span> ((((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)data)%4) == 0)
00219                         {
00220                         <span class="comment">/* data is properly aligned so that we can cast it: */</span>
00221                         <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (c,(<a class="code" href="md5_8h.html#a0">MD5_LONG</a> *)data,sw);
00222                         sw*=<a class="code" href="md5_8h.html#a1">MD5_CBLOCK</a>;
00223                         data+=sw;
00224                         len-=sw;
00225                         }
00226                 <span class="keywordflow">else</span>
00227                         {
00228                         <a class="code" href="md5_8c.html#a21">md5_block_data_order</a>(c,data,sw);
00229                         sw*=<a class="code" href="md5_8h.html#a1">MD5_CBLOCK</a>;
00230                         data+=sw;
00231                         len-=sw;
00232                         }
00233                 }
00234 
00235         <span class="keywordflow">if</span> (len!=0)
00236                 {
00237                 p = c-&gt;<a class="code" href="structMD5state__st.html#o6">data</a>;
00238                 c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a> = (<span class="keywordtype">int</span>) len;
00239                 ew=(<span class="keywordtype">int</span>) (len&gt;&gt;2);      <span class="comment">/* words to copy */</span>
00240                 ec=(<span class="keywordtype">int</span>) (len&amp;0x03);
00241                 <span class="keywordflow">for</span> (; ew; ew--,p++)
00242                         {
00243                         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); *p=l;
00244                         }
00245                 <a class="code" href="md5_8c.html#a7">HOST_c2l_p</a>(data,l,ec);
00246                 *p=l;
00247                 }
00248 }
00249 
00250 
<a name="l00251"></a><a class="code" href="md5_8c.html#a23">00251</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a23">MD5_Transform</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data)
00252 {
00253         <span class="keywordflow">if</span> ((((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)data)%4) == 0)
00254                 <span class="comment">/* data is properly aligned so that we can cast it: */</span>
00255                 <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (c,(<a class="code" href="md5_8h.html#a0">MD5_LONG</a> *)data,1);
00256         <span class="keywordflow">else</span>
00257         <a class="code" href="md5_8c.html#a21">md5_block_data_order</a> (c,data,1);
00258 }
00259 
00260 
<a name="l00261"></a><a class="code" href="md5_8c.html#a24">00261</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a24">MD5_Final</a> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *md, <a class="code" href="structMD5state__st.html">MD5_CTX</a> *c)
00262 {
00263         <a class="code" href="md5_8h.html#a0">MD5_LONG</a> *p;
00264         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l;
00265         <span class="keywordtype">int</span> i,j;
00266         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> end[4]={0x80,0x00,0x00,0x00};
00267         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp=end;
00268 
00269         <span class="comment">/* c-&gt;num should definitly have room for at least one more byte. */</span>
00270         p=c-&gt;<a class="code" href="structMD5state__st.html#o6">data</a>;
00271         i=c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&gt;&gt;2;
00272         j=c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>&amp;0x03;
00273 
00274         l = (j==0) ? 0 : p[i];
00275 
00276         <a class="code" href="md5_8c.html#a5">HOST_p_c2l</a>(cp,l,j); p[i++]=l; <span class="comment">/* i is the next 'undefined word' */</span>
00277 
00278         <span class="keywordflow">if</span> (i&gt;(<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>-2)) <span class="comment">/* save room for Nl and Nh */</span>
00279                 {
00280                 <span class="keywordflow">if</span> (i&lt;<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>) p[i]=0;
00281                 <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (c,p,1);
00282                 i=0;
00283                 }
00284         <span class="keywordflow">for</span> (; i&lt;(<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>-2); i++)
00285                 p[i]=0;
00286 
00287         p[<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>-2]=c-&gt;<a class="code" href="structMD5state__st.html#o4">Nl</a>;
00288         p[<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>-1]=c-&gt;<a class="code" href="structMD5state__st.html#o5">Nh</a>;
00289         <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (c,p,1);
00290 
00291 
00292         <span class="comment">// HASH_MAKE_STRING(c,md);</span>
00293         <span class="keywordflow">do</span> {    
00294         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ll;               
00295         ll=(c)-&gt;A; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));   
00296         ll=(c)-&gt;B; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));   
00297         ll=(c)-&gt;C; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));   
00298         ll=(c)-&gt;D; <a class="code" href="md5_8c.html#a8">HOST_l2c</a>(ll,(md));   
00299         } <span class="keywordflow">while</span> (0);
00300 
00301 
00302         c-&gt;<a class="code" href="structMD5state__st.html#o7">num</a>=0;
00303         <span class="comment">/* clear stuff, HASH_BLOCK may be leaving some stuff on the stack</span>
00304 <span class="comment">         * but I'm not worried :-)</span>
00305 <span class="comment">        memset((void *)c,0,sizeof(MD5_CTX));</span>
00306 <span class="comment">         */</span>
00307 }
00308 
00309 
<a name="l00310"></a><a class="code" href="md5_8c.html#a9">00310</a> <span class="preprocessor">#define F(b,c,d)        ((((c) ^ (d)) &amp; (b)) ^ (d))</span>
<a name="l00311"></a><a class="code" href="md5_8c.html#a10">00311</a> <span class="preprocessor"></span><span class="preprocessor">#define G(b,c,d)        ((((b) ^ (c)) &amp; (d)) ^ (c))</span>
<a name="l00312"></a><a class="code" href="md5_8c.html#a11">00312</a> <span class="preprocessor"></span><span class="preprocessor">#define H(b,c,d)        ((b) ^ (c) ^ (d))</span>
<a name="l00313"></a><a class="code" href="md5_8c.html#a12">00313</a> <span class="preprocessor"></span><span class="preprocessor">#define I(b,c,d)        (((~(d)) | (b)) ^ (c))</span>
00314 <span class="preprocessor"></span>
<a name="l00315"></a><a class="code" href="md5_8c.html#a13">00315</a> <span class="preprocessor">#define R0(a,b,c,d,k,s,t) { \</span>
00316 <span class="preprocessor">        a+=((k)+(t)+F((b),(c),(d))); \</span>
00317 <span class="preprocessor">        a=ROTATE(a,s); \</span>
00318 <span class="preprocessor">        a+=b; };\</span>
00319 <span class="preprocessor"></span>
<a name="l00320"></a><a class="code" href="md5_8c.html#a14">00320</a> <span class="preprocessor"></span><span class="preprocessor">#define R1(a,b,c,d,k,s,t) { \</span>
00321 <span class="preprocessor">        a+=((k)+(t)+G((b),(c),(d))); \</span>
00322 <span class="preprocessor">        a=ROTATE(a,s); \</span>
00323 <span class="preprocessor">        a+=b; };</span>
00324 <span class="preprocessor"></span>
<a name="l00325"></a><a class="code" href="md5_8c.html#a15">00325</a> <span class="preprocessor">#define R2(a,b,c,d,k,s,t) { \</span>
00326 <span class="preprocessor">        a+=((k)+(t)+H((b),(c),(d))); \</span>
00327 <span class="preprocessor">        a=ROTATE(a,s); \</span>
00328 <span class="preprocessor">        a+=b; };</span>
00329 <span class="preprocessor"></span>
<a name="l00330"></a><a class="code" href="md5_8c.html#a16">00330</a> <span class="preprocessor">#define R3(a,b,c,d,k,s,t) { \</span>
00331 <span class="preprocessor">        a+=((k)+(t)+I((b),(c),(d))); \</span>
00332 <span class="preprocessor">        a=ROTATE(a,s); \</span>
00333 <span class="preprocessor">        a+=b; };</span>
00334 <span class="preprocessor"></span>
00335 
00336 
<a name="l00337"></a><a class="code" href="md5_8c.html#a20">00337</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a20">md5_block_host_order</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> num)
00338 {
00339         <span class="keyword">const</span> <a class="code" href="md5_8h.html#a0">MD5_LONG</a> *X=data;
00340         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> A,B,C,D;
00341         <span class="comment">/*</span>
00342 <span class="comment">         * In case you wonder why A-D are declared as long and not</span>
00343 <span class="comment">         * as MD5_LONG. Doing so results in slight performance</span>
00344 <span class="comment">         * boost on LP64 architectures. The catch is we don't</span>
00345 <span class="comment">         * really care if 32 MSBs of a 64-bit register get polluted</span>
00346 <span class="comment">         * with eventual overflows as we *save* only 32 LSBs in</span>
00347 <span class="comment">         * *either* case. Now declaring 'em long excuses the compiler</span>
00348 <span class="comment">         * from keeping 32 MSBs zeroed resulting in 13% performance</span>
00349 <span class="comment">         * improvement under SPARC Solaris7/64 and 5% under AlphaLinux.</span>
00350 <span class="comment">         * Well, to be honest it should say that this *prevents* </span>
00351 <span class="comment">         * performance degradation.</span>
00352 <span class="comment">         *</span>
00353 <span class="comment">         *                              &lt;appro@fy.chalmers.se&gt;</span>
00354 <span class="comment">         */</span>
00355 
00356         A=c-&gt;<a class="code" href="structMD5state__st.html#o0">A</a>;
00357         B=c-&gt;<a class="code" href="structMD5state__st.html#o1">B</a>;
00358         C=c-&gt;<a class="code" href="structMD5state__st.html#o2">C</a>;
00359         D=c-&gt;<a class="code" href="structMD5state__st.html#o3">D</a>;
00360 
00361         <span class="keywordflow">for</span> (;num--;X+=<a class="code" href="md5_8h.html#a2">MD5_LBLOCK</a>)
00362                 {
00363         <span class="comment">/* Round 0 */</span>
00364         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X[ 0], 7,0xd76aa478L);
00365         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X[ 1],12,0xe8c7b756L);
00366         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X[ 2],17,0x242070dbL);
00367         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X[ 3],22,0xc1bdceeeL);
00368         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X[ 4], 7,0xf57c0fafL);
00369         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X[ 5],12,0x4787c62aL);
00370         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X[ 6],17,0xa8304613L);
00371         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X[ 7],22,0xfd469501L);
00372         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X[ 8], 7,0x698098d8L);
00373         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X[ 9],12,0x8b44f7afL);
00374         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X[10],17,0xffff5bb1L);
00375         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X[11],22,0x895cd7beL);
00376         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X[12], 7,0x6b901122L);
00377         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X[13],12,0xfd987193L);
00378         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X[14],17,0xa679438eL);
00379         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X[15],22,0x49b40821L);
00380         <span class="comment">/* Round 1 */</span>
00381         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X[ 1], 5,0xf61e2562L);
00382         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X[ 6], 9,0xc040b340L);
00383         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X[11],14,0x265e5a51L);
00384         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X[ 0],20,0xe9b6c7aaL);
00385         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X[ 5], 5,0xd62f105dL);
00386         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X[10], 9,0x02441453L);
00387         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X[15],14,0xd8a1e681L);
00388         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X[ 4],20,0xe7d3fbc8L);
00389         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X[ 9], 5,0x21e1cde6L);
00390         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X[14], 9,0xc33707d6L);
00391         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X[ 3],14,0xf4d50d87L);
00392         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X[ 8],20,0x455a14edL);
00393         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X[13], 5,0xa9e3e905L);
00394         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X[ 2], 9,0xfcefa3f8L);
00395         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X[ 7],14,0x676f02d9L);
00396         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X[12],20,0x8d2a4c8aL);
00397         <span class="comment">/* Round 2 */</span>
00398         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X[ 5], 4,0xfffa3942L);
00399         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X[ 8],11,0x8771f681L);
00400         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X[11],16,0x6d9d6122L);
00401         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X[14],23,0xfde5380cL);
00402         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X[ 1], 4,0xa4beea44L);
00403         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X[ 4],11,0x4bdecfa9L);
00404         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X[ 7],16,0xf6bb4b60L);
00405         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X[10],23,0xbebfbc70L);
00406         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X[13], 4,0x289b7ec6L);
00407         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X[ 0],11,0xeaa127faL);
00408         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X[ 3],16,0xd4ef3085L);
00409         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X[ 6],23,0x04881d05L);
00410         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X[ 9], 4,0xd9d4d039L);
00411         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X[12],11,0xe6db99e5L);
00412         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X[15],16,0x1fa27cf8L);
00413         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X[ 2],23,0xc4ac5665L);
00414         <span class="comment">/* Round 3 */</span>
00415         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X[ 0], 6,0xf4292244L);
00416         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X[ 7],10,0x432aff97L);
00417         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X[14],15,0xab9423a7L);
00418         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X[ 5],21,0xfc93a039L);
00419         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X[12], 6,0x655b59c3L);
00420         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X[ 3],10,0x8f0ccc92L);
00421         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X[10],15,0xffeff47dL);
00422         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X[ 1],21,0x85845dd1L);
00423         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X[ 8], 6,0x6fa87e4fL);
00424         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X[15],10,0xfe2ce6e0L);
00425         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X[ 6],15,0xa3014314L);
00426         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X[13],21,0x4e0811a1L);
00427         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X[ 4], 6,0xf7537e82L);
00428         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X[11],10,0xbd3af235L);
00429         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X[ 2],15,0x2ad7d2bbL);
00430         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X[ 9],21,0xeb86d391L);
00431 
00432         A = c-&gt;<a class="code" href="structMD5state__st.html#o0">A</a> += A;
00433         B = c-&gt;<a class="code" href="structMD5state__st.html#o1">B</a> += B;
00434         C = c-&gt;<a class="code" href="structMD5state__st.html#o2">C</a> += C;
00435         D = c-&gt;<a class="code" href="structMD5state__st.html#o3">D</a> += D;
00436                 }
00437 }
00438 
00439 
<a name="l00440"></a><a class="code" href="md5_8c.html#a21">00440</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a21">md5_block_data_order</a> (<a class="code" href="structMD5state__st.html">MD5_CTX</a> *c, <span class="keyword">const</span> <span class="keywordtype">void</span> *data_, <span class="keywordtype">int</span> num)
00441 {
00442         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data=data_;
00443         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> A,B,C,D,l;
00444         <span class="comment">/*</span>
00445 <span class="comment">         * In case you wonder why A-D are declared as long and not</span>
00446 <span class="comment">         * as MD5_LONG. Doing so results in slight performance</span>
00447 <span class="comment">         * boost on LP64 architectures. The catch is we don't</span>
00448 <span class="comment">         * really care if 32 MSBs of a 64-bit register get polluted</span>
00449 <span class="comment">         * with eventual overflows as we *save* only 32 LSBs in</span>
00450 <span class="comment">         * *either* case. Now declaring 'em long excuses the compiler</span>
00451 <span class="comment">         * from keeping 32 MSBs zeroed resulting in 13% performance</span>
00452 <span class="comment">         * improvement under SPARC Solaris7/64 and 5% under AlphaLinux.</span>
00453 <span class="comment">         * Well, to be honest it should say that this *prevents* </span>
00454 <span class="comment">         * performance degradation.</span>
00455 <span class="comment">         *</span>
00456 <span class="comment">         *                              &lt;appro@fy.chalmers.se&gt;</span>
00457 <span class="comment">         */</span>
00458         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   XX0, XX1, XX2, XX3, XX4, XX5, XX6, XX7,
00459                         XX8, XX9,XX10,XX11,XX12,XX13,XX14,XX15;
00460 <span class="preprocessor">#define X(i)    XX##i</span>
00461 <span class="preprocessor"></span>
00462         A=c-&gt;<a class="code" href="structMD5state__st.html#o0">A</a>;
00463         B=c-&gt;<a class="code" href="structMD5state__st.html#o1">B</a>;
00464         C=c-&gt;<a class="code" href="structMD5state__st.html#o2">C</a>;
00465         D=c-&gt;<a class="code" href="structMD5state__st.html#o3">D</a>;
00466 
00467         <span class="keywordflow">for</span> (;num--;)
00468                 {
00469         <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 0)=l;              <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 1)=l;
00470         <span class="comment">/* Round 0 */</span>
00471         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X( 0), 7,0xd76aa478L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 2)=l;
00472         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X( 1),12,0xe8c7b756L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 3)=l;
00473         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X( 2),17,0x242070dbL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 4)=l;
00474         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X( 3),22,0xc1bdceeeL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 5)=l;
00475         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X( 4), 7,0xf57c0fafL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 6)=l;
00476         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X( 5),12,0x4787c62aL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 7)=l;
00477         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X( 6),17,0xa8304613L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 8)=l;
00478         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X( 7),22,0xfd469501L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X( 9)=l;
00479         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X( 8), 7,0x698098d8L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(10)=l;
00480         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X( 9),12,0x8b44f7afL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(11)=l;
00481         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X(10),17,0xffff5bb1L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(12)=l;
00482         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X(11),22,0x895cd7beL);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(13)=l;
00483         <a class="code" href="md5_8c.html#a13">R0</a>(A,B,C,D,X(12), 7,0x6b901122L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(14)=l;
00484         <a class="code" href="md5_8c.html#a13">R0</a>(D,A,B,C,X(13),12,0xfd987193L);       <a class="code" href="md5_8c.html#a4">HOST_c2l</a>(data,l); X(15)=l;
00485         <a class="code" href="md5_8c.html#a13">R0</a>(C,D,A,B,X(14),17,0xa679438eL);
00486         <a class="code" href="md5_8c.html#a13">R0</a>(B,C,D,A,X(15),22,0x49b40821L);
00487         <span class="comment">/* Round 1 */</span>
00488         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X( 1), 5,0xf61e2562L);
00489         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X( 6), 9,0xc040b340L);
00490         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X(11),14,0x265e5a51L);
00491         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X( 0),20,0xe9b6c7aaL);
00492         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X( 5), 5,0xd62f105dL);
00493         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X(10), 9,0x02441453L);
00494         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X(15),14,0xd8a1e681L);
00495         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X( 4),20,0xe7d3fbc8L);
00496         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X( 9), 5,0x21e1cde6L);
00497         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X(14), 9,0xc33707d6L);
00498         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X( 3),14,0xf4d50d87L);
00499         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X( 8),20,0x455a14edL);
00500         <a class="code" href="md5_8c.html#a14">R1</a>(A,B,C,D,X(13), 5,0xa9e3e905L);
00501         <a class="code" href="md5_8c.html#a14">R1</a>(D,A,B,C,X( 2), 9,0xfcefa3f8L);
00502         <a class="code" href="md5_8c.html#a14">R1</a>(C,D,A,B,X( 7),14,0x676f02d9L);
00503         <a class="code" href="md5_8c.html#a14">R1</a>(B,C,D,A,X(12),20,0x8d2a4c8aL);
00504         <span class="comment">/* Round 2 */</span>
00505         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X( 5), 4,0xfffa3942L);
00506         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X( 8),11,0x8771f681L);
00507         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X(11),16,0x6d9d6122L);
00508         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X(14),23,0xfde5380cL);
00509         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X( 1), 4,0xa4beea44L);
00510         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X( 4),11,0x4bdecfa9L);
00511         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X( 7),16,0xf6bb4b60L);
00512         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X(10),23,0xbebfbc70L);
00513         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X(13), 4,0x289b7ec6L);
00514         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X( 0),11,0xeaa127faL);
00515         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X( 3),16,0xd4ef3085L);
00516         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X( 6),23,0x04881d05L);
00517         <a class="code" href="md5_8c.html#a15">R2</a>(A,B,C,D,X( 9), 4,0xd9d4d039L);
00518         <a class="code" href="md5_8c.html#a15">R2</a>(D,A,B,C,X(12),11,0xe6db99e5L);
00519         <a class="code" href="md5_8c.html#a15">R2</a>(C,D,A,B,X(15),16,0x1fa27cf8L);
00520         <a class="code" href="md5_8c.html#a15">R2</a>(B,C,D,A,X( 2),23,0xc4ac5665L);
00521         <span class="comment">/* Round 3 */</span>
00522         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X( 0), 6,0xf4292244L);
00523         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X( 7),10,0x432aff97L);
00524         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X(14),15,0xab9423a7L);
00525         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X( 5),21,0xfc93a039L);
00526         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X(12), 6,0x655b59c3L);
00527         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X( 3),10,0x8f0ccc92L);
00528         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X(10),15,0xffeff47dL);
00529         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X( 1),21,0x85845dd1L);
00530         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X( 8), 6,0x6fa87e4fL);
00531         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X(15),10,0xfe2ce6e0L);
00532         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X( 6),15,0xa3014314L);
00533         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X(13),21,0x4e0811a1L);
00534         <a class="code" href="md5_8c.html#a16">R3</a>(A,B,C,D,X( 4), 6,0xf7537e82L);
00535         <a class="code" href="md5_8c.html#a16">R3</a>(D,A,B,C,X(11),10,0xbd3af235L);
00536         <a class="code" href="md5_8c.html#a16">R3</a>(C,D,A,B,X( 2),15,0x2ad7d2bbL);
00537         <a class="code" href="md5_8c.html#a16">R3</a>(B,C,D,A,X( 9),21,0xeb86d391L);
00538 
00539         A = c-&gt;<a class="code" href="structMD5state__st.html#o0">A</a> += A;
00540         B = c-&gt;<a class="code" href="structMD5state__st.html#o1">B</a> += B;
00541         C = c-&gt;<a class="code" href="structMD5state__st.html#o2">C</a> += C;
00542         D = c-&gt;<a class="code" href="structMD5state__st.html#o3">D</a> += D;
00543                 }
00544 }
00545 
00546 
00547 
<a name="l00559"></a><a class="code" href="md5_8c.html#a25">00559</a> <span class="keywordtype">void</span> <a class="code" href="md5_8c.html#a25">hmac_md5</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* text, <span class="keywordtype">int</span> text_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  key, <span class="keywordtype">int</span> key_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  digest)
00560 {
00561     <a class="code" href="structMD5state__st.html">MD5_CTX</a> context;
00562     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_ipad[65];    <span class="comment">/* inner padding - key XORd with ipad */</span>
00563     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_opad[65];    <span class="comment">/* outer padding - key XORd with opad */</span>
00564     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tk[16];                <span class="comment">/* L=16 for MD5 (RFC 2141, 2. Definition of HMAC) */</span>
00565     <span class="keywordtype">int</span> i;
00566 
00567         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
00568                       <span class="stringliteral">"hmac_md5"</span>, 
00569                                   (<span class="stringliteral">"text=%p, text_len=%d, key=%p, key_len=%d, digest=%p"</span>,
00570                               (<span class="keywordtype">void</span> *)text, text_len, (<span class="keywordtype">void</span> *)key, key_len, (<span class="keywordtype">void</span> *)digest)
00571                                  );
00572 
00573 
00574     <span class="comment">/* if key is longer than 64 bytes reset it to key=MD5(key) */</span>
00575     <span class="keywordflow">if</span> (key_len &gt; 64) {
00576 
00577             <a class="code" href="structMD5state__st.html">MD5_CTX</a>      tctx;
00578 
00579             <a class="code" href="md5_8c.html#a19">MD5_Init</a>(&amp;tctx);
00580             <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;tctx, key, key_len);
00581             <a class="code" href="md5_8c.html#a24">MD5_Final</a>(tk, &amp;tctx);
00582 
00583             key = tk;
00584             key_len = 16;
00585     }
00586 
00587     <span class="comment">/*</span>
00588 <span class="comment">     * the HMAC_MD5 transform looks like:</span>
00589 <span class="comment">     *</span>
00590 <span class="comment">     * MD5(K XOR opad, MD5(K XOR ipad, text))</span>
00591 <span class="comment">     *</span>
00592 <span class="comment">     * where K is an n byte key</span>
00593 <span class="comment">     * ipad is the byte 0x36 repeated 64 times</span>
00594 <span class="comment">     * opad is the byte 0x5c repeated 64 times</span>
00595 <span class="comment">     * and text is the data being protected</span>
00596 <span class="comment">     */</span>
00597 
00598     <span class="comment">/* start out by storing key in pads */</span>
00599     memset(k_ipad, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(k_ipad));
00600     memset(k_opad, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span>(k_opad));
00601     memcpy(k_ipad, key, key_len);
00602     memcpy(k_opad, key, key_len);
00603 
00604 
00605     <span class="comment">/* XOR key with ipad and opad values */</span>
00606     <span class="keywordflow">for</span> (i=0; i&lt;64; i++) {
00607             k_ipad[i] ^= 0x36;
00608             k_opad[i] ^= 0x5c;
00609     }
00610     <span class="comment">/*</span>
00611 <span class="comment">     * perform inner MD5</span>
00612 <span class="comment">     */</span>
00613     <a class="code" href="md5_8c.html#a19">MD5_Init</a>(&amp;context);                  <span class="comment">/* init context for 1st</span>
00614 <span class="comment">                                          * pass */</span>
00615     <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;context, k_ipad, 64);    <span class="comment">/* start with inner pad */</span>
00616     <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;context, text, text_len);<span class="comment">/* then text of datagram */</span>
00617     <a class="code" href="md5_8c.html#a24">MD5_Final</a>(digest, &amp;context);         <span class="comment">/* finish up 1st pass */</span>
00618     <span class="comment">/*</span>
00619 <span class="comment">     * perform outer MD5</span>
00620 <span class="comment">     */</span>
00621     <a class="code" href="md5_8c.html#a19">MD5_Init</a>(&amp;context);                  <span class="comment">/* init context for 2nd</span>
00622 <span class="comment">                                          * pass */</span>
00623     <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;context, k_opad, 64);    <span class="comment">/* start with outer pad */</span>
00624     <a class="code" href="md5_8c.html#a22">MD5_Update</a>(&amp;context, digest, 16);    <span class="comment">/* then results of 1st</span>
00625 <span class="comment">                                          * hash */</span>
00626     <a class="code" href="md5_8c.html#a24">MD5_Final</a>(digest, &amp;context);         <span class="comment">/* finish up 2nd pass */</span>
00627 
00628         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"hmac_md5"</span>, (<span class="stringliteral">"void"</span>) );
00629 }
00630 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
