<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>des.c</h1><a href="des_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec       </span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00055 <span class="preprocessor">#include &lt;string.h&gt;</span>
00056 
00057 <span class="preprocessor">#include "<a class="code" href="des_8h.html">ipsec/des.h</a>"</span>
00058 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00059 
00060 
<a name="l00061"></a><a class="code" href="des_8c.html#a20">00061</a> <span class="keyword">const</span> <a class="code" href="des_8h.html#a0">DES_LONG</a> <a class="code" href="des_8c.html#a20">DES_SPtrans</a>[8][64]={
00062         {
00063         <span class="comment">/* nibble 0 */</span>
00064         0x02080800L, 0x00080000L, 0x02000002L, 0x02080802L,
00065         0x02000000L, 0x00080802L, 0x00080002L, 0x02000002L,
00066         0x00080802L, 0x02080800L, 0x02080000L, 0x00000802L,
00067         0x02000802L, 0x02000000L, 0x00000000L, 0x00080002L,
00068         0x00080000L, 0x00000002L, 0x02000800L, 0x00080800L,
00069         0x02080802L, 0x02080000L, 0x00000802L, 0x02000800L,
00070         0x00000002L, 0x00000800L, 0x00080800L, 0x02080002L,
00071         0x00000800L, 0x02000802L, 0x02080002L, 0x00000000L,
00072         0x00000000L, 0x02080802L, 0x02000800L, 0x00080002L,
00073         0x02080800L, 0x00080000L, 0x00000802L, 0x02000800L,
00074         0x02080002L, 0x00000800L, 0x00080800L, 0x02000002L,
00075         0x00080802L, 0x00000002L, 0x02000002L, 0x02080000L,
00076         0x02080802L, 0x00080800L, 0x02080000L, 0x02000802L,
00077         0x02000000L, 0x00000802L, 0x00080002L, 0x00000000L,
00078         0x00080000L, 0x02000000L, 0x02000802L, 0x02080800L,
00079         0x00000002L, 0x02080002L, 0x00000800L, 0x00080802L,
00080         },{
00081         <span class="comment">/* nibble 1 */</span>
00082         0x40108010L, 0x00000000L, 0x00108000L, 0x40100000L,
00083         0x40000010L, 0x00008010L, 0x40008000L, 0x00108000L,
00084         0x00008000L, 0x40100010L, 0x00000010L, 0x40008000L,
00085         0x00100010L, 0x40108000L, 0x40100000L, 0x00000010L,
00086         0x00100000L, 0x40008010L, 0x40100010L, 0x00008000L,
00087         0x00108010L, 0x40000000L, 0x00000000L, 0x00100010L,
00088         0x40008010L, 0x00108010L, 0x40108000L, 0x40000010L,
00089         0x40000000L, 0x00100000L, 0x00008010L, 0x40108010L,
00090         0x00100010L, 0x40108000L, 0x40008000L, 0x00108010L,
00091         0x40108010L, 0x00100010L, 0x40000010L, 0x00000000L,
00092         0x40000000L, 0x00008010L, 0x00100000L, 0x40100010L,
00093         0x00008000L, 0x40000000L, 0x00108010L, 0x40008010L,
00094         0x40108000L, 0x00008000L, 0x00000000L, 0x40000010L,
00095         0x00000010L, 0x40108010L, 0x00108000L, 0x40100000L,
00096         0x40100010L, 0x00100000L, 0x00008010L, 0x40008000L,
00097         0x40008010L, 0x00000010L, 0x40100000L, 0x00108000L,
00098         },{
00099         <span class="comment">/* nibble 2 */</span>
00100         0x04000001L, 0x04040100L, 0x00000100L, 0x04000101L,
00101         0x00040001L, 0x04000000L, 0x04000101L, 0x00040100L,
00102         0x04000100L, 0x00040000L, 0x04040000L, 0x00000001L,
00103         0x04040101L, 0x00000101L, 0x00000001L, 0x04040001L,
00104         0x00000000L, 0x00040001L, 0x04040100L, 0x00000100L,
00105         0x00000101L, 0x04040101L, 0x00040000L, 0x04000001L,
00106         0x04040001L, 0x04000100L, 0x00040101L, 0x04040000L,
00107         0x00040100L, 0x00000000L, 0x04000000L, 0x00040101L,
00108         0x04040100L, 0x00000100L, 0x00000001L, 0x00040000L,
00109         0x00000101L, 0x00040001L, 0x04040000L, 0x04000101L,
00110         0x00000000L, 0x04040100L, 0x00040100L, 0x04040001L,
00111         0x00040001L, 0x04000000L, 0x04040101L, 0x00000001L,
00112         0x00040101L, 0x04000001L, 0x04000000L, 0x04040101L,
00113         0x00040000L, 0x04000100L, 0x04000101L, 0x00040100L,
00114         0x04000100L, 0x00000000L, 0x04040001L, 0x00000101L,
00115         0x04000001L, 0x00040101L, 0x00000100L, 0x04040000L,
00116         },{
00117         <span class="comment">/* nibble 3 */</span>
00118         0x00401008L, 0x10001000L, 0x00000008L, 0x10401008L,
00119         0x00000000L, 0x10400000L, 0x10001008L, 0x00400008L,
00120         0x10401000L, 0x10000008L, 0x10000000L, 0x00001008L,
00121         0x10000008L, 0x00401008L, 0x00400000L, 0x10000000L,
00122         0x10400008L, 0x00401000L, 0x00001000L, 0x00000008L,
00123         0x00401000L, 0x10001008L, 0x10400000L, 0x00001000L,
00124         0x00001008L, 0x00000000L, 0x00400008L, 0x10401000L,
00125         0x10001000L, 0x10400008L, 0x10401008L, 0x00400000L,
00126         0x10400008L, 0x00001008L, 0x00400000L, 0x10000008L,
00127         0x00401000L, 0x10001000L, 0x00000008L, 0x10400000L,
00128         0x10001008L, 0x00000000L, 0x00001000L, 0x00400008L,
00129         0x00000000L, 0x10400008L, 0x10401000L, 0x00001000L,
00130         0x10000000L, 0x10401008L, 0x00401008L, 0x00400000L,
00131         0x10401008L, 0x00000008L, 0x10001000L, 0x00401008L,
00132         0x00400008L, 0x00401000L, 0x10400000L, 0x10001008L,
00133         0x00001008L, 0x10000000L, 0x10000008L, 0x10401000L,
00134         },{
00135         <span class="comment">/* nibble 4 */</span>
00136         0x08000000L, 0x00010000L, 0x00000400L, 0x08010420L,
00137         0x08010020L, 0x08000400L, 0x00010420L, 0x08010000L,
00138         0x00010000L, 0x00000020L, 0x08000020L, 0x00010400L,
00139         0x08000420L, 0x08010020L, 0x08010400L, 0x00000000L,
00140         0x00010400L, 0x08000000L, 0x00010020L, 0x00000420L,
00141         0x08000400L, 0x00010420L, 0x00000000L, 0x08000020L,
00142         0x00000020L, 0x08000420L, 0x08010420L, 0x00010020L,
00143         0x08010000L, 0x00000400L, 0x00000420L, 0x08010400L,
00144         0x08010400L, 0x08000420L, 0x00010020L, 0x08010000L,
00145         0x00010000L, 0x00000020L, 0x08000020L, 0x08000400L,
00146         0x08000000L, 0x00010400L, 0x08010420L, 0x00000000L,
00147         0x00010420L, 0x08000000L, 0x00000400L, 0x00010020L,
00148         0x08000420L, 0x00000400L, 0x00000000L, 0x08010420L,
00149         0x08010020L, 0x08010400L, 0x00000420L, 0x00010000L,
00150         0x00010400L, 0x08010020L, 0x08000400L, 0x00000420L,
00151         0x00000020L, 0x00010420L, 0x08010000L, 0x08000020L,
00152         },{
00153         <span class="comment">/* nibble 5 */</span>
00154         0x80000040L, 0x00200040L, 0x00000000L, 0x80202000L,
00155         0x00200040L, 0x00002000L, 0x80002040L, 0x00200000L,
00156         0x00002040L, 0x80202040L, 0x00202000L, 0x80000000L,
00157         0x80002000L, 0x80000040L, 0x80200000L, 0x00202040L,
00158         0x00200000L, 0x80002040L, 0x80200040L, 0x00000000L,
00159         0x00002000L, 0x00000040L, 0x80202000L, 0x80200040L,
00160         0x80202040L, 0x80200000L, 0x80000000L, 0x00002040L,
00161         0x00000040L, 0x00202000L, 0x00202040L, 0x80002000L,
00162         0x00002040L, 0x80000000L, 0x80002000L, 0x00202040L,
00163         0x80202000L, 0x00200040L, 0x00000000L, 0x80002000L,
00164         0x80000000L, 0x00002000L, 0x80200040L, 0x00200000L,
00165         0x00200040L, 0x80202040L, 0x00202000L, 0x00000040L,
00166         0x80202040L, 0x00202000L, 0x00200000L, 0x80002040L,
00167         0x80000040L, 0x80200000L, 0x00202040L, 0x00000000L,
00168         0x00002000L, 0x80000040L, 0x80002040L, 0x80202000L,
00169         0x80200000L, 0x00002040L, 0x00000040L, 0x80200040L,
00170         },{
00171         <span class="comment">/* nibble 6 */</span>
00172         0x00004000L, 0x00000200L, 0x01000200L, 0x01000004L,
00173         0x01004204L, 0x00004004L, 0x00004200L, 0x00000000L,
00174         0x01000000L, 0x01000204L, 0x00000204L, 0x01004000L,
00175         0x00000004L, 0x01004200L, 0x01004000L, 0x00000204L,
00176         0x01000204L, 0x00004000L, 0x00004004L, 0x01004204L,
00177         0x00000000L, 0x01000200L, 0x01000004L, 0x00004200L,
00178         0x01004004L, 0x00004204L, 0x01004200L, 0x00000004L,
00179         0x00004204L, 0x01004004L, 0x00000200L, 0x01000000L,
00180         0x00004204L, 0x01004000L, 0x01004004L, 0x00000204L,
00181         0x00004000L, 0x00000200L, 0x01000000L, 0x01004004L,
00182         0x01000204L, 0x00004204L, 0x00004200L, 0x00000000L,
00183         0x00000200L, 0x01000004L, 0x00000004L, 0x01000200L,
00184         0x00000000L, 0x01000204L, 0x01000200L, 0x00004200L,
00185         0x00000204L, 0x00004000L, 0x01004204L, 0x01000000L,
00186         0x01004200L, 0x00000004L, 0x00004004L, 0x01004204L,
00187         0x01000004L, 0x01004200L, 0x01004000L, 0x00004004L,
00188         },{
00189         <span class="comment">/* nibble 7 */</span>
00190         0x20800080L, 0x20820000L, 0x00020080L, 0x00000000L,
00191         0x20020000L, 0x00800080L, 0x20800000L, 0x20820080L,
00192         0x00000080L, 0x20000000L, 0x00820000L, 0x00020080L,
00193         0x00820080L, 0x20020080L, 0x20000080L, 0x20800000L,
00194         0x00020000L, 0x00820080L, 0x00800080L, 0x20020000L,
00195         0x20820080L, 0x20000080L, 0x00000000L, 0x00820000L,
00196         0x20000000L, 0x00800000L, 0x20020080L, 0x20800080L,
00197         0x00800000L, 0x00020000L, 0x20820000L, 0x00000080L,
00198         0x00800000L, 0x00020000L, 0x20000080L, 0x20820080L,
00199         0x00020080L, 0x20000000L, 0x00000000L, 0x00820000L,
00200         0x20800080L, 0x20020080L, 0x20020000L, 0x00800080L,
00201         0x20820000L, 0x00000080L, 0x00800080L, 0x20020000L,
00202         0x20820080L, 0x00800000L, 0x20800000L, 0x20000080L,
00203         0x00820000L, 0x00020080L, 0x20020080L, 0x20800000L,
00204         0x00000080L, 0x20820000L, 0x00820080L, 0x00000000L,
00205         0x20000000L, 0x20800080L, 0x00020000L, 0x00820080L,
00206         }};
00207 
00208 
00209 
00210 <span class="comment">/* DES_cbc_encrypt does not update the IV!  Use DES_ncbc_encrypt instead. */</span>
00211 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a25">DES_cbc_encrypt</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input,<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output,
00212                      <span class="keywordtype">long</span> length,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule,<a class="code" href="des_8h.html#a3">DES_cblock</a> *ivec,
00213                      <span class="keywordtype">int</span> enc);
00214 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a26">DES_ncbc_encrypt</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input,<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output,
00215                       <span class="keywordtype">long</span> length,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule,<a class="code" href="des_8h.html#a3">DES_cblock</a> *ivec,
00216                       <span class="keywordtype">int</span> enc);
00217 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a27">DES_encrypt1</a>(DES_LONG *data,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks, <span class="keywordtype">int</span> enc);
00218 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a28">DES_encrypt2</a>(DES_LONG *data,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks, <span class="keywordtype">int</span> enc);
00219 
00220 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a29">DES_encrypt3</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,
00221                   <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3);
00222 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a30">DES_decrypt3</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,
00223                   <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3);
00224 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a31">DES_ede3_cbc_encrypt</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input,<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output,
00225                           <span class="keywordtype">long</span> length,
00226                           <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2,
00227                           <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3,<a class="code" href="des_8h.html#a3">DES_cblock</a> *ivec,<span class="keywordtype">int</span> enc);
00228 <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a32">DES_set_odd_parity</a>(<a class="code" href="des_8h.html#a3">DES_cblock</a> *key);
00229 <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a33">DES_check_key_parity</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key);
00230 <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a34">DES_is_weak_key</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key);
00231 <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a35">DES_set_key</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule);
00232 <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a36">DES_key_sched</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule);
00233 <span class="keywordtype">int</span> <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule);
00234 <span class="keywordtype">void</span> <a class="code" href="des_8h.html#a7">DES_set_key_unchecked</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key,<a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule);
00235 
<a name="l00236"></a><a class="code" href="des_8c.html#a0">00236</a> <span class="preprocessor">#define DES_KEY_SZ      (sizeof(DES_cblock))</span>
<a name="l00237"></a><a class="code" href="des_8c.html#a1">00237</a> <span class="preprocessor"></span><span class="preprocessor">#define DES_SCHEDULE_SZ (sizeof(DES_key_schedule))</span>
00238 <span class="preprocessor"></span>
00239 
<a name="l00240"></a><a class="code" href="des_8c.html#a2">00240</a> <span class="preprocessor">#define ITERATIONS 16</span>
<a name="l00241"></a><a class="code" href="des_8c.html#a3">00241</a> <span class="preprocessor"></span><span class="preprocessor">#define HALF_ITERATIONS 8</span>
00242 <span class="preprocessor"></span>
00243 
00244 <span class="comment">/* char to long */</span>
<a name="l00245"></a><a class="code" href="des_8c.html#a4">00245</a> <span class="preprocessor">#define c2l(c,l)        (l =((DES_LONG)(*((c)++)))    , \</span>
00246 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++)))&lt;&lt; 8L, \</span>
00247 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++)))&lt;&lt;16L, \</span>
00248 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++)))&lt;&lt;24L)</span>
00249 <span class="preprocessor"></span>
00250 <span class="comment">/* NOTE - c is not incremented as per c2l */</span>
00251 
00252 <span class="comment">/* char to long network order */</span>
<a name="l00253"></a><a class="code" href="des_8c.html#a5">00253</a> <span class="preprocessor">#define c2ln(c,l1,l2,n) { \</span>
00254 <span class="preprocessor">                        c+=n; \</span>
00255 <span class="preprocessor">                        l1=l2=0; \</span>
00256 <span class="preprocessor">                        switch (n) { \</span>
00257 <span class="preprocessor">                        case 8: l2 =((DES_LONG)(*(--(c))))&lt;&lt;24L; \</span>
00258 <span class="preprocessor">                        case 7: l2|=((DES_LONG)(*(--(c))))&lt;&lt;16L; \</span>
00259 <span class="preprocessor">                        case 6: l2|=((DES_LONG)(*(--(c))))&lt;&lt; 8L; \</span>
00260 <span class="preprocessor">                        case 5: l2|=((DES_LONG)(*(--(c))));     \</span>
00261 <span class="preprocessor">                        case 4: l1 =((DES_LONG)(*(--(c))))&lt;&lt;24L; \</span>
00262 <span class="preprocessor">                        case 3: l1|=((DES_LONG)(*(--(c))))&lt;&lt;16L; \</span>
00263 <span class="preprocessor">                        case 2: l1|=((DES_LONG)(*(--(c))))&lt;&lt; 8L; \</span>
00264 <span class="preprocessor">                        case 1: l1|=((DES_LONG)(*(--(c))));     \</span>
00265 <span class="preprocessor">                                } \</span>
00266 <span class="preprocessor">                        }</span>
00267 <span class="preprocessor"></span>
00268 
00269 <span class="comment">/* long to char */</span>
<a name="l00270"></a><a class="code" href="des_8c.html#a6">00270</a> <span class="preprocessor">#define l2c(l,c)        (*((c)++)=(unsigned char)(((l)     )&amp;0xff), \</span>
00271 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt; 8L)&amp;0xff), \</span>
00272 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;16L)&amp;0xff), \</span>
00273 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;24L)&amp;0xff))</span>
00274 <span class="preprocessor"></span>
00275 <span class="comment">/* replacements for htonl and ntohl since I have no idea what to do</span>
00276 <span class="comment"> * when faced with machines with 8 byte longs. */</span>
<a name="l00277"></a><a class="code" href="des_8c.html#a7">00277</a> <span class="preprocessor">#define HDRSIZE 4</span>
00278 <span class="preprocessor"></span>
00279 
00280 <span class="comment">/* network to long */</span>
<a name="l00281"></a><a class="code" href="des_8c.html#a8">00281</a> <span class="preprocessor">#define n2l(c,l)        (l =((DES_LONG)(*((c)++)))&lt;&lt;24L, \</span>
00282 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++)))&lt;&lt;16L, \</span>
00283 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++)))&lt;&lt; 8L, \</span>
00284 <span class="preprocessor">                         l|=((DES_LONG)(*((c)++))))</span>
00285 <span class="preprocessor"></span>
00286 
00287 <span class="comment">/* long to network */</span>
<a name="l00288"></a><a class="code" href="des_8c.html#a9">00288</a> <span class="preprocessor">#define l2n(l,c)        (*((c)++)=(unsigned char)(((l)&gt;&gt;24L)&amp;0xff), \</span>
00289 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt;16L)&amp;0xff), \</span>
00290 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)&gt;&gt; 8L)&amp;0xff), \</span>
00291 <span class="preprocessor">                         *((c)++)=(unsigned char)(((l)     )&amp;0xff))</span>
00292 <span class="preprocessor"></span>
00293 <span class="comment">/* NOTE - c is not incremented as per l2c */</span>
00294 
00295 <span class="comment">/* long to char network */</span>
<a name="l00296"></a><a class="code" href="des_8c.html#a10">00296</a> <span class="preprocessor">#define l2cn(l1,l2,c,n) { \</span>
00297 <span class="preprocessor">                        c+=n; \</span>
00298 <span class="preprocessor">                        switch (n) { \</span>
00299 <span class="preprocessor">                        case 8: *(--(c))=(unsigned char)(((l2)&gt;&gt;24L)&amp;0xff); \</span>
00300 <span class="preprocessor">                        case 7: *(--(c))=(unsigned char)(((l2)&gt;&gt;16L)&amp;0xff); \</span>
00301 <span class="preprocessor">                        case 6: *(--(c))=(unsigned char)(((l2)&gt;&gt; 8L)&amp;0xff); \</span>
00302 <span class="preprocessor">                        case 5: *(--(c))=(unsigned char)(((l2)     )&amp;0xff); \</span>
00303 <span class="preprocessor">                        case 4: *(--(c))=(unsigned char)(((l1)&gt;&gt;24L)&amp;0xff); \</span>
00304 <span class="preprocessor">                        case 3: *(--(c))=(unsigned char)(((l1)&gt;&gt;16L)&amp;0xff); \</span>
00305 <span class="preprocessor">                        case 2: *(--(c))=(unsigned char)(((l1)&gt;&gt; 8L)&amp;0xff); \</span>
00306 <span class="preprocessor">                        case 1: *(--(c))=(unsigned char)(((l1)     )&amp;0xff); \</span>
00307 <span class="preprocessor">                                } \</span>
00308 <span class="preprocessor">                        }</span>
00309 <span class="preprocessor"></span>
00310 
00311 <span class="comment">/* ALARM: check this out carefully</span>
00312 <span class="comment"> * keep an eye on that when porting to 16 bit</span>
00313 <span class="comment"> *</span>
00314 <span class="comment"> *</span>
00315 <span class="comment"> */</span>
00316 <span class="preprocessor">#ifndef ROTATE</span>
<a name="l00317"></a><a class="code" href="des_8c.html#a11">00317</a> <span class="preprocessor"></span><span class="preprocessor">#define ROTATE(a,n)     (((a)&gt;&gt;(n))+((a)&lt;&lt;(32-(n))))</span>
00318 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
<a name="l00320"></a><a class="code" href="des_8c.html#a12">00320</a> <span class="preprocessor">#define LOAD_DATA_tmp(a,b,c,d,e,f) LOAD_DATA(a,b,c,d,e,f,g)</span>
<a name="l00321"></a><a class="code" href="des_8c.html#a13">00321</a> <span class="preprocessor"></span><span class="preprocessor">#define LOAD_DATA(R,S,u,t,E0,E1,tmp) \</span>
00322 <span class="preprocessor">        u=R^s[S  ]; \</span>
00323 <span class="preprocessor">        t=R^s[S+1]</span>
00324 <span class="preprocessor"></span>
<a name="l00325"></a><a class="code" href="des_8c.html#a14">00325</a> <span class="preprocessor">#define D_ENCRYPT(LL,R,S) {\</span>
00326 <span class="preprocessor">        LOAD_DATA_tmp(R,S,u,t,E0,E1); \</span>
00327 <span class="preprocessor">        t=ROTATE(t,4); \</span>
00328 <span class="preprocessor">        LL^=\</span>
00329 <span class="preprocessor">                DES_SPtrans[0][(u&gt;&gt; 2L)&amp;0x3f]^ \</span>
00330 <span class="preprocessor">                DES_SPtrans[2][(u&gt;&gt;10L)&amp;0x3f]^ \</span>
00331 <span class="preprocessor">                DES_SPtrans[4][(u&gt;&gt;18L)&amp;0x3f]^ \</span>
00332 <span class="preprocessor">                DES_SPtrans[6][(u&gt;&gt;26L)&amp;0x3f]^ \</span>
00333 <span class="preprocessor">                DES_SPtrans[1][(t&gt;&gt; 2L)&amp;0x3f]^ \</span>
00334 <span class="preprocessor">                DES_SPtrans[3][(t&gt;&gt;10L)&amp;0x3f]^ \</span>
00335 <span class="preprocessor">                DES_SPtrans[5][(t&gt;&gt;18L)&amp;0x3f]^ \</span>
00336 <span class="preprocessor">                DES_SPtrans[7][(t&gt;&gt;26L)&amp;0x3f]; }</span>
00337 <span class="preprocessor"></span>
00338 
00339 
00340         <span class="comment">/* IP and FP</span>
00341 <span class="comment">         * The problem is more of a geometric problem that random bit fiddling.</span>
00342 <span class="comment">         0  1  2  3  4  5  6  7      62 54 46 38 30 22 14  6</span>
00343 <span class="comment">         8  9 10 11 12 13 14 15      60 52 44 36 28 20 12  4</span>
00344 <span class="comment">        16 17 18 19 20 21 22 23      58 50 42 34 26 18 10  2</span>
00345 <span class="comment">        24 25 26 27 28 29 30 31  to  56 48 40 32 24 16  8  0</span>
00346 <span class="comment"></span>
00347 <span class="comment">        32 33 34 35 36 37 38 39      63 55 47 39 31 23 15  7</span>
00348 <span class="comment">        40 41 42 43 44 45 46 47      61 53 45 37 29 21 13  5</span>
00349 <span class="comment">        48 49 50 51 52 53 54 55      59 51 43 35 27 19 11  3</span>
00350 <span class="comment">        56 57 58 59 60 61 62 63      57 49 41 33 25 17  9  1</span>
00351 <span class="comment"></span>
00352 <span class="comment">        The output has been subject to swaps of the form</span>
00353 <span class="comment">        0 1 -&gt; 3 1 but the odd and even bits have been put into</span>
00354 <span class="comment">        2 3    2 0</span>
00355 <span class="comment">        different words.  The main trick is to remember that</span>
00356 <span class="comment">        t=((l&gt;&gt;size)^r)&amp;(mask);</span>
00357 <span class="comment">        r^=t;</span>
00358 <span class="comment">        l^=(t&lt;&lt;size);</span>
00359 <span class="comment">        can be used to swap and move bits between words.</span>
00360 <span class="comment"></span>
00361 <span class="comment">        So l =  0  1  2  3  r = 16 17 18 19</span>
00362 <span class="comment">                4  5  6  7      20 21 22 23</span>
00363 <span class="comment">                8  9 10 11      24 25 26 27</span>
00364 <span class="comment">               12 13 14 15      28 29 30 31</span>
00365 <span class="comment">        becomes (for size == 2 and mask == 0x3333)</span>
00366 <span class="comment">           t =   2^16  3^17 -- --   l =  0  1 16 17  r =  2  3 18 19</span>
00367 <span class="comment">                 6^20  7^21 -- --        4  5 20 21       6  7 22 23</span>
00368 <span class="comment">                10^24 11^25 -- --        8  9 24 25      10 11 24 25</span>
00369 <span class="comment">                14^28 15^29 -- --       12 13 28 29      14 15 28 29</span>
00370 <span class="comment"></span>
00371 <span class="comment">        Thanks for hints from Richard Outerbridge - he told me IP&amp;FP</span>
00372 <span class="comment">        could be done in 15 xor, 10 shifts and 5 ands.</span>
00373 <span class="comment">        When I finally started to think of the problem in 2D</span>
00374 <span class="comment">        I first got ~42 operations without xors.  When I remembered</span>
00375 <span class="comment">        how to use xors :-) I got it to its final state.</span>
00376 <span class="comment">        */</span>
00377 
00378 
<a name="l00379"></a><a class="code" href="des_8c.html#a15">00379</a> <span class="preprocessor">#define PERM_OP(a,b,t,n,m) ((t)=((((a)&gt;&gt;(n))^(b))&amp;(m)),\</span>
00380 <span class="preprocessor">        (b)^=(t),\</span>
00381 <span class="preprocessor">        (a)^=((t)&lt;&lt;(n)))</span>
00382 <span class="preprocessor"></span>
<a name="l00383"></a><a class="code" href="des_8c.html#a16">00383</a> <span class="preprocessor">#define IP(l,r) \</span>
00384 <span class="preprocessor">        { \</span>
00385 <span class="preprocessor">        DES_LONG tt; \</span>
00386 <span class="preprocessor">        PERM_OP(r,l,tt, 4,0x0f0f0f0fL); \</span>
00387 <span class="preprocessor">        PERM_OP(l,r,tt,16,0x0000ffffL); \</span>
00388 <span class="preprocessor">        PERM_OP(r,l,tt, 2,0x33333333L); \</span>
00389 <span class="preprocessor">        PERM_OP(l,r,tt, 8,0x00ff00ffL); \</span>
00390 <span class="preprocessor">        PERM_OP(r,l,tt, 1,0x55555555L); \</span>
00391 <span class="preprocessor">        }</span>
00392 <span class="preprocessor"></span>
<a name="l00393"></a><a class="code" href="des_8c.html#a17">00393</a> <span class="preprocessor">#define FP(l,r) \</span>
00394 <span class="preprocessor">        { \</span>
00395 <span class="preprocessor">        DES_LONG tt; \</span>
00396 <span class="preprocessor">        PERM_OP(l,r,tt, 1,0x55555555L); \</span>
00397 <span class="preprocessor">        PERM_OP(r,l,tt, 8,0x00ff00ffL); \</span>
00398 <span class="preprocessor">        PERM_OP(l,r,tt, 2,0x33333333L); \</span>
00399 <span class="preprocessor">        PERM_OP(r,l,tt,16,0x0000ffffL); \</span>
00400 <span class="preprocessor">        PERM_OP(l,r,tt, 4,0x0f0f0f0fL); \</span>
00401 <span class="preprocessor">        }</span>
00402 <span class="preprocessor"></span>
00403 
00404 
00405 <span class="comment">// des cbc encryption, we use this for IPsec</span>
<a name="l00406"></a><a class="code" href="des_8c.html#a26">00406</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a26">DES_ncbc_encrypt</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out, <span class="keywordtype">long</span> length,
00407                      <a class="code" href="structDES__ks.html">DES_key_schedule</a> *_schedule, <a class="code" href="des_8h.html#a3">DES_cblock</a> *ivec, <span class="keywordtype">int</span> enc)
00408 {
00409         <a class="code" href="des_8h.html#a0">DES_LONG</a> tin0,tin1;
00410         <a class="code" href="des_8h.html#a0">DES_LONG</a> tout0,tout1,xor0,xor1;
00411         <span class="keywordtype">long</span> l=length;
00412         <a class="code" href="des_8h.html#a0">DES_LONG</a> tin[2];
00413         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *iv;
00414 
00415         iv = &amp;(*ivec)[0];
00416 
00417         <span class="keywordflow">if</span> (enc)
00418                 {
00419                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,tout0);
00420                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,tout1);
00421                 <span class="keywordflow">for</span> (l-=8; l&gt;=0; l-=8)
00422                         {
00423                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0);
00424                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1);
00425                         tin0^=tout0; tin[0]=tin0;
00426                         tin1^=tout1; tin[1]=tin1;
00427                         <a class="code" href="des_8c.html#a27">DES_encrypt1</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,_schedule,<a class="code" href="des_8h.html#a1">DES_ENCRYPT</a>);
00428                         tout0=tin[0]; <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00429                         tout1=tin[1]; <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00430                         }
00431                 <span class="keywordflow">if</span> (l != -8)
00432                         {
00433                         <a class="code" href="des_8c.html#a5">c2ln</a>(in,tin0,tin1,l+8);
00434                         tin0^=tout0; tin[0]=tin0;
00435                         tin1^=tout1; tin[1]=tin1;
00436                         <a class="code" href="des_8c.html#a27">DES_encrypt1</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,_schedule,<a class="code" href="des_8h.html#a1">DES_ENCRYPT</a>);
00437                         tout0=tin[0]; <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00438                         tout1=tin[1]; <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00439                         }
00440                 iv = &amp;(*ivec)[0];                               <span class="comment">// next 3 lines ifndef CBC_ENC_C__DONT_UPDATE_IV</span>
00441                 <a class="code" href="des_8c.html#a6">l2c</a>(tout0,iv);
00442                 <a class="code" href="des_8c.html#a6">l2c</a>(tout1,iv);
00443                 }
00444         <span class="keywordflow">else</span>
00445                 {
00446                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,xor0);
00447                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,xor1);
00448                 <span class="keywordflow">for</span> (l-=8; l&gt;=0; l-=8)
00449                         {
00450                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0); tin[0]=tin0;
00451                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1); tin[1]=tin1;
00452                         <a class="code" href="des_8c.html#a27">DES_encrypt1</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,_schedule,<a class="code" href="des_8h.html#a2">DES_DECRYPT</a>);
00453                         tout0=tin[0]^xor0;
00454                         tout1=tin[1]^xor1;
00455                         <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00456                         <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00457                         xor0=tin0;
00458                         xor1=tin1;
00459                         }
00460                 <span class="keywordflow">if</span> (l != -8)
00461                         {
00462                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0); tin[0]=tin0;
00463                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1); tin[1]=tin1;
00464                         <a class="code" href="des_8c.html#a27">DES_encrypt1</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,_schedule,<a class="code" href="des_8h.html#a2">DES_DECRYPT</a>);
00465                         tout0=tin[0]^xor0;
00466                         tout1=tin[1]^xor1;
00467                         <a class="code" href="des_8c.html#a10">l2cn</a>(tout0,tout1,out,l+8);
00468 
00469                         xor0=tin0;                              <span class="comment">// next 2 lines #ifndef CBC_ENC_C__DONT_UPDATE_IV</span>
00470                         xor1=tin1;
00471                         }
00472                 iv = &amp;(*ivec)[0];                       <span class="comment">// next 3 lines #ifndef CBC_ENC_C__DONT_UPDATE_IV</span>
00473                 <a class="code" href="des_8c.html#a6">l2c</a>(xor0,iv);
00474                 <a class="code" href="des_8c.html#a6">l2c</a>(xor1,iv);
00475                 }
00476         tin0=tin1=tout0=tout1=xor0=xor1=0;
00477         tin[0]=tin[1]=0;
00478 }
00479 
00480 
00481 <span class="comment">// normal DES encryption routine</span>
<a name="l00482"></a><a class="code" href="des_8c.html#a27">00482</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a27">DES_encrypt1</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks, <span class="keywordtype">int</span> enc)
00483 {
00484         <a class="code" href="des_8h.html#a0">DES_LONG</a> l,r,t,u;
00485         <span class="keywordtype">int</span> i;
00486         <a class="code" href="des_8h.html#a0">DES_LONG</a> *s;
00487         r=data[0];
00488         l=data[1];
00489         <a class="code" href="des_8c.html#a16">IP</a>(r,l);
00490         <span class="comment">/* Things have been modified so that the initial rotate is</span>
00491 <span class="comment">         * done outside the loop.  This required the</span>
00492 <span class="comment">         * DES_SPtrans values in sp.h to be rotated 1 bit to the right.</span>
00493 <span class="comment">         * One perl script later and things have a 5% speed up on a sparc2.</span>
00494 <span class="comment">         * Thanks to Richard Outerbridge &lt;71755.204@CompuServe.COM&gt;</span>
00495 <span class="comment">         * for pointing this out. */</span>
00496         <span class="comment">/* clear the top bits on machines with 8byte longs */</span>
00497         <span class="comment">/* shift left by 2 */</span>
00498         r=<a class="code" href="des_8c.html#a11">ROTATE</a>(r,29)&amp;0xffffffffL;
00499         l=<a class="code" href="des_8c.html#a11">ROTATE</a>(l,29)&amp;0xffffffffL;
00500         s=ks-&gt;<a class="code" href="structDES__ks.html#o2">ks</a>-&gt;deslong;
00501         <span class="comment">/* I don't know if it is worth the effort of loop unrolling the</span>
00502 <span class="comment">         * inner loop */</span>
00503         <span class="keywordflow">if</span> (enc)
00504                 {
00505                 <span class="keywordflow">for</span> (i=0; i&lt;32; i+=8)
00506                         {
00507                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i+0); <span class="comment">/*  1 */</span>
00508                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i+2); <span class="comment">/*  2 */</span>
00509                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i+4); <span class="comment">/*  3 */</span>
00510                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i+6); <span class="comment">/*  4 */</span>
00511                         }
00512                 }
00513         <span class="keywordflow">else</span>
00514                 {
00515                 <span class="keywordflow">for</span> (i=30; i&gt;0; i-=8)
00516                         {
00517                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i-0); <span class="comment">/* 16 */</span>
00518                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i-2); <span class="comment">/* 15 */</span>
00519                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i-4); <span class="comment">/* 14 */</span>
00520                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i-6); <span class="comment">/* 13 */</span>
00521                         }
00522                 }
00523         <span class="comment">/* rotate and clear the top bits on machines with 8byte longs */</span>
00524         l=<a class="code" href="des_8c.html#a11">ROTATE</a>(l,3)&amp;0xffffffffL;
00525         r=<a class="code" href="des_8c.html#a11">ROTATE</a>(r,3)&amp;0xffffffffL;
00526         <a class="code" href="des_8c.html#a17">FP</a>(r,l);
00527         data[0]=l;
00528         data[1]=r;
00529         l=r=t=u=0;
00530 }
00531 
00532 <span class="comment">// another DES encryption function</span>
<a name="l00533"></a><a class="code" href="des_8c.html#a28">00533</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a28">DES_encrypt2</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks, <span class="keywordtype">int</span> enc)
00534 {
00535         <a class="code" href="des_8h.html#a0">DES_LONG</a> l,r,t,u;
00536         <span class="keywordtype">int</span> i;
00537         <a class="code" href="des_8h.html#a0">DES_LONG</a> *s;
00538         r=data[0];
00539         l=data[1];
00540         <span class="comment">/* Things have been modified so that the initial rotate is</span>
00541 <span class="comment">         * done outside the loop.  This required the</span>
00542 <span class="comment">         * DES_SPtrans values in sp.h to be rotated 1 bit to the right.</span>
00543 <span class="comment">         * One perl script later and things have a 5% speed up on a sparc2.</span>
00544 <span class="comment">         * Thanks to Richard Outerbridge &lt;71755.204@CompuServe.COM&gt;</span>
00545 <span class="comment">         * for pointing this out. */</span>
00546         <span class="comment">/* clear the top bits on machines with 8byte longs */</span>
00547         r=<a class="code" href="des_8c.html#a11">ROTATE</a>(r,29)&amp;0xffffffffL;
00548         l=<a class="code" href="des_8c.html#a11">ROTATE</a>(l,29)&amp;0xffffffffL;
00549         s=ks-&gt;<a class="code" href="structDES__ks.html#o2">ks</a>-&gt;deslong;
00550         <span class="comment">/* I don't know if it is worth the effort of loop unrolling the</span>
00551 <span class="comment">         * inner loop */</span>
00552         <span class="keywordflow">if</span> (enc)
00553                 {
00554                 <span class="keywordflow">for</span> (i=0; i&lt;32; i+=8)
00555                         {
00556                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i+0); <span class="comment">/*  1 */</span>
00557                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i+2); <span class="comment">/*  2 */</span>
00558                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i+4); <span class="comment">/*  3 */</span>
00559                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i+6); <span class="comment">/*  4 */</span>
00560                         }
00561                 }
00562         <span class="keywordflow">else</span>
00563                 {
00564                 <span class="keywordflow">for</span> (i=30; i&gt;0; i-=8)
00565                         {
00566                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i-0); <span class="comment">/* 16 */</span>
00567                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i-2); <span class="comment">/* 15 */</span>
00568                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(l,r,i-4); <span class="comment">/* 14 */</span>
00569                         <a class="code" href="des_8c.html#a14">D_ENCRYPT</a>(r,l,i-6); <span class="comment">/* 13 */</span>
00570                         }
00571                 }
00572         <span class="comment">/* rotate and clear the top bits on machines with 8byte longs */</span>
00573         data[0]=<a class="code" href="des_8c.html#a11">ROTATE</a>(l,3)&amp;0xffffffffL;
00574         data[1]=<a class="code" href="des_8c.html#a11">ROTATE</a>(r,3)&amp;0xffffffffL;
00575         l=r=t=u=0;
00576 }
00577 
00578 <span class="comment">// 3DES encrypt</span>
<a name="l00579"></a><a class="code" href="des_8c.html#a29">00579</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a29">DES_encrypt3</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,
00580                   <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3)
00581 {
00582         <a class="code" href="des_8h.html#a0">DES_LONG</a> l,r;
00583         l=data[0];
00584         r=data[1];
00585         <a class="code" href="des_8c.html#a16">IP</a>(l,r);
00586         data[0]=l;
00587         data[1]=r;
00588         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks1,<a class="code" href="des_8h.html#a1">DES_ENCRYPT</a>);
00589         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks2,<a class="code" href="des_8h.html#a2">DES_DECRYPT</a>);
00590         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks3,<a class="code" href="des_8h.html#a1">DES_ENCRYPT</a>);
00591         l=data[0];
00592         r=data[1];
00593         <a class="code" href="des_8c.html#a17">FP</a>(r,l);
00594         data[0]=l;
00595         data[1]=r;
00596 }
00597 
00598 <span class="comment">// 3DES decrypt</span>
<a name="l00599"></a><a class="code" href="des_8c.html#a30">00599</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a30">DES_decrypt3</a>(DES_LONG *data, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,
00600                   <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3)
00601 {
00602         <a class="code" href="des_8h.html#a0">DES_LONG</a> l,r;
00603         l=data[0];
00604         r=data[1];
00605         <a class="code" href="des_8c.html#a16">IP</a>(l,r);
00606         data[0]=l;
00607         data[1]=r;
00608         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks3,<a class="code" href="des_8h.html#a2">DES_DECRYPT</a>);
00609         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks2,<a class="code" href="des_8h.html#a1">DES_ENCRYPT</a>);
00610         <a class="code" href="des_8c.html#a28">DES_encrypt2</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)data,ks1,<a class="code" href="des_8h.html#a2">DES_DECRYPT</a>);
00611         l=data[0];
00612         r=data[1];
00613         <a class="code" href="des_8c.html#a17">FP</a>(r,l);
00614         data[0]=l;
00615         data[1]=r;
00616 }
00617 <span class="preprocessor">#ifndef DES_DEFAULT_OPTIONS</span>
00618 <span class="preprocessor"></span><span class="comment">//#undef CBC_ENC_C__DONT_UPDATE_IV</span>
00619 
00620 <span class="comment">// 3DES CBC encrypt/decrypt fuctnion, we USE that for IPsec</span>
<a name="l00621"></a><a class="code" href="des_8c.html#a31">00621</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a31">DES_ede3_cbc_encrypt</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output,
00622                           <span class="keywordtype">long</span> length, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks1,
00623                           <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks2, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *ks3,
00624                           <a class="code" href="des_8h.html#a3">DES_cblock</a> *ivec, <span class="keywordtype">int</span> enc)
00625 {
00626         <a class="code" href="des_8h.html#a0">DES_LONG</a> tin0,tin1;
00627         <a class="code" href="des_8h.html#a0">DES_LONG</a> tout0,tout1,xor0,xor1;
00628         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in;
00629         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out;
00630         <span class="keywordtype">long</span> l=length;
00631         <a class="code" href="des_8h.html#a0">DES_LONG</a> tin[2];
00632         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *iv;
00633         in=input;
00634         out=output;
00635         iv = &amp;(*ivec)[0];
00636         <span class="keywordflow">if</span> (enc)
00637                 {
00638                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,tout0);
00639                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,tout1);
00640                 <span class="keywordflow">for</span> (l-=8; l&gt;=0; l-=8)
00641                         {
00642                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0);
00643                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1);
00644                         tin0^=tout0;
00645                         tin1^=tout1;
00646                         tin[0]=tin0;
00647                         tin[1]=tin1;
00648                         <a class="code" href="des_8c.html#a29">DES_encrypt3</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,ks1,ks2,ks3);
00649                         tout0=tin[0];
00650                         tout1=tin[1];
00651                         <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00652                         <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00653                         }
00654                 <span class="keywordflow">if</span> (l != -8)
00655                         {
00656                         <a class="code" href="des_8c.html#a5">c2ln</a>(in,tin0,tin1,l+8);
00657                         tin0^=tout0;
00658                         tin1^=tout1;
00659                         tin[0]=tin0;
00660                         tin[1]=tin1;
00661                         <a class="code" href="des_8c.html#a29">DES_encrypt3</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,ks1,ks2,ks3);
00662                         tout0=tin[0];
00663                         tout1=tin[1];
00664                         <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00665                         <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00666                         }
00667                 iv = &amp;(*ivec)[0];
00668                 <a class="code" href="des_8c.html#a6">l2c</a>(tout0,iv);
00669                 <a class="code" href="des_8c.html#a6">l2c</a>(tout1,iv);
00670                 }
00671         <span class="keywordflow">else</span>
00672                 {
00673                 <a class="code" href="des_8h.html#a0">DES_LONG</a> t0,t1;
00674                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,xor0);
00675                 <a class="code" href="des_8c.html#a4">c2l</a>(iv,xor1);
00676                 <span class="keywordflow">for</span> (l-=8; l&gt;=0; l-=8)
00677                         {
00678                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0);
00679                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1);
00680                         t0=tin0;
00681                         t1=tin1;
00682                         tin[0]=tin0;
00683                         tin[1]=tin1;
00684                         <a class="code" href="des_8c.html#a30">DES_decrypt3</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,ks1,ks2,ks3);
00685                         tout0=tin[0];
00686                         tout1=tin[1];
00687                         tout0^=xor0;
00688                         tout1^=xor1;
00689                         <a class="code" href="des_8c.html#a6">l2c</a>(tout0,out);
00690                         <a class="code" href="des_8c.html#a6">l2c</a>(tout1,out);
00691                         xor0=t0;
00692                         xor1=t1;
00693                         }
00694                 <span class="keywordflow">if</span> (l != -8)
00695                         {
00696                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin0);
00697                         <a class="code" href="des_8c.html#a4">c2l</a>(in,tin1);
00698                         
00699                         t0=tin0;
00700                         t1=tin1;
00701                         tin[0]=tin0;
00702                         tin[1]=tin1;
00703                         <a class="code" href="des_8c.html#a30">DES_decrypt3</a>((<a class="code" href="des_8h.html#a0">DES_LONG</a> *)tin,ks1,ks2,ks3);
00704                         tout0=tin[0];
00705                         tout1=tin[1];
00706                 
00707                         tout0^=xor0;
00708                         tout1^=xor1;
00709                         <a class="code" href="des_8c.html#a10">l2cn</a>(tout0,tout1,out,l+8);
00710                         xor0=t0;
00711                         xor1=t1;
00712                         }
00713                 iv = &amp;(*ivec)[0];
00714                 <a class="code" href="des_8c.html#a6">l2c</a>(xor0,iv);
00715                 <a class="code" href="des_8c.html#a6">l2c</a>(xor1,iv);
00716                 }
00717         tin0=tin1=tout0=tout1=xor0=xor1=0;
00718         tin[0]=tin[1]=0;
00719 }
00720 <span class="preprocessor">#endif </span><span class="comment">/* DES_DEFAULT_OPTIONS */</span>
00721 
00722 
<a name="l00723"></a><a class="code" href="des_8c.html#a21">00723</a> <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a21">_shadow_DES_check_key</a>;
00724 
<a name="l00725"></a><a class="code" href="des_8c.html#a22">00725</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="des_8c.html#a22">odd_parity</a>[256]={
00726   1,  1,  2,  2,  4,  4,  7,  7,  8,  8, 11, 11, 13, 13, 14, 14,
00727  16, 16, 19, 19, 21, 21, 22, 22, 25, 25, 26, 26, 28, 28, 31, 31,
00728  32, 32, 35, 35, 37, 37, 38, 38, 41, 41, 42, 42, 44, 44, 47, 47,
00729  49, 49, 50, 50, 52, 52, 55, 55, 56, 56, 59, 59, 61, 61, 62, 62,
00730  64, 64, 67, 67, 69, 69, 70, 70, 73, 73, 74, 74, 76, 76, 79, 79,
00731  81, 81, 82, 82, 84, 84, 87, 87, 88, 88, 91, 91, 93, 93, 94, 94,
00732  97, 97, 98, 98,100,100,103,103,104,104,107,107,109,109,110,110,
00733 112,112,115,115,117,117,118,118,121,121,122,122,124,124,127,127,
00734 128,128,131,131,133,133,134,134,137,137,138,138,140,140,143,143,
00735 145,145,146,146,148,148,151,151,152,152,155,155,157,157,158,158,
00736 161,161,162,162,164,164,167,167,168,168,171,171,173,173,174,174,
00737 176,176,179,179,181,181,182,182,185,185,186,186,188,188,191,191,
00738 193,193,194,194,196,196,199,199,200,200,203,203,205,205,206,206,
00739 208,208,211,211,213,213,214,214,217,217,218,218,220,220,223,223,
00740 224,224,227,227,229,229,230,230,233,233,234,234,236,236,239,239,
00741 241,241,242,242,244,244,247,247,248,248,251,251,253,253,254,254};
00742 
<a name="l00743"></a><a class="code" href="des_8c.html#a32">00743</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a32">DES_set_odd_parity</a>(<a class="code" href="des_8h.html#a3">DES_cblock</a> *key)
00744 {
00745         <span class="keywordtype">int</span> i;
00746 
00747         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="des_8c.html#a0">DES_KEY_SZ</a>; i++)
00748                 (*key)[i]=<a class="code" href="des_8c.html#a22">odd_parity</a>[(*key)[i]];
00749 }
00750 
<a name="l00751"></a><a class="code" href="des_8c.html#a33">00751</a> <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a33">DES_check_key_parity</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key)
00752 {
00753         <span class="keywordtype">int</span> i;
00754 
00755         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="des_8c.html#a0">DES_KEY_SZ</a>; i++)
00756                 {
00757                 <span class="keywordflow">if</span> ((*key)[i] != <a class="code" href="des_8c.html#a22">odd_parity</a>[(*key)[i]])
00758                         <span class="keywordflow">return</span>(0);
00759                 }
00760         <span class="keywordflow">return</span>(1);
00761 }
00762 
00763 <span class="comment">/* Weak and semi week keys as take from</span>
00764 <span class="comment"> * %A D.W. Davies</span>
00765 <span class="comment"> * %A W.L. Price</span>
00766 <span class="comment"> * %T Security for Computer Networks</span>
00767 <span class="comment"> * %I John Wiley &amp; Sons</span>
00768 <span class="comment"> * %D 1984</span>
00769 <span class="comment"> * Many thanks to smb@ulysses.att.com (Steven Bellovin) for the reference</span>
00770 <span class="comment"> * (and actual cblock values).</span>
00771 <span class="comment"> */</span>
<a name="l00772"></a><a class="code" href="des_8c.html#a18">00772</a> <span class="preprocessor">#define NUM_WEAK_KEY    16</span>
<a name="l00773"></a><a class="code" href="des_8c.html#a23">00773</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="des_8h.html#a3">DES_cblock</a> <a class="code" href="des_8c.html#a23">weak_keys</a>[<a class="code" href="des_8c.html#a18">NUM_WEAK_KEY</a>]={
00774         <span class="comment">/* weak keys */</span>
00775         {0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01},
00776         {0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE},
00777         {0x1F,0x1F,0x1F,0x1F,0x0E,0x0E,0x0E,0x0E},
00778         {0xE0,0xE0,0xE0,0xE0,0xF1,0xF1,0xF1,0xF1},
00779         <span class="comment">/* semi-weak keys */</span>
00780         {0x01,0xFE,0x01,0xFE,0x01,0xFE,0x01,0xFE},
00781         {0xFE,0x01,0xFE,0x01,0xFE,0x01,0xFE,0x01},
00782         {0x1F,0xE0,0x1F,0xE0,0x0E,0xF1,0x0E,0xF1},
00783         {0xE0,0x1F,0xE0,0x1F,0xF1,0x0E,0xF1,0x0E},
00784         {0x01,0xE0,0x01,0xE0,0x01,0xF1,0x01,0xF1},
00785         {0xE0,0x01,0xE0,0x01,0xF1,0x01,0xF1,0x01},
00786         {0x1F,0xFE,0x1F,0xFE,0x0E,0xFE,0x0E,0xFE},
00787         {0xFE,0x1F,0xFE,0x1F,0xFE,0x0E,0xFE,0x0E},
00788         {0x01,0x1F,0x01,0x1F,0x01,0x0E,0x01,0x0E},
00789         {0x1F,0x01,0x1F,0x01,0x0E,0x01,0x0E,0x01},
00790         {0xE0,0xFE,0xE0,0xFE,0xF1,0xFE,0xF1,0xFE},
00791         {0xFE,0xE0,0xFE,0xE0,0xFE,0xF1,0xFE,0xF1}};
00792 
<a name="l00793"></a><a class="code" href="des_8c.html#a34">00793</a> <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a34">DES_is_weak_key</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key)
00794 {
00795         <span class="keywordtype">int</span> i;
00796 
00797         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="des_8c.html#a18">NUM_WEAK_KEY</a>; i++)
00798                 <span class="comment">/* Added == 0 to comparison, I obviously don't run</span>
00799 <span class="comment">                 * this section very often :-(, thanks to</span>
00800 <span class="comment">                 * engineering@MorningStar.Com for the fix</span>
00801 <span class="comment">                 * eay 93/06/29</span>
00802 <span class="comment">                 * Another problem, I was comparing only the first 4</span>
00803 <span class="comment">                 * bytes, 97/03/18 */</span>
00804                 <span class="keywordflow">if</span> (memcmp(<a class="code" href="des_8c.html#a23">weak_keys</a>[i],key,<span class="keyword">sizeof</span>(<a class="code" href="des_8h.html#a3">DES_cblock</a>)) == 0) <span class="keywordflow">return</span>(1);
00805         <span class="keywordflow">return</span>(0);
00806 }
00807 
00808 <span class="comment">/* NOW DEFINED IN des_local.h</span>
00809 <span class="comment"> * See ecb_encrypt.c for a pseudo description of these macros. </span>
00810 <span class="comment"> * #define PERM_OP(a,b,t,n,m) ((t)=((((a)&gt;&gt;(n))^(b))&amp;(m)),\</span>
00811 <span class="comment"> *      (b)^=(t),\</span>
00812 <span class="comment"> *      (a)=((a)^((t)&lt;&lt;(n))))</span>
00813 <span class="comment"> */</span>
00814 
<a name="l00815"></a><a class="code" href="des_8c.html#a19">00815</a> <span class="preprocessor">#define HPERM_OP(a,t,n,m) ((t)=((((a)&lt;&lt;(16-(n)))^(a))&amp;(m)),\</span>
00816 <span class="preprocessor">        (a)=(a)^(t)^(t&gt;&gt;(16-(n))))</span>
00817 <span class="preprocessor"></span>
<a name="l00818"></a><a class="code" href="des_8c.html#a24">00818</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="des_8h.html#a0">DES_LONG</a> <a class="code" href="des_8c.html#a24">des_skb</a>[8][64]={
00819         {
00820         <span class="comment">/* for C bits (numbered as per FIPS 46) 1 2 3 4 5 6 */</span>
00821         0x00000000L,0x00000010L,0x20000000L,0x20000010L,
00822         0x00010000L,0x00010010L,0x20010000L,0x20010010L,
00823         0x00000800L,0x00000810L,0x20000800L,0x20000810L,
00824         0x00010800L,0x00010810L,0x20010800L,0x20010810L,
00825         0x00000020L,0x00000030L,0x20000020L,0x20000030L,
00826         0x00010020L,0x00010030L,0x20010020L,0x20010030L,
00827         0x00000820L,0x00000830L,0x20000820L,0x20000830L,
00828         0x00010820L,0x00010830L,0x20010820L,0x20010830L,
00829         0x00080000L,0x00080010L,0x20080000L,0x20080010L,
00830         0x00090000L,0x00090010L,0x20090000L,0x20090010L,
00831         0x00080800L,0x00080810L,0x20080800L,0x20080810L,
00832         0x00090800L,0x00090810L,0x20090800L,0x20090810L,
00833         0x00080020L,0x00080030L,0x20080020L,0x20080030L,
00834         0x00090020L,0x00090030L,0x20090020L,0x20090030L,
00835         0x00080820L,0x00080830L,0x20080820L,0x20080830L,
00836         0x00090820L,0x00090830L,0x20090820L,0x20090830L,
00837         },{
00838         <span class="comment">/* for C bits (numbered as per FIPS 46) 7 8 10 11 12 13 */</span>
00839         0x00000000L,0x02000000L,0x00002000L,0x02002000L,
00840         0x00200000L,0x02200000L,0x00202000L,0x02202000L,
00841         0x00000004L,0x02000004L,0x00002004L,0x02002004L,
00842         0x00200004L,0x02200004L,0x00202004L,0x02202004L,
00843         0x00000400L,0x02000400L,0x00002400L,0x02002400L,
00844         0x00200400L,0x02200400L,0x00202400L,0x02202400L,
00845         0x00000404L,0x02000404L,0x00002404L,0x02002404L,
00846         0x00200404L,0x02200404L,0x00202404L,0x02202404L,
00847         0x10000000L,0x12000000L,0x10002000L,0x12002000L,
00848         0x10200000L,0x12200000L,0x10202000L,0x12202000L,
00849         0x10000004L,0x12000004L,0x10002004L,0x12002004L,
00850         0x10200004L,0x12200004L,0x10202004L,0x12202004L,
00851         0x10000400L,0x12000400L,0x10002400L,0x12002400L,
00852         0x10200400L,0x12200400L,0x10202400L,0x12202400L,
00853         0x10000404L,0x12000404L,0x10002404L,0x12002404L,
00854         0x10200404L,0x12200404L,0x10202404L,0x12202404L,
00855         },{
00856         <span class="comment">/* for C bits (numbered as per FIPS 46) 14 15 16 17 19 20 */</span>
00857         0x00000000L,0x00000001L,0x00040000L,0x00040001L,
00858         0x01000000L,0x01000001L,0x01040000L,0x01040001L,
00859         0x00000002L,0x00000003L,0x00040002L,0x00040003L,
00860         0x01000002L,0x01000003L,0x01040002L,0x01040003L,
00861         0x00000200L,0x00000201L,0x00040200L,0x00040201L,
00862         0x01000200L,0x01000201L,0x01040200L,0x01040201L,
00863         0x00000202L,0x00000203L,0x00040202L,0x00040203L,
00864         0x01000202L,0x01000203L,0x01040202L,0x01040203L,
00865         0x08000000L,0x08000001L,0x08040000L,0x08040001L,
00866         0x09000000L,0x09000001L,0x09040000L,0x09040001L,
00867         0x08000002L,0x08000003L,0x08040002L,0x08040003L,
00868         0x09000002L,0x09000003L,0x09040002L,0x09040003L,
00869         0x08000200L,0x08000201L,0x08040200L,0x08040201L,
00870         0x09000200L,0x09000201L,0x09040200L,0x09040201L,
00871         0x08000202L,0x08000203L,0x08040202L,0x08040203L,
00872         0x09000202L,0x09000203L,0x09040202L,0x09040203L,
00873         },{
00874         <span class="comment">/* for C bits (numbered as per FIPS 46) 21 23 24 26 27 28 */</span>
00875         0x00000000L,0x00100000L,0x00000100L,0x00100100L,
00876         0x00000008L,0x00100008L,0x00000108L,0x00100108L,
00877         0x00001000L,0x00101000L,0x00001100L,0x00101100L,
00878         0x00001008L,0x00101008L,0x00001108L,0x00101108L,
00879         0x04000000L,0x04100000L,0x04000100L,0x04100100L,
00880         0x04000008L,0x04100008L,0x04000108L,0x04100108L,
00881         0x04001000L,0x04101000L,0x04001100L,0x04101100L,
00882         0x04001008L,0x04101008L,0x04001108L,0x04101108L,
00883         0x00020000L,0x00120000L,0x00020100L,0x00120100L,
00884         0x00020008L,0x00120008L,0x00020108L,0x00120108L,
00885         0x00021000L,0x00121000L,0x00021100L,0x00121100L,
00886         0x00021008L,0x00121008L,0x00021108L,0x00121108L,
00887         0x04020000L,0x04120000L,0x04020100L,0x04120100L,
00888         0x04020008L,0x04120008L,0x04020108L,0x04120108L,
00889         0x04021000L,0x04121000L,0x04021100L,0x04121100L,
00890         0x04021008L,0x04121008L,0x04021108L,0x04121108L,
00891         },{
00892         <span class="comment">/* for D bits (numbered as per FIPS 46) 1 2 3 4 5 6 */</span>
00893         0x00000000L,0x10000000L,0x00010000L,0x10010000L,
00894         0x00000004L,0x10000004L,0x00010004L,0x10010004L,
00895         0x20000000L,0x30000000L,0x20010000L,0x30010000L,
00896         0x20000004L,0x30000004L,0x20010004L,0x30010004L,
00897         0x00100000L,0x10100000L,0x00110000L,0x10110000L,
00898         0x00100004L,0x10100004L,0x00110004L,0x10110004L,
00899         0x20100000L,0x30100000L,0x20110000L,0x30110000L,
00900         0x20100004L,0x30100004L,0x20110004L,0x30110004L,
00901         0x00001000L,0x10001000L,0x00011000L,0x10011000L,
00902         0x00001004L,0x10001004L,0x00011004L,0x10011004L,
00903         0x20001000L,0x30001000L,0x20011000L,0x30011000L,
00904         0x20001004L,0x30001004L,0x20011004L,0x30011004L,
00905         0x00101000L,0x10101000L,0x00111000L,0x10111000L,
00906         0x00101004L,0x10101004L,0x00111004L,0x10111004L,
00907         0x20101000L,0x30101000L,0x20111000L,0x30111000L,
00908         0x20101004L,0x30101004L,0x20111004L,0x30111004L,
00909         },{
00910         <span class="comment">/* for D bits (numbered as per FIPS 46) 8 9 11 12 13 14 */</span>
00911         0x00000000L,0x08000000L,0x00000008L,0x08000008L,
00912         0x00000400L,0x08000400L,0x00000408L,0x08000408L,
00913         0x00020000L,0x08020000L,0x00020008L,0x08020008L,
00914         0x00020400L,0x08020400L,0x00020408L,0x08020408L,
00915         0x00000001L,0x08000001L,0x00000009L,0x08000009L,
00916         0x00000401L,0x08000401L,0x00000409L,0x08000409L,
00917         0x00020001L,0x08020001L,0x00020009L,0x08020009L,
00918         0x00020401L,0x08020401L,0x00020409L,0x08020409L,
00919         0x02000000L,0x0A000000L,0x02000008L,0x0A000008L,
00920         0x02000400L,0x0A000400L,0x02000408L,0x0A000408L,
00921         0x02020000L,0x0A020000L,0x02020008L,0x0A020008L,
00922         0x02020400L,0x0A020400L,0x02020408L,0x0A020408L,
00923         0x02000001L,0x0A000001L,0x02000009L,0x0A000009L,
00924         0x02000401L,0x0A000401L,0x02000409L,0x0A000409L,
00925         0x02020001L,0x0A020001L,0x02020009L,0x0A020009L,
00926         0x02020401L,0x0A020401L,0x02020409L,0x0A020409L,
00927         },{
00928         <span class="comment">/* for D bits (numbered as per FIPS 46) 16 17 18 19 20 21 */</span>
00929         0x00000000L,0x00000100L,0x00080000L,0x00080100L,
00930         0x01000000L,0x01000100L,0x01080000L,0x01080100L,
00931         0x00000010L,0x00000110L,0x00080010L,0x00080110L,
00932         0x01000010L,0x01000110L,0x01080010L,0x01080110L,
00933         0x00200000L,0x00200100L,0x00280000L,0x00280100L,
00934         0x01200000L,0x01200100L,0x01280000L,0x01280100L,
00935         0x00200010L,0x00200110L,0x00280010L,0x00280110L,
00936         0x01200010L,0x01200110L,0x01280010L,0x01280110L,
00937         0x00000200L,0x00000300L,0x00080200L,0x00080300L,
00938         0x01000200L,0x01000300L,0x01080200L,0x01080300L,
00939         0x00000210L,0x00000310L,0x00080210L,0x00080310L,
00940         0x01000210L,0x01000310L,0x01080210L,0x01080310L,
00941         0x00200200L,0x00200300L,0x00280200L,0x00280300L,
00942         0x01200200L,0x01200300L,0x01280200L,0x01280300L,
00943         0x00200210L,0x00200310L,0x00280210L,0x00280310L,
00944         0x01200210L,0x01200310L,0x01280210L,0x01280310L,
00945         },{
00946         <span class="comment">/* for D bits (numbered as per FIPS 46) 22 23 24 25 27 28 */</span>
00947         0x00000000L,0x04000000L,0x00040000L,0x04040000L,
00948         0x00000002L,0x04000002L,0x00040002L,0x04040002L,
00949         0x00002000L,0x04002000L,0x00042000L,0x04042000L,
00950         0x00002002L,0x04002002L,0x00042002L,0x04042002L,
00951         0x00000020L,0x04000020L,0x00040020L,0x04040020L,
00952         0x00000022L,0x04000022L,0x00040022L,0x04040022L,
00953         0x00002020L,0x04002020L,0x00042020L,0x04042020L,
00954         0x00002022L,0x04002022L,0x00042022L,0x04042022L,
00955         0x00000800L,0x04000800L,0x00040800L,0x04040800L,
00956         0x00000802L,0x04000802L,0x00040802L,0x04040802L,
00957         0x00002800L,0x04002800L,0x00042800L,0x04042800L,
00958         0x00002802L,0x04002802L,0x00042802L,0x04042802L,
00959         0x00000820L,0x04000820L,0x00040820L,0x04040820L,
00960         0x00000822L,0x04000822L,0x00040822L,0x04040822L,
00961         0x00002820L,0x04002820L,0x00042820L,0x04042820L,
00962         0x00002822L,0x04002822L,0x00042822L,0x04042822L,
00963         }};
00964 
<a name="l00965"></a><a class="code" href="des_8c.html#a35">00965</a> <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a35">DES_set_key</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule)
00966 {
00967         <span class="keywordflow">if</span> (<a class="code" href="des_8c.html#a21">_shadow_DES_check_key</a>)
00968                 {
00969                 <span class="keywordflow">return</span> <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>(key, schedule);
00970                 }
00971         <span class="keywordflow">else</span>
00972                 {
00973                 <a class="code" href="des_8h.html#a7">DES_set_key_unchecked</a>(key, schedule);
00974                 <span class="keywordflow">return</span> 0;
00975                 }
00976 }
00977 
00978 <span class="comment">/* return 0 if key parity is odd (correct),</span>
00979 <span class="comment"> * return -1 if key parity error,</span>
00980 <span class="comment"> * return -2 if illegal weak key.</span>
00981 <span class="comment"> */</span>
<a name="l00982"></a><a class="code" href="des_8c.html#a37">00982</a> <span class="keywordtype">int</span> <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule)
00983 {
00984         <span class="keywordflow">if</span> (!<a class="code" href="des_8c.html#a33">DES_check_key_parity</a>(key))
00985                 <span class="keywordflow">return</span>(-1);
00986         <span class="keywordflow">if</span> (<a class="code" href="des_8c.html#a34">DES_is_weak_key</a>(key))
00987                 <span class="keywordflow">return</span>(-2);
00988         <a class="code" href="des_8h.html#a7">DES_set_key_unchecked</a>(key, schedule);
00989         <span class="keywordflow">return</span> 0;
00990 }
00991 
<a name="l00992"></a><a class="code" href="des_8c.html#a38">00992</a> <span class="keywordtype">void</span> <a class="code" href="des_8h.html#a7">DES_set_key_unchecked</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule)
00993 {
00994         <span class="keyword">static</span> <span class="keywordtype">int</span> shifts2[16]={0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0};
00995         <a class="code" href="des_8h.html#a0">DES_LONG</a> c,d,t,s,t2;
00996         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in;
00997         <a class="code" href="des_8h.html#a0">DES_LONG</a> *k;
00998         <span class="keywordtype">int</span> i;
00999 
01000         k = &amp;schedule-&gt;<a class="code" href="structDES__ks.html#o2">ks</a>-&gt;deslong[0];
01001         in = &amp;(*key)[0];
01002 
01003         <a class="code" href="des_8c.html#a4">c2l</a>(in,c);
01004         <a class="code" href="des_8c.html#a4">c2l</a>(in,d);
01005 
01006         <span class="comment">/* do PC1 in 47 simple operations :-)</span>
01007 <span class="comment">         * Thanks to John Fletcher (john_fletcher@lccmail.ocf.llnl.gov)</span>
01008 <span class="comment">         * for the inspiration. :-) */</span>
01009         <a class="code" href="des_8c.html#a15">PERM_OP</a> (d,c,t,4,0x0f0f0f0fL);
01010         <a class="code" href="des_8c.html#a19">HPERM_OP</a>(c,t,-2,0xcccc0000L);
01011         <a class="code" href="des_8c.html#a19">HPERM_OP</a>(d,t,-2,0xcccc0000L);
01012         <a class="code" href="des_8c.html#a15">PERM_OP</a> (d,c,t,1,0x55555555L);
01013         <a class="code" href="des_8c.html#a15">PERM_OP</a> (c,d,t,8,0x00ff00ffL);
01014         <a class="code" href="des_8c.html#a15">PERM_OP</a> (d,c,t,1,0x55555555L);
01015         d=      (((d&amp;0x000000ffL)&lt;&lt;16L)| (d&amp;0x0000ff00L)     |
01016                  ((d&amp;0x00ff0000L)&gt;&gt;16L)|((c&amp;0xf0000000L)&gt;&gt;4L));
01017         c&amp;=0x0fffffffL;
01018 
01019         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="des_8c.html#a2">ITERATIONS</a>; i++)
01020                 {
01021                 <span class="keywordflow">if</span> (shifts2[i])
01022                         { c=((c&gt;&gt;2L)|(c&lt;&lt;26L)); d=((d&gt;&gt;2L)|(d&lt;&lt;26L)); }
01023                 <span class="keywordflow">else</span>
01024                         { c=((c&gt;&gt;1L)|(c&lt;&lt;27L)); d=((d&gt;&gt;1L)|(d&lt;&lt;27L)); }
01025                 c&amp;=0x0fffffffL;
01026                 d&amp;=0x0fffffffL;
01027                 <span class="comment">/* could be a few less shifts but I am to lazy at this</span>
01028 <span class="comment">                 * point in time to investigate */</span>
01029                 s=      <a class="code" href="des_8c.html#a24">des_skb</a>[0][ (c    )&amp;0x3f                ]|
01030                         <a class="code" href="des_8c.html#a24">des_skb</a>[1][((c&gt;&gt; 6L)&amp;0x03)|((c&gt;&gt; 7L)&amp;0x3c)]|
01031                         <a class="code" href="des_8c.html#a24">des_skb</a>[2][((c&gt;&gt;13L)&amp;0x0f)|((c&gt;&gt;14L)&amp;0x30)]|
01032                         <a class="code" href="des_8c.html#a24">des_skb</a>[3][((c&gt;&gt;20L)&amp;0x01)|((c&gt;&gt;21L)&amp;0x06) |
01033                                                   ((c&gt;&gt;22L)&amp;0x38)];
01034                 t=      <a class="code" href="des_8c.html#a24">des_skb</a>[4][ (d    )&amp;0x3f                ]|
01035                         <a class="code" href="des_8c.html#a24">des_skb</a>[5][((d&gt;&gt; 7L)&amp;0x03)|((d&gt;&gt; 8L)&amp;0x3c)]|
01036                         <a class="code" href="des_8c.html#a24">des_skb</a>[6][ (d&gt;&gt;15L)&amp;0x3f                ]|
01037                         <a class="code" href="des_8c.html#a24">des_skb</a>[7][((d&gt;&gt;21L)&amp;0x0f)|((d&gt;&gt;22L)&amp;0x30)];
01038 
01039                 <span class="comment">/* table contained 0213 4657 */</span>
01040                 t2=((t&lt;&lt;16L)|(s&amp;0x0000ffffL))&amp;0xffffffffL;
01041                 *(k++)=<a class="code" href="des_8c.html#a11">ROTATE</a>(t2,30)&amp;0xffffffffL;
01042 
01043                 t2=((s&gt;&gt;16L)|(t&amp;0xffff0000L));
01044                 *(k++)=<a class="code" href="des_8c.html#a11">ROTATE</a>(t2,26)&amp;0xffffffffL;
01045                 }
01046 }
01047 
<a name="l01048"></a><a class="code" href="des_8c.html#a36">01048</a> <span class="keywordtype">int</span> <a class="code" href="des_8c.html#a36">DES_key_sched</a>(<a class="code" href="des_8h.html#a4">const_DES_cblock</a> *key, <a class="code" href="structDES__ks.html">DES_key_schedule</a> *schedule)
01049 {
01050         <span class="keywordflow">return</span>(<a class="code" href="des_8c.html#a35">DES_set_key</a>(key,schedule));
01051 }
01052 
01053 
01054 
<a name="l01067"></a><a class="code" href="des_8c.html#a39">01067</a> <span class="keywordtype">void</span> <a class="code" href="des_8c.html#a39">cipher_3des_cbc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* text, <span class="keywordtype">int</span> text_len, 
01068                      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* key, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* iv, <span class="keywordtype">int</span> mode, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  output)
01069 {
01070         <span class="keywordtype">int</span> ret_val;
01071         <a class="code" href="structDES__ks.html">DES_key_schedule</a> ks1, ks2, ks3;
01072 
01073         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER, 
01074                       <span class="stringliteral">"cipher_3des_cbc"</span>, 
01075                                   (<span class="stringliteral">"text=%p, text_len=%d, key=%p, iv=%p, mode=%d, output=%p"</span>,
01076                               (<span class="keywordtype">void</span> *)text, text_len, (<span class="keywordtype">void</span> *)key, (<span class="keywordtype">void</span> *)iv, <a class="code" href="sa_8h.html#a24">mode</a>, (<span class="keywordtype">void</span> *)output)
01077                                  );
01078 
01079         ret_val = <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>((<a class="code" href="des_8h.html#a4">const_DES_cblock</a>*)(key + 0*8), &amp;ks1);
01080         <span class="keywordflow">if</span>(ret_val != 0) {
01081                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_esp_decapsulate"</span>, <a class="code" href="types_8h.html#a38a21">IPSEC_STATUS_BAD_KEY</a>, (<span class="stringliteral">"DES_set_key_checked(&amp;cbc1_key,&amp;ks1) could not set 1st 3DES key - ret_val = %d\n"</span>, ret_val)) ;
01082                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"cipher_3des_cbc"</span>, (<span class="stringliteral">"void"</span>) );
01083                 <span class="keywordflow">return</span>;
01084         }
01085 
01086         ret_val = <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>((<a class="code" href="des_8h.html#a4">const_DES_cblock</a>*)(key + 1*8), &amp;ks2);
01087         <span class="keywordflow">if</span>(ret_val != 0) {
01088                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_esp_decapsulate"</span>, <a class="code" href="types_8h.html#a38a21">IPSEC_STATUS_BAD_KEY</a>, (<span class="stringliteral">"DES_set_key_checked(&amp;cbc2_key,&amp;ks2) could not set 2nd 3DES key - ret_val = %d\n"</span>, ret_val)) ;
01089                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"cipher_3des_cbc"</span>, (<span class="stringliteral">"void"</span>) );
01090                 <span class="keywordflow">return</span>;
01091         }
01092 
01093         ret_val = <a class="code" href="des_8h.html#a6">DES_set_key_checked</a>((<a class="code" href="des_8h.html#a4">const_DES_cblock</a>*)(key + 2*8), &amp;ks3);
01094         <span class="keywordflow">if</span>(ret_val != 0) {
01095                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_esp_decapsulate"</span>, <a class="code" href="types_8h.html#a38a21">IPSEC_STATUS_BAD_KEY</a>, (<span class="stringliteral">"DES_set_key_checked(&amp;cbc3_key,&amp;ks3) could not set 3rd 3DES key - ret_val = %d\n"</span>, ret_val)) ;
01096                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"cipher_3des_cbc"</span>, (<span class="stringliteral">"void"</span>) );
01097                 <span class="keywordflow">return</span>;
01098         }
01099 
01100         <a class="code" href="des_8c.html#a31">DES_ede3_cbc_encrypt</a>(text, output, text_len, (<a class="code" href="structDES__ks.html">DES_key_schedule</a> *)&amp;ks1 ,(<a class="code" href="structDES__ks.html">DES_key_schedule</a> *)&amp;ks2, (<a class="code" href="structDES__ks.html">DES_key_schedule</a> *)&amp;ks3, (<a class="code" href="des_8h.html#a3">DES_cblock</a>*)iv, <a class="code" href="sa_8h.html#a24">mode</a>);
01101 
01102         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"cipher_3des_cbc"</span>, (<span class="stringliteral">"void"</span>) );
01103 }
01104 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
