<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ipsec.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
embedded IPsec implementation (tunnel mode with manual keying only) 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Christian Scheurer &lt;<a href="http://www.christianscheurer.ch">http://www.christianscheurer.ch</a>&gt; <br>
</dd></dl>
<b>OUTLINE:</b><p>
The different IPsec functions are glued together at this place. All intercepted inbound and outbound traffic which require IPsec processing is passed to this module. The packets are then processed processes according their SA.<p>
<b>IMPLEMENTATION:</b><p>
For SA management code of the <a class="el" href="sa_8c.html">sa.c</a> module was used. Then AH and ESP functionality out of <a class="el" href="ah_8c.html">ah.c</a> and <a class="el" href="esp_8c.html">esp.c</a> was used to process the packets properly.<p>
<b>NOTES:</b><p>
This document is part of <em>embedded IPsec<br>
 Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne<br>
 All rights reserved.</em><hr>

<p>
Definition in file <a class="el" href="ipsec_8c-source.html">ipsec.c</a>.
<p>
<code>#include "<a class="el" href="debug_8h-source.html">ipsec/debug.h</a>"</code><br>
<code>#include "<a class="el" href="ipsec_8h-source.html">ipsec/ipsec.h</a>"</code><br>
<code>#include "<a class="el" href="util_8h-source.html">ipsec/util.h</a>"</code><br>
<code>#include "<a class="el" href="sa_8h-source.html">ipsec/sa.h</a>"</code><br>
<code>#include "<a class="el" href="ah_8h-source.html">ipsec/ah.h</a>"</code><br>
<code>#include "<a class="el" href="esp_8h-source.html">ipsec/esp.h</a>"</code><br>

<p>
<a href="ipsec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ipsec_8c.html#a0">ipsec_input</a> (unsigned char *packet, int packet_size, int *payload_offset, int *payload_size, <a class="el" href="structdb__set__netif__struct.html">db_set_netif</a> *<a class="el" href="ipsecdev_8c.html#a7">databases</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="ipsec_8c.html#a1">ipsec_output</a> (unsigned char *packet, int packet_size, int *payload_offset, int *payload_size, <a class="el" href="types_8h.html#a4">__u32</a> src, <a class="el" href="types_8h.html#a4">__u32</a> dst, <a class="el" href="structspd__entry__struct.html">spd_entry</a> *spd)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="ipsec.c::ipsec_input" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int ipsec_input </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>packet_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structdb__set__netif__struct.html">db_set_netif</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>databases</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
IPsec input processing<p>
This function is called by the ipsec device driver when a packet arrives having AH or ESP in the protocol field. A SA lookup gets the appropriate SA which is then passed to the packet processing funciton <a class="el" href="ah_8c.html#a2">ipsec_ah_check()</a> or <a class="el" href="esp_8c.html#a3">ipsec_esp_decapsulate()</a>. After successfully processing an IPsec packet an check together with an SPD lookup verifies if the packet was processed acording the right SA.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>packet</em>&nbsp;</td><td>pointer used to access the intercepted original packet </td></tr>
    <tr><td valign=top><em>packet_size</em>&nbsp;</td><td>length of the intercepted packet </td></tr>
    <tr><td valign=top><em>payload_offset</em>&nbsp;</td><td>pointer used to return offset of the new IP packet relative to original packet pointer </td></tr>
    <tr><td valign=top><em>payload_size</em>&nbsp;</td><td>pointer used to return total size of the new IP packet </td></tr>
    <tr><td valign=top><em>databases</em>&nbsp;</td><td>Collection of all security policy databases for the active IPsec device </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>int return status code </dd></dl>

<p>
Definition at line <a class="el" href="ipsec_8c-source.html#l00081">81</a> of file <a class="el" href="ipsec_8c-source.html">ipsec.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ipsec.c::ipsec_output" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int ipsec_output </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>packet</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>packet_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_offset</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>payload_size</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>src</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="types_8h.html#a4">__u32</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dst</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="structspd__entry__struct.html">spd_entry</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>spd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
IPsec output processing<p>
This function is called when outbound packets need IPsec processing. Depending the SA, passed via the SPD entry <a class="el" href="ah_8c.html#a2">ipsec_ah_check()</a> and <a class="el" href="esp_8c.html#a4">ipsec_esp_encapsulate()</a> is called to encapsulate the packet in a IPsec header.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>packet</em>&nbsp;</td><td>pointer used to access the intercepted original packet </td></tr>
    <tr><td valign=top><em>packet_size</em>&nbsp;</td><td>length of the intercepted packet </td></tr>
    <tr><td valign=top><em>payload_offset</em>&nbsp;</td><td>pointer used to return offset of the new IP packet relative to original packet pointer </td></tr>
    <tr><td valign=top><em>payload_size</em>&nbsp;</td><td>pointer used to return total size of the new IP packet </td></tr>
    <tr><td valign=top><em>src</em>&nbsp;</td><td>IP address of the local tunnel start point (external IP address) </td></tr>
    <tr><td valign=top><em>dst</em>&nbsp;</td><td>IP address of the remote tunnel end point (external IP address) </td></tr>
    <tr><td valign=top><em>spd</em>&nbsp;</td><td>pointer to security policy database where the rules for IPsec processing are stored </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>int return status code</dd></dl>
<dl compact><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>invoke IKE to generate a proper SA for this SPD entry</dd></dl>

<p>
Definition at line <a class="el" href="ipsec_8c-source.html#l00193">193</a> of file <a class="el" href="ipsec_8c-source.html">ipsec.c</a>.    </td>
  </tr>
</table>
	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
