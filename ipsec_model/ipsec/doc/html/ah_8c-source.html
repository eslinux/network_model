<html>
<head>
<title>embedded IPsec - IPsec library</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2 align="left"><img src="logo_small.gif" alt="embedded IPsec"> source 
        code documentation </h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ah.c</h1><a href="ah_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * embedded IPsec</span>
00003 <span class="comment"> * Copyright (c) 2003 Niklaus Schild and Christian Scheurer, HTI Biel/Bienne</span>
00004 <span class="comment"> * All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00007 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00012 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00013 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00014 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00015 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00019 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00020 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00021 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00022 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00023 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00024 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00025 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00026 <span class="comment"> * OF SUCH DAMAGE.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 
00062 <span class="preprocessor">#include &lt;string.h&gt;</span>
00063 
00064 <span class="preprocessor">#include "<a class="code" href="ipsec_8h.html">ipsec/ipsec.h</a>"</span>
00065 <span class="preprocessor">#include "<a class="code" href="util_8h.html">ipsec/util.h</a>"</span>
00066 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">ipsec/debug.h</a>"</span>
00067 
00068 <span class="preprocessor">#include "<a class="code" href="sa_8h.html">ipsec/sa.h</a>"</span>
00069 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">ipsec/md5.h</a>"</span>
00070 <span class="preprocessor">#include "<a class="code" href="sha1_8h.html">ipsec/sha1.h</a>"</span>
00071 
00072 <span class="preprocessor">#include "<a class="code" href="ah_8h.html">ipsec/ah.h</a>"</span>
00073 
00074 
00075 
<a name="l00076"></a><a class="code" href="ah_8c.html#a0">00076</a> <a class="code" href="types_8h.html#a4">__u32</a> <a class="code" href="ah_8c.html#a0">ipsec_ah_bitmap</a>   = 0;                    
<a name="l00079"></a><a class="code" href="ah_8c.html#a1">00079</a> <a class="code" href="types_8h.html#a4">__u32</a> <a class="code" href="ah_8c.html#a1">ipsec_ah_lastSeq</a>  = 0;                    
<a name="l00100"></a><a class="code" href="ah_8c.html#a2">00100</a> <span class="keywordtype">int</span> <a class="code" href="ah_8h.html#a4">ipsec_ah_check</a>(<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *outer_packet, <span class="keywordtype">int</span> *payload_offset, <span class="keywordtype">int</span> *payload_size,
00101                                     <a class="code" href="structsa__entry__struct.html">sad_entry</a> *sa)
00102 {
00103         <span class="keywordtype">int</span> ret_val     = <a class="code" href="types_8h.html#a38a23">IPSEC_STATUS_NOT_INITIALIZED</a>; <span class="comment">/* by default, the return value is undefined */</span>
00104         <a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a> *ah_header;
00105         <span class="keywordtype">int</span> ah_len;
00106         <span class="keywordtype">int</span> ah_offs;
00107         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> orig_digest[<a class="code" href="ipsec_8h.html#a6">IPSEC_MAX_AUTHKEY_LEN</a>];
00108         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[<a class="code" href="ipsec_8h.html#a6">IPSEC_MAX_AUTHKEY_LEN</a>];
00109 
00110         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER,
00111                       <span class="stringliteral">"ipsec_ah_check"</span>,
00112                                   (<span class="stringliteral">"outer_packet=%p, *payload_offset=%d, *payload_size=%d sa=%p"</span>,
00113                               (<span class="keywordtype">void</span> *)outer_packet, *payload_offset, *payload_size, (<span class="keywordtype">void</span> *)sa)
00114                                  );
00115 
00116         <span class="comment">/* The AH header is expected to be 24 bytes since we support only 96 bit authentication values */</span>
00117         ah_offs = ((outer_packet-&gt;v_hl &amp; 0x0F) &lt;&lt; 2);
00118         ah_len = (<a class="code" href="ah_8h.html#a0">IPSEC_AH_HDR_SIZE</a> - 4) + ( ((<a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet + ah_offs))-&gt;len &lt;&lt; 2 );
00119 
00120         <span class="comment">/* minimal AH header + ICV */</span>
00121         <span class="keywordflow">if</span>(ah_len != <a class="code" href="ah_8h.html#a0">IPSEC_AH_HDR_SIZE</a> + <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>)
00122         {
00123                 <a class="code" href="debug_8h.html#a7">IPSEC_LOG_DBG</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"wrong AH header size: ah_len=%d (must be 24 bytes, only 96bit authentication values allowed)"</span>, ah_len) );
00124                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_check"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00125                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>;
00126         }
00127         
00128         ah_header = ((<a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet + ah_offs));
00129 
00130         <span class="comment">/* preliminary anti-replay check (without updating the global sequence number window)     */</span>
00131         <span class="comment">/* This check prevents useless ICV calculation if the Sequence Number is obviously wrong  */</span>
00132         ret_val = <a class="code" href="util_8c.html#a11">ipsec_check_replay_window</a>(<a class="code" href="util_8c.html#a7">ipsec_ntohl</a>(ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o4">sequence</a>), <a class="code" href="ah_8c.html#a1">ipsec_ah_lastSeq</a>, <a class="code" href="ah_8c.html#a0">ipsec_ah_bitmap</a>);
00133         <span class="keywordflow">if</span>(ret_val != <a class="code" href="types_8h.html#a39a24">IPSEC_AUDIT_SUCCESS</a>)
00134         {
00135                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a39a31">IPSEC_AUDIT_SEQ_MISMATCH</a>, (<span class="stringliteral">"packet rejected by anti-replay check (lastSeq=%08lx, seq=%08lx, window size=%d)"</span>, <a class="code" href="ah_8c.html#a1">ipsec_ah_lastSeq</a>, <a class="code" href="util_8c.html#a7">ipsec_ntohl</a>(ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o4">sequence</a>), <a class="code" href="ipsec_8h.html#a8">IPSEC_SEQ_MAX_WINDOW</a>) );
00136                 <span class="keywordflow">return</span> ret_val;
00137         }
00138         
00139         <span class="comment">/* zero all mutable fields prior to ICV calculation */</span>
00140         <span class="comment">/* mutuable fields according to RFC2402, 3.3.3.1.1.1. */</span>
00141         outer_packet-&gt;tos               = 0;
00142         outer_packet-&gt;offset    = 0;
00143         outer_packet-&gt;ttl               = 0;
00144         outer_packet-&gt;chksum    = 0;
00145 
00146         <span class="comment">/* backup 96bit HMAC before setting it to 0 */</span>
00147         memcpy(orig_digest, ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o5">ah_data</a>, <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>);
00148         memset(((<a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet + ah_offs))-&gt;ah_data, <span class="charliteral">'\0'</span>, <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>);
00149 
00150         <span class="keywordflow">if</span>(sa-&gt;<a class="code" href="structsa__entry__struct.html#o4">mode</a> != <a class="code" href="sa_8h.html#a7">IPSEC_TUNNEL</a>)
00151         {
00152                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>, (<span class="stringliteral">"Can't handle mode %d. Only mode %d (IPSEC_TUNNEL) is implemented."</span>, sa-&gt;<a class="code" href="structsa__entry__struct.html#o4">mode</a>, <a class="code" href="sa_8h.html#a7">IPSEC_TUNNEL</a>) );
00153                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_check"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>) );
00154                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>;
00155         }
00156 
00157         <span class="keywordflow">switch</span>(sa-&gt;<a class="code" href="structsa__entry__struct.html#o11">auth_alg</a>) {
00158 
00159                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a12">IPSEC_HMAC_MD5</a>:
00160                         <a class="code" href="md5_8c.html#a25">hmac_md5</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet, <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(outer_packet-&gt;len),
00161                                  (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sa-&gt;<a class="code" href="structsa__entry__struct.html#o12">authkey</a>, <a class="code" href="ipsec_8h.html#a4">IPSEC_AUTH_MD5_KEY_LEN</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;digest);
00162                         <span class="keywordflow">break</span>;
00163                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a13">IPSEC_HMAC_SHA1</a>:
00164                         <a class="code" href="sha1_8c.html#a36">hmac_sha1</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet, <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(outer_packet-&gt;len),
00165                                   (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sa-&gt;<a class="code" href="structsa__entry__struct.html#o12">authkey</a>, <a class="code" href="ipsec_8h.html#a5">IPSEC_AUTH_SHA1_KEY_LEN</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;digest);
00166                         <span class="keywordflow">break</span>;
00167                 <span class="keywordflow">default</span>:
00168                         <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"unknown HASH algorithm for this AH"</span>)) ;
00169                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_check"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00170                         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>;
00171         }
00172 
00173         <span class="keywordflow">if</span>(memcmp(orig_digest, digest, <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>) != 0) {
00174                 <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"AH ICV does not match"</span>)) ;
00175                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_check"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00176                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>;
00177         }
00178         
00179         <span class="comment">/* post-ICV calculationn anti-replay check (this call will update the global sequence number window) */</span>
00180         ret_val = <a class="code" href="util_8c.html#a12">ipsec_update_replay_window</a>(<a class="code" href="util_8c.html#a7">ipsec_ntohl</a>(ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o4">sequence</a>), (<a class="code" href="types_8h.html#a4">__u32</a> *)&amp;<a class="code" href="ah_8c.html#a1">ipsec_ah_lastSeq</a>, (<a class="code" href="types_8h.html#a4">__u32</a> *)&amp;<a class="code" href="ah_8c.html#a0">ipsec_ah_bitmap</a>);
00181         <span class="keywordflow">if</span>(ret_val != <a class="code" href="types_8h.html#a39a24">IPSEC_AUDIT_SUCCESS</a>)
00182         {
00183                 <a class="code" href="debug_8h.html#a9">IPSEC_LOG_AUD</a>(<span class="stringliteral">"ipsec_ah_check"</span>, <a class="code" href="types_8h.html#a39a31">IPSEC_AUDIT_SEQ_MISMATCH</a>, (<span class="stringliteral">"packet rejected by anti-replay update (lastSeq=%08lx, seq=%08lx, window size=%d)"</span>, <a class="code" href="ah_8c.html#a1">ipsec_ah_lastSeq</a>, <a class="code" href="util_8c.html#a7">ipsec_ntohl</a>(ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o4">sequence</a>), <a class="code" href="ipsec_8h.html#a8">IPSEC_SEQ_MAX_WINDOW</a>) );
00184                 <span class="keywordflow">return</span> ret_val;
00185         }
00186         
00187         *payload_offset = ah_offs + ah_len;
00188         *payload_size   = <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(((<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *)((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)outer_packet + ah_offs + ah_len))-&gt;len);
00189 
00190         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_check"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>) );
00191         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>;
00192 }
00193 
00194 
<a name="l00214"></a><a class="code" href="ah_8c.html#a3">00214</a> <span class="keywordtype">int</span> <a class="code" href="ah_8h.html#a5">ipsec_ah_encapsulate</a>(<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a> *inner_packet, <span class="keywordtype">int</span> *payload_offset, <span class="keywordtype">int</span> *payload_size,
00215                                                  <a class="code" href="structsa__entry__struct.html">sad_entry</a> *sa, <a class="code" href="types_8h.html#a4">__u32</a> src, <a class="code" href="types_8h.html#a4">__u32</a> dst
00216                                      )
00217 {
00218         <span class="keywordtype">int</span> ret_val = <a class="code" href="types_8h.html#a38a23">IPSEC_STATUS_NOT_INITIALIZED</a>;                     <span class="comment">/* by default, the return value is undefined */</span>
00219         <a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>         *new_ip_header ;
00220         <a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a>         *new_ah_header;
00221         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>           digest[<a class="code" href="ipsec_8h.html#a6">IPSEC_MAX_AUTHKEY_LEN</a>];
00222 
00223         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_ENTER,
00224                       <span class="stringliteral">"ipsec_ah_encapsulate"</span>,
00225                                   (<span class="stringliteral">"inner_packet=%p, *payload_offset=%d, *payload_size=%d sa=%p, src=%lu, dst=%lu"</span>,
00226                               (<span class="keywordtype">void</span> *)inner_packet, *payload_offset, *payload_size, (<span class="keywordtype">void</span> *)sa, src, dst)
00227                                  );
00228 
00229 
00230         <span class="comment">/* set new packet header pointers */</span>
00231         new_ip_header = (<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>*)(((<span class="keywordtype">char</span>*)inner_packet) - <a class="code" href="ah_8h.html#a0">IPSEC_AH_HDR_SIZE</a> - <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a> - <a class="code" href="ipsec_8h.html#a7">IPSEC_MIN_IPHDR_SIZE</a>) ;
00232         new_ah_header = (<a class="code" href="structah__hdr__struct.html">ipsec_ah_header</a>*)(((<span class="keywordtype">char</span>*)inner_packet) - <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a> - <a class="code" href="ah_8h.html#a0">IPSEC_AH_HDR_SIZE</a>) ;
00233 
00234         <span class="comment">/* decrement and check TTL */</span>
00236         <span class="comment">// inner_packet-&gt;ttl--;</span>
00237         <span class="comment">// inner_packet-&gt;chksum = ip_chksum(inner_packet, sizeof(ip_header));</span>
00238         <span class="keywordflow">if</span> (inner_packet-&gt;ttl == 0)
00239         {
00240                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_encapsulate"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a22">IPSEC_STATUS_TTL_EXPIRED</a>) );
00241                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a22">IPSEC_STATUS_TTL_EXPIRED</a>;
00242         }
00243 
00244         <span class="keywordflow">if</span>(<a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a> != 12)
00245         {
00246                 <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_encapsulate"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>) );
00247                 <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a13">IPSEC_STATUS_NOT_IMPLEMENTED</a>;
00248         }
00249 
00250 
00251         <span class="comment">/* increment Sequence Number Field by 1 for each AH packet (1st packet has squ==1) */</span>
00252         sa-&gt;sequence_number++;
00253 
00254         <span class="comment">/* set header fields */</span>
00255         new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o0">nexthdr</a>  = 0x04; <span class="comment">/* IP in IP */</span>
00256         new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o1">len</a>      = 0x04; <span class="comment">/* length is 4 for AH with 96bit ICV */</span>
00257         new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o2">reserved</a> = 0x0000;
00258         new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o3">spi</a>              = sa-&gt;spi;
00259         new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o4">sequence</a> = <a class="code" href="util_8c.html#a6">ipsec_htonl</a>(sa-&gt;sequence_number);
00260         memset(new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o5">ah_data</a>, <span class="charliteral">'\0'</span>, <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>);
00261 
00262         <span class="comment">/* setup IP header and zero all mutable fields prior to ICV calculation */</span>
00263         <span class="comment">/* mutable fields according to RFC2402, 3.3.3.1.1.1. */</span>
00264         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o0">v_hl</a>     = 0x45;
00265         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o1">tos</a>              = 0;
00266         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o2">len</a>              = <a class="code" href="util_8c.html#a4">ipsec_htons</a>(<a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(inner_packet-&gt;len) + <a class="code" href="ah_8h.html#a0">IPSEC_AH_HDR_SIZE</a> + <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a> + <a class="code" href="ipsec_8h.html#a7">IPSEC_MIN_IPHDR_SIZE</a>);
00267         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o3">id</a>               = 1000 ;        
00268         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o4">offset</a>   = 0;
00269         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o5">ttl</a>              = 0;
00270         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o6">protocol</a> = <a class="code" href="types_8h.html#a40a37">IPSEC_PROTO_AH</a>;
00271         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o7">chksum</a>   = 0;
00272         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o8">src</a>              = src;
00273         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o9">dest</a>     = dst;
00274 
00275         <span class="comment">/* calculate AH according the SA */</span>
00276         <span class="keywordflow">switch</span>(sa-&gt;auth_alg) {
00277 
00278                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a12">IPSEC_HMAC_MD5</a>:
00279                         <a class="code" href="md5_8c.html#a25">hmac_md5</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)new_ip_header, <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(new_ip_header-&gt;len),
00280                                  (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sa-&gt;authkey, <a class="code" href="ipsec_8h.html#a4">IPSEC_AUTH_MD5_KEY_LEN</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;digest);
00281                         <span class="keywordflow">break</span>;
00282                 <span class="keywordflow">case</span> <a class="code" href="sa_8h.html#a13">IPSEC_HMAC_SHA1</a>:
00283                         <a class="code" href="sha1_8c.html#a36">hmac_sha1</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)new_ip_header, <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(new_ip_header-&gt;len),
00284                                   (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sa-&gt;authkey, <a class="code" href="ipsec_8h.html#a5">IPSEC_AUTH_SHA1_KEY_LEN</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;digest);
00285                         <span class="keywordflow">break</span>;
00286                 <span class="keywordflow">default</span>:
00287                         <a class="code" href="debug_8h.html#a6">IPSEC_LOG_ERR</a>(<span class="stringliteral">"ipsec_ah_encapsulate"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>, (<span class="stringliteral">"unknown HASH algorithm for this AH"</span>) );
00288                         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_encapsulate"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>) );
00289                         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a14">IPSEC_STATUS_FAILURE</a>;
00290 
00291         }
00292 
00293         <span class="comment">/* insert ICV */</span>
00294         memcpy(new_ah_header-&gt;<a class="code" href="structah__hdr__struct.html#o5">ah_data</a>, digest, <a class="code" href="ipsec_8h.html#a3">IPSEC_AUTH_ICV</a>);
00295 
00296         <span class="comment">/* update outer IP header */</span>
00297         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o1">tos</a> = inner_packet-&gt;tos ;
00298         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o5">ttl</a> = 64 ;
00299 
00300         <span class="comment">/* set checksum */</span>
00301         new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o7">chksum</a> = <a class="code" href="util_8c.html#a9">ipsec_ip_chksum</a>(new_ip_header, <span class="keyword">sizeof</span>(<a class="code" href="structipsec__ip__hdr__struct.html">ipsec_ip_header</a>)) ;
00302 
00303         <span class="comment">/* setup return values */</span>
00304         *payload_size   = <a class="code" href="util_8c.html#a5">ipsec_ntohs</a>(new_ip_header-&gt;<a class="code" href="structipsec__ip__hdr__struct.html#o2">len</a>);
00305         *payload_offset = (((<span class="keywordtype">char</span>*)new_ip_header) - ((<span class="keywordtype">char</span>*)inner_packet)) ;
00306 
00307         <a class="code" href="debug_8h.html#a12">IPSEC_LOG_TRC</a>(IPSEC_TRACE_RETURN, <span class="stringliteral">"ipsec_ah_encapsulate"</span>, (<span class="stringliteral">"return = %d"</span>, <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>) );
00308         <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a38a12">IPSEC_STATUS_SUCCESS</a>;
00309 }
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright 2003 by Christian Scheurer and Niklaus Schild</div>
</html>
