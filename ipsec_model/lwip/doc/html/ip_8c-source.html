
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ip.c</h1><a href="ip_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 
00034 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00035 <span class="comment">/* ip.c</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * This is the code for the IP layer.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> */</span>
00040 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00041 
00042 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00043 
00044 
00045 <span class="preprocessor">#include "<a class="code" href="def_8h.html">lwip/def.h</a>"</span>
00046 <span class="preprocessor">#include "<a class="code" href="mem_8h.html">lwip/mem.h</a>"</span>
00047 <span class="preprocessor">#include "lwip/ip.h"</span>
00048 <span class="preprocessor">#include "<a class="code" href="ip__frag_8h.html">lwip/ip_frag.h</a>"</span>
00049 <span class="preprocessor">#include "lwip/inet.h"</span>
00050 <span class="preprocessor">#include "<a class="code" href="netif_8h.html">lwip/netif.h</a>"</span>
00051 <span class="preprocessor">#include "lwip/icmp.h"</span>
00052 <span class="preprocessor">#include "<a class="code" href="udp_8h.html">lwip/udp.h</a>"</span>
00053 <span class="preprocessor">#include "<a class="code" href="tcp_8h.html">lwip/tcp.h</a>"</span>
00054 
00055 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">lwip/stats.h</a>"</span>
00056 
00057 <span class="preprocessor">#include "arch/perf.h"</span>
00058 
00059 <span class="preprocessor">#include "<a class="code" href="snmp_8h.html">lwip/snmp.h</a>"</span>
00060 <span class="preprocessor">#if LWIP_DHCP</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#  include "<a class="code" href="dhcp_8h.html">lwip/dhcp.h</a>"</span>
00062 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_DHCP */</span>
00063 
00064 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00065 <span class="comment">/* ip_init:</span>
00066 <span class="comment"> *</span>
00067 <span class="comment"> * Initializes the IP layer.</span>
00068 <span class="comment"> */</span>
00069 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00070 <span class="keywordtype">void</span>
<a name="l00071"></a><a class="code" href="ip_8c.html#a0">00071</a> <a class="code" href="ip_8c.html#a0">ip_init</a>(<span class="keywordtype">void</span>)
00072 {
00073 }
00074 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00075 <span class="comment">/* ip_lookup:</span>
00076 <span class="comment"> *</span>
00077 <span class="comment"> * An experimental feature that will be changed in future versions. Do</span>
00078 <span class="comment"> * not depend on it yet...</span>
00079 <span class="comment"> */</span>
00080 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00081 <span class="preprocessor">#ifdef LWIP_DEBUG</span>
00082 <span class="preprocessor"></span>u8_t
00083 <a class="code" href="ipv4_2lwip_2ip_8h.html#a28">ip_lookup</a>(<span class="keywordtype">void</span> *header, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *inp)
00084 {
00085   <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr;
00086 
00087   iphdr = header;
00088 
00089   <span class="comment">/* not IP v4? */</span>
00090   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a10">IPH_V</a>(iphdr) != 4) {
00091     <span class="keywordflow">return</span> 0;
00092   }
00093 
00094   <span class="comment">/* Immediately accept/decline packets that are fragments or has</span>
00095 <span class="comment">     options. */</span>
00096 <span class="preprocessor">#if IP_REASSEMBLY == 0</span>
00097 <span class="preprocessor"></span>  <span class="comment">/*  if ((IPH_OFFSET(iphdr) &amp; htons(IP_OFFMASK | IP_MF)) != 0) {</span>
00098 <span class="comment">    return 0;</span>
00099 <span class="comment">    }*/</span>
00100 <span class="preprocessor">#endif </span><span class="comment">/* IP_REASSEMBLY == 0 */</span>
00101 
00102 <span class="preprocessor">#if IP_OPTIONS == 0</span>
00103 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a11">IPH_HL</a>(iphdr) != 5) {
00104     <span class="keywordflow">return</span> 0;
00105   }
00106 <span class="preprocessor">#endif </span><span class="comment">/* IP_OPTIONS == 0 */</span>
00107 
00108   <span class="keywordflow">switch</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr)) {
00109 <span class="preprocessor">#if LWIP_UDP &gt; 0</span>
00110 <span class="preprocessor"></span>  <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a2">IP_PROTO_UDP</a>:
00111     <span class="keywordflow">return</span> <a class="code" href="udp_8h.html#a14">udp_lookup</a>(iphdr, inp);
00112 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_UDP */</span>
00113 <span class="preprocessor">#if LWIP_TCP &gt; 0</span>
00114 <span class="preprocessor"></span>  <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a4">IP_PROTO_TCP</a>:
00115     <span class="keywordflow">return</span> 1;
00116 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_TCP */</span>
00117   <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a1">IP_PROTO_ICMP</a>:
00118     <span class="keywordflow">return</span> 1;
00119   <span class="keywordflow">default</span>:
00120     <span class="keywordflow">return</span> 0;
00121   }
00122 }
00123 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_DEBUG */</span>
00124 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00125 <span class="comment">/* ip_route:</span>
00126 <span class="comment"> *</span>
00127 <span class="comment"> * Finds the appropriate network interface for a given IP address. It</span>
00128 <span class="comment"> * searches the list of network interfaces linearly. A match is found</span>
00129 <span class="comment"> * if the masked IP address of the network interface equals the masked</span>
00130 <span class="comment"> * IP address given to the function.</span>
00131 <span class="comment"> */</span>
00132 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00133 <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *
<a name="l00134"></a><a class="code" href="ip_8c.html#a1">00134</a> <a class="code" href="ip_8c.html#a1">ip_route</a>(<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest)
00135 {
00136   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00137 
00138   <span class="comment">/* iterate through netifs */</span>
00139   <span class="keywordflow">for</span>(<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>; <a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>; <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next) {
00140     <span class="comment">/* network mask matches? */</span>
00141     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a28">ip_addr_maskcmp</a>(dest, &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;netmask))) {
00142       <span class="comment">/* return netif on which to forward IP packet */</span>
00143       <span class="keywordflow">return</span> <a class="code" href="structnetif.html">netif</a>;
00144     }
00145   }
00146   <span class="comment">/* no matching netif found, use default netif */</span>
00147   <span class="keywordflow">return</span> <a class="code" href="netif_8c.html#a1">netif_default</a>;
00148 }
00149 <span class="preprocessor">#if IP_FORWARD</span>
00150 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00151 <span class="comment">/* ip_forward:</span>
00152 <span class="comment"> *</span>
00153 <span class="comment"> * Forwards an IP packet. It finds an appropriate route for the</span>
00154 <span class="comment"> * packet, decrements the TTL value of the packet, adjusts the</span>
00155 <span class="comment"> * checksum and outputs the packet on the appropriate interface.</span>
00156 <span class="comment"> */</span>
00157 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00158 <span class="keyword">static</span> <span class="keywordtype">void</span>
00159 <a class="code" href="ip6_8c.html#a2">ip_forward</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *inp)
00160 {
00161   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00162 
00163   PERF_START;
00164   <span class="comment">/* Find network interface where to forward this IP packet to. */</span>
00165   <a class="code" href="structnetif.html">netif</a> = <a class="code" href="ip_8c.html#a1">ip_route</a>((<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *)&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>));
00166   <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00167     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"ip_forward: no forwarding route for 0x%lx found\n"</span>,
00168                       iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>));
00169     <a class="code" href="snmp_8h.html#a14">snmp_inc_ipnoroutes</a>();
00170     <span class="keywordflow">return</span>;
00171   }
00172   <span class="comment">/* Do not forward packets onto the same network interface on which</span>
00173 <span class="comment">     they arrived. */</span>
00174   <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a> == inp) {
00175     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"ip_forward: not bouncing packets back on incoming interface.\n"</span>));
00176     <a class="code" href="snmp_8h.html#a14">snmp_inc_ipnoroutes</a>();
00177     <span class="keywordflow">return</span>;
00178   }
00179 
00180   <span class="comment">/* decrement TTL */</span>
00181   <a class="code" href="ipv4_2lwip_2ip_8h.html#a23">IPH_TTL_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2ip_8h.html#a16">IPH_TTL</a>(iphdr) - 1);
00182   <span class="comment">/* send ICMP if TTL == 0 */</span>
00183   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a16">IPH_TTL</a>(iphdr) == 0) {
00184     <span class="comment">/* Don't send ICMP messages in response to ICMP messages */</span>
00185     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr) != <a class="code" href="ipv4_2lwip_2ip_8h.html#a1">IP_PROTO_ICMP</a>) {
00186       <a class="code" href="icmp6_8c.html#a2">icmp_time_exceeded</a>(p, ICMP_TE_TTL);
00187       <a class="code" href="snmp_8h.html#a32">snmp_inc_icmpouttimeexcds</a>();
00188     }
00189     <span class="keywordflow">return</span>;
00190   }
00191 
00192   <span class="comment">/* Incrementally update the IP checksum. */</span>
00193   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a18">IPH_CHKSUM</a>(iphdr) &gt;= <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(0xffff - 0x100)) {
00194     <a class="code" href="ipv4_2lwip_2ip_8h.html#a25">IPH_CHKSUM_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2ip_8h.html#a18">IPH_CHKSUM</a>(iphdr) + <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(0x100) + 1);
00195   } <span class="keywordflow">else</span> {
00196     <a class="code" href="ipv4_2lwip_2ip_8h.html#a25">IPH_CHKSUM_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2ip_8h.html#a18">IPH_CHKSUM</a>(iphdr) + <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(0x100));
00197   }
00198 
00199   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"ip_forward: forwarding packet to 0x%lx\n"</span>,
00200                     iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>));
00201 
00202 <span class="preprocessor">#ifdef IP_STATS</span>
00203 <span class="preprocessor"></span>  ++lwip_stats.ip.fw;
00204   ++lwip_stats.ip.xmit;
00205 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00206     <a class="code" href="snmp_8h.html#a15">snmp_inc_ipforwdatagrams</a>();
00207 
00208   PERF_STOP(<span class="stringliteral">"ip_forward"</span>);
00209   <span class="comment">/* transmit pbuf on chosen interface */</span>
00210   <a class="code" href="structnetif.html">netif</a>-&gt;output(<a class="code" href="structnetif.html">netif</a>, p, (<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *)&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>));
00211 }
00212 <span class="preprocessor">#endif </span><span class="comment">/* IP_FORWARD */</span>
00213 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00214 <span class="comment">/* ip_input:</span>
00215 <span class="comment"> *</span>
00216 <span class="comment"> * This function is called by the network interface device driver when</span>
00217 <span class="comment"> * an IP packet is received. The function does the basic checks of the</span>
00218 <span class="comment"> * IP header such as packet size being at least larger than the header</span>
00219 <span class="comment"> * size etc. If the packet was not destined for us, the packet is</span>
00220 <span class="comment"> * forwarded (using ip_forward). The IP checksum is always checked.</span>
00221 <span class="comment"> *</span>
00222 <span class="comment"> * Finally, the packet is sent to the upper layer protocol input function.</span>
00223 <span class="comment"> */</span>
00224 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00225 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00226"></a><a class="code" href="ip_8c.html#a2">00226</a> <a class="code" href="ip_8c.html#a2">ip_input</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *inp) {
00227   <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr;
00228   <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00229   <span class="keyword">static</span> u16_t iphdrlen;
00230 
00231 <span class="preprocessor">#ifdef IP_STATS</span>
00232 <span class="preprocessor"></span>  ++lwip_stats.ip.recv;
00233 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00234   <a class="code" href="snmp_8h.html#a8">snmp_inc_ipinreceives</a>();
00235 
00236   <span class="comment">/* identify the IP header */</span>
00237   iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00238   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a10">IPH_V</a>(iphdr) != 4) {
00239     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 1, (<span class="stringliteral">"IP packet dropped due to bad version number %u\n"</span>, <a class="code" href="ipv4_2lwip_2ip_8h.html#a10">IPH_V</a>(iphdr)));
00240 <span class="preprocessor">#if IP_DEBUG</span>
00241 <span class="preprocessor"></span>    ip_debug_print(p);
00242 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00243     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00244 <span class="preprocessor">#ifdef IP_STATS</span>
00245 <span class="preprocessor"></span>    ++lwip_stats.ip.err;
00246     ++lwip_stats.ip.drop;
00247 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00248     <a class="code" href="snmp_8h.html#a13">snmp_inc_ipunknownprotos</a>();
00249     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00250   }
00251   <span class="comment">/* obtain IP header length in number of 32-bit words */</span>
00252   iphdrlen = <a class="code" href="ipv4_2lwip_2ip_8h.html#a11">IPH_HL</a>(iphdr);
00253   <span class="comment">/* calculate IP header length in bytes */</span>
00254   iphdrlen *= 4;
00255 
00256   <span class="comment">/* header length exceeds first pbuf length? */</span>
00257   <span class="keywordflow">if</span> (iphdrlen &gt; p-&gt;<a class="code" href="structpbuf.html#o3">len</a>) {
00258     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"IP header (len %u) does not fit in first pbuf (len %u), IP packet droppped.\n"</span>,
00259       iphdrlen, p-&gt;<a class="code" href="structpbuf.html#o3">len</a>));
00260     <span class="comment">/* free (drop) packet pbufs */</span>
00261     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00262 <span class="preprocessor">#ifdef IP_STATS</span>
00263 <span class="preprocessor"></span>    ++lwip_stats.ip.lenerr;
00264     ++lwip_stats.ip.drop;
00265 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00266     <a class="code" href="snmp_8h.html#a10">snmp_inc_ipindiscards</a>();
00267     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00268   }
00269 
00270   <span class="comment">/* verify checksum */</span>
00271   <span class="keywordflow">if</span> (<a class="code" href="inet_8c.html#a2">inet_chksum</a>(iphdr, iphdrlen) != 0) {
00272 
00273     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"Checksum (0x%x) failed, IP packet dropped.\n"</span>, <a class="code" href="inet_8c.html#a2">inet_chksum</a>(iphdr, iphdrlen)));
00274 <span class="preprocessor">#if IP_DEBUG</span>
00275 <span class="preprocessor"></span>    ip_debug_print(p);
00276 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00277     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00278 <span class="preprocessor">#ifdef IP_STATS</span>
00279 <span class="preprocessor"></span>    ++lwip_stats.ip.chkerr;
00280     ++lwip_stats.ip.drop;
00281 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00282     <a class="code" href="snmp_8h.html#a10">snmp_inc_ipindiscards</a>();
00283     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00284   }
00285 
00286   <span class="comment">/* Trim pbuf. This should have been done at the netif layer,</span>
00287 <span class="comment">     but we'll do it anyway just to be sure that its done. */</span>
00288   <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(p, <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a13">IPH_LEN</a>(iphdr)));
00289 
00290   <span class="comment">/* is this packet for us? */</span>
00291   <span class="keywordflow">for</span>(<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>; <a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>; <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next) {
00292 
00293     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: iphdr-&gt;dest 0x%lx netif-&gt;ip_addr 0x%lx (0x%lx, 0x%lx, 0x%lx)\n"</span>,
00294                       iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>, <a class="code" href="structnetif.html">netif</a>-&gt;ip_addr.addr,
00295                       iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a> &amp; <a class="code" href="structnetif.html">netif</a>-&gt;netmask.addr,
00296                       <a class="code" href="structnetif.html">netif</a>-&gt;ip_addr.addr &amp; <a class="code" href="structnetif.html">netif</a>-&gt;netmask.addr,
00297                       iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a> &amp; ~(<a class="code" href="structnetif.html">netif</a>-&gt;netmask.addr)));
00298 
00299     <span class="comment">/* interface configured? */</span>
00300     <span class="keywordflow">if</span> (!<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a30">ip_addr_isany</a>(&amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr)))
00301     {
00302       <span class="comment">/* unicast to this interface address? */</span>
00303       <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a29">ip_addr_cmp</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr)) ||
00304         <span class="comment">/* or broadcast matching this interface network address? */</span>
00305         (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a31">ip_addr_isbroadcast</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;netmask)) &amp;&amp;
00306          <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a28">ip_addr_maskcmp</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;netmask))) ||
00307          <span class="comment">/* or restricted broadcast? */</span>
00308          <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a29">ip_addr_cmp</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a1">IP_ADDR_BROADCAST</a>)) {
00309          <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: packet accepted on interface %c%c\n"</span>,
00310                        <a class="code" href="structnetif.html">netif</a>-&gt;name[0], <a class="code" href="structnetif.html">netif</a>-&gt;name[1]));
00311          <span class="comment">/* break out of for loop */</span>
00312          <span class="keywordflow">break</span>;
00313       }
00314     }
00315   }
00316 <span class="preprocessor">#if LWIP_DHCP</span>
00317 <span class="preprocessor"></span>  <span class="comment">/* Pass DHCP messages regardless of destination address. DHCP traffic is addressed</span>
00318 <span class="comment">     using link layer addressing (such as Ethernet MAC) so we must not filter on IP.</span>
00319 <span class="comment">     According to RFC 1542 section 3.1.1, referred by RFC 2131). */</span>
00320   <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00321     <span class="comment">/* remote port is DHCP server? */</span>
00322     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr) == <a class="code" href="ipv4_2lwip_2ip_8h.html#a2">IP_PROTO_UDP</a>) {
00323       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"ip_input: UDP packet to DHCP client port %u\n"</span>,
00324         <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(((<span class="keyword">struct</span> <a class="code" href="structudp__hdr.html">udp_hdr</a> *)((u8_t *)iphdr + iphdrlen))-&gt;dest)));
00325       <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(((<span class="keyword">struct</span> <a class="code" href="structudp__hdr.html">udp_hdr</a> *)((u8_t *)iphdr + iphdrlen))-&gt;dest) == <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>) {
00326         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"ip_input: DHCP packet accepted.\n"</span>));
00327         <a class="code" href="structnetif.html">netif</a> = inp;
00328       }
00329     }
00330   }
00331 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_DHCP */</span>
00332         <span class="comment">/* packet not for us? */</span>
00333   <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00334     <span class="comment">/* packet not for us, route or discard */</span>
00335     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"ip_input: packet not for us.\n"</span>));
00336 <span class="preprocessor">#if IP_FORWARD</span>
00337 <span class="preprocessor"></span>    <span class="comment">/* non-broadcast packet? */</span>
00338     <span class="keywordflow">if</span> (!<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a31">ip_addr_isbroadcast</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), &amp;(inp-&gt;<a class="code" href="structnetif.html#o2">netmask</a>))) {
00339       <span class="comment">/* try to forward IP packet on (other) interfaces */</span>
00340       <a class="code" href="ip6_8c.html#a2">ip_forward</a>(p, iphdr, inp);
00341     }
00342     <span class="keywordflow">else</span>
00343 <span class="preprocessor">#endif </span><span class="comment">/* IP_FORWARD */</span>
00344     {
00345       <a class="code" href="snmp_8h.html#a10">snmp_inc_ipindiscards</a>();
00346     }
00347     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00348     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00349   }
00350 
00351 <span class="preprocessor">#if IP_REASSEMBLY</span>
00352 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr) &amp; <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a9">IP_OFFMASK</a> | <a class="code" href="ipv4_2lwip_2ip_8h.html#a8">IP_MF</a>)) != 0) {
00353     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"IP packet is a fragment (id=0x%04x tot_len=%u len=%u MF=%u offset=%u), calling ip_reass()\n"</span>,
00354       <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a14">IPH_ID</a>(iphdr)), p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a13">IPH_LEN</a>(iphdr)), !!(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr) &amp; <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a8">IP_MF</a>)), (<a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr)) &amp; <a class="code" href="ipv4_2lwip_2ip_8h.html#a9">IP_OFFMASK</a>)*8));
00355     p = <a class="code" href="ip__frag_8c.html#a14">ip_reass</a>(p);
00356     <span class="keywordflow">if</span> (p == <a class="code" href="def_8h.html#a2">NULL</a>) {
00357       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00358     }
00359     iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00360   }
00361 <span class="preprocessor">#else </span><span class="comment">/* IP_REASSEMBLY */</span>
00362   <span class="keywordflow">if</span> ((<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr) &amp; <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a9">IP_OFFMASK</a> | <a class="code" href="ipv4_2lwip_2ip_8h.html#a8">IP_MF</a>)) != 0) {
00363     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00364     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"IP packet dropped since it was fragmented (0x%x) (while IP_REASSEMBLY == 0).\n"</span>,
00365                   <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr))));
00366 <span class="preprocessor">#ifdef IP_STATS</span>
00367 <span class="preprocessor"></span>    ++lwip_stats.ip.opterr;
00368     ++lwip_stats.ip.drop;
00369 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00370     <a class="code" href="snmp_8h.html#a13">snmp_inc_ipunknownprotos</a>();
00371     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00372   }
00373 <span class="preprocessor">#endif </span><span class="comment">/* IP_REASSEMBLY */</span>
00374 
00375 <span class="preprocessor">#if IP_OPTIONS == 0</span>
00376 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (iphdrlen &gt; <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>) {
00377     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"IP packet dropped since there were IP options (while IP_OPTIONS == 0).\n"</span>));
00378     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00379 <span class="preprocessor">#ifdef IP_STATS</span>
00380 <span class="preprocessor"></span>    ++lwip_stats.ip.opterr;
00381     ++lwip_stats.ip.drop;
00382 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00383     <a class="code" href="snmp_8h.html#a13">snmp_inc_ipunknownprotos</a>();
00384     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00385   }
00386 <span class="preprocessor">#endif </span><span class="comment">/* IP_OPTIONS == 0 */</span>
00387 
00388   <span class="comment">/* send to upper layers */</span>
00389 <span class="preprocessor">#if IP_DEBUG</span>
00390 <span class="preprocessor"></span>  <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: \n"</span>));
00391   ip_debug_print(p);
00392   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: p-&gt;len %d p-&gt;tot_len %d\n"</span>, p-&gt;<a class="code" href="structpbuf.html#o3">len</a>, p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>));
00393 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00394 
00395   <span class="keywordflow">switch</span> (<a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr)) {
00396 <span class="preprocessor">#if LWIP_UDP &gt; 0</span>
00397 <span class="preprocessor"></span>  <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a2">IP_PROTO_UDP</a>:
00398     <a class="code" href="snmp_8h.html#a9">snmp_inc_ipindelivers</a>();
00399     <a class="code" href="udp_8h.html#a15">udp_input</a>(p, inp);
00400     <span class="keywordflow">break</span>;
00401 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_UDP */</span>
00402 <span class="preprocessor">#if LWIP_TCP &gt; 0</span>
00403 <span class="preprocessor"></span>  <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a4">IP_PROTO_TCP</a>:
00404     <a class="code" href="snmp_8h.html#a9">snmp_inc_ipindelivers</a>();
00405     <a class="code" href="tcp_8h.html#a84">tcp_input</a>(p, inp);
00406     <span class="keywordflow">break</span>;
00407 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_TCP */</span>
00408   <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a1">IP_PROTO_ICMP</a>:
00409     <a class="code" href="snmp_8h.html#a9">snmp_inc_ipindelivers</a>();
00410     <a class="code" href="icmp_8c.html#a0">icmp_input</a>(p, inp);
00411     <span class="keywordflow">break</span>;
00412   <span class="keywordflow">default</span>:
00413     <span class="comment">/* send ICMP destination protocol unreachable unless is was a broadcast */</span>
00414     <span class="keywordflow">if</span> (!<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a31">ip_addr_isbroadcast</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), &amp;(inp-&gt;<a class="code" href="structnetif.html#o2">netmask</a>)) &amp;&amp;
00415        !<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a32">ip_addr_ismulticast</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>))) {
00416       p-&gt;<a class="code" href="structpbuf.html#o1">payload</a> = iphdr;
00417       <a class="code" href="icmp_8c.html#a1">icmp_dest_unreach</a>(p, <a class="code" href="ipv4_2lwip_2icmp_8h.html#a27a18">ICMP_DUR_PROTO</a>);
00418     }
00419     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00420 
00421     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"Unsupported transport protocol %d\n"</span>, <a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr)));
00422 
00423 <span class="preprocessor">#ifdef IP_STATS</span>
00424 <span class="preprocessor"></span>    ++lwip_stats.ip.proterr;
00425     ++lwip_stats.ip.drop;
00426 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00427     <a class="code" href="snmp_8h.html#a13">snmp_inc_ipunknownprotos</a>();
00428 
00429   }
00430   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00431 }
00432 
00433 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00434 <span class="comment">/* ip_output_if:</span>
00435 <span class="comment"> *</span>
00436 <span class="comment"> * Sends an IP packet on a network interface. This function constructs</span>
00437 <span class="comment"> * the IP header and calculates the IP header checksum. If the source</span>
00438 <span class="comment"> * IP address is NULL, the IP address of the outgoing network</span>
00439 <span class="comment"> * interface is filled in as source address.</span>
00440 <span class="comment"> */</span>
00441 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00442 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00443"></a><a class="code" href="ip_8c.html#a3">00443</a> <a class="code" href="ipv6_2lwip_2ip_8h.html#a10">ip_output_if</a> (<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *src, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest,
00444              u8_t ttl,
00445              u8_t proto, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00446 {
00447   <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr;
00448   <span class="keyword">static</span> u16_t ip_id = 0;
00449 
00450   <a class="code" href="snmp_8h.html#a12">snmp_inc_ipoutrequests</a>();
00451 
00452   <span class="keywordflow">if</span> (dest != <a class="code" href="ipv4_2lwip_2ip_8h.html#a5">IP_HDRINCL</a>) {
00453     <span class="keywordflow">if</span> (<a class="code" href="pbuf_8c.html#a13">pbuf_header</a>(p, <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>)) {
00454       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"ip_output: not enough room for IP header in pbuf\n"</span>));
00455 
00456 <span class="preprocessor">#ifdef IP_STATS</span>
00457 <span class="preprocessor"></span>      ++lwip_stats.ip.err;
00458 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00459       <a class="code" href="snmp_8h.html#a11">snmp_inc_ipoutdiscards</a>();
00460       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a2">ERR_BUF</a>;
00461     }
00462 
00463     iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00464 
00465     <a class="code" href="ipv4_2lwip_2ip_8h.html#a23">IPH_TTL_SET</a>(iphdr, ttl);
00466     <a class="code" href="ipv4_2lwip_2ip_8h.html#a24">IPH_PROTO_SET</a>(iphdr, proto);
00467 
00468     <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>), dest);
00469 
00470     <a class="code" href="ipv4_2lwip_2ip_8h.html#a19">IPH_VHLTOS_SET</a>(iphdr, 4, <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a> / 4, 0);
00471     <a class="code" href="ipv4_2lwip_2ip_8h.html#a20">IPH_LEN_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>));
00472     <a class="code" href="ipv4_2lwip_2ip_8h.html#a22">IPH_OFFSET_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a7">IP_DF</a>));
00473     <a class="code" href="ipv4_2lwip_2ip_8h.html#a21">IPH_ID_SET</a>(iphdr, <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(ip_id));
00474     ++ip_id;
00475 
00476     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a30">ip_addr_isany</a>(src)) {
00477       <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;src), &amp;(netif-&gt;<a class="code" href="structnetif.html#o1">ip_addr</a>));
00478     } <span class="keywordflow">else</span> {
00479       <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;src), src);
00480     }
00481 
00482     <a class="code" href="ipv4_2lwip_2ip_8h.html#a25">IPH_CHKSUM_SET</a>(iphdr, 0);
00483     <a class="code" href="ipv4_2lwip_2ip_8h.html#a25">IPH_CHKSUM_SET</a>(iphdr, <a class="code" href="inet_8c.html#a2">inet_chksum</a>(iphdr, <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>));
00484   } <span class="keywordflow">else</span> {
00485     iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00486     dest = &amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>);
00487   }
00488 
00489 <span class="preprocessor">#if IP_FRAG</span>
00490 <span class="preprocessor"></span>  <span class="comment">/* don't fragment if interface has mtu set to 0 [loopif] */</span>
00491   <span class="keywordflow">if</span> (netif-&gt;<a class="code" href="structnetif.html#o10">mtu</a> &amp;&amp; (p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a> &gt; netif-&gt;<a class="code" href="structnetif.html#o10">mtu</a>))
00492     <span class="keywordflow">return</span> <a class="code" href="ip__frag_8c.html#a15">ip_frag</a>(p,netif,dest);
00493 <span class="preprocessor">#endif</span>
00494 <span class="preprocessor"></span>
00495 <span class="preprocessor">#ifdef IP_STATS</span>
00496 <span class="preprocessor"></span>  lwip_stats.ip.xmit++;
00497 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00498   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_output_if: %c%c%u\n"</span>, netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00499 <span class="preprocessor">#if IP_DEBUG</span>
00500 <span class="preprocessor"></span>  ip_debug_print(p);
00501 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00502 
00503   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"netif-&gt;output()"</span>));
00504 
00505   <span class="keywordflow">return</span> netif-&gt;<a class="code" href="structnetif.html#o5">output</a>(netif, p, dest);
00506 }
00507 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00508 <span class="comment">/* ip_output:</span>
00509 <span class="comment"> *</span>
00510 <span class="comment"> * Simple interface to ip_output_if. It finds the outgoing network</span>
00511 <span class="comment"> * interface and calls upon ip_output_if to do the actual work.</span>
00512 <span class="comment"> */</span>
00513 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00514 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00515"></a><a class="code" href="ip_8c.html#a4">00515</a> <a class="code" href="ipv6_2lwip_2ip_8h.html#a9">ip_output</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *src, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest,
00516           u8_t ttl, u8_t proto)
00517 {
00518   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00519 
00520   <span class="keywordflow">if</span> ((<a class="code" href="structnetif.html">netif</a> = <a class="code" href="ip_8c.html#a1">ip_route</a>(dest)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00521     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a> | 2, (<span class="stringliteral">"ip_output: No route to 0x%lx\n"</span>, dest-&gt;<a class="code" href="structip__addr.html#o0">addr</a>));
00522 
00523 <span class="preprocessor">#ifdef IP_STATS</span>
00524 <span class="preprocessor"></span>    ++lwip_stats.ip.rterr;
00525 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00526     <a class="code" href="snmp_8h.html#a11">snmp_inc_ipoutdiscards</a>();
00527     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a9">ERR_RTE</a>;
00528   }
00529 
00530   <span class="keywordflow">return</span> <a class="code" href="ipv6_2lwip_2ip_8h.html#a10">ip_output_if</a> (p, src, dest, ttl, proto, <a class="code" href="structnetif.html">netif</a>);
00531 }
00532 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00533 <span class="preprocessor">#if IP_DEBUG</span>
00534 <span class="preprocessor"></span><span class="keywordtype">void</span>
00535 ip_debug_print(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p)
00536 {
00537   <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00538   u8_t *payload;
00539 
00540   payload = (u8_t *)iphdr + <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>;
00541 
00542   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"IP header:\n"</span>));
00543   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00544   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|%2d |%2d |  0x%02x |     %5u     | (v, hl, tos, len)\n"</span>,
00545                     <a class="code" href="ipv4_2lwip_2ip_8h.html#a10">IPH_V</a>(iphdr),
00546                     <a class="code" href="ipv4_2lwip_2ip_8h.html#a11">IPH_HL</a>(iphdr),
00547                     <a class="code" href="ipv4_2lwip_2ip_8h.html#a12">IPH_TOS</a>(iphdr),
00548                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a13">IPH_LEN</a>(iphdr))));
00549   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00550   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|    %5u      |%u%u%u|    %4u   | (id, flags, offset)\n"</span>,
00551                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a14">IPH_ID</a>(iphdr)),
00552                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr)) &gt;&gt; 15 &amp; 1,
00553                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr)) &gt;&gt; 14 &amp; 1,
00554                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr)) &gt;&gt; 13 &amp; 1,
00555                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a15">IPH_OFFSET</a>(iphdr)) &amp; IP_OFFMASK));
00556   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00557   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|  %3u  |  %3u  |    0x%04x     | (ttl, proto, chksum)\n"</span>,
00558                     <a class="code" href="ipv4_2lwip_2ip_8h.html#a16">IPH_TTL</a>(iphdr),
00559                     <a class="code" href="ipv4_2lwip_2ip_8h.html#a17">IPH_PROTO</a>(iphdr),
00560                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(<a class="code" href="ipv4_2lwip_2ip_8h.html#a18">IPH_CHKSUM</a>(iphdr))));
00561   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00562   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|  %3ld  |  %3ld  |  %3ld  |  %3ld  | (src)\n"</span>,
00563                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr) &gt;&gt; 24 &amp; 0xff,
00564                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr) &gt;&gt; 16 &amp; 0xff,
00565                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr) &gt;&gt; 8 &amp; 0xff,
00566                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr) &amp; 0xff));
00567   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00568   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|  %3ld  |  %3ld  |  %3ld  |  %3ld  | (dest)\n"</span>,
00569                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt; 24 &amp; 0xff,
00570                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt; 16 &amp; 0xff,
00571                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt; 8 &amp; 0xff,
00572                     <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>.<a class="code" href="structip__addr.html#o0">addr</a>) &amp; 0xff));
00573   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00574 }
00575 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00576 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00577 
00578 
00579 
00580 
00581 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
