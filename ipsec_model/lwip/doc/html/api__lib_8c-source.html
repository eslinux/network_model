
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>api_lib.c</h1><a href="api__lib_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved. </span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification, </span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission. </span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED </span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT </span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, </span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT </span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING </span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY </span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> * </span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="comment">/* This is the part of the API that is linked with</span>
00034 <span class="comment">   the application */</span>
00035 
00036 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00037 <span class="preprocessor">#include "<a class="code" href="api_8h.html">lwip/api.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="api__msg_8h.html">lwip/api_msg.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="memp_8h.html">lwip/memp.h</a>"</span>
00040 
00041 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00042 <span class="keyword">struct</span>
<a name="l00043"></a><a class="code" href="api__lib_8c.html#a0">00043</a> <span class="keyword"></span><a class="code" href="structnetbuf.html">netbuf</a> *<a class="code" href="api__lib_8c.html#a0">netbuf_new</a>(<span class="keywordtype">void</span>)
00044 {
00045   <span class="keyword">struct </span><a class="code" href="structnetbuf.html">netbuf</a> *buf;
00046 
00047   buf = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a5">MEMP_NETBUF</a>);
00048   <span class="keywordflow">if</span> (buf != <a class="code" href="def_8h.html#a2">NULL</a>) {
00049     buf-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
00050     buf-&gt;ptr = <a class="code" href="def_8h.html#a2">NULL</a>;
00051     <span class="keywordflow">return</span> buf;
00052   } <span class="keywordflow">else</span> {
00053     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00054   }
00055 }
00056 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00057 <span class="keywordtype">void</span>
<a name="l00058"></a><a class="code" href="api__lib_8c.html#a1">00058</a> <a class="code" href="api__lib_8c.html#a1">netbuf_delete</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00059 {
00060   <span class="keywordflow">if</span> (buf != <a class="code" href="def_8h.html#a2">NULL</a>) {
00061     <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00062       <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>);
00063       buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> = buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00064     }
00065     <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a5">MEMP_NETBUF</a>, buf);
00066   }
00067 }
00068 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00069 <span class="keywordtype">void</span> *
<a name="l00070"></a><a class="code" href="api__lib_8c.html#a2">00070</a> <a class="code" href="api__lib_8c.html#a2">netbuf_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf, u16_t size)
00071 {
00072   <span class="comment">/* Deallocate any previously allocated memory. */</span>
00073   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00074     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>);
00075   }
00076   buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a7">PBUF_TRANSPORT</a>, size, <a class="code" href="pbuf_8h.html#a27a11">PBUF_RAM</a>);
00077   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00078      <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00079   }
00080   buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>;
00081   <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00082 }
00083 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00084 <span class="keywordtype">void</span>
<a name="l00085"></a><a class="code" href="api__lib_8c.html#a3">00085</a> <a class="code" href="api__lib_8c.html#a3">netbuf_free</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00086 {
00087   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00088     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>);
00089   }
00090   buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> = buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00091 }
00092 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00093 <span class="keywordtype">void</span>
<a name="l00094"></a><a class="code" href="api__lib_8c.html#a4">00094</a> <a class="code" href="api__lib_8c.html#a4">netbuf_ref</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf, <span class="keywordtype">void</span> *dataptr, u16_t size)
00095 {
00096   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00097     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>);
00098   }
00099   buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a> = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a7">PBUF_TRANSPORT</a>, 0, <a class="code" href="pbuf_8h.html#a27a13">PBUF_REF</a>);
00100   buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o1">payload</a> = dataptr;
00101   buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o3">len</a> = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a> = size;
00102   buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>;
00103 }
00104 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00105 <span class="keywordtype">void</span>
<a name="l00106"></a><a class="code" href="api__lib_8c.html#a5">00106</a> <a class="code" href="api__lib_8c.html#a5">netbuf_chain</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *head, <span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *tail)
00107 {
00108   <a class="code" href="pbuf_8c.html#a17">pbuf_chain</a>(head-&gt;<a class="code" href="structnetbuf.html#o0">p</a>, tail-&gt;<a class="code" href="structnetbuf.html#o0">p</a>);
00109   head-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = head-&gt;<a class="code" href="structnetbuf.html#o0">p</a>;
00110   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a5">MEMP_NETBUF</a>, tail);
00111 }
00112 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00113 u16_t
<a name="l00114"></a><a class="code" href="api__lib_8c.html#a6">00114</a> <a class="code" href="api__lib_8c.html#a6">netbuf_len</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00115 {
00116   <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>;
00117 }
00118 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00119 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00120"></a><a class="code" href="api__lib_8c.html#a7">00120</a> <a class="code" href="api__lib_8c.html#a7">netbuf_data</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf, <span class="keywordtype">void</span> **dataptr, u16_t *len)
00121 {
00122   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00123     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a2">ERR_BUF</a>;
00124   }
00125   *dataptr = buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a>-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00126   *len = buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a>-&gt;<a class="code" href="structpbuf.html#o3">len</a>;
00127   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00128 }
00129 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00130 s8_t
<a name="l00131"></a><a class="code" href="api__lib_8c.html#a8">00131</a> <a class="code" href="api__lib_8c.html#a8">netbuf_next</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00132 {
00133   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a>-&gt;<a class="code" href="structpbuf.html#o0">next</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00134     <span class="keywordflow">return</span> -1;
00135   }
00136   buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a>-&gt;<a class="code" href="structpbuf.html#o0">next</a>;
00137   <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a>-&gt;<a class="code" href="structpbuf.html#o0">next</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00138     <span class="keywordflow">return</span> 1;
00139   }
00140   <span class="keywordflow">return</span> 0;
00141 }
00142 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00143 <span class="keywordtype">void</span>
<a name="l00144"></a><a class="code" href="api__lib_8c.html#a9">00144</a> <a class="code" href="api__lib_8c.html#a9">netbuf_first</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00145 {
00146   buf-&gt;<a class="code" href="structnetbuf.html#o1">ptr</a> = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>;
00147 }
00148 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00149 <span class="keywordtype">void</span>
<a name="l00150"></a><a class="code" href="api__lib_8c.html#a10">00150</a> <a class="code" href="api__lib_8c.html#a10">netbuf_copy_partial</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf, <span class="keywordtype">void</span> *dataptr, u16_t len, u16_t offset)
00151 {
00152   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p;
00153   u16_t i, left;
00154 
00155   left = 0;
00156 
00157   <span class="keywordflow">if</span> (buf == <a class="code" href="def_8h.html#a2">NULL</a>) {
00158     <span class="keywordflow">return</span>;
00159   }
00160   
00161   <span class="comment">/* This implementation is bad. It should use bcopy</span>
00162 <span class="comment">     instead. */</span>
00163   <span class="keywordflow">for</span>(p = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>; left &lt; len &amp;&amp; p != <a class="code" href="def_8h.html#a2">NULL</a>; p = p-&gt;next) {
00164     <span class="keywordflow">if</span> (offset != 0 &amp;&amp; offset &gt;= p-&gt;len) {
00165       offset -= p-&gt;len;
00166     } <span class="keywordflow">else</span> {    
00167       <span class="keywordflow">for</span>(i = offset; i &lt; p-&gt;len; ++i) {
00168   ((<span class="keywordtype">char</span> *)dataptr)[left] = ((<span class="keywordtype">char</span> *)p-&gt;payload)[i];
00169   <span class="keywordflow">if</span> (++left &gt;= len) {
00170     <span class="keywordflow">return</span>;
00171   }
00172       }
00173       offset = 0;
00174     }
00175   }
00176 }
00177 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00178 <span class="keywordtype">void</span>
<a name="l00179"></a><a class="code" href="api__lib_8c.html#a11">00179</a> <a class="code" href="api__lib_8c.html#a11">netbuf_copy</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf, <span class="keywordtype">void</span> *dataptr, u16_t len)
00180 {
00181   <a class="code" href="api__lib_8c.html#a10">netbuf_copy_partial</a>(buf, dataptr, len, 0);
00182 }
00183 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00184 <span class="keyword">struct </span><a class="code" href="structip__addr.html">ip_addr</a> *
<a name="l00185"></a><a class="code" href="api__lib_8c.html#a12">00185</a> <a class="code" href="api__lib_8c.html#a12">netbuf_fromaddr</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00186 {
00187   <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structnetbuf.html#o2">fromaddr</a>;
00188 }
00189 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00190 u16_t
<a name="l00191"></a><a class="code" href="api__lib_8c.html#a13">00191</a> <a class="code" href="api__lib_8c.html#a13">netbuf_fromport</a>(<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00192 {
00193   <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structnetbuf.html#o3">fromport</a>;
00194 }
00195 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00196 <span class="keyword">struct</span>
<a name="l00197"></a><a class="code" href="api__lib_8c.html#a14">00197</a> <span class="keyword"></span><a class="code" href="structnetconn.html">netconn</a> *<a class="code" href="api__lib_8c.html#a14">netconn_new</a>(<span class="keyword">enum</span> netconn_type t)
00198 {
00199   <span class="keyword">struct </span><a class="code" href="structnetconn.html">netconn</a> *conn;
00200 
00201   conn = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a6">MEMP_NETCONN</a>);
00202   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00203     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00204   }
00205   conn-&gt;type = t;
00206   conn-&gt;pcb.tcp = <a class="code" href="def_8h.html#a2">NULL</a>;
00207 
00208   <span class="keywordflow">if</span> ((conn-&gt;mbox = <a class="code" href="sys_8h.html#a17">sys_mbox_new</a>()) == SYS_MBOX_NULL) {
00209     <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a6">MEMP_NETCONN</a>, conn);
00210     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00211   }
00212   conn-&gt;recvmbox = SYS_MBOX_NULL;
00213   conn-&gt;acceptmbox = SYS_MBOX_NULL;
00214   conn-&gt;sem = SYS_SEM_NULL;
00215   conn-&gt;state = <a class="code" href="api_8h.html#a47a6">NETCONN_NONE</a>;
00216   conn-&gt;socket = 0;
00217   conn-&gt;callback = 0;
00218   conn-&gt;recv_avail = 0;
00219   <span class="keywordflow">return</span> conn;
00220 }
00221 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00222 <span class="keyword">struct</span>
<a name="l00223"></a><a class="code" href="api__lib_8c.html#a15">00223</a> <span class="keyword"></span><a class="code" href="structnetconn.html">netconn</a> *<a class="code" href="api__lib_8c.html#a15">netconn_new_with_callback</a>(<span class="keyword">enum</span> netconn_type t,
00224                                    <span class="keywordtype">void</span> (*callback)(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *, <span class="keyword">enum</span> netconn_evt, u16_t len))
00225 {
00226     <span class="keyword">struct </span>netconn *conn;
00227     
00228     <span class="comment">/* get a netconn and then initialize callback pointer and socket */</span>
00229     conn = <a class="code" href="api__lib_8c.html#a14">netconn_new</a>(t);
00230     <span class="keywordflow">if</span> (conn)
00231         conn-&gt;callback = callback;
00232     <span class="keywordflow">return</span> conn;
00233 }
00234 
00235 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00236 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00237"></a><a class="code" href="api__lib_8c.html#a16">00237</a> <a class="code" href="api__lib_8c.html#a16">netconn_delete</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00238 {
00239   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00240   <span class="keywordtype">void</span> *<a class="code" href="structmem.html">mem</a>;
00241   
00242   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00243     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00244   }
00245   
00246   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00247     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00248   }
00249   
00250   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a1">API_MSG_DELCONN</a>;
00251   msg-&gt;msg.conn = conn;
00252   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);  
00253   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00254   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00255 
00256   <span class="comment">/* Drain the recvmbox. */</span>
00257   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> != SYS_MBOX_NULL) {
00258     <span class="keywordflow">while</span> (<a class="code" href="sys_8h.html#a19">sys_arch_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a>, &amp;mem, 1) != <a class="code" href="sys_8h.html#a0">SYS_ARCH_TIMEOUT</a>) {
00259       <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a> == <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a>) {
00260   <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>((<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *)mem);
00261       } <span class="keywordflow">else</span> {
00262   <a class="code" href="api__lib_8c.html#a1">netbuf_delete</a>((<span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *)mem);
00263       }
00264     }
00265     <a class="code" href="sys_8h.html#a20">sys_mbox_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a>);
00266     conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> = SYS_MBOX_NULL;
00267   }
00268  
00269 
00270   <span class="comment">/* Drain the acceptmbox. */</span>
00271   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a> != SYS_MBOX_NULL) {
00272     <span class="keywordflow">while</span> (<a class="code" href="sys_8h.html#a19">sys_arch_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a>, &amp;mem, 1) != <a class="code" href="sys_8h.html#a0">SYS_ARCH_TIMEOUT</a>) {
00273       <a class="code" href="api__lib_8c.html#a16">netconn_delete</a>((<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *)mem);
00274     }
00275     
00276     <a class="code" href="sys_8h.html#a20">sys_mbox_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a>);
00277     conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a> = SYS_MBOX_NULL;
00278   }
00279 
00280   <a class="code" href="sys_8h.html#a20">sys_mbox_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>);
00281   conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a> = SYS_MBOX_NULL;
00282   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> != SYS_SEM_NULL) {
00283     <a class="code" href="sys_8h.html#a12">sys_sem_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a>);
00284   }
00285   <span class="comment">/*  conn-&gt;sem = SYS_SEM_NULL;*/</span>
00286   <a class="code" href="memp_8c.html#a8">memp_free</a>(<a class="code" href="memp_8h.html#a17a6">MEMP_NETCONN</a>, conn);
00287   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00288 }
00289 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00290 <span class="keyword">enum</span> <a class="code" href="api__lib_8c.html#a17">netconn_type</a>
<a name="l00291"></a><a class="code" href="api__lib_8c.html#a17">00291</a> <a class="code" href="api_8h.html#a46">netconn_type</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00292 {
00293   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o0">type</a>;
00294 }
00295 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00296 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00297"></a><a class="code" href="api__lib_8c.html#a18">00297</a> <a class="code" href="api__lib_8c.html#a18">netconn_peer</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr,
00298        u16_t *port)
00299 {
00300   <span class="keywordflow">switch</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a>) {
00301   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a4">NETCONN_UDPLITE</a>:
00302   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a5">NETCONN_UDPNOCHKSUM</a>:
00303   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a3">NETCONN_UDP</a>:
00304     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp == <a class="code" href="def_8h.html#a2">NULL</a> ||
00305   ((conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp-&gt;flags &amp; <a class="code" href="udp_8h.html#a3">UDP_FLAGS_CONNECTED</a>) == 0))
00306      <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a6">ERR_CONN</a>;
00307     *addr = (conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp-&gt;remote_ip);
00308     *port = conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp-&gt;remote_port;
00309     <span class="keywordflow">break</span>;
00310   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a>:
00311     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp == <a class="code" href="def_8h.html#a2">NULL</a>)
00312       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a6">ERR_CONN</a>;
00313     *addr = (conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp-&gt;remote_ip);
00314     *port = conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp-&gt;remote_port;
00315     <span class="keywordflow">break</span>;
00316   }
00317   <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a0">ERR_OK</a>);
00318 }
00319 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00320 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00321"></a><a class="code" href="api__lib_8c.html#a19">00321</a> <a class="code" href="api__lib_8c.html#a19">netconn_addr</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> **addr,
00322        u16_t *port)
00323 {
00324   <span class="keywordflow">switch</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a>) {
00325   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a4">NETCONN_UDPLITE</a>:
00326   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a5">NETCONN_UDPNOCHKSUM</a>:
00327   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a3">NETCONN_UDP</a>:
00328     *addr = &amp;(conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp-&gt;local_ip);
00329     *port = conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.udp-&gt;local_port;
00330     <span class="keywordflow">break</span>;
00331   <span class="keywordflow">case</span> <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a>:
00332     *addr = &amp;(conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp-&gt;local_ip);
00333     *port = conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp-&gt;local_port;
00334     <span class="keywordflow">break</span>;
00335   }
00336   <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a0">ERR_OK</a>);
00337 }
00338 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00339 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00340"></a><a class="code" href="api__lib_8c.html#a20">00340</a> <a class="code" href="api__lib_8c.html#a20">netconn_bind</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr,
00341       u16_t port)
00342 {
00343   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00344 
00345   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00346     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00347   }
00348 
00349   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a> != <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a> &amp;&amp;
00350      conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> == SYS_MBOX_NULL) {
00351     <span class="keywordflow">if</span> ((conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> = <a class="code" href="sys_8h.html#a17">sys_mbox_new</a>()) == SYS_MBOX_NULL) {
00352       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00353     }
00354   }
00355   
00356   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00357     <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>);
00358   }
00359   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a2">API_MSG_BIND</a>;
00360   msg-&gt;msg.conn = conn;
00361   msg-&gt;msg.msg.bc.ipaddr = addr;
00362   msg-&gt;msg.msg.bc.port = port;
00363   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00364   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00365   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00366   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00367 }
00368 
00369 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00370 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00371"></a><a class="code" href="api__lib_8c.html#a21">00371</a> <a class="code" href="api__lib_8c.html#a21">netconn_connect</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr,
00372        u16_t port)
00373 {
00374   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00375   
00376   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00377     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00378   }
00379 
00380 
00381   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> == SYS_MBOX_NULL) {
00382     <span class="keywordflow">if</span> ((conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> = <a class="code" href="sys_8h.html#a17">sys_mbox_new</a>()) == SYS_MBOX_NULL) {
00383       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00384     }
00385   }
00386   
00387   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00388     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00389   }
00390   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a3">API_MSG_CONNECT</a>;
00391   msg-&gt;msg.conn = conn;  
00392   msg-&gt;msg.msg.bc.ipaddr = addr;
00393   msg-&gt;msg.msg.bc.port = port;
00394   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00395   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00396   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00397   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00398 }
00399 
00400 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00401"></a><a class="code" href="api__lib_8c.html#a22">00401</a> <a class="code" href="api__lib_8c.html#a22">netconn_disconnect</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00402 {
00403   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00404   
00405   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00406     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00407   }
00408 
00409   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00410     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00411   }
00412   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a4">API_MSG_DISCONNECT</a>;
00413   msg-&gt;msg.conn = conn;  
00414   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00415   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00416   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00417   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00418 
00419 }
00420 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00421 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00422"></a><a class="code" href="api__lib_8c.html#a23">00422</a> <a class="code" href="api__lib_8c.html#a23">netconn_listen</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00423 {
00424   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00425 
00426   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00427     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00428   }
00429 
00430   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a> == SYS_MBOX_NULL) {
00431     conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a> = <a class="code" href="sys_8h.html#a17">sys_mbox_new</a>();
00432     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a> == SYS_MBOX_NULL) {
00433       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00434     }
00435   }
00436   
00437   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00438     <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>);
00439   }
00440   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a5">API_MSG_LISTEN</a>;
00441   msg-&gt;msg.conn = conn;
00442   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00443   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00444   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00445   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00446 }
00447 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00448 <span class="keyword">struct </span><a class="code" href="structnetconn.html">netconn</a> *
<a name="l00449"></a><a class="code" href="api__lib_8c.html#a24">00449</a> <a class="code" href="api__lib_8c.html#a24">netconn_accept</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00450 {
00451   <span class="keyword">struct </span><a class="code" href="structnetconn.html">netconn</a> *newconn;
00452   
00453   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00454     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00455   }
00456   
00457   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o8">acceptmbox</a>, (<span class="keywordtype">void</span> **)&amp;newconn);
00458   <span class="comment">/* Register event with callback */</span>
00459   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)
00460       (*conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)(conn, <a class="code" href="api_8h.html#a48a13">NETCONN_EVT_RCVMINUS</a>, 0);
00461   
00462   <span class="keywordflow">return</span> newconn;
00463 }
00464 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00465 <span class="keyword">struct </span><a class="code" href="structnetbuf.html">netbuf</a> *
<a name="l00466"></a><a class="code" href="api__lib_8c.html#a25">00466</a> <a class="code" href="api__lib_8c.html#a25">netconn_recv</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00467 {
00468   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00469   <span class="keyword">struct </span><a class="code" href="structnetbuf.html">netbuf</a> *buf;
00470   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p;
00471   u16_t len;
00472     
00473   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00474     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00475   }
00476   
00477   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> == SYS_MBOX_NULL) {
00478     conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a6">ERR_CONN</a>;
00479     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00480   }
00481 
00482   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00483     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00484   }
00485 
00486   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a> == <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a>) {
00487     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp-&gt;state == <a class="code" href="tcp_8h.html#a99a54">LISTEN</a>) {
00488       conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a6">ERR_CONN</a>;
00489       <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00490     }
00491 
00492 
00493     buf = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a5">MEMP_NETBUF</a>);
00494 
00495     <span class="keywordflow">if</span> (buf == <a class="code" href="def_8h.html#a2">NULL</a>) {
00496       conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00497       <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00498     }
00499     
00500     <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a>, (<span class="keywordtype">void</span> **)&amp;p);
00501 
00502     <span class="keywordflow">if</span> (p != <a class="code" href="def_8h.html#a2">NULL</a>)
00503     {
00504         len = p-&gt;tot_len;
00505         conn-&gt;<a class="code" href="structnetconn.html#o11">recv_avail</a> -= len;
00506     }
00507     <span class="keywordflow">else</span>
00508         len = 0;
00509     
00510     <span class="comment">/* Register event with callback */</span>
00511       <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)
00512         (*conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)(conn, <a class="code" href="api_8h.html#a48a13">NETCONN_EVT_RCVMINUS</a>, len);
00513 
00514     <span class="comment">/* If we are closed, we indicate that we no longer wish to receive</span>
00515 <span class="comment">       data by setting conn-&gt;recvmbox to SYS_MBOX_NULL. */</span>
00516     <span class="keywordflow">if</span> (p == <a class="code" href="def_8h.html#a2">NULL</a>) {
00517       <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a5">MEMP_NETBUF</a>, buf);
00518       <a class="code" href="sys_8h.html#a20">sys_mbox_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a>);
00519       conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a> = SYS_MBOX_NULL;
00520       <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00521     }
00522 
00523     buf-&gt;p = p;
00524     buf-&gt;ptr = p;
00525     buf-&gt;fromport = 0;
00526     buf-&gt;fromaddr = <a class="code" href="def_8h.html#a2">NULL</a>;
00527 
00528     <span class="comment">/* Let the stack know that we have taken the data. */</span>
00529     <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00530       conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00531       <span class="keywordflow">return</span> buf;
00532     }
00533     msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a8">API_MSG_RECV</a>;
00534     msg-&gt;msg.conn = conn;
00535     <span class="keywordflow">if</span> (buf != <a class="code" href="def_8h.html#a2">NULL</a>) {
00536       msg-&gt;msg.msg.len = buf-&gt;p-&gt;tot_len;
00537     } <span class="keywordflow">else</span> {
00538       msg-&gt;msg.msg.len = 1;
00539     }
00540     <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00541 
00542     <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00543     <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00544   } <span class="keywordflow">else</span> {
00545     <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o7">recvmbox</a>, (<span class="keywordtype">void</span> **)&amp;buf);
00546   conn-&gt;<a class="code" href="structnetconn.html#o11">recv_avail</a> -= buf-&gt;p-&gt;tot_len;
00547     <span class="comment">/* Register event with callback */</span>
00548     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)
00549         (*conn-&gt;<a class="code" href="structnetconn.html#o12">callback</a>)(conn, <a class="code" href="api_8h.html#a48a13">NETCONN_EVT_RCVMINUS</a>, buf-&gt;p-&gt;tot_len);
00550   }
00551 
00552   
00553 
00554     
00555   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a63">API_LIB_DEBUG</a>, (<span class="stringliteral">"netconn_recv: received %p (err %d)\n"</span>, (<span class="keywordtype">void</span> *)buf, conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>));
00556 
00557 
00558   <span class="keywordflow">return</span> buf;
00559 }
00560 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00561 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00562"></a><a class="code" href="api__lib_8c.html#a26">00562</a> <a class="code" href="api__lib_8c.html#a26">netconn_send</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keyword">struct</span> <a class="code" href="structnetbuf.html">netbuf</a> *buf)
00563 {
00564   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00565 
00566   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00567     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00568   }
00569 
00570   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00571     <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00572   }
00573 
00574   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00575     <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>);
00576   }
00577 
00578   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a63">API_LIB_DEBUG</a>, (<span class="stringliteral">"netconn_send: sending %d bytes\n"</span>, buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>));
00579   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a7">API_MSG_SEND</a>;
00580   msg-&gt;msg.conn = conn;
00581   msg-&gt;msg.msg.p = buf-&gt;<a class="code" href="structnetbuf.html#o0">p</a>;
00582   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00583 
00584   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00585   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00586   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00587 }
00588 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00589 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00590"></a><a class="code" href="api__lib_8c.html#a27">00590</a> <a class="code" href="api__lib_8c.html#a27">netconn_write</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn, <span class="keywordtype">void</span> *dataptr, u16_t size, u8_t copy)
00591 {
00592   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00593   u16_t len;
00594   
00595   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00596     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00597   }
00598 
00599   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00600     <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00601   }
00602   
00603   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> == SYS_SEM_NULL) {
00604     conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> = <a class="code" href="sys_8h.html#a9">sys_sem_new</a>(0);
00605     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> == SYS_SEM_NULL) {
00606       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00607     }
00608   }
00609 
00610   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00611     <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>);
00612   }
00613   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a9">API_MSG_WRITE</a>;
00614   msg-&gt;msg.conn = conn;
00615         
00616 
00617   conn-&gt;<a class="code" href="structnetconn.html#o1">state</a> = <a class="code" href="api_8h.html#a47a7">NETCONN_WRITE</a>;
00618   <span class="keywordflow">while</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> == <a class="code" href="err_8h.html#a0">ERR_OK</a> &amp;&amp; size &gt; 0) {
00619     msg-&gt;msg.msg.w.dataptr = dataptr;
00620     msg-&gt;msg.msg.w.copy = copy;
00621     
00622     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o0">type</a> == <a class="code" href="api_8h.html#a46a2">NETCONN_TCP</a>) {
00623       <span class="keywordflow">if</span> (<a class="code" href="tcp_8h.html#a1">tcp_sndbuf</a>(conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp) == 0) {
00624   <a class="code" href="sys_8c.html#a1">sys_sem_wait</a>(conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a>);
00625   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00626     <span class="keywordflow">goto</span> ret;
00627   }
00628       }
00629       <span class="keywordflow">if</span> (size &gt; <a class="code" href="tcp_8h.html#a1">tcp_sndbuf</a>(conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp)) {
00630   <span class="comment">/* We cannot send more than one send buffer's worth of data at a</span>
00631 <span class="comment">     time. */</span>
00632   len = <a class="code" href="tcp_8h.html#a1">tcp_sndbuf</a>(conn-&gt;<a class="code" href="structnetconn.html#o4">pcb</a>.tcp);
00633       } <span class="keywordflow">else</span> {
00634   len = size;
00635       }
00636     } <span class="keywordflow">else</span> {
00637       len = size;
00638     }
00639     
00640     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a63">API_LIB_DEBUG</a>, (<span class="stringliteral">"netconn_write: writing %d bytes (%d)\n"</span>, len, copy));
00641     msg-&gt;msg.msg.w.len = len;
00642     <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00643     <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);    
00644     <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> == <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00645       dataptr = (<span class="keywordtype">void</span> *)((<span class="keywordtype">char</span> *)dataptr + len);
00646       size -= len;
00647     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> == <a class="code" href="err_8h.html#a1">ERR_MEM</a>) {
00648       conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00649       <a class="code" href="sys_8c.html#a1">sys_sem_wait</a>(conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a>);
00650     } <span class="keywordflow">else</span> {
00651       <span class="keywordflow">goto</span> ret;
00652     }
00653   }
00654  ret:
00655   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00656   conn-&gt;<a class="code" href="structnetconn.html#o1">state</a> = <a class="code" href="api_8h.html#a47a6">NETCONN_NONE</a>;
00657   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> != SYS_SEM_NULL) {
00658     <a class="code" href="sys_8h.html#a12">sys_sem_free</a>(conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a>);
00659     conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> = SYS_SEM_NULL;
00660   }
00661   
00662   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00663 }
00664 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00665 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00666"></a><a class="code" href="api__lib_8c.html#a28">00666</a> <a class="code" href="api__lib_8c.html#a28">netconn_close</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00667 {
00668   <span class="keyword">struct </span><a class="code" href="structapi__msg.html">api_msg</a> *msg;
00669 
00670   <span class="keywordflow">if</span> (conn == <a class="code" href="def_8h.html#a2">NULL</a>) {
00671     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a7">ERR_VAL</a>;
00672   }
00673   <span class="keywordflow">if</span> ((msg = <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00674     <span class="keywordflow">return</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> = <a class="code" href="err_8h.html#a1">ERR_MEM</a>);
00675   }
00676 
00677   conn-&gt;<a class="code" href="structnetconn.html#o1">state</a> = <a class="code" href="api_8h.html#a47a11">NETCONN_CLOSE</a>;
00678  again:
00679   msg-&gt;type = <a class="code" href="api__msg_8h.html#a14a10">API_MSG_CLOSE</a>;
00680   msg-&gt;msg.conn = conn;
00681   <a class="code" href="api__msg_8c.html#a14">api_msg_post</a>(msg);
00682   <a class="code" href="sys_8c.html#a0">sys_mbox_fetch</a>(conn-&gt;<a class="code" href="structnetconn.html#o6">mbox</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00683   <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structnetconn.html#o5">err</a> == <a class="code" href="err_8h.html#a1">ERR_MEM</a> &amp;&amp;
00684      conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a> != SYS_SEM_NULL) {
00685     <a class="code" href="sys_8c.html#a1">sys_sem_wait</a>(conn-&gt;<a class="code" href="structnetconn.html#o9">sem</a>);
00686     <span class="keywordflow">goto</span> again;
00687   }
00688   conn-&gt;<a class="code" href="structnetconn.html#o1">state</a> = <a class="code" href="api_8h.html#a47a6">NETCONN_NONE</a>;
00689   <a class="code" href="memp_8c.html#a9">memp_freep</a>(<a class="code" href="memp_8h.html#a17a7">MEMP_API_MSG</a>, msg);
00690   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00691 }
00692 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00693 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00694"></a><a class="code" href="api__lib_8c.html#a29">00694</a> <a class="code" href="api__lib_8c.html#a29">netconn_err</a>(<span class="keyword">struct</span> <a class="code" href="structnetconn.html">netconn</a> *conn)
00695 {
00696   <span class="keywordflow">return</span> conn-&gt;<a class="code" href="structnetconn.html#o5">err</a>;
00697 }
00698 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
