
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsm.c</h1><a href="fsm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*****************************************************************************</span>
00002 <span class="comment">* fsm.c - Network Control Protocol Finite State Machine program file.</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 2003 by Marc Boucher, Services Informatiques (MBSI) inc.</span>
00005 <span class="comment">* portions Copyright (c) 1997 by Global Election Systems Inc.</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* The authors hereby grant permission to use, copy, modify, distribute,</span>
00008 <span class="comment">* and license this software and its documentation for any purpose, provided</span>
00009 <span class="comment">* that existing copyright notices are retained in all copies and that this</span>
00010 <span class="comment">* notice and the following disclaimer are included verbatim in any </span>
00011 <span class="comment">* distributions. No written agreement, license, or royalty fee is required</span>
00012 <span class="comment">* for any of the authorized uses.</span>
00013 <span class="comment">*</span>
00014 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS *AS IS* AND ANY EXPRESS OR</span>
00015 <span class="comment">* IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00016 <span class="comment">* OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00017 <span class="comment">* IN NO EVENT SHALL THE CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
00018 <span class="comment">* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
00019 <span class="comment">* NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
00020 <span class="comment">* DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
00021 <span class="comment">* THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
00022 <span class="comment">* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
00023 <span class="comment">* THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00024 <span class="comment">*</span>
00025 <span class="comment">******************************************************************************</span>
00026 <span class="comment">* REVISION HISTORY</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* 03-01-01 Marc Boucher &lt;marc@mbsi.ca&gt;</span>
00029 <span class="comment">*   Ported to lwIP.</span>
00030 <span class="comment">* 97-12-01 Guy Lancaster &lt;lancasterg@acm.org&gt;, Global Election Systems Inc.</span>
00031 <span class="comment">*       Original based on BSD fsm.c.</span>
00032 <span class="comment">*****************************************************************************/</span>
00033 <span class="comment">/*</span>
00034 <span class="comment"> * fsm.c - {Link, IP} Control Protocol Finite State Machine.</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> * Copyright (c) 1989 Carnegie Mellon University.</span>
00037 <span class="comment"> * All rights reserved.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * Redistribution and use in source and binary forms are permitted</span>
00040 <span class="comment"> * provided that the above copyright notice and this paragraph are</span>
00041 <span class="comment"> * duplicated in all such forms and that any documentation,</span>
00042 <span class="comment"> * advertising materials, and other materials related to such</span>
00043 <span class="comment"> * distribution and use acknowledge that the software was developed</span>
00044 <span class="comment"> * by Carnegie Mellon University.  The name of the</span>
00045 <span class="comment"> * University may not be used to endorse or promote products derived</span>
00046 <span class="comment"> * from this software without specific prior written permission.</span>
00047 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR</span>
00048 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
00049 <span class="comment"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00050 <span class="comment"> */</span>
00051 
00052 
00053 <span class="comment">/*</span>
00054 <span class="comment"> * TODO:</span>
00055 <span class="comment"> * Randomize fsm id on link/init.</span>
00056 <span class="comment"> * Deal with variable outgoing MTU.</span>
00057 <span class="comment"> */</span>
00058 
00059 <span class="preprocessor">#include "<a class="code" href="ppp_8h.html">ppp.h</a>"</span>
00060 <span class="preprocessor">#if PPP_SUPPORT &gt; 0</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="fsm_8h.html">fsm.h</a>"</span>
00062 <span class="preprocessor">#include "<a class="code" href="pppdebug_8h.html">pppdebug.h</a>"</span>
00063 
00064 
00065 <span class="comment">/*************************/</span>
00066 <span class="comment">/*** LOCAL DEFINITIONS ***/</span>
00067 <span class="comment">/*************************/</span>
00068 
00069 
00070 <span class="comment">/************************/</span>
00071 <span class="comment">/*** LOCAL DATA TYPES ***/</span>
00072 <span class="comment">/************************/</span>
00073 
00074 
00075 <span class="comment">/***********************************/</span>
00076 <span class="comment">/*** LOCAL FUNCTION DECLARATIONS ***/</span>
00077 <span class="comment">/***********************************/</span>
00078 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_timeout (<span class="keywordtype">void</span> *);
00079 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfreq (<a class="code" href="structfsm.html">fsm</a> *, u_char, u_char *, <span class="keywordtype">int</span>);
00080 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfack (<a class="code" href="structfsm.html">fsm</a> *, <span class="keywordtype">int</span>, u_char *, <span class="keywordtype">int</span>);
00081 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfnakrej (<a class="code" href="structfsm.html">fsm</a> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, u_char *, <span class="keywordtype">int</span>);
00082 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rtermreq (<a class="code" href="structfsm.html">fsm</a> *, <span class="keywordtype">int</span>, u_char *, <span class="keywordtype">int</span>);
00083 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rtermack (<a class="code" href="structfsm.html">fsm</a> *);
00084 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rcoderej (<a class="code" href="structfsm.html">fsm</a> *, u_char *, <span class="keywordtype">int</span>);
00085 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_sconfreq (<a class="code" href="structfsm.html">fsm</a> *, <span class="keywordtype">int</span>);
00086 
00087 <span class="preprocessor">#define PROTO_NAME(f)   ((f)-&gt;callbacks-&gt;proto_name)</span>
00088 <span class="preprocessor"></span>
00089 
00090 <span class="comment">/******************************/</span>
00091 <span class="comment">/*** PUBLIC DATA STRUCTURES ***/</span>
00092 <span class="comment">/******************************/</span>
00093 
00094 
00095 <span class="comment">/*****************************/</span>
00096 <span class="comment">/*** LOCAL DATA STRUCTURES ***/</span>
00097 <span class="comment">/*****************************/</span>
00098 <span class="keywordtype">int</span> <a class="code" href="fsm_8h.html#a23">peer_mru</a>[NUM_PPP];
00099 
00100 
00101 <span class="comment">/***********************************/</span>
00102 <span class="comment">/*** PUBLIC FUNCTION DEFINITIONS ***/</span>
00103 <span class="comment">/***********************************/</span>
00104 
00105 <span class="comment">/*</span>
00106 <span class="comment"> * fsm_init - Initialize fsm.</span>
00107 <span class="comment"> *</span>
00108 <span class="comment"> * Initialize fsm state.</span>
00109 <span class="comment"> */</span>
00110 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a24">fsm_init</a>(<a class="code" href="structfsm.html">fsm</a> *f)
00111 {
00112         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a8">INITIAL</a>;
00113         f-&gt;<a class="code" href="structfsm.html#o3">flags</a> = 0;
00114         f-&gt;<a class="code" href="structfsm.html#o4">id</a> = 0;                              <span class="comment">/* XXX Start with random id? */</span>
00115         f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a> = FSM_DEFTIMEOUT;
00116         f-&gt;<a class="code" href="structfsm.html#o8">maxconfreqtransmits</a> = FSM_DEFMAXCONFREQS;
00117         f-&gt;<a class="code" href="structfsm.html#o10">maxtermtransmits</a> = FSM_DEFMAXTERMREQS;
00118         f-&gt;<a class="code" href="structfsm.html#o12">maxnakloops</a> = FSM_DEFMAXNAKLOOPS;
00119         f-&gt;<a class="code" href="structfsm.html#o15">term_reason_len</a> = 0;
00120 }
00121 
00122 
00123 <span class="comment">/*</span>
00124 <span class="comment"> * fsm_lowerup - The lower layer is up.</span>
00125 <span class="comment"> */</span>
00126 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a25">fsm_lowerup</a>(<a class="code" href="structfsm.html">fsm</a> *f)
00127 {
00128         <span class="keywordtype">int</span> oldState = f-&gt;<a class="code" href="structfsm.html#o2">state</a>;
00129 
00130         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00131         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a8">INITIAL</a>:
00132                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a10">CLOSED</a>;
00133                 <span class="keywordflow">break</span>;
00134         
00135         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a9">STARTING</a>:
00136                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o3">flags</a> &amp; <a class="code" href="fsm_8h.html#a20">OPT_SILENT</a> )
00137                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00138                 <span class="keywordflow">else</span> {
00139                         <span class="comment">/* Send an initial configure-request */</span>
00140                         fsm_sconfreq(f, 0);
00141                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00142                 }
00143         <span class="keywordflow">break</span>;
00144         
00145         <span class="keywordflow">default</span>:
00146                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: Up event in state %d!\n"</span>,
00147                                 PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00148         }
00149         
00150         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: lowerup state %d -&gt; %d\n"</span>,
00151                         PROTO_NAME(f), oldState, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00152 }
00153 
00154 
00155 <span class="comment">/*</span>
00156 <span class="comment"> * fsm_lowerdown - The lower layer is down.</span>
00157 <span class="comment"> *</span>
00158 <span class="comment"> * Cancel all timeouts and inform upper layers.</span>
00159 <span class="comment"> */</span>
00160 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a26">fsm_lowerdown</a>(<a class="code" href="structfsm.html">fsm</a> *f)
00161 {
00162         <span class="keywordtype">int</span> oldState = f-&gt;<a class="code" href="structfsm.html#o2">state</a>;
00163         
00164         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00165         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00166                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a8">INITIAL</a>;
00167                 <span class="keywordflow">break</span>;
00168         
00169         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00170                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a9">STARTING</a>;
00171                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a9">starting</a> )
00172                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a9">starting</a>)(f);
00173                 <span class="keywordflow">break</span>;
00174         
00175         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00176                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a8">INITIAL</a>;
00177                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00178                 <span class="keywordflow">break</span>;
00179         
00180         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00181         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00182         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00183         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00184                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a9">STARTING</a>;
00185                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00186                 <span class="keywordflow">break</span>;
00187         
00188         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00189                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a> )
00190                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);
00191                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a9">STARTING</a>;
00192                 <span class="keywordflow">break</span>;
00193         
00194         <span class="keywordflow">default</span>:
00195                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: Down event in state %d!\n"</span>,
00196                                 PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00197         }
00198         
00199         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: lowerdown state %d -&gt; %d\n"</span>,
00200                         PROTO_NAME(f), oldState, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00201 }
00202 
00203 
00204 <span class="comment">/*</span>
00205 <span class="comment"> * fsm_open - Link is allowed to come up.</span>
00206 <span class="comment"> */</span>
00207 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a27">fsm_open</a>(<a class="code" href="structfsm.html">fsm</a> *f)
00208 {
00209         <span class="keywordtype">int</span> oldState = f-&gt;<a class="code" href="structfsm.html#o2">state</a>;
00210         
00211         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00212                 <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a8">INITIAL</a>:
00213                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a9">STARTING</a>;
00214                         <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a9">starting</a> )
00215                                 (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a9">starting</a>)(f);
00216                         <span class="keywordflow">break</span>;
00217                 
00218                 <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00219                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o3">flags</a> &amp; <a class="code" href="fsm_8h.html#a20">OPT_SILENT</a> )
00220                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00221                 <span class="keywordflow">else</span> {
00222                         <span class="comment">/* Send an initial configure-request */</span>
00223                         fsm_sconfreq(f, 0);
00224                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00225                 }
00226                 <span class="keywordflow">break</span>;
00227         
00228         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00229                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a13">STOPPING</a>;
00230                 <span class="comment">/* fall through */</span>
00231         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00232         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00233                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o3">flags</a> &amp; <a class="code" href="fsm_8h.html#a19">OPT_RESTART</a> ){
00234                         <a class="code" href="fsm_8h.html#a26">fsm_lowerdown</a>(f);
00235                         <a class="code" href="fsm_8h.html#a25">fsm_lowerup</a>(f);
00236                 }
00237                 <span class="keywordflow">break</span>;
00238         }
00239         
00240         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: open state %d -&gt; %d\n"</span>,
00241                         PROTO_NAME(f), oldState, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00242 }
00243 
00244 
00245 <span class="comment">/*</span>
00246 <span class="comment"> * fsm_close - Start closing connection.</span>
00247 <span class="comment"> *</span>
00248 <span class="comment"> * Cancel timeouts and either initiate close or possibly go directly to</span>
00249 <span class="comment"> * the CLOSED state.</span>
00250 <span class="comment"> */</span>
00251 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a28">fsm_close</a>(<a class="code" href="structfsm.html">fsm</a> *f, <span class="keywordtype">char</span> *reason)
00252 {
00253         <span class="keywordtype">int</span> oldState = f-&gt;<a class="code" href="structfsm.html#o2">state</a>;
00254         
00255         f-&gt;<a class="code" href="structfsm.html#o14">term_reason</a> = reason;
00256         f-&gt;<a class="code" href="structfsm.html#o15">term_reason_len</a> = (reason == <a class="code" href="def_8h.html#a2">NULL</a>? 0: strlen(reason));
00257         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00258         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a9">STARTING</a>:
00259                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a8">INITIAL</a>;
00260                 <span class="keywordflow">break</span>;
00261         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00262                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a10">CLOSED</a>;
00263                 <span class="keywordflow">break</span>;
00264         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00265                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a12">CLOSING</a>;
00266                 <span class="keywordflow">break</span>;
00267         
00268         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00269         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00270         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00271         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00272                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> != <a class="code" href="fsm_8h.html#a17">OPENED</a> )
00273                         UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00274                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a> )
00275                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers we're down */</span>
00276                 
00277                 <span class="comment">/* Init restart counter, send Terminate-Request */</span>
00278                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = f-&gt;<a class="code" href="structfsm.html#o10">maxtermtransmits</a>;
00279                 <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMREQ, f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> = ++f-&gt;<a class="code" href="structfsm.html#o4">id</a>,
00280                                         (u_char *) f-&gt;<a class="code" href="structfsm.html#o14">term_reason</a>, f-&gt;<a class="code" href="structfsm.html#o15">term_reason_len</a>);
00281                 TIMEOUT(fsm_timeout, f, f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a>);
00282                 --f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a>;
00283                 
00284                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a12">CLOSING</a>;
00285                 <span class="keywordflow">break</span>;
00286         }
00287         
00288         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: close reason=%s state %d -&gt; %d\n"</span>,
00289                         PROTO_NAME(f), reason, oldState, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00290 }
00291 
00292 
00293 <span class="comment">/*</span>
00294 <span class="comment"> * fsm_sdata - Send some data.</span>
00295 <span class="comment"> *</span>
00296 <span class="comment"> * Used for all packets sent to our peer by this module.</span>
00297 <span class="comment"> */</span>
00298 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(
00299         <a class="code" href="structfsm.html">fsm</a> *f,
00300         u_char code, 
00301         u_char id,
00302         u_char *data,
00303         <span class="keywordtype">int</span> datalen
00304 )
00305 {
00306         u_char *outp;
00307         <span class="keywordtype">int</span> outlen;
00308         
00309         <span class="comment">/* Adjust length to be smaller than MTU */</span>
00310         outp = outpacket_buf[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>];
00311         <span class="keywordflow">if</span> (datalen &gt; <a class="code" href="fsm_8h.html#a23">peer_mru</a>[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>] - (<span class="keywordtype">int</span>)<a class="code" href="fsm_8h.html#a0">HEADERLEN</a>)
00312                 datalen = <a class="code" href="fsm_8h.html#a23">peer_mru</a>[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>] - <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>;
00313         <span class="keywordflow">if</span> (datalen &amp;&amp; data != outp + PPP_HDRLEN + <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>)
00314                 BCOPY(data, outp + PPP_HDRLEN + HEADERLEN, datalen);
00315         outlen = datalen + <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>;
00316         MAKEHEADER(outp, f-&gt;<a class="code" href="structfsm.html#o1">protocol</a>);
00317         PUTCHAR(code, outp);
00318         PUTCHAR(id, outp);
00319         PUTSHORT(outlen, outp);
00320         pppWrite(f-&gt;<a class="code" href="structfsm.html#o0">unit</a>, outpacket_buf[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>], outlen + PPP_HDRLEN);
00321         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_sdata(%s): Sent code %d,%d,%d.\n"</span>,
00322                                 PROTO_NAME(f), code, id, outlen));
00323 }
00324 
00325 
00326 <span class="comment">/*</span>
00327 <span class="comment"> * fsm_input - Input packet.</span>
00328 <span class="comment"> */</span>
00329 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a29">fsm_input</a>(<a class="code" href="structfsm.html">fsm</a> *f, u_char *inpacket, <span class="keywordtype">int</span> l)
00330 {
00331         u_char *inp = inpacket;
00332         u_char code, id;
00333         <span class="keywordtype">int</span> len;
00334         
00335         <span class="comment">/*</span>
00336 <span class="comment">        * Parse header (code, id and length).</span>
00337 <span class="comment">        * If packet too short, drop it.</span>
00338 <span class="comment">        */</span>
00339         <span class="keywordflow">if</span> (l &lt; <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>) {
00340                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"fsm_input(%x): Rcvd short header.\n"</span>,
00341                                         f-&gt;<a class="code" href="structfsm.html#o1">protocol</a>));
00342                 <span class="keywordflow">return</span>;
00343         }
00344         GETCHAR(code, inp);
00345         GETCHAR(id, inp);
00346         GETSHORT(len, inp);
00347         <span class="keywordflow">if</span> (len &lt; <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>) {
00348                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_input(%x): Rcvd illegal length.\n"</span>,
00349                                 f-&gt;<a class="code" href="structfsm.html#o1">protocol</a>));
00350                 <span class="keywordflow">return</span>;
00351         }
00352         <span class="keywordflow">if</span> (len &gt; l) {
00353                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_input(%x): Rcvd short packet.\n"</span>,
00354                                 f-&gt;<a class="code" href="structfsm.html#o1">protocol</a>));
00355                 <span class="keywordflow">return</span>;
00356         }
00357         len -= <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>;               <span class="comment">/* subtract header length */</span>
00358         
00359         <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a8">INITIAL</a> || f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a9">STARTING</a> ){
00360                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_input(%x): Rcvd packet in state %d.\n"</span>,
00361                                 f-&gt;<a class="code" href="structfsm.html#o1">protocol</a>, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00362                 <span class="keywordflow">return</span>;
00363         }
00364         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_input(%s):%d,%d,%d\n"</span>, PROTO_NAME(f), code, id, l));
00365         <span class="comment">/*</span>
00366 <span class="comment">         * Action depends on code.</span>
00367 <span class="comment">         */</span>
00368         <span class="keywordflow">switch</span> (code) {
00369         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a1">CONFREQ</a>:
00370                 fsm_rconfreq(f, id, inp, len);
00371                 <span class="keywordflow">break</span>;
00372         
00373         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a2">CONFACK</a>:
00374                 fsm_rconfack(f, id, inp, len);
00375                 <span class="keywordflow">break</span>;
00376         
00377         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a3">CONFNAK</a>:
00378         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a4">CONFREJ</a>:
00379                 fsm_rconfnakrej(f, code, id, inp, len);
00380                 <span class="keywordflow">break</span>;
00381         
00382         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a5">TERMREQ</a>:
00383                 fsm_rtermreq(f, id, inp, len);
00384                 <span class="keywordflow">break</span>;
00385         
00386         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a6">TERMACK</a>:
00387                 fsm_rtermack(f);
00388                 <span class="keywordflow">break</span>;
00389         
00390         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a7">CODEREJ</a>:
00391                 fsm_rcoderej(f, inp, len);
00392                 <span class="keywordflow">break</span>;
00393         
00394         <span class="keywordflow">default</span>:
00395                 <span class="keywordflow">if</span>( !f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a13">extcode</a>
00396                                 || !(*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a13">extcode</a>)(f, code, id, inp, len) )
00397                         <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, CODEREJ, ++f-&gt;<a class="code" href="structfsm.html#o4">id</a>, inpacket, len + HEADERLEN);
00398                 <span class="keywordflow">break</span>;
00399         }
00400 }
00401 
00402 
00403 <span class="comment">/*</span>
00404 <span class="comment"> * fsm_protreject - Peer doesn't speak this protocol.</span>
00405 <span class="comment"> *</span>
00406 <span class="comment"> * Treat this as a catastrophic error (RXJ-).</span>
00407 <span class="comment"> */</span>
00408 <span class="keywordtype">void</span> <a class="code" href="fsm_8h.html#a30">fsm_protreject</a>(<a class="code" href="structfsm.html">fsm</a> *f)
00409 {
00410         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00411         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00412                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00413                 <span class="comment">/* fall through */</span>
00414         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00415                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a10">CLOSED</a>;
00416                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00417                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00418                 <span class="keywordflow">break</span>;
00419         
00420         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00421         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00422         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00423         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00424                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00425                 <span class="comment">/* fall through */</span>
00426         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00427                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00428                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00429                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00430                 <span class="keywordflow">break</span>;
00431         
00432         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00433                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a> )
00434                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);
00435                 
00436                 <span class="comment">/* Init restart counter, send Terminate-Request */</span>
00437                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = f-&gt;<a class="code" href="structfsm.html#o10">maxtermtransmits</a>;
00438                 <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMREQ, f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> = ++f-&gt;<a class="code" href="structfsm.html#o4">id</a>,
00439                                         (u_char *) f-&gt;<a class="code" href="structfsm.html#o14">term_reason</a>, f-&gt;<a class="code" href="structfsm.html#o15">term_reason_len</a>);
00440                 TIMEOUT(fsm_timeout, f, f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a>);
00441                 --f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a>;
00442                 
00443                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a13">STOPPING</a>;
00444                 <span class="keywordflow">break</span>;
00445         
00446         <span class="keywordflow">default</span>:
00447                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: Protocol-reject event in state %d!\n"</span>,
00448                                         PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00449         }
00450 }
00451 
00452 
00453 
00454 
00455 
00456 <span class="comment">/**********************************/</span>
00457 <span class="comment">/*** LOCAL FUNCTION DEFINITIONS ***/</span>
00458 <span class="comment">/**********************************/</span>
00459 
00460 <span class="comment">/*</span>
00461 <span class="comment"> * fsm_timeout - Timeout expired.</span>
00462 <span class="comment"> */</span>
00463 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_timeout(<span class="keywordtype">void</span> *arg)
00464 {
00465     <a class="code" href="structfsm.html">fsm</a> *f = (<a class="code" href="structfsm.html">fsm</a> *) arg;
00466 
00467     <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a>) {
00468     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00469     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00470                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> &lt;= 0 ){
00471                     <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"%s: timeout sending Terminate-Request state=%d\n"</span>,
00472                                            PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00473                     <span class="comment">/*</span>
00474 <span class="comment">                     * We've waited for an ack long enough.  Peer probably heard us.</span>
00475 <span class="comment">                     */</span>
00476                     f-&gt;<a class="code" href="structfsm.html#o2">state</a> = (f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a12">CLOSING</a>)? <a class="code" href="fsm_8h.html#a10">CLOSED</a>: <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00477                     <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00478                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00479                 } <span class="keywordflow">else</span> {
00480                     <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"%s: timeout resending Terminate-Requests state=%d\n"</span>,
00481                                            PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00482                     <span class="comment">/* Send Terminate-Request */</span>
00483                     <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMREQ, f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> = ++f-&gt;<a class="code" href="structfsm.html#o4">id</a>,
00484                               (u_char *) f-&gt;<a class="code" href="structfsm.html#o14">term_reason</a>, f-&gt;<a class="code" href="structfsm.html#o15">term_reason_len</a>);
00485                     TIMEOUT(fsm_timeout, f, f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a>);
00486                     --f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a>;
00487                 }
00488                 <span class="keywordflow">break</span>;
00489 
00490     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00491     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00492     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00493                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> &lt;= 0) {
00494                     <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"%s: timeout sending Config-Requests state=%d\n"</span>,
00495                            PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00496                     f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00497                     <span class="keywordflow">if</span>( (f-&gt;<a class="code" href="structfsm.html#o3">flags</a> &amp; <a class="code" href="fsm_8h.html#a18">OPT_PASSIVE</a>) == 0 &amp;&amp; f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00498                                 (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00499         
00500                 } <span class="keywordflow">else</span> {
00501                     <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"%s: timeout resending Config-Request state=%d\n"</span>,
00502                            PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00503                     <span class="comment">/* Retransmit the configure-request */</span>
00504                     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a12">retransmit</a>)
00505                                 (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a12">retransmit</a>)(f);
00506                     fsm_sconfreq(f, 1);         <span class="comment">/* Re-send Configure-Request */</span>
00507                     <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a15">ACKRCVD</a> )
00508                                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00509                 }
00510                 <span class="keywordflow">break</span>;
00511 
00512     <span class="keywordflow">default</span>:
00513                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: Timeout event in state %d!\n"</span>,
00514                                   PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00515             }
00516 }
00517 
00518 
00519 <span class="comment">/*</span>
00520 <span class="comment"> * fsm_rconfreq - Receive Configure-Request.</span>
00521 <span class="comment"> */</span>
00522 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfreq(<a class="code" href="structfsm.html">fsm</a> *f, u_char id, u_char *inp, <span class="keywordtype">int</span> len)
00523 {
00524         <span class="keywordtype">int</span> code, reject_if_disagree;
00525         
00526         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rconfreq(%s): Rcvd id %d state=%d\n"</span>, 
00527                                 PROTO_NAME(f), id, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00528         <span class="keywordflow">switch</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> ){
00529         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00530                 <span class="comment">/* Go away, we're closed */</span>
00531                 <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMACK, id, NULL, 0);
00532                 <span class="keywordflow">return</span>;
00533         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00534         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00535                 <span class="keywordflow">return</span>;
00536         
00537         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00538                 <span class="comment">/* Go down and restart negotiation */</span>
00539                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a> )
00540                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers */</span>
00541                 fsm_sconfreq(f, 0);             <span class="comment">/* Send initial Configure-Request */</span>
00542                 <span class="keywordflow">break</span>;
00543         
00544         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00545                 <span class="comment">/* Negotiation started by our peer */</span>
00546                 fsm_sconfreq(f, 0);             <span class="comment">/* Send initial Configure-Request */</span>
00547                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00548                 <span class="keywordflow">break</span>;
00549         }
00550         
00551         <span class="comment">/*</span>
00552 <span class="comment">        * Pass the requested configuration options</span>
00553 <span class="comment">        * to protocol-specific code for checking.</span>
00554 <span class="comment">        */</span>
00555         <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a6">reqci</a>){               <span class="comment">/* Check CI */</span>
00556                 reject_if_disagree = (f-&gt;<a class="code" href="structfsm.html#o11">nakloops</a> &gt;= f-&gt;<a class="code" href="structfsm.html#o12">maxnakloops</a>);
00557                 code = (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a6">reqci</a>)(f, inp, &amp;len, reject_if_disagree);
00558         } 
00559         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len)
00560                 code = <a class="code" href="fsm_8h.html#a4">CONFREJ</a>;                 <span class="comment">/* Reject all CI */</span>
00561         <span class="keywordflow">else</span>
00562                 code = <a class="code" href="fsm_8h.html#a2">CONFACK</a>;
00563         
00564         <span class="comment">/* send the Ack, Nak or Rej to the peer */</span>
00565         <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, (u_char)code, id, inp, len);
00566         
00567         <span class="keywordflow">if</span> (code == <a class="code" href="fsm_8h.html#a2">CONFACK</a>) {
00568                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>) {
00569                         UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00570                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a17">OPENED</a>;
00571                         <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a7">up</a>)
00572                                 (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a7">up</a>)(f); <span class="comment">/* Inform upper layers */</span>
00573                 } 
00574                 <span class="keywordflow">else</span>
00575                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a16">ACKSENT</a>;
00576                 f-&gt;<a class="code" href="structfsm.html#o11">nakloops</a> = 0;
00577         } 
00578         <span class="keywordflow">else</span> {
00579                 <span class="comment">/* we sent CONFACK or CONFREJ */</span>
00580                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a> != <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>)
00581                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00582                 <span class="keywordflow">if</span>( code == <a class="code" href="fsm_8h.html#a3">CONFNAK</a> )
00583                         ++f-&gt;<a class="code" href="structfsm.html#o11">nakloops</a>;
00584         }
00585 }
00586 
00587 
00588 <span class="comment">/*</span>
00589 <span class="comment"> * fsm_rconfack - Receive Configure-Ack.</span>
00590 <span class="comment"> */</span>
00591 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfack(<a class="code" href="structfsm.html">fsm</a> *f, <span class="keywordtype">int</span> id, u_char *inp, <span class="keywordtype">int</span> len)
00592 {
00593         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rconfack(%s): Rcvd id %d state=%d\n"</span>,
00594                                 PROTO_NAME(f), id, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00595         
00596         <span class="keywordflow">if</span> (id != f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> || f-&gt;<a class="code" href="structfsm.html#o6">seen_ack</a>)              <span class="comment">/* Expected id? */</span>
00597                 <span class="keywordflow">return</span>;                                 <span class="comment">/* Nope, toss... */</span>
00598         <span class="keywordflow">if</span>( !(f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a3">ackci</a>? (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a3">ackci</a>)(f, inp, len):
00599                                                                 (len == 0)) ){
00600                 <span class="comment">/* Ack is bad - ignore it */</span>
00601                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: received bad Ack (length %d)\n"</span>,
00602                                         PROTO_NAME(f), len));
00603                 <span class="keywordflow">return</span>;
00604         }
00605         f-&gt;<a class="code" href="structfsm.html#o6">seen_ack</a> = 1;
00606         
00607         <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a>) {
00608         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00609         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00610                 <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMACK, (u_char)id, NULL, 0);
00611                 <span class="keywordflow">break</span>;
00612         
00613         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00614                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>;
00615                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = f-&gt;<a class="code" href="structfsm.html#o8">maxconfreqtransmits</a>;
00616                 <span class="keywordflow">break</span>;
00617         
00618         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00619                 <span class="comment">/* Huh? an extra valid Ack? oh well... */</span>
00620                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00621                 fsm_sconfreq(f, 0);
00622                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00623                 <span class="keywordflow">break</span>;
00624         
00625         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00626                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00627                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a17">OPENED</a>;
00628                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = f-&gt;<a class="code" href="structfsm.html#o8">maxconfreqtransmits</a>;
00629                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a7">up</a>)
00630                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a7">up</a>)(f); <span class="comment">/* Inform upper layers */</span>
00631                 <span class="keywordflow">break</span>;
00632         
00633         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00634                 <span class="comment">/* Go down and restart negotiation */</span>
00635                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)
00636                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers */</span>
00637                 fsm_sconfreq(f, 0);             <span class="comment">/* Send initial Configure-Request */</span>
00638                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00639                 <span class="keywordflow">break</span>;
00640         }
00641 }
00642 
00643 
00644 <span class="comment">/*</span>
00645 <span class="comment"> * fsm_rconfnakrej - Receive Configure-Nak or Configure-Reject.</span>
00646 <span class="comment"> */</span>
00647 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rconfnakrej(<a class="code" href="structfsm.html">fsm</a> *f, <span class="keywordtype">int</span> code, <span class="keywordtype">int</span> id, u_char *inp, <span class="keywordtype">int</span> len)
00648 {
00649         int (*proc) (<a class="code" href="structfsm.html">fsm</a> *, u_char *, <span class="keywordtype">int</span>);
00650         <span class="keywordtype">int</span> ret;
00651         
00652         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rconfnakrej(%s): Rcvd id %d state=%d\n"</span>,
00653                                 PROTO_NAME(f), id, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00654         
00655         <span class="keywordflow">if</span> (id != f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> || f-&gt;<a class="code" href="structfsm.html#o6">seen_ack</a>)      <span class="comment">/* Expected id? */</span>
00656                 <span class="keywordflow">return</span>;                         <span class="comment">/* Nope, toss... */</span>
00657         proc = (code == <a class="code" href="fsm_8h.html#a3">CONFNAK</a>)? f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a4">nakci</a>: f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a5">rejci</a>;
00658         <span class="keywordflow">if</span> (!proc || !(ret = proc(f, inp, len))) {
00659                 <span class="comment">/* Nak/reject is bad - ignore it */</span>
00660                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: received bad %s (length %d)\n"</span>,
00661                                         PROTO_NAME(f), (code==CONFNAK? <span class="stringliteral">"Nak"</span>: <span class="stringliteral">"reject"</span>), len));
00662                 <span class="keywordflow">return</span>;
00663         }
00664         f-&gt;<a class="code" href="structfsm.html#o6">seen_ack</a> = 1;
00665         
00666         <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a>) {
00667         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a10">CLOSED</a>:
00668         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a11">STOPPED</a>:
00669                 <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMACK, (u_char)id, NULL, 0);
00670                 <span class="keywordflow">break</span>;
00671         
00672         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a14">REQSENT</a>:
00673         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00674                 <span class="comment">/* They didn't agree to what we wanted - try another request */</span>
00675                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00676                 <span class="keywordflow">if</span> (ret &lt; 0)
00677                         f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;             <span class="comment">/* kludge for stopping CCP */</span>
00678                 <span class="keywordflow">else</span>
00679                         fsm_sconfreq(f, 0);             <span class="comment">/* Send Configure-Request */</span>
00680                 <span class="keywordflow">break</span>;
00681         
00682         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00683                 <span class="comment">/* Got a Nak/reject when we had already had an Ack?? oh well... */</span>
00684                 UNTIMEOUT(fsm_timeout, f);      <span class="comment">/* Cancel timeout */</span>
00685                 fsm_sconfreq(f, 0);
00686                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00687                 <span class="keywordflow">break</span>;
00688         
00689         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00690                 <span class="comment">/* Go down and restart negotiation */</span>
00691                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)
00692                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers */</span>
00693                 fsm_sconfreq(f, 0);             <span class="comment">/* Send initial Configure-Request */</span>
00694                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00695                 <span class="keywordflow">break</span>;
00696         }
00697 }
00698 
00699 
00700 <span class="comment">/*</span>
00701 <span class="comment"> * fsm_rtermreq - Receive Terminate-Req.</span>
00702 <span class="comment"> */</span>
00703 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rtermreq(<a class="code" href="structfsm.html">fsm</a> *f, <span class="keywordtype">int</span> id, u_char *p, <span class="keywordtype">int</span> len)
00704 {
00705         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rtermreq(%s): Rcvd id %d state=%d\n"</span>,
00706                                 PROTO_NAME(f), id, f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00707         
00708         <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a>) {
00709         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00710         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a16">ACKSENT</a>:
00711                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;             <span class="comment">/* Start over but keep trying */</span>
00712                 <span class="keywordflow">break</span>;
00713         
00714         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00715                 <span class="keywordflow">if</span> (len &gt; 0) {
00716                         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s terminated by peer (%x)\n"</span>, PROTO_NAME(f), p));
00717                 } <span class="keywordflow">else</span> {
00718                         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s terminated by peer\n"</span>, PROTO_NAME(f)));
00719                 }
00720                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)
00721                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers */</span>
00722                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = 0;
00723                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a13">STOPPING</a>;
00724                 TIMEOUT(fsm_timeout, f, f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a>);
00725                 <span class="keywordflow">break</span>;
00726         }
00727         
00728         <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, TERMACK, (u_char)id, NULL, 0);
00729 }
00730 
00731 
00732 <span class="comment">/*</span>
00733 <span class="comment"> * fsm_rtermack - Receive Terminate-Ack.</span>
00734 <span class="comment"> */</span>
00735 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rtermack(<a class="code" href="structfsm.html">fsm</a> *f)
00736 {
00737         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rtermack(%s): state=%d\n"</span>, 
00738                                 PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00739         
00740         <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structfsm.html#o2">state</a>) {
00741         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a12">CLOSING</a>:
00742                 UNTIMEOUT(fsm_timeout, f);
00743                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a10">CLOSED</a>;
00744                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00745                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00746                 <span class="keywordflow">break</span>;
00747         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a13">STOPPING</a>:
00748                 UNTIMEOUT(fsm_timeout, f);
00749                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a11">STOPPED</a>;
00750                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a> )
00751                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a10">finished</a>)(f);
00752                 <span class="keywordflow">break</span>;
00753         
00754         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a15">ACKRCVD</a>:
00755                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00756                 <span class="keywordflow">break</span>;
00757         
00758         <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#a17">OPENED</a>:
00759                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)
00760                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a8">down</a>)(f);       <span class="comment">/* Inform upper layers */</span>
00761                 fsm_sconfreq(f, 0);
00762                 <span class="keywordflow">break</span>;
00763         }
00764 }
00765 
00766 
00767 <span class="comment">/*</span>
00768 <span class="comment"> * fsm_rcoderej - Receive an Code-Reject.</span>
00769 <span class="comment"> */</span>
00770 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_rcoderej(<a class="code" href="structfsm.html">fsm</a> *f, u_char *inp, <span class="keywordtype">int</span> len)
00771 {
00772         u_char code, id;
00773         
00774         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rcoderej(%s): state=%d\n"</span>, 
00775                                 PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o2">state</a>));
00776         
00777         <span class="keywordflow">if</span> (len &lt; <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>) {
00778                 <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"fsm_rcoderej: Rcvd short Code-Reject packet!\n"</span>));
00779                 <span class="keywordflow">return</span>;
00780         }
00781         GETCHAR(code, inp);
00782         GETCHAR(id, inp);
00783         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_WARNING, <span class="stringliteral">"%s: Rcvd Code-Reject for code %d, id %d\n"</span>,
00784                                 PROTO_NAME(f), code, id));
00785         
00786         <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> == <a class="code" href="fsm_8h.html#a15">ACKRCVD</a> )
00787                 f-&gt;<a class="code" href="structfsm.html#o2">state</a> = <a class="code" href="fsm_8h.html#a14">REQSENT</a>;
00788 }
00789 
00790 
00791 <span class="comment">/*</span>
00792 <span class="comment"> * fsm_sconfreq - Send a Configure-Request.</span>
00793 <span class="comment"> */</span>
00794 <span class="keyword">static</span> <span class="keywordtype">void</span> fsm_sconfreq(<a class="code" href="structfsm.html">fsm</a> *f, <span class="keywordtype">int</span> retransmit)
00795 {
00796         u_char *outp;
00797         <span class="keywordtype">int</span> cilen;
00798         
00799         <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o2">state</a> != <a class="code" href="fsm_8h.html#a14">REQSENT</a> &amp;&amp; f-&gt;<a class="code" href="structfsm.html#o2">state</a> != <a class="code" href="fsm_8h.html#a15">ACKRCVD</a> &amp;&amp; f-&gt;<a class="code" href="structfsm.html#o2">state</a> != <a class="code" href="fsm_8h.html#a16">ACKSENT</a> ){
00800                 <span class="comment">/* Not currently negotiating - reset options */</span>
00801                 <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a0">resetci</a> )
00802                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a0">resetci</a>)(f);
00803                 f-&gt;<a class="code" href="structfsm.html#o11">nakloops</a> = 0;
00804                 }
00805         
00806         <span class="keywordflow">if</span>( !retransmit ){
00807                 <span class="comment">/* New request - reset retransmission counter, use new ID */</span>
00808                 f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a> = f-&gt;<a class="code" href="structfsm.html#o8">maxconfreqtransmits</a>;
00809                 f-&gt;<a class="code" href="structfsm.html#o5">reqid</a> = ++f-&gt;<a class="code" href="structfsm.html#o4">id</a>;
00810         }
00811         
00812         f-&gt;<a class="code" href="structfsm.html#o6">seen_ack</a> = 0;
00813         
00814         <span class="comment">/*</span>
00815 <span class="comment">         * Make up the request packet</span>
00816 <span class="comment">         */</span>
00817         outp = outpacket_buf[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>] + PPP_HDRLEN + <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>;
00818         <span class="keywordflow">if</span>( f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a1">cilen</a> &amp;&amp; f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a2">addci</a> ){
00819                 cilen = (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a1">cilen</a>)(f);
00820                 <span class="keywordflow">if</span>( cilen &gt; <a class="code" href="fsm_8h.html#a23">peer_mru</a>[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>] - (<span class="keywordtype">int</span>)<a class="code" href="fsm_8h.html#a0">HEADERLEN</a> )
00821                         cilen = <a class="code" href="fsm_8h.html#a23">peer_mru</a>[f-&gt;<a class="code" href="structfsm.html#o0">unit</a>] - <a class="code" href="fsm_8h.html#a0">HEADERLEN</a>;
00822                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a2">addci</a>)
00823                         (*f-&gt;<a class="code" href="structfsm.html#o13">callbacks</a>-&gt;<a class="code" href="structfsm__callbacks.html#a2">addci</a>)(f, outp, &amp;cilen);
00824         } <span class="keywordflow">else</span>
00825                 cilen = 0;
00826         
00827         <span class="comment">/* send the request to our peer */</span>
00828         <a class="code" href="fsm_8h.html#a31">fsm_sdata</a>(f, CONFREQ, f-&gt;<a class="code" href="structfsm.html#o5">reqid</a>, outp, cilen);
00829         
00830         <span class="comment">/* start the retransmit timer */</span>
00831         --f-&gt;<a class="code" href="structfsm.html#o9">retransmits</a>;
00832         TIMEOUT(fsm_timeout, f, f-&gt;<a class="code" href="structfsm.html#o7">timeouttime</a>);
00833         
00834         <a class="code" href="pppdebug_8h.html#a4">FSMDEBUG</a>((LOG_INFO, <span class="stringliteral">"%s: sending Configure-Request, id %d\n"</span>,
00835                                 PROTO_NAME(f), f-&gt;<a class="code" href="structfsm.html#o5">reqid</a>));
00836 }
00837 
00838 <span class="preprocessor">#endif </span><span class="comment">/* PPP_SUPPORT */</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
