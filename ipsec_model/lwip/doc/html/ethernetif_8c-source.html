
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ethernetif.c</h1><a href="ethernetif_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved. </span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification, </span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission. </span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED </span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT </span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, </span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT </span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING </span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY </span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> * </span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="comment">/*</span>
00034 <span class="comment"> * This file is a skeleton for developing Ethernet network interface</span>
00035 <span class="comment"> * drivers for lwIP. Add code to the low_level functions and do a</span>
00036 <span class="comment"> * search-and-replace for the word "ethernetif" to replace it with</span>
00037 <span class="comment"> * something that better describes your network interface.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * THIS CODE NEEDS TO BE FIXED - IT IS NOT In SYNC WITH CURRENT ETHARP API</span>
00040 <span class="comment"> */</span>
00041 
00042 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="def_8h.html">lwip/def.h</a>"</span>
00044 <span class="preprocessor">#include "<a class="code" href="mem_8h.html">lwip/mem.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="pbuf_8h.html">lwip/pbuf.h</a>"</span>
00046 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">lwip/sys.h</a>"</span>
00047 
00048 <span class="preprocessor">#include "netif/arp.h"</span>
00049 
00050 <span class="comment">/* Define those to better describe your network interface. */</span>
<a name="l00051"></a><a class="code" href="ethernetif_8c.html#a0">00051</a> <span class="preprocessor">#define IFNAME0 'e'</span>
<a name="l00052"></a><a class="code" href="ethernetif_8c.html#a1">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define IFNAME1 't'</span>
00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="structethernetif.html">00054</a> <span class="keyword">struct </span><a class="code" href="structethernetif.html">ethernetif</a> {
<a name="l00055"></a><a class="code" href="structethernetif.html#o0">00055</a>   <span class="keyword">struct </span><a class="code" href="structeth__addr.html">eth_addr</a> *<a class="code" href="structethernetif.html#o0">ethaddr</a>;
00056   <span class="comment">/* Add whatever per-interface state that is needed here. */</span>
00057 };
00058 
<a name="l00059"></a><a class="code" href="ethernetif_8c.html#a2">00059</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structeth__addr.html">eth_addr</a> <a class="code" href="ethernetif_8c.html#a2">ethbroadcast</a> = {{0xff,0xff,0xff,0xff,0xff,0xff}};
00060 
00061 <span class="comment">/* Forward declarations. */</span>
00062 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="ethernetif_8c.html#a3">ethernetif_input</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00063 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="ethernetif_8c.html#a4">ethernetif_output</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p,
00064              <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *ipaddr);
00065 
00066 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00067 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00068"></a><a class="code" href="ethernetif_8c.html#a5">00068</a> <a class="code" href="ethernetif_8c.html#a5">low_level_init</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00069 {
00070   <span class="keyword">struct </span><a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>;
00071 
00072   <a class="code" href="structethernetif.html">ethernetif</a> = netif-&gt;<a class="code" href="structnetif.html#o7">state</a>;
00073   
00074   <span class="comment">/* set MAC hardware address length */</span>
00075   netif-&gt;<a class="code" href="structnetif.html#o8">hwaddr_len</a> = 6;
00076 
00077   <span class="comment">/* set MAC hardware address */</span>
00078   netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[0] = ;
00079   ...
00080   netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[6] = ;
00081 
00082   <span class="comment">/* maximum transfer unit */</span>
00083   netif-&gt;<a class="code" href="structnetif.html#o10">mtu</a> = 1500;
00084   
00085   <span class="comment">/* broadcast capability */</span>
00086   netif-&gt;<a class="code" href="structnetif.html#o13">flags</a> = <a class="code" href="netif_8h.html#a2">NETIF_FLAG_BROADCAST</a>;
00087  
00088   <span class="comment">/* Do whatever else is needed to initialize interface. */</span>  
00089 }
00090 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00091 <span class="comment">/*</span>
00092 <span class="comment"> * low_level_output():</span>
00093 <span class="comment"> *</span>
00094 <span class="comment"> * Should do the actual transmission of the packet. The packet is</span>
00095 <span class="comment"> * contained in the pbuf that is passed to the function. This pbuf</span>
00096 <span class="comment"> * might be chained.</span>
00097 <span class="comment"> *</span>
00098 <span class="comment"> */</span>
00099 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00100 
00101 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00102"></a><a class="code" href="ethernetif_8c.html#a6">00102</a> <a class="code" href="ethernetif_8c.html#a6">low_level_output</a>(<span class="keyword">struct</span> <a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p)
00103 {
00104   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *q;
00105 
00106   initiate transfer();
00107   
00108   <span class="keywordflow">for</span>(q = p; q != <a class="code" href="def_8h.html#a2">NULL</a>; q = q-&gt;next) {
00109     <span class="comment">/* Send the data from the pbuf to the interface, one pbuf at a</span>
00110 <span class="comment">       time. The size of the data in each pbuf is kept in the -&gt;len</span>
00111 <span class="comment">       variable. */</span>
00112     send data from(q-&gt;payload, q-&gt;len);
00113   }
00114 
00115   signal that packet should be sent();
00116   
00117 <span class="preprocessor">#ifdef LINK_STATS</span>
00118 <span class="preprocessor"></span>  lwip_stats.link.xmit++;
00119 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>      
00120 
00121   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00122 }
00123 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00124 <span class="comment">/*</span>
00125 <span class="comment"> * low_level_input():</span>
00126 <span class="comment"> *</span>
00127 <span class="comment"> * Should allocate a pbuf and transfer the bytes of the incoming</span>
00128 <span class="comment"> * packet from the interface into the pbuf.</span>
00129 <span class="comment"> *</span>
00130 <span class="comment"> */</span>
00131 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00132 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *
<a name="l00133"></a><a class="code" href="ethernetif_8c.html#a7">00133</a> <a class="code" href="ethernetif_8c.html#a7">low_level_input</a>(<span class="keyword">struct</span> <a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>)
00134 {
00135   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p, *q;
00136   u16_t len;
00137 
00138   <span class="comment">/* Obtain the size of the packet and put it into the "len"</span>
00139 <span class="comment">     variable. */</span>
00140   len = ;
00141 
00142   <span class="comment">/* We allocate a pbuf chain of pbufs from the pool. */</span>
00143   p = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a10">PBUF_RAW</a>, len, <a class="code" href="pbuf_8h.html#a27a14">PBUF_POOL</a>);
00144   
00145   <span class="keywordflow">if</span> (p != <a class="code" href="def_8h.html#a2">NULL</a>) {
00146     <span class="comment">/* We iterate over the pbuf chain until we have read the entire</span>
00147 <span class="comment">       packet into the pbuf. */</span>
00148     <span class="keywordflow">for</span>(q = p; q != <a class="code" href="def_8h.html#a2">NULL</a>; q = q-&gt;next) {
00149       <span class="comment">/* Read enough bytes to fill this pbuf in the chain. The</span>
00150 <span class="comment">         available data in the pbuf is given by the q-&gt;len</span>
00151 <span class="comment">         variable. */</span>
00152       read data into(q-&gt;payload, q-&gt;len);
00153     }
00154     acknowledge that packet has been read();
00155 <span class="preprocessor">#ifdef LINK_STATS</span>
00156 <span class="preprocessor"></span>    lwip_stats.link.recv++;
00157 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>      
00158   } <span class="keywordflow">else</span> {
00159     drop packet();
00160 <span class="preprocessor">#ifdef LINK_STATS</span>
00161 <span class="preprocessor"></span>    lwip_stats.link.memerr++;
00162     lwip_stats.link.drop++;
00163 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>      
00164   }
00165 
00166   <span class="keywordflow">return</span> p;  
00167 }
00168 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00169 <span class="comment">/*</span>
00170 <span class="comment"> * ethernetif_output():</span>
00171 <span class="comment"> *</span>
00172 <span class="comment"> * This function is called by the TCP/IP stack when an IP packet</span>
00173 <span class="comment"> * should be sent. It calls the function called low_level_output() to</span>
00174 <span class="comment"> * do the actuall transmission of the packet.</span>
00175 <span class="comment"> *</span>
00176 <span class="comment"> */</span>
00177 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00178 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00179"></a><a class="code" href="ethernetif_8c.html#a4">00179</a> <a class="code" href="ethernetif_8c.html#a4">ethernetif_output</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p,
00180       <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *ipaddr)
00181 {
00182   <span class="keyword">struct </span><a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>;
00183   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *q;
00184   <span class="keyword">struct </span><a class="code" href="structeth__hdr.html">eth_hdr</a> *ethhdr;
00185   <span class="keyword">struct </span><a class="code" href="structeth__addr.html">eth_addr</a> *dest, mcastaddr;
00186   <span class="keyword">struct </span><a class="code" href="structip__addr.html">ip_addr</a> *queryaddr;
00187   <a class="code" href="err_8h.html#a13">err_t</a> err;
00188   u8_t i;
00189   
00190   <a class="code" href="structethernetif.html">ethernetif</a> = netif-&gt;<a class="code" href="structnetif.html#o7">state</a>;
00191 
00192   <span class="comment">/* Make room for Ethernet header. */</span>
00193   <span class="keywordflow">if</span> (<a class="code" href="pbuf_8c.html#a13">pbuf_header</a>(p, 14) != 0) {
00194     <span class="comment">/* The pbuf_header() call shouldn't fail, but we allocate an extra</span>
00195 <span class="comment">       pbuf just in case. */</span>
00196     q = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a9">PBUF_LINK</a>, 14, <a class="code" href="pbuf_8h.html#a27a11">PBUF_RAM</a>);
00197     <span class="keywordflow">if</span> (q == <a class="code" href="def_8h.html#a2">NULL</a>) {
00198 <span class="preprocessor">#ifdef LINK_STATS</span>
00199 <span class="preprocessor"></span>      lwip_stats.link.drop++;
00200       lwip_stats.link.memerr++;
00201 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>      
00202       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00203     }
00204     <a class="code" href="pbuf_8c.html#a17">pbuf_chain</a>(q, p);
00205     p = q;
00206   }
00207 
00208   <span class="comment">/* Construct Ethernet header. Start with looking up deciding which</span>
00209 <span class="comment">     MAC address to use as a destination address. Broadcasts and</span>
00210 <span class="comment">     multicasts are special, all other addresses are looked up in the</span>
00211 <span class="comment">     ARP table. */</span>
00212   queryaddr = ipaddr;
00213   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a30">ip_addr_isany</a>(ipaddr) ||
00214      <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a31">ip_addr_isbroadcast</a>(ipaddr, &amp;(netif-&gt;<a class="code" href="structnetif.html#o2">netmask</a>))) {
00215     dest = (<span class="keyword">struct </span><a class="code" href="structeth__addr.html">eth_addr</a> *)&amp;<a class="code" href="ethernetif_8c.html#a2">ethbroadcast</a>;
00216   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a32">ip_addr_ismulticast</a>(ipaddr)) {
00217     <span class="comment">/* Hash IP multicast address to MAC address. */</span>
00218     mcastaddr.addr[0] = 0x01;
00219     mcastaddr.addr[1] = 0x0;
00220     mcastaddr.addr[2] = 0x5e;
00221     mcastaddr.addr[3] = <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a35">ip4_addr2</a>(ipaddr) &amp; 0x7f;
00222     mcastaddr.addr[4] = <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a36">ip4_addr3</a>(ipaddr);
00223     mcastaddr.addr[5] = <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a37">ip4_addr4</a>(ipaddr);
00224     dest = &amp;mcastaddr;
00225   } <span class="keywordflow">else</span> {
00226 
00227     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a28">ip_addr_maskcmp</a>(ipaddr, &amp;(netif-&gt;<a class="code" href="structnetif.html#o1">ip_addr</a>), &amp;(netif-&gt;<a class="code" href="structnetif.html#o2">netmask</a>))) {
00228       <span class="comment">/* Use destination IP address if the destination is on the same</span>
00229 <span class="comment">         subnet as we are. */</span>
00230       queryaddr = ipaddr;
00231     } <span class="keywordflow">else</span> {
00232       <span class="comment">/* Otherwise we use the default router as the address to send</span>
00233 <span class="comment">         the Ethernet frame to. */</span>
00234       queryaddr = &amp;(netif-&gt;<a class="code" href="structnetif.html#o3">gw</a>);
00235     }
00236     dest = arp_lookup(queryaddr);
00237   }
00238 
00239 
00240   <span class="comment">/* If the arp_lookup() didn't find an address, we send out an ARP</span>
00241 <span class="comment">     query for the IP address. */</span>
00242   <span class="keywordflow">if</span> (dest == <a class="code" href="def_8h.html#a2">NULL</a>) {
00243     q = arp_query(netif, <a class="code" href="structethernetif.html">ethernetif</a>-&gt;ethaddr, queryaddr);
00244     <span class="keywordflow">if</span> (q != <a class="code" href="def_8h.html#a2">NULL</a>) {
00245       err = <a class="code" href="ethernetif_8c.html#a6">low_level_output</a>(<a class="code" href="structethernetif.html">ethernetif</a>, q);
00246       <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(q);
00247       <span class="keywordflow">return</span> err;
00248     }
00249 <span class="preprocessor">#ifdef LINK_STATS</span>
00250 <span class="preprocessor"></span>    lwip_stats.link.drop++;
00251     lwip_stats.link.memerr++;
00252 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>          
00253     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00254   }
00255   ethhdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00256 
00257   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++) {
00258     ethhdr-&gt;dest.addr[i] = dest-&gt;addr[i];
00259     ethhdr-&gt;src.addr[i] = <a class="code" href="structethernetif.html">ethernetif</a>-&gt;ethaddr-&gt;addr[i];
00260   }
00261   
00262   ethhdr-&gt;type = <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(<a class="code" href="etharp_8h.html#a2">ETHTYPE_IP</a>);
00263   
00264   <span class="keywordflow">return</span> <a class="code" href="ethernetif_8c.html#a6">low_level_output</a>(<a class="code" href="structethernetif.html">ethernetif</a>, p);
00265 
00266 }
00267 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00268 <span class="comment">/*</span>
00269 <span class="comment"> * ethernetif_input():</span>
00270 <span class="comment"> *</span>
00271 <span class="comment"> * This function should be called when a packet is ready to be read</span>
00272 <span class="comment"> * from the interface. It uses the function low_level_input() that</span>
00273 <span class="comment"> * should handle the actual reception of bytes from the network</span>
00274 <span class="comment"> * interface.</span>
00275 <span class="comment"> *</span>
00276 <span class="comment"> */</span>
00277 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00278 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00279"></a><a class="code" href="ethernetif_8c.html#a3">00279</a> <a class="code" href="ethernetif_8c.html#a3">ethernetif_input</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00280 {
00281   <span class="keyword">struct </span><a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>;
00282   <span class="keyword">struct </span><a class="code" href="structeth__hdr.html">eth_hdr</a> *ethhdr;
00283   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p;
00284 
00285 
00286   <a class="code" href="structethernetif.html">ethernetif</a> = netif-&gt;<a class="code" href="structnetif.html#o7">state</a>;
00287   
00288   p = <a class="code" href="ethernetif_8c.html#a7">low_level_input</a>(<a class="code" href="structethernetif.html">ethernetif</a>);
00289 
00290   <span class="keywordflow">if</span> (p != <a class="code" href="def_8h.html#a2">NULL</a>) {
00291 
00292 <span class="preprocessor">#ifdef LINK_STATS</span>
00293 <span class="preprocessor"></span>    lwip_stats.link.recv++;
00294 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>
00295 
00296     ethhdr = p-&gt;payload;
00297     
00298     <span class="keywordflow">switch</span> (<a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(ethhdr-&gt;type)) {
00299     <span class="keywordflow">case</span> <a class="code" href="etharp_8h.html#a2">ETHTYPE_IP</a>:
00300       arp_ip_input(netif, p);
00301       <a class="code" href="pbuf_8c.html#a13">pbuf_header</a>(p, -14);
00302       netif-&gt;<a class="code" href="structnetif.html#o4">input</a>(p, netif);
00303       <span class="keywordflow">break</span>;
00304     <span class="keywordflow">case</span> <a class="code" href="etharp_8h.html#a1">ETHTYPE_ARP</a>:
00305       p = arp_arp_input(netif, <a class="code" href="structethernetif.html">ethernetif</a>-&gt;ethaddr, p);
00306       <span class="keywordflow">if</span> (p != <a class="code" href="def_8h.html#a2">NULL</a>) {
00307   <a class="code" href="ethernetif_8c.html#a6">low_level_output</a>(<a class="code" href="structethernetif.html">ethernetif</a>, p);
00308   <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00309       }
00310       <span class="keywordflow">break</span>;
00311     <span class="keywordflow">default</span>:
00312       <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00313       <span class="keywordflow">break</span>;
00314     }
00315   }
00316 }
00317 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00318 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00319"></a><a class="code" href="ethernetif_8c.html#a8">00319</a> <a class="code" href="ethernetif_8c.html#a8">arp_timer</a>(<span class="keywordtype">void</span> *arg)
00320 {
00321   arp_tmr();
00322   <a class="code" href="sys_8c.html#a2">sys_timeout</a>(<a class="code" href="etharp_8h.html#a0">ARP_TMR_INTERVAL</a>, <a class="code" href="ethernetif_8c.html#a8">arp_timer</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00323 }
00324 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00325 <span class="comment">/*</span>
00326 <span class="comment"> * ethernetif_init():</span>
00327 <span class="comment"> *</span>
00328 <span class="comment"> * Should be called at the beginning of the program to set up the</span>
00329 <span class="comment"> * network interface. It calls the function low_level_init() to do the</span>
00330 <span class="comment"> * actual setup of the hardware.</span>
00331 <span class="comment"> *</span>
00332 <span class="comment"> */</span>
00333 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00334 <span class="keywordtype">void</span>
<a name="l00335"></a><a class="code" href="ethernetif_8c.html#a9">00335</a> <a class="code" href="ethernetif_8c.html#a9">ethernetif_init</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00336 {
00337   <span class="keyword">struct </span><a class="code" href="structethernetif.html">ethernetif</a> *<a class="code" href="structethernetif.html">ethernetif</a>;
00338     
00339   <a class="code" href="structethernetif.html">ethernetif</a> = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structethernetif.html">ethernetif</a>));
00340   netif-&gt;<a class="code" href="structnetif.html#o7">state</a> = <a class="code" href="structethernetif.html">ethernetif</a>;
00341   netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0] = <a class="code" href="ethernetif_8c.html#a0">IFNAME0</a>;
00342   netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1] = <a class="code" href="ethernetif_8c.html#a1">IFNAME1</a>;
00343   netif-&gt;<a class="code" href="structnetif.html#o5">output</a> = <a class="code" href="ethernetif_8c.html#a4">ethernetif_output</a>;
00344   netif-&gt;<a class="code" href="structnetif.html#o6">linkoutput</a> = <a class="code" href="ethernetif_8c.html#a6">low_level_output</a>;
00345   
00346   <a class="code" href="structethernetif.html">ethernetif</a>-&gt;ethaddr = (<span class="keyword">struct </span><a class="code" href="structeth__addr.html">eth_addr</a> *)&amp;(netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[0]);
00347   
00348   <a class="code" href="ethernetif_8c.html#a5">low_level_init</a>(netif);
00349   arp_init();
00350 
00351   <a class="code" href="sys_8c.html#a2">sys_timeout</a>(<a class="code" href="etharp_8h.html#a0">ARP_TMR_INTERVAL</a>, <a class="code" href="ethernetif_8c.html#a8">arp_timer</a>, <a class="code" href="def_8h.html#a2">NULL</a>);
00352 }
00353 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
