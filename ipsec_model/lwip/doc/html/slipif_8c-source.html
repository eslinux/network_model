
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>slipif.c</h1><a href="slipif_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001, Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved. </span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> * modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> * are met: </span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright </span>
00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer. </span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright </span>
00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the </span>
00012 <span class="comment"> *    documentation and/or other materials provided with the distribution. </span>
00013 <span class="comment"> * 3. Neither the name of the Institute nor the names of its contributors </span>
00014 <span class="comment"> *    may be used to endorse or promote products derived from this software </span>
00015 <span class="comment"> *    without specific prior written permission. </span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND </span>
00018 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
00019 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
00020 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE </span>
00021 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
00022 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS </span>
00023 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) </span>
00024 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT </span>
00025 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY </span>
00026 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF </span>
00027 <span class="comment"> * SUCH DAMAGE. </span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * This file is built upon the file: src/arch/rtxc/netif/sioslip.c</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> * Author: Magnus Ivarsson &lt;magnus.ivarsson(at)volvo.com&gt; </span>
00032 <span class="comment"> */</span>
00033 
00034 <span class="comment">/* </span>
00035 <span class="comment"> * This is an arch independent SLIP netif. The specific serial hooks must be provided </span>
00036 <span class="comment"> * by another file.They are sio_open, sio_recv and sio_send</span>
00037 <span class="comment"> */</span> 
00038 
00039 <span class="preprocessor">#include "<a class="code" href="slipif_8h.html">netif/slipif.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="def_8h.html">lwip/def.h</a>"</span>
00042 <span class="preprocessor">#include "<a class="code" href="pbuf_8h.html">lwip/pbuf.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">lwip/sys.h</a>"</span>
00044 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">lwip/stats.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="sio_8h.html">lwip/sio.h</a>"</span>
00046 
<a name="l00047"></a><a class="code" href="slipif_8c.html#a0">00047</a> <span class="preprocessor">#define SLIP_END     0300</span>
<a name="l00048"></a><a class="code" href="slipif_8c.html#a1">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define SLIP_ESC     0333</span>
<a name="l00049"></a><a class="code" href="slipif_8c.html#a2">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define SLIP_ESC_END 0334</span>
<a name="l00050"></a><a class="code" href="slipif_8c.html#a3">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define SLIP_ESC_ESC 0335</span>
00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="slipif_8c.html#a4">00052</a> <span class="preprocessor">#define MAX_SIZE     1500</span>
00053 <span class="preprocessor"></span>
00059 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00060"></a><a class="code" href="slipif_8c.html#a5">00060</a> <a class="code" href="slipif_8c.html#a5">slipif_output</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *ipaddr)
00061 {
00062   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *q;
00063   <span class="keywordtype">int</span> i;
00064   u8_t c;
00065 
00066   <span class="comment">/* Send pbuf out on the serial I/O device. */</span>
00067   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a0">SLIP_END</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00068 
00069   <span class="keywordflow">for</span>(q = p; q != <a class="code" href="def_8h.html#a2">NULL</a>; q = q-&gt;next) {
00070     <span class="keywordflow">for</span>(i = 0; i &lt; q-&gt;len; i++) {
00071       c = ((u8_t *)q-&gt;payload)[i];
00072       <span class="keywordflow">switch</span> (c) {
00073       <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a0">SLIP_END</a>:
00074   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a1">SLIP_ESC</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00075   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a2">SLIP_ESC_END</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00076   <span class="keywordflow">break</span>;
00077       <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a1">SLIP_ESC</a>:
00078   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a1">SLIP_ESC</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00079   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a3">SLIP_ESC_ESC</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00080   <span class="keywordflow">break</span>;
00081       <span class="keywordflow">default</span>:
00082   <a class="code" href="sio_8h.html#a2">sio_send</a>(c, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00083   <span class="keywordflow">break</span>;
00084       }
00085     }
00086   }
00087   <a class="code" href="sio_8h.html#a2">sio_send</a>(<a class="code" href="slipif_8c.html#a0">SLIP_END</a>, netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00088   <span class="keywordflow">return</span> 0;
00089 }
00090 
00098 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *
<a name="l00099"></a><a class="code" href="slipif_8c.html#a6">00099</a> <a class="code" href="slipif_8c.html#a6">slipif_input</a>( <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> * <a class="code" href="structnetif.html">netif</a> )
00100 {
00101   u8_t c;
00102   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p, *q;
00103   <span class="keywordtype">int</span> recved;
00104   <span class="keywordtype">int</span> i;
00105 
00106   q = p = <a class="code" href="def_8h.html#a2">NULL</a>;
00107   recved = i = 0;
00108   c = 0;
00109 
00110   <span class="keywordflow">while</span> (1) {
00111     c = <a class="code" href="sio_8h.html#a3">sio_recv</a>(netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00112     <span class="keywordflow">switch</span> (c) {
00113     <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a0">SLIP_END</a>:
00114       <span class="keywordflow">if</span> (recved &gt; 0) {
00115   <span class="comment">/* Received whole packet. */</span>
00116   <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(q, recved);
00117   
00118 <span class="preprocessor">#ifdef LINK_STATS</span>
00119 <span class="preprocessor"></span>  ++lwip_stats.link.recv;
00120 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>         
00121   
00122   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a86">SLIP_DEBUG</a>, (<span class="stringliteral">"slipif: Got packet\n"</span>));
00123   <span class="keywordflow">return</span> q;
00124       }
00125       <span class="keywordflow">break</span>;
00126 
00127     <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a1">SLIP_ESC</a>:
00128       c = <a class="code" href="sio_8h.html#a3">sio_recv</a>(netif-&gt;<a class="code" href="structnetif.html#o7">state</a>);
00129       <span class="keywordflow">switch</span> (c) {
00130       <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a2">SLIP_ESC_END</a>:
00131   c = <a class="code" href="slipif_8c.html#a0">SLIP_END</a>;
00132   <span class="keywordflow">break</span>;
00133       <span class="keywordflow">case</span> <a class="code" href="slipif_8c.html#a3">SLIP_ESC_ESC</a>:
00134   c = <a class="code" href="slipif_8c.html#a1">SLIP_ESC</a>;
00135   <span class="keywordflow">break</span>;
00136       }
00137       <span class="comment">/* FALLTHROUGH */</span>
00138       
00139     <span class="keywordflow">default</span>:
00140       <span class="keywordflow">if</span> (p == <a class="code" href="def_8h.html#a2">NULL</a>) {
00141   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a86">SLIP_DEBUG</a>, (<span class="stringliteral">"slipif_input: alloc\n"</span>));
00142   p = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a9">PBUF_LINK</a>, <a class="code" href="opt_8h.html#a15">PBUF_POOL_BUFSIZE</a>, <a class="code" href="pbuf_8h.html#a27a14">PBUF_POOL</a>);
00143 
00144 <span class="preprocessor">#ifdef LINK_STATS           </span>
00145 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (p == <a class="code" href="def_8h.html#a2">NULL</a>) {
00146     ++lwip_stats.link.drop;
00147     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a86">SLIP_DEBUG</a>, (<span class="stringliteral">"slipif_input: no new pbuf! (DROP)\n"</span>));
00148   }
00149 <span class="preprocessor">#endif </span><span class="comment">/* LINK_STATS */</span>                  
00150   
00151   <span class="keywordflow">if</span> (q != <a class="code" href="def_8h.html#a2">NULL</a>) {
00152     <a class="code" href="pbuf_8c.html#a17">pbuf_chain</a>(q, p);
00153     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00154   } <span class="keywordflow">else</span> {
00155     q = p;
00156   }
00157       }
00158       <span class="keywordflow">if</span> (p != <a class="code" href="def_8h.html#a2">NULL</a> &amp;&amp; recved &lt; <a class="code" href="slipif_8c.html#a4">MAX_SIZE</a>) {
00159   ((u8_t *)p-&gt;payload)[i] = c;
00160   recved++;
00161   i++;
00162   <span class="keywordflow">if</span> (i &gt;= p-&gt;len) {
00163     i = 0;
00164     p = <a class="code" href="def_8h.html#a2">NULL</a>;
00165   }
00166       }
00167       <span class="keywordflow">break</span>;
00168     }
00169     
00170   }
00171   <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00172 }
00173 
00179 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00180"></a><a class="code" href="slipif_8c.html#a7">00180</a> <a class="code" href="slipif_8c.html#a7">slipif_loop</a>(<span class="keywordtype">void</span> *nf)
00181 {
00182   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p;
00183   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a> = (<span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *)nf;
00184 
00185   <span class="keywordflow">while</span> (1) {
00186     p = <a class="code" href="slipif_8c.html#a6">slipif_input</a>(<a class="code" href="structnetif.html">netif</a>);
00187     <a class="code" href="structnetif.html">netif</a>-&gt;input(p, <a class="code" href="structnetif.html">netif</a>);
00188   }
00189 }
00190 
00197 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00198"></a><a class="code" href="slipif_8c.html#a8">00198</a> <a class="code" href="slipif_8c.html#a8">slipif_init</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00199 {
00200   
00201   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a86">SLIP_DEBUG</a>, (<span class="stringliteral">"slipif_init: netif-&gt;num=%x\n"</span>, (<span class="keywordtype">int</span>)netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00202 
00203   netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0] = <span class="charliteral">'s'</span>;
00204   netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1] = <span class="charliteral">'l'</span>;
00205   netif-&gt;<a class="code" href="structnetif.html#o5">output</a> = <a class="code" href="slipif_8c.html#a5">slipif_output</a>;
00206   netif-&gt;<a class="code" href="structnetif.html#o10">mtu</a> = 1500;  
00207 
00208   netif-&gt;<a class="code" href="structnetif.html#o7">state</a> = <a class="code" href="sio_8h.html#a1">sio_open</a>(netif-&gt;<a class="code" href="structnetif.html#o12">num</a>);
00209   <span class="keywordflow">if</span> (!netif-&gt;<a class="code" href="structnetif.html#o7">state</a>)
00210       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a11">ERR_IF</a>;
00211 
00212   <a class="code" href="sys_8h.html#a22">sys_thread_new</a>(<a class="code" href="slipif_8c.html#a7">slipif_loop</a>, netif, <a class="code" href="opt_8h.html#a44">SLIPIF_THREAD_PRIO</a>);
00213   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00214 }
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
