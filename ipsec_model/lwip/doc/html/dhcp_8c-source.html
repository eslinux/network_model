
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dhcp.c</h1><a href="dhcp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00007 <span class="comment">/*</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Copyright (c) 2001-2003 Leon Woestenberg &lt;leon.woestenberg@gmx.net&gt;</span>
00010 <span class="comment"> * Copyright (c) 2001-2003 Axon Digital Design B.V., The Netherlands.</span>
00011 <span class="comment"> * All rights reserved.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00014 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00017 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00018 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00019 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00020 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00021 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00022 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00025 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00026 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00027 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00028 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00029 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00030 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00031 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00032 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00033 <span class="comment"> * OF SUCH DAMAGE.</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> * This file is a contribution to the lwIP TCP/IP stack.</span>
00036 <span class="comment"> * The Swedish Institute of Computer Science and Adam Dunkels</span>
00037 <span class="comment"> * are specifically granted permission to redistribute this</span>
00038 <span class="comment"> * source code.</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Author: Leon Woestenberg &lt;leon.woestenberg@gmx.net&gt;</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> * This is a DHCP client for the lwIP TCP/IP stack. It aims to conform</span>
00043 <span class="comment"> * with RFC 2131 and RFC 2132.</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * TODO:</span>
00046 <span class="comment"> * - Proper parsing of DHCP messages exploiting file/sname field overloading.</span>
00047 <span class="comment"> * - Add JavaDoc style documentation (API, internals).</span>
00048 <span class="comment"> * - Support for interfaces other than Ethernet (SLIP, PPP, ...)</span>
00049 <span class="comment"> *</span>
00050 <span class="comment"> * Please coordinate changes and requests with Leon Woestenberg</span>
00051 <span class="comment"> * &lt;leon.woestenberg@gmx.net&gt;</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> * Integration with your code:</span>
00054 <span class="comment"> *</span>
00055 <span class="comment"> * In lwip/dhcp.h</span>
00056 <span class="comment"> * #define DHCP_COARSE_TIMER_SECS (recommended 60 which is a minute)</span>
00057 <span class="comment"> * #define DHCP_FINE_TIMER_MSECS (recommended 500 which equals TCP coarse timer)</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> * Then have your application call dhcp_coarse_tmr() and</span>
00060 <span class="comment"> * dhcp_fine_tmr() on the defined intervals.</span>
00061 <span class="comment"> *</span>
00062 <span class="comment"> * dhcp_start(struct netif *netif);</span>
00063 <span class="comment"> * starts a DHCP client instance which configures the interface by</span>
00064 <span class="comment"> * obtaining an IP address lease and maintaining it.</span>
00065 <span class="comment"> *</span>
00066 <span class="comment"> * Use dhcp_release(netif) to end the lease and use dhcp_stop(netif)</span>
00067 <span class="comment"> * to remove the DHCP client.</span>
00068 <span class="comment"> *</span>
00069 <span class="comment"> */</span>
00070 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">lwip/stats.h</a>"</span>
00071 <span class="preprocessor">#include "<a class="code" href="mem_8h.html">lwip/mem.h</a>"</span>
00072 <span class="preprocessor">#include "<a class="code" href="udp_8h.html">lwip/udp.h</a>"</span>
00073 <span class="preprocessor">#include "<a class="code" href="netif_8h.html">lwip/netif.h</a>"</span>
00074 <span class="preprocessor">#include "lwip/inet.h"</span>
00075 <span class="preprocessor">#include "lwip/ip_addr.h"</span>
00076 <span class="preprocessor">#include "<a class="code" href="etharp_8h.html">netif/etharp.h</a>"</span>
00077 
00078 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">lwip/sys.h</a>"</span>
00079 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00080 <span class="preprocessor">#include "<a class="code" href="dhcp_8h.html">lwip/dhcp.h</a>"</span>
00081 
<a name="l00084"></a><a class="code" href="dhcp_8c.html#a0">00084</a> <span class="keyword">static</span> u32_t <a class="code" href="dhcp_8c.html#a0">xid</a> = 0xABCD0000;
00085 
00087 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a1">dhcp_handle_ack</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00088 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a2">dhcp_handle_nak</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00089 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a3">dhcp_handle_offer</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00090 
00091 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00092 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a5">dhcp_select</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00093 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a6">dhcp_check</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00094 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a7">dhcp_bind</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00095 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a8">dhcp_decline</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00096 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a9">dhcp_rebind</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00097 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a10">dhcp_release</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00098 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> new_state);
00099 
00101 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a12">dhcp_recv</a>(<span class="keywordtype">void</span> *arg, <span class="keyword">struct</span> <a class="code" href="structudp__pcb.html">udp_pcb</a> *pcb, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr, u16_t port);
00102 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a13">dhcp_unfold_reply</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>);
00103 <span class="keyword">static</span> u8_t *<a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t option_type);
00104 <span class="keyword">static</span> u8_t <a class="code" href="dhcp_8c.html#a15">dhcp_get_option_byte</a>(u8_t *ptr);
00105 <span class="keyword">static</span> u16_t <a class="code" href="dhcp_8c.html#a16">dhcp_get_option_short</a>(u8_t *ptr);
00106 <span class="keyword">static</span> u32_t <a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(u8_t *ptr);
00107 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a18">dhcp_free_reply</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>);
00108 
00110 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a19">dhcp_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00111 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a20">dhcp_t1_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00112 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a21">dhcp_t2_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00113 
00116 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00118 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>);
00120 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t option_type, u8_t option_len);
00122 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t value);
00123 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u16_t value);
00124 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u32_t value);
00126 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>);
00127 
<a name="l00139"></a><a class="code" href="dhcp_8c.html#a2">00139</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a2">dhcp_handle_nak</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>) {
00140   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00141   u16_t msecs = 10 * 1000;
00142   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_handle_nak(netif=%p) %c%c%u\n"</span>, netif,
00143     netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00144   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00145   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_handle_nak(): set request timeout %u msecs\n"</span>, msecs));
00146   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a37">DHCP_BACKING_OFF</a>);
00147 }
00148 
<a name="l00156"></a><a class="code" href="dhcp_8c.html#a6">00156</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a6">dhcp_check</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00157 {
00158   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00159   <a class="code" href="err_8h.html#a13">err_t</a> result;
00160   u16_t msecs;
00161   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_check(netif=%p) %c%c\n"</span>, (<span class="keywordtype">void</span> *)netif, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0],
00162     (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)netif-&gt;name[1]));
00163   <span class="comment">/* create an ARP query for the offered IP address, expecting that no host</span>
00164 <span class="comment">     responds, as the IP address should not be in use. */</span>
00165   result = <a class="code" href="etharp_8c.html#a22">etharp_query</a>(netif, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr, <a class="code" href="def_8h.html#a2">NULL</a>);
00166   <span class="keywordflow">if</span> (result != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00167     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_check: could not perform ARP query\n"</span>));
00168   }
00169   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00170   msecs = 500;
00171   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00172   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_check(): set request timeout %u msecs\n"</span>, msecs));
00173   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a34">DHCP_CHECKING</a>);
00174 }
00175 
<a name="l00181"></a><a class="code" href="dhcp_8c.html#a3">00181</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a3">dhcp_handle_offer</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00182 {
00183   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00184   <span class="comment">/* obtain the server address */</span>
00185   u8_t *option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a67">DHCP_OPTION_SERVER_ID</a>);
00186   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_handle_offer(netif=%p) %c%c%u\n"</span>, netif,
00187     netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00188   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>)
00189   {
00190     <a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr.addr = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(<a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(&amp;option_ptr[2]));
00191     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_handle_offer(): server 0x%08lx\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr.addr));
00192     <span class="comment">/* remember offered address */</span>
00193     <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr, (<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *)&amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;yiaddr);
00194     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_handle_offer(): offer for 0x%08lx\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr));
00195     <a class="code" href="dhcp_8c.html#a5">dhcp_select</a>(netif);
00196   }
00197 }
00198 
<a name="l00207"></a><a class="code" href="dhcp_8c.html#a5">00207</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a5">dhcp_select</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00208 {
00209   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00210   <a class="code" href="err_8h.html#a13">err_t</a> result;
00211   u32_t msecs;
00212   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_select(netif=%p) %c%c%u\n"</span>, netif, netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00213 
00214   <span class="comment">/* create and initialize the DHCP message header */</span>
00215   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00216   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>)
00217   {
00218     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00219     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a43">DHCP_REQUEST</a>);
00220 
00221     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a69">DHCP_OPTION_MAX_MSG_SIZE</a>, <a class="code" href="dhcp_8h.html#a70">DHCP_OPTION_MAX_MSG_SIZE_LEN</a>);
00222     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00223 
00224     <span class="comment">/* MUST request the offered IP address */</span>
00225     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a62">DHCP_OPTION_REQUESTED_IP</a>, 4);
00226     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr));
00227 
00228     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a67">DHCP_OPTION_SERVER_ID</a>, 4);
00229     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr.addr));
00230 
00231     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a68">DHCP_OPTION_PARAMETER_REQUEST_LIST</a>, 3);
00232     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a54">DHCP_OPTION_SUBNET_MASK</a>);
00233     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a55">DHCP_OPTION_ROUTER</a>);
00234     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a59">DHCP_OPTION_BROADCAST</a>);
00235 
00236     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00237     <span class="comment">/* shrink the pbuf to the actual content length */</span>
00238     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00239 
00240     <span class="comment">/* TODO: we really should bind to a specific local interface here</span>
00241 <span class="comment">       but we cannot specify an unconfigured netif as it is addressless */</span>
00242     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00243     <span class="comment">/* send broadcast to any DHCP server */</span>
00244     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a1">IP_ADDR_BROADCAST</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00245     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00246     <span class="comment">/* reconnect to any (or to server here?!) */</span>
00247     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00248     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00249     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_select: REQUESTING\n"</span>));
00250     <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>);
00251   } <span class="keywordflow">else</span> {
00252     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_select: could not allocate DHCP request\n"</span>));
00253   }
00254   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00255   msecs = <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt; 4 ? <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries * 1000 : 4 * 1000;
00256   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00257   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_select(): set request timeout %u msecs\n"</span>, msecs));
00258   <span class="keywordflow">return</span> result;
00259 }
00260 
<a name="l00265"></a><a class="code" href="dhcp_8c.html#a29">00265</a> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a29">dhcp_coarse_tmr</a>()
00266 {
00267   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>;
00268   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_coarse_tmr()\n"</span>));
00269   <span class="comment">/* iterate through all network interfaces */</span>
00270   <span class="keywordflow">while</span> (<a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00271     <span class="comment">/* only act on DHCP configured interfaces */</span>
00272     <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a>-&gt;dhcp != <a class="code" href="def_8h.html#a2">NULL</a>) {
00273       <span class="comment">/* timer is active (non zero), and triggers (zeroes) now? */</span>
00274       <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a>-&gt;dhcp-&gt;t2_timeout-- == 1) {
00275         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_coarse_tmr(): t2 timeout\n"</span>));
00276         <span class="comment">/* this clients' rebind timeout triggered */</span>
00277         <a class="code" href="dhcp_8c.html#a21">dhcp_t2_timeout</a>(<a class="code" href="structnetif.html">netif</a>);
00278       <span class="comment">/* timer is active (non zero), and triggers (zeroes) now */</span>
00279       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a>-&gt;dhcp-&gt;t1_timeout-- == 1) {
00280         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_coarse_tmr(): t1 timeout\n"</span>));
00281         <span class="comment">/* this clients' renewal timeout triggered */</span>
00282         <a class="code" href="dhcp_8c.html#a20">dhcp_t1_timeout</a>(<a class="code" href="structnetif.html">netif</a>);
00283       }
00284     }
00285     <span class="comment">/* proceed to next netif */</span>
00286     <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next;
00287   }
00288 }
00289 
<a name="l00296"></a><a class="code" href="dhcp_8c.html#a30">00296</a> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a30">dhcp_fine_tmr</a>()
00297 {
00298   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>;
00299   <span class="comment">/* loop through clients */</span>
00300   <span class="keywordflow">while</span> (<a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
00301     <span class="comment">/* only act on DHCP configured interfaces */</span>
00302     <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a>-&gt;dhcp != <a class="code" href="def_8h.html#a2">NULL</a>) {
00303       <span class="comment">/* timer is active (non zero), and triggers (zeroes) now */</span>
00304       <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a>-&gt;dhcp-&gt;request_timeout-- == 1) {
00305         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_fine_tmr(): request timeout\n"</span>));
00306         <span class="comment">/* this clients' request timeout triggered */</span>
00307         <a class="code" href="dhcp_8c.html#a19">dhcp_timeout</a>(<a class="code" href="structnetif.html">netif</a>);
00308       }
00309     }
00310     <span class="comment">/* proceed to next network interface */</span>
00311     <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next;
00312   }
00313 }
00314 
<a name="l00324"></a><a class="code" href="dhcp_8c.html#a19">00324</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a19">dhcp_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00325 {
00326   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00327   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_timeout()\n"</span>));
00328   <span class="comment">/* back-off period has passed, or server selection timed out */</span>
00329   <span class="keywordflow">if</span> ((<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a37">DHCP_BACKING_OFF</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a32">DHCP_SELECTING</a>)) {
00330     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_timeout(): restarting discovery\n"</span>));
00331     <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(netif);
00332   <span class="comment">/* receiving the requested lease timed out */</span>
00333   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>) {
00334     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): REQUESTING, DHCP request timed out\n"</span>));
00335     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt;= 5) {
00336       <a class="code" href="dhcp_8c.html#a5">dhcp_select</a>(netif);
00337     } <span class="keywordflow">else</span> {
00338       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): REQUESTING, releasing, restarting\n"</span>));
00339       <a class="code" href="dhcp_8c.html#a10">dhcp_release</a>(netif);
00340       <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(netif);
00341     }
00342   <span class="comment">/* received no ARP reply for the offered address (which is good) */</span>
00343   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a34">DHCP_CHECKING</a>) {
00344     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): CHECKING, ARP request timed out\n"</span>));
00345     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt;= 1) {
00346       <a class="code" href="dhcp_8c.html#a6">dhcp_check</a>(netif);
00347     <span class="comment">/* no ARP replies on the offered address,</span>
00348 <span class="comment">       looks like the IP address is indeed free */</span>
00349     } <span class="keywordflow">else</span> {
00350       <span class="comment">/* bind the interface to the offered address */</span>
00351       <a class="code" href="dhcp_8c.html#a7">dhcp_bind</a>(netif);
00352     }
00353   }
00354   <span class="comment">/* did not get response to renew request? */</span>
00355   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>) {
00356     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): RENEWING, DHCP request timed out\n"</span>));
00357     <span class="comment">/* just retry renewal */</span>
00358     <span class="comment">/* note that the rebind timer will eventually time-out if renew does not work */</span>
00359     <a class="code" href="dhcp_8c.html#a33">dhcp_renew</a>(netif);
00360   <span class="comment">/* did not get response to rebind request? */</span>
00361   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a30">DHCP_REBINDING</a>) {
00362     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): REBINDING, DHCP request timed out\n"</span>));
00363     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt;= 8) {
00364       <a class="code" href="dhcp_8c.html#a9">dhcp_rebind</a>(netif);
00365     } <span class="keywordflow">else</span> {
00366       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_timeout(): RELEASING, DISCOVERING\n"</span>));
00367       <a class="code" href="dhcp_8c.html#a10">dhcp_release</a>(netif);
00368       <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(netif);
00369     }
00370   }
00371 }
00372 
<a name="l00378"></a><a class="code" href="dhcp_8c.html#a20">00378</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a20">dhcp_t1_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00379 {
00380   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00381   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_t1_timeout()\n"</span>));
00382   <span class="keywordflow">if</span> ((<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a36">DHCP_BOUND</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>)) {
00383     <span class="comment">/* just retry to renew */</span>
00384     <span class="comment">/* note that the rebind timer will eventually time-out if renew does not work */</span>
00385     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_t1_timeout(): must renew\n"</span>));
00386     <a class="code" href="dhcp_8c.html#a33">dhcp_renew</a>(netif);
00387   }
00388 }
00389 
<a name="l00394"></a><a class="code" href="dhcp_8c.html#a21">00394</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a21">dhcp_t2_timeout</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00395 {
00396   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00397   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_t2_timeout()\n"</span>));
00398   <span class="keywordflow">if</span> ((<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a36">DHCP_BOUND</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>)) {
00399     <span class="comment">/* just retry to rebind */</span>
00400     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_t2_timeout(): must rebind\n"</span>));
00401     <a class="code" href="dhcp_8c.html#a9">dhcp_rebind</a>(netif);
00402   }
00403 }
00404 
<a name="l00410"></a><a class="code" href="dhcp_8c.html#a1">00410</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a1">dhcp_handle_ack</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00411 {
00412   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00413   u8_t *option_ptr;
00414   <span class="comment">/* clear options we might not get from the ACK */</span>
00415   <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_sn_mask.addr = 0;
00416   <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_gw_addr.addr = 0;
00417   <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_bc_addr.addr = 0;
00418 
00419   <span class="comment">/* lease time given? */</span>
00420   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a63">DHCP_OPTION_LEASE_TIME</a>);
00421   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00422     <span class="comment">/* remember offered lease time */</span>
00423     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t0_lease = <a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(option_ptr + 2);
00424   }
00425   <span class="comment">/* renewal period given? */</span>
00426   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a71">DHCP_OPTION_T1</a>);
00427   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00428     <span class="comment">/* remember given renewal period */</span>
00429     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew = <a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(option_ptr + 2);
00430   } <span class="keywordflow">else</span> {
00431     <span class="comment">/* calculate safe periods for renewal */</span>
00432     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew = <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t0_lease / 2;
00433   }
00434 
00435   <span class="comment">/* renewal period given? */</span>
00436   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a72">DHCP_OPTION_T2</a>);
00437   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00438     <span class="comment">/* remember given rebind period */</span>
00439     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind = <a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(option_ptr + 2);
00440   } <span class="keywordflow">else</span> {
00441     <span class="comment">/* calculate safe periods for rebinding */</span>
00442     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind = <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t0_lease;
00443   }
00444 
00445   <span class="comment">/* (y)our internet address */</span>
00446   <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;yiaddr);
00447 
00452 <span class="preprocessor">#if 0</span>
00453 <span class="preprocessor"></span>  <span class="comment">/* boot server address */</span>
00454   <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_si_addr, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;siaddr);
00455   <span class="comment">/* boot file name */</span>
00456   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;file[0]) {
00457     <a class="code" href="structdhcp.html">dhcp</a>-&gt;boot_file_name = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(strlen(<a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;file) + 1);
00458     strcpy(<a class="code" href="structdhcp.html">dhcp</a>-&gt;boot_file_name, <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_in-&gt;file);
00459   }
00460 <span class="preprocessor">#endif</span>
00461 <span class="preprocessor"></span>
00462   <span class="comment">/* subnet mask */</span>
00463   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a54">DHCP_OPTION_SUBNET_MASK</a>);
00464   <span class="comment">/* subnet mask given? */</span>
00465   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00466     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_sn_mask.addr = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(<a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(&amp;option_ptr[2]));
00467   }
00468 
00469   <span class="comment">/* gateway router */</span>
00470   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a55">DHCP_OPTION_ROUTER</a>);
00471   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00472     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_gw_addr.addr = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(<a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(&amp;option_ptr[2]));
00473   }
00474 
00475   <span class="comment">/* broadcast address */</span>
00476   option_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a59">DHCP_OPTION_BROADCAST</a>);
00477   <span class="keywordflow">if</span> (option_ptr != <a class="code" href="def_8h.html#a2">NULL</a>) {
00478     <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_bc_addr.addr = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(<a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(&amp;option_ptr[2]));
00479   }
00480 }
00481 
<a name="l00495"></a><a class="code" href="dhcp_8c.html#a31">00495</a> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a31">dhcp_start</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00496 {
00497   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00498   <a class="code" href="err_8h.html#a13">err_t</a> result = <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00499 
00500   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"netif != NULL"</span>, netif != <a class="code" href="def_8h.html#a2">NULL</a>);
00501   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_start(netif=%p) %c%c%u\n"</span>, netif, netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00502 
00503   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00504     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): starting new DHCP client\n"</span>));
00505     <a class="code" href="structdhcp.html">dhcp</a> = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a>));
00506     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00507       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): could not allocate dhcp\n"</span>));
00508       netif-&gt;<a class="code" href="structnetif.html#o13">flags</a> &amp;= ~<a class="code" href="netif_8h.html#a4">NETIF_FLAG_DHCP</a>;
00509       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00510     }
00511     <span class="comment">/* clear data structure */</span>
00512     memset(<a class="code" href="structdhcp.html">dhcp</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a>));
00513     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): allocated dhcp"</span>));
00514     <a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb = <a class="code" href="udp_8h.html#a7">udp_new</a>();
00515     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb == <a class="code" href="def_8h.html#a2">NULL</a>) {
00516       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>  | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): could not obtain pcb\n"</span>));
00517       <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)<a class="code" href="structdhcp.html">dhcp</a>);
00518       <a class="code" href="structdhcp.html">dhcp</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00519       netif-&gt;<a class="code" href="structnetif.html#o13">flags</a> &amp;= ~<a class="code" href="netif_8h.html#a4">NETIF_FLAG_DHCP</a>;
00520       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
00521     }
00522     <span class="comment">/* store this dhcp client in the netif */</span>
00523     netif-&gt;dhcp = <a class="code" href="structdhcp.html">dhcp</a>;
00524     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): created new udp pcb\n"</span>));
00525     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_start(): starting DHCP configuration\n"</span>));
00526   } <span class="keywordflow">else</span> {
00527     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a> | 3, (<span class="stringliteral">"dhcp_start(): restarting DHCP configuration\n"</span>));
00528   }
00529   <span class="comment">/* (re)start the DHCP negotiation */</span>
00530   result = <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(netif);
00531   <span class="keywordflow">if</span> (result != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00532     <span class="comment">/* free resources allocated above */</span>
00533     <a class="code" href="dhcp_8c.html#a34">dhcp_stop</a>(netif);
00534   }
00535   <span class="keywordflow">return</span> result;
00536 }
00537 
<a name="l00548"></a><a class="code" href="dhcp_8c.html#a32">00548</a> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a32">dhcp_inform</a>(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00549 {
00550   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>;
00551   <a class="code" href="err_8h.html#a13">err_t</a> result = <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00552   <a class="code" href="structdhcp.html">dhcp</a> = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a>));
00553   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00554     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_inform(): could not allocate dhcp\n"</span>));
00555     <span class="keywordflow">return</span>;
00556   }
00557   netif-&gt;dhcp = <a class="code" href="structdhcp.html">dhcp</a>;
00558   memset(<a class="code" href="structdhcp.html">dhcp</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a>));
00559 
00560   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_inform(): allocated dhcp\n"</span>));
00561   <a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb = <a class="code" href="udp_8h.html#a7">udp_new</a>();
00562   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb == <a class="code" href="def_8h.html#a2">NULL</a>) {
00563     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_inform(): could not obtain pcb"</span>));
00564     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)<a class="code" href="structdhcp.html">dhcp</a>);
00565     <span class="keywordflow">return</span>;
00566   }
00567   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_inform(): created new udp pcb\n"</span>));
00568   <span class="comment">/* create and initialize the DHCP message header */</span>
00569   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00570   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00571 
00572     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00573     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a48">DHCP_INFORM</a>);
00574 
00575     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a69">DHCP_OPTION_MAX_MSG_SIZE</a>, <a class="code" href="dhcp_8h.html#a70">DHCP_OPTION_MAX_MSG_SIZE_LEN</a>);
00576     <span class="comment">/* TODO: use netif-&gt;mtu ?! */</span>
00577     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00578 
00579     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00580 
00581     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00582 
00583     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00584     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a1">IP_ADDR_BROADCAST</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00585     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_inform: INFORMING\n"</span>));
00586     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00587     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00588     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00589   } <span class="keywordflow">else</span> {
00590     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_inform: could not allocate DHCP request\n"</span>));
00591   }
00592 
00593   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a> != <a class="code" href="def_8h.html#a2">NULL</a>)
00594   {
00595     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb != <a class="code" href="def_8h.html#a2">NULL</a>) <a class="code" href="udp_8h.html#a8">udp_remove</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb);
00596     <a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb = <a class="code" href="def_8h.html#a2">NULL</a>;
00597     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)<a class="code" href="structdhcp.html">dhcp</a>);
00598     netif-&gt;dhcp = <a class="code" href="def_8h.html#a2">NULL</a>;
00599   }
00600 }
00601 
00602 <span class="preprocessor">#if DHCP_DOES_ARP_CHECK</span>
00603 <span class="preprocessor"></span>
00609 <span class="keywordtype">void</span> dhcp_arp_reply(<span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr)
00610 {
00611   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | 3, (<span class="stringliteral">"dhcp_arp_reply()\n"</span>));
00612   <span class="comment">/* is this DHCP client doing an ARP check? */</span>
00613   <span class="keywordflow">if</span> ((netif-&gt;dhcp != <a class="code" href="def_8h.html#a2">NULL</a>) &amp;&amp; (netif-&gt;dhcp-&gt;<a class="code" href="structnetif.html#o7">state</a> == <a class="code" href="dhcp_8h.html#a34">DHCP_CHECKING</a>)) {
00614     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | DBG_STATE, (<span class="stringliteral">"dhcp_arp_reply(): CHECKING, arp reply for 0x%08lx\n"</span>, addr-&gt;<a class="code" href="structip__addr.html#o0">addr</a>));
00615     <span class="comment">/* did a host respond with the address we</span>
00616 <span class="comment">       were offered by the DHCP server? */</span>
00617     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a29">ip_addr_cmp</a>(addr, &amp;netif-&gt;dhcp-&gt;offered_ip_addr)) {
00618       <span class="comment">/* we will not accept the offered address */</span>
00619       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | DBG_STATE | 1, (<span class="stringliteral">"dhcp_arp_reply(): arp reply matched with offered address, declining\n"</span>));
00620       <a class="code" href="dhcp_8c.html#a8">dhcp_decline</a>(netif);
00621     }
00622   }
00623 }
00624 
00632 <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a8">dhcp_decline</a>(<span class="keyword">struct</span> netif *netif)
00633 {
00634   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00635   <a class="code" href="err_8h.html#a13">err_t</a> result = <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00636   u16_t msecs;
00637   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | 3, (<span class="stringliteral">"dhcp_decline()\n"</span>));
00638   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, DHCP_BACKING_OFF);
00639   <span class="comment">/* create and initialize the DHCP message header */</span>
00640   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00641   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>)
00642   {
00643     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, DHCP_OPTION_MESSAGE_TYPE, DHCP_OPTION_MESSAGE_TYPE_LEN);
00644     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, DHCP_DECLINE);
00645 
00646     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, DHCP_OPTION_MAX_MSG_SIZE, DHCP_OPTION_MAX_MSG_SIZE_LEN);
00647     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00648 
00649     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00650     <span class="comment">/* resize pbuf to reflect true size of options */</span>
00651     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - DHCP_OPTIONS_LEN + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00652 
00653     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, IP_ADDR_ANY, DHCP_CLIENT_PORT);
00654     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr, DHCP_SERVER_PORT);
00655     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00656     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00657     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | DBG_STATE, (<span class="stringliteral">"dhcp_decline: BACKING OFF\n"</span>));
00658   } <span class="keywordflow">else</span> {
00659     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE | 2, (<span class="stringliteral">"dhcp_decline: could not allocate DHCP request\n"</span>));
00660   }
00661   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00662   msecs = 10*1000;
00663   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00664    <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(DHCP_DEBUG | DBG_TRACE, (<span class="stringliteral">"dhcp_decline(): set request timeout %u msecs\n"</span>, msecs));
00665   <span class="keywordflow">return</span> result;
00666 }
00667 <span class="preprocessor">#endif</span>
00668 <span class="preprocessor"></span>
00669 
<a name="l00674"></a><a class="code" href="dhcp_8c.html#a4">00674</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a4">dhcp_discover</a>(<span class="keyword">struct</span> netif *netif)
00675 {
00676   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00677   <a class="code" href="err_8h.html#a13">err_t</a> result = <a class="code" href="err_8h.html#a0">ERR_OK</a>;
00678   u16_t msecs;
00679   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_discover()\n"</span>));
00680   <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>);
00681   <span class="comment">/* create and initialize the DHCP message header */</span>
00682   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00683   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>)
00684   {
00685     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: making request\n"</span>));
00686     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00687     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a41">DHCP_DISCOVER</a>);
00688 
00689     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a69">DHCP_OPTION_MAX_MSG_SIZE</a>, <a class="code" href="dhcp_8h.html#a70">DHCP_OPTION_MAX_MSG_SIZE_LEN</a>);
00690     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00691 
00692     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a68">DHCP_OPTION_PARAMETER_REQUEST_LIST</a>, 3);
00693     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a54">DHCP_OPTION_SUBNET_MASK</a>);
00694     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a55">DHCP_OPTION_ROUTER</a>);
00695     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a59">DHCP_OPTION_BROADCAST</a>);
00696 
00697     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00698 
00699     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: realloc()ing\n"</span>));
00700     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00701 
00702     <span class="comment">/* set receive callback function with netif as user data */</span>
00703     <a class="code" href="udp_8h.html#a12">udp_recv</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="dhcp_8c.html#a12">dhcp_recv</a>, netif);
00704     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00705     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a1">IP_ADDR_BROADCAST</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00706 
00707     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: send()ing\n"</span>));
00708 
00709     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00710     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: bind()ing\n"</span>));
00711     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00712     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: connect()ing\n"</span>));
00713     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00714     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_discover: deleting()ing\n"</span>));
00715     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00716     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_discover: SELECTING\n"</span>));
00717     <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a32">DHCP_SELECTING</a>);
00718   } <span class="keywordflow">else</span> {
00719     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_discover: could not allocate DHCP request\n"</span>));
00720   }
00721   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00722   msecs = <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt; 4 ? (<a class="code" href="structdhcp.html">dhcp</a>-&gt;tries + 1) * 1000 : 10 * 1000;
00723   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00724   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_discover(): set request timeout %u msecs\n"</span>, msecs));
00725   <span class="keywordflow">return</span> result;
00726 }
00727 
00728 
<a name="l00734"></a><a class="code" href="dhcp_8c.html#a7">00734</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a7">dhcp_bind</a>(<span class="keyword">struct</span> netif *netif)
00735 {
00736   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00737   <span class="keyword">struct </span><a class="code" href="structip__addr.html">ip_addr</a> sn_mask, gw_addr;
00738   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_bind: netif != NULL"</span>, netif != <a class="code" href="def_8h.html#a2">NULL</a>);
00739   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_bind: dhcp != NULL"</span>, <a class="code" href="structdhcp.html">dhcp</a> != <a class="code" href="def_8h.html#a2">NULL</a>);
00740   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_bind(netif=%p) %c%c%u\n"</span>, netif, netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], netif-&gt;<a class="code" href="structnetif.html#o12">num</a>));
00741 
00742   <span class="comment">/* temporary DHCP lease? */</span>
00743   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew != 0xffffffffUL) {
00744     <span class="comment">/* set renewal period timer */</span>
00745     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_bind(): t1 renewal timer %lu secs\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew));
00746     <a class="code" href="structdhcp.html">dhcp</a>-&gt;t1_timeout = (<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew + <a class="code" href="dhcp_8h.html#a0">DHCP_COARSE_TIMER_SECS</a> / 2) / <a class="code" href="dhcp_8h.html#a0">DHCP_COARSE_TIMER_SECS</a>;
00747     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;t1_timeout == 0) <a class="code" href="structdhcp.html">dhcp</a>-&gt;t1_timeout = 1;
00748     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_bind(): set request timeout %u msecs\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t1_renew*1000));
00749   }
00750   <span class="comment">/* set renewal period timer */</span>
00751   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind != 0xffffffffUL) {
00752     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_bind(): t2 rebind timer %lu secs\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind));
00753     <a class="code" href="structdhcp.html">dhcp</a>-&gt;t2_timeout = (<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind + <a class="code" href="dhcp_8h.html#a0">DHCP_COARSE_TIMER_SECS</a> / 2) / <a class="code" href="dhcp_8h.html#a0">DHCP_COARSE_TIMER_SECS</a>;
00754     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;t2_timeout == 0) <a class="code" href="structdhcp.html">dhcp</a>-&gt;t2_timeout = 1;
00755     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_bind(): set request timeout %u msecs\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_t2_rebind*1000));
00756   }
00757   <span class="comment">/* copy offered network mask */</span>
00758   <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;sn_mask, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_sn_mask);
00759 
00760   <span class="comment">/* subnet mask not given? */</span>
00761   <span class="comment">/* TODO: this is not a valid check. what if the network mask is 0? */</span>
00762   <span class="keywordflow">if</span> (sn_mask.<a class="code" href="structip__addr.html#o0">addr</a> == 0) {
00763     <span class="comment">/* choose a safe subnet mask given the network class */</span>
00764     u8_t first_octet = <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a34">ip4_addr1</a>(&amp;sn_mask);
00765     <span class="keywordflow">if</span> (first_octet &lt;= 127) sn_mask.<a class="code" href="structip__addr.html#o0">addr</a> = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(0xff000000);
00766     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (first_octet &gt;= 192) sn_mask.<a class="code" href="structip__addr.html#o0">addr</a> = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(0xffffff00);
00767     <span class="keywordflow">else</span> sn_mask.<a class="code" href="structip__addr.html#o0">addr</a> = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(0xffff0000);
00768   }
00769 
00770   <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;gw_addr, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_gw_addr);
00771   <span class="comment">/* gateway address not given? */</span>
00772   <span class="keywordflow">if</span> (gw_addr.<a class="code" href="structip__addr.html#o0">addr</a> == 0) {
00773     <span class="comment">/* copy network address */</span>
00774     gw_addr.<a class="code" href="structip__addr.html#o0">addr</a> = (<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr &amp; sn_mask.<a class="code" href="structip__addr.html#o0">addr</a>);
00775     <span class="comment">/* use first host address on network as gateway */</span>
00776     gw_addr.<a class="code" href="structip__addr.html#o0">addr</a> |= <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(0x00000001);
00777   }
00778 
00779   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_bind(): IP: 0x%08lx\n"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr));
00780   <a class="code" href="netif_8c.html#a6">netif_set_ipaddr</a>(netif, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr);
00781   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_bind(): SN: 0x%08lx\n"</span>, sn_mask.<a class="code" href="structip__addr.html#o0">addr</a>));
00782   <a class="code" href="netif_8c.html#a8">netif_set_netmask</a>(netif, &amp;sn_mask);
00783   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_bind(): GW: 0x%08lx\n"</span>, gw_addr.<a class="code" href="structip__addr.html#o0">addr</a>));
00784   <a class="code" href="netif_8c.html#a7">netif_set_gw</a>(netif, &amp;gw_addr);
00785   <span class="comment">/* netif is now bound to DHCP leased address */</span>
00786   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a36">DHCP_BOUND</a>);
00787 }
00788 
<a name="l00794"></a><a class="code" href="dhcp_8c.html#a33">00794</a> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a33">dhcp_renew</a>(<span class="keyword">struct</span> netif *netif)
00795 {
00796   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00797   <a class="code" href="err_8h.html#a13">err_t</a> result;
00798   u16_t msecs;
00799   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_renew()\n"</span>));
00800   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>);
00801 
00802   <span class="comment">/* create and initialize the DHCP message header */</span>
00803   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00804   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00805 
00806     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00807     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a43">DHCP_REQUEST</a>);
00808 
00809     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a69">DHCP_OPTION_MAX_MSG_SIZE</a>, <a class="code" href="dhcp_8h.html#a70">DHCP_OPTION_MAX_MSG_SIZE_LEN</a>);
00810     <span class="comment">/* TODO: use netif-&gt;mtu in some way */</span>
00811     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00812 
00813 <span class="preprocessor">#if 0</span>
00814 <span class="preprocessor"></span>    <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a62">DHCP_OPTION_REQUESTED_IP</a>, 4);
00815     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr));
00816 <span class="preprocessor">#endif</span>
00817 <span class="preprocessor"></span>
00818 <span class="preprocessor">#if 0</span>
00819 <span class="preprocessor"></span>    <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a67">DHCP_OPTION_SERVER_ID</a>, 4);
00820     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr.addr));
00821 <span class="preprocessor">#endif</span>
00822 <span class="preprocessor"></span>    <span class="comment">/* append DHCP message trailer */</span>
00823     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00824 
00825     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00826 
00827     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00828     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00829     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00830     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00831 
00832     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_renew: RENEWING\n"</span>));
00833   } <span class="keywordflow">else</span> {
00834     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_renew: could not allocate DHCP request\n"</span>));
00835   }
00836   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00837   <span class="comment">/* back-off on retries, but to a maximum of 20 seconds */</span>
00838   msecs = <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt; 10 ? <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries * 2000 : 20 * 1000;
00839   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00840    <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_renew(): set request timeout %u msecs\n"</span>, msecs));
00841   <span class="keywordflow">return</span> result;
00842 }
00843 
<a name="l00849"></a><a class="code" href="dhcp_8c.html#a9">00849</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a9">dhcp_rebind</a>(<span class="keyword">struct</span> netif *netif)
00850 {
00851   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00852   <a class="code" href="err_8h.html#a13">err_t</a> result;
00853   u16_t msecs;
00854   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_rebind()\n"</span>));
00855   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a30">DHCP_REBINDING</a>);
00856 
00857   <span class="comment">/* create and initialize the DHCP message header */</span>
00858   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00859   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>)
00860   {
00861 
00862     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00863     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a43">DHCP_REQUEST</a>);
00864 
00865     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a69">DHCP_OPTION_MAX_MSG_SIZE</a>, <a class="code" href="dhcp_8h.html#a70">DHCP_OPTION_MAX_MSG_SIZE_LEN</a>);
00866     <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<a class="code" href="structdhcp.html">dhcp</a>, 576);
00867 
00868 <span class="preprocessor">#if 0</span>
00869 <span class="preprocessor"></span>    <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a62">DHCP_OPTION_REQUESTED_IP</a>, 4);
00870     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;offered_ip_addr.addr));
00871 
00872     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a67">DHCP_OPTION_SERVER_ID</a>, 4);
00873     <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr.addr));
00874 <span class="preprocessor">#endif</span>
00875 <span class="preprocessor"></span>
00876     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00877 
00878     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00879 
00880     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00881     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a1">IP_ADDR_BROADCAST</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00882     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00883     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00884     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00885     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_rebind: REBINDING\n"</span>));
00886   } <span class="keywordflow">else</span> {
00887     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_rebind: could not allocate DHCP request\n"</span>));
00888   }
00889   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00890   msecs = <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt; 10 ? <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries * 1000 : 10 * 1000;
00891   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00892    <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_rebind(): set request timeout %u msecs\n"</span>, msecs));
00893   <span class="keywordflow">return</span> result;
00894 }
00895 
<a name="l00901"></a><a class="code" href="dhcp_8c.html#a10">00901</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a10">dhcp_release</a>(<span class="keyword">struct</span> netif *netif)
00902 {
00903   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00904   <a class="code" href="err_8h.html#a13">err_t</a> result;
00905   u16_t msecs;
00906   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_release()\n"</span>));
00907 
00908   <span class="comment">/* idle DHCP client */</span>
00909   <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a38">DHCP_OFF</a>);
00910 
00911 
00912   <span class="comment">/* create and initialize the DHCP message header */</span>
00913   result = <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(netif);
00914   <span class="keywordflow">if</span> (result == <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
00915     <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>, <a class="code" href="dhcp_8h.html#a66">DHCP_OPTION_MESSAGE_TYPE_LEN</a>);
00916     <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a47">DHCP_RELEASE</a>);
00917 
00918     <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00919 
00920     <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a> + <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len);
00921 
00922     <a class="code" href="udp_8h.html#a9">udp_bind</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>, <a class="code" href="dhcp_8h.html#a25">DHCP_CLIENT_PORT</a>);
00923     <a class="code" href="udp_8h.html#a10">udp_connect</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, &amp;<a class="code" href="structdhcp.html">dhcp</a>-&gt;server_ip_addr, <a class="code" href="dhcp_8h.html#a26">DHCP_SERVER_PORT</a>);
00924     <a class="code" href="udp_8h.html#a13">udp_send</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
00925     <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(netif);
00926     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_release: RELEASED, DHCP_OFF\n"</span>));
00927   } <span class="keywordflow">else</span> {
00928     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_release: could not allocate DHCP request\n"</span>));
00929   }
00930   <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries++;
00931   msecs = <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries &lt; 10 ? <a class="code" href="structdhcp.html">dhcp</a>-&gt;tries * 1000 : 10 * 1000;
00932   <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = (msecs + <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a> - 1) / <a class="code" href="dhcp_8h.html#a1">DHCP_FINE_TIMER_MSECS</a>;
00933    <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | <a class="code" href="debug_8h.html#a8">DBG_STATE</a>, (<span class="stringliteral">"dhcp_release(): set request timeout %u msecs\n"</span>, msecs));
00934   <span class="comment">/* remove IP address from interface */</span>
00935   <a class="code" href="netif_8c.html#a6">netif_set_ipaddr</a>(netif, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>);
00936   <a class="code" href="netif_8c.html#a7">netif_set_gw</a>(netif, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>);
00937   <a class="code" href="netif_8c.html#a8">netif_set_netmask</a>(netif, <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a0">IP_ADDR_ANY</a>);
00938   <span class="comment">/* TODO: netif_down(netif); */</span>
00939   <span class="keywordflow">return</span> result;
00940 }
<a name="l00946"></a><a class="code" href="dhcp_8c.html#a34">00946</a> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a34">dhcp_stop</a>(<span class="keyword">struct</span> netif *netif)
00947 {
00948   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
00949   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_stop: netif != NULL"</span>, netif != <a class="code" href="def_8h.html#a2">NULL</a>);
00950 
00951   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_stop()\n"</span>));
00952   <span class="comment">/* netif is DHCP configured? */</span>
00953   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a> != <a class="code" href="def_8h.html#a2">NULL</a>)
00954   {
00955     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb != <a class="code" href="def_8h.html#a2">NULL</a>)
00956     {
00957       <a class="code" href="udp_8h.html#a8">udp_remove</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb);
00958       <a class="code" href="structdhcp.html">dhcp</a>-&gt;pcb = <a class="code" href="def_8h.html#a2">NULL</a>;
00959     }
00960     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;p != <a class="code" href="def_8h.html#a2">NULL</a>)
00961     {
00962       <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p);
00963       <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
00964     }
00965     <span class="comment">/* free unfolded reply */</span>
00966     <a class="code" href="dhcp_8c.html#a18">dhcp_free_reply</a>(<a class="code" href="structdhcp.html">dhcp</a>);
00967     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)<a class="code" href="structdhcp.html">dhcp</a>);
00968     netif-&gt;dhcp = <a class="code" href="def_8h.html#a2">NULL</a>;
00969   }
00970 }
00971 
00972 <span class="comment">/*</span>
00973 <span class="comment"> * Set the DHCP state of a DHCP client.</span>
00974 <span class="comment"> *</span>
00975 <span class="comment"> * If the state changed, reset the number of tries.</span>
00976 <span class="comment"> *</span>
00977 <span class="comment"> * TODO: we might also want to reset the timeout here?</span>
00978 <span class="comment"> */</span>
<a name="l00979"></a><a class="code" href="dhcp_8c.html#a11">00979</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a11">dhcp_set_state</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> new_state)
00980 {
00981   <span class="keywordflow">if</span> (new_state != dhcp-&gt;<a class="code" href="structdhcp.html#o0">state</a>)
00982   {
00983     dhcp-&gt;<a class="code" href="structdhcp.html#o0">state</a> = new_state;
00984     dhcp-&gt;<a class="code" href="structdhcp.html#o1">tries</a> = 0;
00985   }
00986 }
00987 
00988 <span class="comment">/*</span>
00989 <span class="comment"> * Concatenate an option type and length field to the outgoing</span>
00990 <span class="comment"> * DHCP message.</span>
00991 <span class="comment"> *</span>
00992 <span class="comment"> */</span>
<a name="l00993"></a><a class="code" href="dhcp_8c.html#a24">00993</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a24">dhcp_option</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t option_type, u8_t option_len)
00994 {
00995   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_short: dhcp-&gt;options_out_len + 2 + option_len &lt;= DHCP_OPTIONS_LEN"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> + 2 + option_len &lt;= <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
00996   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = option_type;
00997   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = option_len;
00998 }
00999 <span class="comment">/*</span>
01000 <span class="comment"> * Concatenate a single byte to the outgoing DHCP message.</span>
01001 <span class="comment"> *</span>
01002 <span class="comment"> */</span>
<a name="l01003"></a><a class="code" href="dhcp_8c.html#a25">01003</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a25">dhcp_option_byte</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t value)
01004 {
01005   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_short: dhcp-&gt;options_out_len &lt; DHCP_OPTIONS_LEN"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> &lt; <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01006   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = value;
01007 }
<a name="l01008"></a><a class="code" href="dhcp_8c.html#a26">01008</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a26">dhcp_option_short</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u16_t value)
01009 {
01010   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_short: dhcp-&gt;options_out_len + 2 &lt;= DHCP_OPTIONS_LEN"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> + 2 &lt;= <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01011   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = (value &amp; 0xff00U) &gt;&gt; 8;
01012   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] =  value &amp; 0x00ffU;
01013 }
<a name="l01014"></a><a class="code" href="dhcp_8c.html#a27">01014</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a27">dhcp_option_long</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u32_t value)
01015 {
01016   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_long: dhcp-&gt;options_out_len + 4 &lt;= DHCP_OPTIONS_LEN"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> + 4 &lt;= <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01017   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = (value &amp; 0xff000000UL) &gt;&gt; 24;
01018   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = (value &amp; 0x00ff0000UL) &gt;&gt; 16;
01019   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = (value &amp; 0x0000ff00UL) &gt;&gt; 8;
01020   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = (value &amp; 0x000000ffUL);
01021 }
01022 
<a name="l01033"></a><a class="code" href="dhcp_8c.html#a13">01033</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a13">dhcp_unfold_reply</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>)
01034 {
01035   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *p = dhcp-&gt;<a class="code" href="structdhcp.html#o4">p</a>;
01036   u8_t *ptr;
01037   u16_t i;
01038   u16_t j = 0;
01039   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp-&gt;p != NULL"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o4">p</a> != <a class="code" href="def_8h.html#a2">NULL</a>);
01040   <span class="comment">/* free any left-overs from previous unfolds */</span>
01041   <a class="code" href="dhcp_8c.html#a18">dhcp_free_reply</a>(dhcp);
01042   <span class="comment">/* options present? */</span>
01043   <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o4">p</a>-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a> &gt; (<span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>))
01044   {
01045     dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a> = dhcp-&gt;<a class="code" href="structdhcp.html#o4">p</a>-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a> - (<span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01046     dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a>);
01047     <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> == <a class="code" href="def_8h.html#a2">NULL</a>)
01048     {
01049       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_unfold_reply(): could not allocate dhcp-&gt;options\n"</span>));
01050       <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
01051     }
01052   }
01053   dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a> = <a class="code" href="mem_8c.html#a11">mem_malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01054   <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a> == <a class="code" href="def_8h.html#a2">NULL</a>)
01055   {
01056     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_unfold_reply(): could not allocate dhcp-&gt;msg_in\n"</span>));
01057     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a>);
01058     dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
01059     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
01060   }
01061 
01062   ptr = (u8_t *)dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a>;
01063   <span class="comment">/* proceed through struct dhcp_msg */</span>
01064   <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdhcp__msg.html">dhcp_msg</a>) - <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>; i++)
01065   {
01066     *ptr++ = ((u8_t *)p-&gt;payload)[j++];
01067     <span class="comment">/* reached end of pbuf? */</span>
01068     <span class="keywordflow">if</span> (j == p-&gt;len)
01069     {
01070       <span class="comment">/* proceed to next pbuf in chain */</span>
01071       p = p-&gt;next;
01072       j = 0;
01073     }
01074   }
01075   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_unfold_reply(): copied %u bytes into dhcp-&gt;msg_in[]\n"</span>, i));
01076   <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
01077     ptr = (u8_t *)dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a>;
01078     <span class="comment">/* proceed through options */</span>
01079     <span class="keywordflow">for</span> (i = 0; i &lt; dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a>; i++) {
01080       *ptr++ = ((u8_t *)p-&gt;payload)[j++];
01081       <span class="comment">/* reached end of pbuf? */</span>
01082       <span class="keywordflow">if</span> (j == p-&gt;len) {
01083         <span class="comment">/* proceed to next pbuf in chain */</span>
01084         p = p-&gt;next;
01085         j = 0;
01086       }
01087     }
01088     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"dhcp_unfold_reply(): copied %u bytes to dhcp-&gt;options_in[]\n"</span>, i));
01089   }
01090   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
01091 }
01092 
<a name="l01098"></a><a class="code" href="dhcp_8c.html#a18">01098</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a18">dhcp_free_reply</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>)
01099 {
01100   <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {
01101     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a>);
01102     dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
01103   }
01104   <span class="keywordflow">if</span> (dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a>) {
01105     <a class="code" href="mem_8c.html#a8">mem_free</a>((<span class="keywordtype">void</span> *)dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a>);
01106     dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
01107     dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a> = 0;
01108   }
01109   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>, (<span class="stringliteral">"dhcp_free_reply(): free'd\n"</span>));
01110 }
01111 
01112 
<a name="l01116"></a><a class="code" href="dhcp_8c.html#a12">01116</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a12">dhcp_recv</a>(<span class="keywordtype">void</span> *arg, <span class="keyword">struct</span> <a class="code" href="structudp__pcb.html">udp_pcb</a> *pcb, <span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *addr, u16_t port)
01117 {
01118   <span class="keyword">struct </span>netif *netif = (<span class="keyword">struct </span>netif *)arg;
01119   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
01120   <span class="keyword">struct </span><a class="code" href="structdhcp__msg.html">dhcp_msg</a> *reply_msg = (<span class="keyword">struct </span><a class="code" href="structdhcp__msg.html">dhcp_msg</a> *)p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
01121   u8_t *options_ptr;
01122   u8_t msg_type;
01123   u8_t i;
01124   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 3, (<span class="stringliteral">"dhcp_recv(pbuf = %p) from DHCP server %u.%u.%u.%u port %u\n"</span>, p,
01125     (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(addr-&gt;<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt; 24 &amp; 0xff), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(addr-&gt;<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt; 16 &amp; 0xff),
01126     (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(addr-&gt;<a class="code" href="structip__addr.html#o0">addr</a>) &gt;&gt;  8 &amp; 0xff), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(addr-&gt;<a class="code" href="structip__addr.html#o0">addr</a>) &amp; 0xff), port));
01127   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"pbuf-&gt;len = %u\n"</span>, p-&gt;<a class="code" href="structpbuf.html#o3">len</a>));
01128   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"pbuf-&gt;tot_len = %u\n"</span>, p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>));
01129   <span class="comment">/* prevent warnings about unused arguments */</span>
01130   (<span class="keywordtype">void</span>)pcb; (<span class="keywordtype">void</span>)addr; (<span class="keywordtype">void</span>)port;
01131   <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = p;
01132   <span class="comment">/* TODO: check packet length before reading them */</span>
01133   <span class="keywordflow">if</span> (reply_msg-&gt;op != <a class="code" href="dhcp_8h.html#a40">DHCP_BOOTREPLY</a>) {
01134     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"not a DHCP reply message, but type %u\n"</span>, reply_msg-&gt;op));
01135     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01136     <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01137     <span class="keywordflow">return</span>;
01138   }
01139   <span class="comment">/* iterate through hardware address and match against DHCP message */</span>
01140   <span class="keywordflow">for</span> (i = 0; i &lt; netif-&gt;<a class="code" href="structnetif.html#o8">hwaddr_len</a>; i++) {
01141     <span class="keywordflow">if</span> (netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[i] != reply_msg-&gt;chaddr[i]) {
01142       <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"netif-&gt;hwaddr[%u]==%02x != reply_msg-&gt;chaddr[%u]==%02x\n"</span>,
01143         i, netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[i], i, reply_msg-&gt;chaddr[i]));
01144       <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01145       <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01146       <span class="keywordflow">return</span>;
01147     }
01148   }
01149   <span class="comment">/* match transaction ID against what we expected */</span>
01150   <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(reply_msg-&gt;xid) != <a class="code" href="structdhcp.html">dhcp</a>-&gt;xid) {
01151     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"transaction id mismatch\n"</span>));
01152     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01153     <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01154     <span class="keywordflow">return</span>;
01155   }
01156   <span class="comment">/* option fields could be unfold? */</span>
01157   <span class="keywordflow">if</span> (<a class="code" href="dhcp_8c.html#a13">dhcp_unfold_reply</a>(<a class="code" href="structdhcp.html">dhcp</a>) != <a class="code" href="err_8h.html#a0">ERR_OK</a>) {
01158     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"problem unfolding DHCP message - too short on memory?\n"</span>));
01159     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01160     <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01161     <span class="keywordflow">return</span>;
01162   }
01163 
01164   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"searching DHCP_OPTION_MESSAGE_TYPE\n"</span>));
01165   <span class="comment">/* obtain pointer to DHCP message type */</span>
01166   options_ptr = <a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<a class="code" href="structdhcp.html">dhcp</a>, <a class="code" href="dhcp_8h.html#a65">DHCP_OPTION_MESSAGE_TYPE</a>);
01167   <span class="keywordflow">if</span> (options_ptr == <a class="code" href="def_8h.html#a2">NULL</a>) {
01168     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"DHCP_OPTION_MESSAGE_TYPE option not found\n"</span>));
01169     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01170     <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01171     <span class="keywordflow">return</span>;
01172   }
01173 
01174   <span class="comment">/* read DHCP message type */</span>
01175   msg_type = <a class="code" href="dhcp_8c.html#a15">dhcp_get_option_byte</a>(options_ptr + 2);
01176   <span class="comment">/* message type is DHCP ACK? */</span>
01177   <span class="keywordflow">if</span> (msg_type == <a class="code" href="dhcp_8h.html#a45">DHCP_ACK</a>) {
01178     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"DHCP_ACK received\n"</span>));
01179     <span class="comment">/* in requesting state? */</span>
01180     <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>) {
01181       <a class="code" href="dhcp_8c.html#a1">dhcp_handle_ack</a>(netif);
01182       <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = 0;
01183 <span class="preprocessor">#if DHCP_DOES_ARP_CHECK</span>
01184 <span class="preprocessor"></span>      <span class="comment">/* check if the acknowledged lease address is already in use */</span>
01185       <a class="code" href="dhcp_8c.html#a6">dhcp_check</a>(netif);
01186 <span class="preprocessor">#else</span>
01187 <span class="preprocessor"></span>      <span class="comment">/* bind interface to the acknowledged lease address */</span>
01188       <a class="code" href="dhcp_8c.html#a7">dhcp_bind</a>(netif);
01189 <span class="preprocessor">#endif</span>
01190 <span class="preprocessor"></span>    }
01191     <span class="comment">/* already bound to the given lease address? */</span>
01192     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a29">DHCP_REBOOTING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a30">DHCP_REBINDING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>)) {
01193       <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = 0;
01194       <a class="code" href="dhcp_8c.html#a7">dhcp_bind</a>(netif);
01195     }
01196   }
01197   <span class="comment">/* received a DHCP_NAK in appropriate state? */</span>
01198   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((msg_type == <a class="code" href="dhcp_8h.html#a46">DHCP_NAK</a>) &amp;&amp;
01199     ((<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a29">DHCP_REBOOTING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a27">DHCP_REQUESTING</a>) ||
01200      (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a30">DHCP_REBINDING</a>) || (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a31">DHCP_RENEWING</a>  ))) {
01201     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"DHCP_NAK received\n"</span>));
01202     <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = 0;
01203     <a class="code" href="dhcp_8c.html#a2">dhcp_handle_nak</a>(netif);
01204   }
01205   <span class="comment">/* received a DHCP_OFFER in DHCP_SELECTING state? */</span>
01206   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((msg_type == <a class="code" href="dhcp_8h.html#a42">DHCP_OFFER</a>) &amp;&amp; (<a class="code" href="structdhcp.html">dhcp</a>-&gt;state == <a class="code" href="dhcp_8h.html#a32">DHCP_SELECTING</a>)) {
01207     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"DHCP_OFFER received in DHCP_SELECTING state\n"</span>));
01208     <a class="code" href="structdhcp.html">dhcp</a>-&gt;request_timeout = 0;
01209     <span class="comment">/* remember offered lease */</span>
01210     <a class="code" href="dhcp_8c.html#a3">dhcp_handle_offer</a>(netif);
01211   }
01212   <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
01213   <a class="code" href="structdhcp.html">dhcp</a>-&gt;p = <a class="code" href="def_8h.html#a2">NULL</a>;
01214 }
01215 
01216 
<a name="l01217"></a><a class="code" href="dhcp_8c.html#a22">01217</a> <span class="keyword">static</span> <a class="code" href="err_8h.html#a13">err_t</a> <a class="code" href="dhcp_8c.html#a22">dhcp_create_request</a>(<span class="keyword">struct</span> netif *netif)
01218 {
01219   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
01220   u16_t i;
01221   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_create_request: dhcp-&gt;p_out == NULL"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out == <a class="code" href="def_8h.html#a2">NULL</a>);
01222   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_create_request: dhcp-&gt;msg_out == NULL"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out == <a class="code" href="def_8h.html#a2">NULL</a>);
01223   <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out = <a class="code" href="pbuf_8c.html#a11">pbuf_alloc</a>(<a class="code" href="pbuf_8h.html#a26a7">PBUF_TRANSPORT</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdhcp__msg.html">dhcp_msg</a>), <a class="code" href="pbuf_8h.html#a27a11">PBUF_RAM</a>);
01224   <span class="keywordflow">if</span> (<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out == <a class="code" href="def_8h.html#a2">NULL</a>) {
01225     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"dhcp_create_request(): could not allocate pbuf\n"</span>));
01226     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a1">ERR_MEM</a>;
01227   }
01228   <span class="comment">/* give unique transaction identifier to this request */</span>
01229   <a class="code" href="structdhcp.html">dhcp</a>-&gt;xid = <a class="code" href="dhcp_8c.html#a0">xid</a>++;
01230 
01231   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out = (<span class="keyword">struct </span>dhcp_msg *)<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out-&gt;payload;
01232 
01233   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;op = <a class="code" href="dhcp_8h.html#a39">DHCP_BOOTREQUEST</a>;
01234   <span class="comment">/* TODO: make link layer independent */</span>
01235   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;htype = <a class="code" href="dhcp_8h.html#a49">DHCP_HTYPE_ETH</a>;
01236   <span class="comment">/* TODO: make link layer independent */</span>
01237   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;hlen = <a class="code" href="dhcp_8h.html#a50">DHCP_HLEN_ETH</a>;
01238   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;hops = 0;
01239   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;xid = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;xid);
01240   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;secs = 0;
01241   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;flags = 0;
01242   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;ciaddr = netif-&gt;<a class="code" href="structnetif.html#o1">ip_addr</a>.<a class="code" href="structip__addr.html#o0">addr</a>;
01243   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;yiaddr = 0;
01244   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;siaddr = 0;
01245   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;giaddr = 0;
01246   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dhcp_8h.html#a2">DHCP_CHADDR_LEN</a>; i++) {
01247     <span class="comment">/* copy netif hardware address, pad with zeroes */</span>
01248     <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;chaddr[i] = (i &lt; netif-&gt;<a class="code" href="structnetif.html#o8">hwaddr_len</a>) ? netif-&gt;<a class="code" href="structnetif.html#o9">hwaddr</a>[i] : 0<span class="comment">/* pad byte*/</span>;
01249   }
01250   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dhcp_8h.html#a3">DHCP_SNAME_LEN</a>; i++) <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;sname[i] = 0;
01251   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dhcp_8h.html#a4">DHCP_FILE_LEN</a>; i++) <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;file[i] = 0;
01252   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;cookie = <a class="code" href="ipv4_2lwip_2inet_8h.html#a2">htonl</a>(0x63825363UL);
01253   <a class="code" href="structdhcp.html">dhcp</a>-&gt;options_out_len = 0;
01254   <span class="comment">/* fill options field with an incrementing array (for debugging purposes) */</span>
01255   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>; i++) <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out-&gt;options[i] = i;
01256   <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a0">ERR_OK</a>;
01257 }
01258 
<a name="l01259"></a><a class="code" href="dhcp_8c.html#a23">01259</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a23">dhcp_delete_request</a>(<span class="keyword">struct</span> netif *netif)
01260 {
01261   <span class="keyword">struct </span><a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a> = netif-&gt;dhcp;
01262   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_free_msg: dhcp-&gt;p_out != NULL"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out != <a class="code" href="def_8h.html#a2">NULL</a>);
01263   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_free_msg: dhcp-&gt;msg_out != NULL"</span>, <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out != <a class="code" href="def_8h.html#a2">NULL</a>);
01264   <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(<a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out);
01265   <a class="code" href="structdhcp.html">dhcp</a>-&gt;p_out = <a class="code" href="def_8h.html#a2">NULL</a>;
01266   <a class="code" href="structdhcp.html">dhcp</a>-&gt;msg_out = <a class="code" href="def_8h.html#a2">NULL</a>;
01267 }
01268 
<a name="l01276"></a><a class="code" href="dhcp_8c.html#a28">01276</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dhcp_8c.html#a28">dhcp_option_trailer</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>)
01277 {
01278   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_trailer: dhcp-&gt;msg_out != NULL\n"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a> != <a class="code" href="def_8h.html#a2">NULL</a>);
01279   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_trailer: dhcp-&gt;options_out_len &lt; DHCP_OPTIONS_LEN\n"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> &lt; <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01280   dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = <a class="code" href="dhcp_8h.html#a61">DHCP_OPTION_END</a>;
01281   <span class="comment">/* packet is too small, or not 4 byte aligned? */</span>
01282   <span class="keywordflow">while</span> ((dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> &lt; <a class="code" href="dhcp_8h.html#a5">DHCP_MIN_OPTIONS_LEN</a>) || (dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> &amp; 3)) {
01283     <span class="comment">/* LWIP_DEBUGF(DHCP_DEBUG, ("dhcp_option_trailer: dhcp-&gt;options_out_len=%u, DHCP_OPTIONS_LEN=%u", dhcp-&gt;options_out_len, DHCP_OPTIONS_LEN)); */</span>
01284     <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"dhcp_option_trailer: dhcp-&gt;options_out_len &lt; DHCP_OPTIONS_LEN\n"</span>, dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a> &lt; <a class="code" href="dhcp_8h.html#a6">DHCP_OPTIONS_LEN</a>);
01285     <span class="comment">/* add a fill/padding byte */</span>
01286     dhcp-&gt;<a class="code" href="structdhcp.html#o9">msg_out</a>-&gt;options[dhcp-&gt;<a class="code" href="structdhcp.html#o10">options_out_len</a>++] = 0;
01287   }
01288 }
01289 
<a name="l01299"></a><a class="code" href="dhcp_8c.html#a14">01299</a> <span class="keyword">static</span> u8_t *<a class="code" href="dhcp_8c.html#a14">dhcp_get_option_ptr</a>(<span class="keyword">struct</span> <a class="code" href="structdhcp.html">dhcp</a> *<a class="code" href="structdhcp.html">dhcp</a>, u8_t option_type)
01300 {
01301   u8_t overload = <a class="code" href="dhcp_8h.html#a76">DHCP_OVERLOAD_NONE</a>;
01302 
01303   <span class="comment">/* options available? */</span>
01304   <span class="keywordflow">if</span> ((dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a> != <a class="code" href="def_8h.html#a2">NULL</a>) &amp;&amp; (dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a> &gt; 0)) {
01305     <span class="comment">/* start with options field */</span>
01306     u8_t *options = (u8_t *)dhcp-&gt;<a class="code" href="structdhcp.html#o6">options_in</a>;
01307     u16_t offset = 0;
01308     <span class="comment">/* at least 1 byte to read and no end marker, then at least 3 bytes to read? */</span>
01309     <span class="keywordflow">while</span> ((offset &lt; dhcp-&gt;<a class="code" href="structdhcp.html#o7">options_in_len</a>) &amp;&amp; (options[offset] != <a class="code" href="dhcp_8h.html#a61">DHCP_OPTION_END</a>)) {
01310       <span class="comment">/* LWIP_DEBUGF(DHCP_DEBUG, ("msg_offset=%u, q-&gt;len=%u", msg_offset, q-&gt;len)); */</span>
01311       <span class="comment">/* are the sname and/or file field overloaded with options? */</span>
01312       <span class="keywordflow">if</span> (options[offset] == <a class="code" href="dhcp_8h.html#a64">DHCP_OPTION_OVERLOAD</a>) {
01313         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 2, (<span class="stringliteral">"overloaded message detected\n"</span>));
01314         <span class="comment">/* skip option type and length */</span>
01315         offset += 2;
01316         overload = options[offset++];
01317       }
01318       <span class="comment">/* requested option found */</span>
01319       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (options[offset] == option_type) {
01320         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"option found at offset %u in options\n"</span>, offset));
01321         <span class="keywordflow">return</span> &amp;options[offset];
01322       <span class="comment">/* skip option */</span>
01323       } <span class="keywordflow">else</span> {
01324          <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>, (<span class="stringliteral">"skipping option %u in options\n"</span>, options[offset]));
01325         <span class="comment">/* skip option type */</span>
01326         offset++;
01327         <span class="comment">/* skip option length, and then length bytes */</span>
01328         offset += 1 + options[offset];
01329       }
01330     }
01331     <span class="comment">/* is this an overloaded message? */</span>
01332     <span class="keywordflow">if</span> (overload != <a class="code" href="dhcp_8h.html#a76">DHCP_OVERLOAD_NONE</a>) {
01333       u16_t field_len;
01334       <span class="keywordflow">if</span> (overload == <a class="code" href="dhcp_8h.html#a77">DHCP_OVERLOAD_FILE</a>) {
01335         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"overloaded file field\n"</span>));
01336         options = (u8_t *)&amp;dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a>-&gt;file;
01337         field_len = <a class="code" href="dhcp_8h.html#a4">DHCP_FILE_LEN</a>;
01338       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (overload == <a class="code" href="dhcp_8h.html#a78">DHCP_OVERLOAD_SNAME</a>) {
01339         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"overloaded sname field\n"</span>));
01340         options = (u8_t *)&amp;dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a>-&gt;sname;
01341         field_len = <a class="code" href="dhcp_8h.html#a3">DHCP_SNAME_LEN</a>;
01342       <span class="comment">/* TODO: check if else if () is necessary */</span>
01343       } <span class="keywordflow">else</span> {
01344         <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a> | 1, (<span class="stringliteral">"overloaded sname and file field\n"</span>));
01345         options = (u8_t *)&amp;dhcp-&gt;<a class="code" href="structdhcp.html#o5">msg_in</a>-&gt;sname;
01346         field_len = <a class="code" href="dhcp_8h.html#a4">DHCP_FILE_LEN</a> + <a class="code" href="dhcp_8h.html#a3">DHCP_SNAME_LEN</a>;
01347       }
01348       offset = 0;
01349 
01350       <span class="comment">/* at least 1 byte to read and no end marker */</span>
01351       <span class="keywordflow">while</span> ((offset &lt; field_len) &amp;&amp; (options[offset] != <a class="code" href="dhcp_8h.html#a61">DHCP_OPTION_END</a>)) {
01352         <span class="keywordflow">if</span> (options[offset] == option_type) {
01353            <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"option found at offset=%u\n"</span>, offset));
01354           <span class="keywordflow">return</span> &amp;options[offset];
01355         <span class="comment">/* skip option */</span>
01356         } <span class="keywordflow">else</span> {
01357           <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a> | <a class="code" href="debug_8h.html#a7">DBG_TRACE</a>, (<span class="stringliteral">"skipping option %u\n"</span>, options[offset]));
01358           <span class="comment">/* skip option type */</span>
01359           offset++;
01360           offset += 1 + options[offset];
01361         }
01362       }
01363     }
01364   }
01365   <span class="keywordflow">return</span> 0;
01366 }
01367 
<a name="l01376"></a><a class="code" href="dhcp_8c.html#a15">01376</a> <span class="keyword">static</span> u8_t <a class="code" href="dhcp_8c.html#a15">dhcp_get_option_byte</a>(u8_t *ptr)
01377 {
01378   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>, (<span class="stringliteral">"option byte value=%u\n"</span>, *ptr));
01379   <span class="keywordflow">return</span> *ptr;
01380 }
01381 
<a name="l01390"></a><a class="code" href="dhcp_8c.html#a16">01390</a> <span class="keyword">static</span> u16_t <a class="code" href="dhcp_8c.html#a16">dhcp_get_option_short</a>(u8_t *ptr)
01391 {
01392   u16_t value;
01393   value = *ptr++ &lt;&lt; 8;
01394   value |= *ptr;
01395   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>, (<span class="stringliteral">"option short value=%u\n"</span>, value));
01396   <span class="keywordflow">return</span> value;
01397 }
01398 
<a name="l01407"></a><a class="code" href="dhcp_8c.html#a17">01407</a> <span class="keyword">static</span> u32_t <a class="code" href="dhcp_8c.html#a17">dhcp_get_option_long</a>(u8_t *ptr)
01408 {
01409   u32_t value;
01410   value = (u32_t)(*ptr++) &lt;&lt; 24;
01411   value |= (u32_t)(*ptr++) &lt;&lt; 16;
01412   value |= (u32_t)(*ptr++) &lt;&lt; 8;
01413   value |= (u32_t)(*ptr++);
01414   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a87">DHCP_DEBUG</a>, (<span class="stringliteral">"option long value=%lu\n"</span>, value));
01415   <span class="keywordflow">return</span> value;
01416 }
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
