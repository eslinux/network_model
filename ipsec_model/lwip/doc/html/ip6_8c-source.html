
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ip6.c</h1><a href="ip6_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification,</span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY</span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 
00034 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00035 <span class="comment">/* ip.c</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * This is the code for the IP layer for IPv6.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> */</span>
00040 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00041 
00042 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00043 
00044 <span class="preprocessor">#include "<a class="code" href="def_8h.html">lwip/def.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="mem_8h.html">lwip/mem.h</a>"</span>
00046 <span class="preprocessor">#include "lwip/ip.h"</span>
00047 <span class="preprocessor">#include "lwip/inet.h"</span>
00048 <span class="preprocessor">#include "<a class="code" href="netif_8h.html">lwip/netif.h</a>"</span>
00049 <span class="preprocessor">#include "lwip/icmp.h"</span>
00050 <span class="preprocessor">#include "<a class="code" href="udp_8h.html">lwip/udp.h</a>"</span>
00051 <span class="preprocessor">#include "<a class="code" href="tcp_8h.html">lwip/tcp.h</a>"</span>
00052 
00053 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">lwip/stats.h</a>"</span>
00054 
00055 <span class="preprocessor">#include "arch/perf.h"</span>
00056 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00057 <span class="comment">/* ip_init:</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> * Initializes the IP layer.</span>
00060 <span class="comment"> */</span>
00061 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00062 <span class="keywordtype">void</span>
<a name="l00063"></a><a class="code" href="ip6_8c.html#a0">00063</a> <a class="code" href="ip_8c.html#a0">ip_init</a>(<span class="keywordtype">void</span>)
00064 {
00065 }
00066 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00067 <span class="comment">/* ip_route:</span>
00068 <span class="comment"> *</span>
00069 <span class="comment"> * Finds the appropriate network interface for a given IP address. It searches the</span>
00070 <span class="comment"> * list of network interfaces linearly. A match is found if the masked IP address of</span>
00071 <span class="comment"> * the network interface equals the masked IP address given to the function.</span>
00072 <span class="comment"> */</span>
00073 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00074 <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *
<a name="l00075"></a><a class="code" href="ip6_8c.html#a1">00075</a> <a class="code" href="ip_8c.html#a1">ip_route</a>(<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest)
00076 {
00077   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00078 
00079   <span class="keywordflow">for</span>(<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>; <a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>; <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next) {
00080     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a28">ip_addr_maskcmp</a>(dest, &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;netmask))) {
00081       <span class="keywordflow">return</span> <a class="code" href="structnetif.html">netif</a>;
00082     }
00083   }
00084 
00085   <span class="keywordflow">return</span> <a class="code" href="netif_8c.html#a1">netif_default</a>;
00086 }
00087 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00088 <span class="comment">/* ip_forward:</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> * Forwards an IP packet. It finds an appropriate route for the packet, decrements</span>
00091 <span class="comment"> * the TTL value of the packet, adjusts the checksum and outputs the packet on the</span>
00092 <span class="comment"> * appropriate interface.</span>
00093 <span class="comment"> */</span>
00094 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00095 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00096"></a><a class="code" href="ip6_8c.html#a2">00096</a> <a class="code" href="ip6_8c.html#a2">ip_forward</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr)
00097 {
00098   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00099 
00100   PERF_START;
00101 
00102   <span class="keywordflow">if</span> ((<a class="code" href="structnetif.html">netif</a> = <a class="code" href="ip_8c.html#a1">ip_route</a>((<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *)&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>))) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00103 
00104     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: no forwarding route found for "</span>));
00105 <span class="preprocessor">#if IP_DEBUG</span>
00106 <span class="preprocessor"></span>    <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a33">ip_addr_debug_print</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, &amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>));
00107 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00108     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"\n"</span>));
00109     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00110     <span class="keywordflow">return</span>;
00111   }
00112   <span class="comment">/* Decrement TTL and send ICMP if ttl == 0. */</span>
00113   <span class="keywordflow">if</span> (--iphdr-&gt;<a class="code" href="structip__hdr.html#o7">hoplim</a> == 0) {
00114     <span class="comment">/* Don't send ICMP messages in response to ICMP messages */</span>
00115     <span class="keywordflow">if</span> (iphdr-&gt;<a class="code" href="structip__hdr.html#o6">nexthdr</a> != <a class="code" href="ipv4_2lwip_2ip_8h.html#a1">IP_PROTO_ICMP</a>) {
00116       <a class="code" href="icmp6_8c.html#a2">icmp_time_exceeded</a>(p, <a class="code" href="ipv4_2lwip_2icmp_8h.html#a28a22">ICMP_TE_TTL</a>);
00117     }
00118     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00119     <span class="keywordflow">return</span>;
00120   }
00121 
00122   <span class="comment">/* Incremental update of the IP checksum. */</span>
00123   <span class="comment">/*  if (iphdr-&gt;chksum &gt;= htons(0xffff - 0x100)) {</span>
00124 <span class="comment">    iphdr-&gt;chksum += htons(0x100) + 1;</span>
00125 <span class="comment">  } else {</span>
00126 <span class="comment">    iphdr-&gt;chksum += htons(0x100);</span>
00127 <span class="comment">    }*/</span>
00128 
00129 
00130   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_forward: forwarding packet to "</span>));
00131 <span class="preprocessor">#if IP_DEBUG</span>
00132 <span class="preprocessor"></span>  <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a33">ip_addr_debug_print</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, &amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>));
00133 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00134   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"\n"</span>));
00135 
00136 <span class="preprocessor">#ifdef IP_STATS</span>
00137 <span class="preprocessor"></span>  ++lwip_stats.ip.fw;
00138   ++lwip_stats.ip.xmit;
00139 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00140 
00141   PERF_STOP(<span class="stringliteral">"ip_forward"</span>);
00142 
00143   <a class="code" href="structnetif.html">netif</a>-&gt;output(<a class="code" href="structnetif.html">netif</a>, p, (<span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *)&amp;(iphdr-&gt;<a class="code" href="structip__hdr.html#o8">dest</a>));
00144 }
00145 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00146 <span class="comment">/* ip_input:</span>
00147 <span class="comment"> *</span>
00148 <span class="comment"> * This function is called by the network interface device driver when an IP packet is</span>
00149 <span class="comment"> * received. The function does the basic checks of the IP header such as packet size</span>
00150 <span class="comment"> * being at least larger than the header size etc. If the packet was not destined for</span>
00151 <span class="comment"> * us, the packet is forwarded (using ip_forward). The IP checksum is always checked.</span>
00152 <span class="comment"> *</span>
00153 <span class="comment"> * Finally, the packet is sent to the upper layer protocol input function.</span>
00154 <span class="comment"> */</span>
00155 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00156 <span class="keywordtype">void</span>
<a name="l00157"></a><a class="code" href="ip6_8c.html#a3">00157</a> <a class="code" href="ip_8c.html#a2">ip_input</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *inp) {
00158   <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr;
00159   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00160 
00161 
00162   PERF_START;
00163 
00164 <span class="preprocessor">#if IP_DEBUG</span>
00165 <span class="preprocessor"></span>  ip_debug_print(p);
00166 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00167 
00168 
00169 <span class="preprocessor">#ifdef IP_STATS</span>
00170 <span class="preprocessor"></span>  ++lwip_stats.ip.recv;
00171 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00172 
00173   <span class="comment">/* identify the IP header */</span>
00174   iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00175 
00176 
00177   <span class="keywordflow">if</span> (iphdr-&gt;v != 6) {
00178     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"IP packet dropped due to bad version number\n"</span>));
00179 <span class="preprocessor">#if IP_DEBUG</span>
00180 <span class="preprocessor"></span>    ip_debug_print(p);
00181 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00182     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00183 <span class="preprocessor">#ifdef IP_STATS</span>
00184 <span class="preprocessor"></span>    ++lwip_stats.ip.err;
00185     ++lwip_stats.ip.drop;
00186 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00187     <span class="keywordflow">return</span>;
00188   }
00189 
00190   <span class="comment">/* is this packet for us? */</span>
00191   <span class="keywordflow">for</span>(<a class="code" href="structnetif.html">netif</a> = <a class="code" href="netif_8c.html#a0">netif_list</a>; <a class="code" href="structnetif.html">netif</a> != <a class="code" href="def_8h.html#a2">NULL</a>; <a class="code" href="structnetif.html">netif</a> = <a class="code" href="structnetif.html">netif</a>-&gt;next) {
00192 <span class="preprocessor">#if IP_DEBUG</span>
00193 <span class="preprocessor"></span>    <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_input: iphdr-&gt;dest "</span>));
00194     <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a33">ip_addr_debug_print</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, &amp;(iphdr-&gt;dest));
00195     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"netif-&gt;ip_addr "</span>));
00196     <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a33">ip_addr_debug_print</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr));
00197     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"\n"</span>));
00198 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00199     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a29">ip_addr_cmp</a>(&amp;(iphdr-&gt;dest), &amp;(<a class="code" href="structnetif.html">netif</a>-&gt;ip_addr))) {
00200       <span class="keywordflow">break</span>;
00201     }
00202   }
00203 
00204 
00205   <span class="keywordflow">if</span> (<a class="code" href="structnetif.html">netif</a> == <a class="code" href="def_8h.html#a2">NULL</a>) {
00206     <span class="comment">/* packet not for us, route or discard */</span>
00207 <span class="preprocessor">#ifdef IP_FORWARD</span>
00208 <span class="preprocessor"></span>    <a class="code" href="ip6_8c.html#a2">ip_forward</a>(p, iphdr);
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>    <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00211     <span class="keywordflow">return</span>;
00212   }
00213 
00214   <a class="code" href="pbuf_8c.html#a12">pbuf_realloc</a>(p, <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a> + <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(iphdr-&gt;len));
00215 
00216   <span class="comment">/* send to upper layers */</span>
00217 <span class="preprocessor">#if IP_DEBUG</span>
00218 <span class="preprocessor"></span>  <span class="comment">/*  LWIP_DEBUGF("ip_input: \n");</span>
00219 <span class="comment">  ip_debug_print(p);</span>
00220 <span class="comment">  LWIP_DEBUGF("ip_input: p-&gt;len %u p-&gt;tot_len %u\n", p-&gt;len, p-&gt;tot_len);*/</span>
00221 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00222 
00223 
00224   <a class="code" href="pbuf_8c.html#a13">pbuf_header</a>(p, -<a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>);
00225 
00226   <span class="keywordflow">switch</span> (iphdr-&gt;nexthdr) {
00227   <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a2">IP_PROTO_UDP</a>:
00228     <a class="code" href="udp_8h.html#a15">udp_input</a>(p);
00229     <span class="keywordflow">break</span>;
00230   <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a4">IP_PROTO_TCP</a>:
00231     <a class="code" href="tcp_8h.html#a84">tcp_input</a>(p);
00232     <span class="keywordflow">break</span>;
00233   <span class="keywordflow">case</span> <a class="code" href="ipv4_2lwip_2ip_8h.html#a1">IP_PROTO_ICMP</a>:
00234     <a class="code" href="icmp_8c.html#a0">icmp_input</a>(p, inp);
00235     <span class="keywordflow">break</span>;
00236   <span class="keywordflow">default</span>:
00237     <span class="comment">/* send ICMP destination protocol unreachable */</span>
00238     <a class="code" href="icmp_8c.html#a1">icmp_dest_unreach</a>(p, <a class="code" href="ipv4_2lwip_2icmp_8h.html#a27a18">ICMP_DUR_PROTO</a>);
00239     <a class="code" href="pbuf_8c.html#a14">pbuf_free</a>(p);
00240     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"Unsupported transport protocol %u\n"</span>,
00241           iphdr-&gt;nexthdr));
00242 
00243 <span class="preprocessor">#ifdef IP_STATS</span>
00244 <span class="preprocessor"></span>    ++lwip_stats.ip.proterr;
00245     ++lwip_stats.ip.drop;
00246 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00247 
00248   }
00249   PERF_STOP(<span class="stringliteral">"ip_input"</span>);
00250 }
00251 
00252 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00253 <span class="comment">/* ip_output_if:</span>
00254 <span class="comment"> *</span>
00255 <span class="comment"> * Sends an IP packet on a network interface. This function constructs the IP header</span>
00256 <span class="comment"> * and calculates the IP header checksum. If the source IP address is NULL,</span>
00257 <span class="comment"> * the IP address of the outgoing network interface is filled in as source address.</span>
00258 <span class="comment"> */</span>
00259 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00260 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00261"></a><a class="code" href="ip6_8c.html#a4">00261</a> <a class="code" href="ipv6_2lwip_2ip_8h.html#a10">ip_output_if</a> (<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *src, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest,
00262        u8_t ttl,
00263        u8_t proto, <span class="keyword">struct</span> <a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>)
00264 {
00265   <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr;
00266 
00267   PERF_START;
00268 
00269   printf(<span class="stringliteral">"len %u tot_len %u\n"</span>, p-&gt;<a class="code" href="structpbuf.html#o3">len</a>, p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>);
00270   <span class="keywordflow">if</span> (<a class="code" href="pbuf_8c.html#a13">pbuf_header</a>(p, <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>)) {
00271     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_output: not enough room for IP header in pbuf\n"</span>));
00272 <span class="preprocessor">#ifdef IP_STATS</span>
00273 <span class="preprocessor"></span>    ++lwip_stats.ip.err;
00274 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00275 
00276     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a2">ERR_BUF</a>;
00277   }
00278   printf(<span class="stringliteral">"len %u tot_len %u\n"</span>, p-&gt;<a class="code" href="structpbuf.html#o3">len</a>, p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>);
00279 
00280   iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00281 
00282 
00283   <span class="keywordflow">if</span> (dest != <a class="code" href="ipv4_2lwip_2ip_8h.html#a5">IP_HDRINCL</a>) {
00284     printf(<span class="stringliteral">"!IP_HDRLINCL\n"</span>);
00285     iphdr-&gt;hoplim = ttl;
00286     iphdr-&gt;nexthdr = proto;
00287     iphdr-&gt;len = <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>(p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a> - <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>);
00288     <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;dest), dest);
00289 
00290     iphdr-&gt;v = 6;
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a30">ip_addr_isany</a>(src)) {
00293       <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;src), &amp;(netif-&gt;<a class="code" href="structnetif.html#o1">ip_addr</a>));
00294     } <span class="keywordflow">else</span> {
00295       <a class="code" href="ipv4_2lwip_2ip__addr_8h.html#a27">ip_addr_set</a>(&amp;(iphdr-&gt;src), src);
00296     }
00297 
00298   } <span class="keywordflow">else</span> {
00299     dest = &amp;(iphdr-&gt;dest);
00300   }
00301 
00302 <span class="preprocessor">#ifdef IP_STATS</span>
00303 <span class="preprocessor"></span>  ++lwip_stats.ip.xmit;
00304 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00305 
00306   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_output_if: %c%c (len %u)\n"</span>, netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[0], netif-&gt;<a class="code" href="structnetif.html#o11">name</a>[1], p-&gt;<a class="code" href="structpbuf.html#o2">tot_len</a>));
00307 <span class="preprocessor">#if IP_DEBUG</span>
00308 <span class="preprocessor"></span>  ip_debug_print(p);
00309 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00310 
00311   PERF_STOP(<span class="stringliteral">"ip_output_if"</span>);
00312   <span class="keywordflow">return</span> netif-&gt;<a class="code" href="structnetif.html#o5">output</a>(netif, p, dest);
00313 }
00314 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00315 <span class="comment">/* ip_output:</span>
00316 <span class="comment"> *</span>
00317 <span class="comment"> * Simple interface to ip_output_if. It finds the outgoing network interface and</span>
00318 <span class="comment"> * calls upon ip_output_if to do the actual work.</span>
00319 <span class="comment"> */</span>
00320 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00321 <a class="code" href="err_8h.html#a13">err_t</a>
<a name="l00322"></a><a class="code" href="ip6_8c.html#a5">00322</a> <a class="code" href="ipv6_2lwip_2ip_8h.html#a9">ip_output</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *src, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest,
00323     u8_t ttl, u8_t proto)
00324 {
00325   <span class="keyword">struct </span><a class="code" href="structnetif.html">netif</a> *<a class="code" href="structnetif.html">netif</a>;
00326   <span class="keywordflow">if</span> ((<a class="code" href="structnetif.html">netif</a> = <a class="code" href="ip_8c.html#a1">ip_route</a>(dest)) == <a class="code" href="def_8h.html#a2">NULL</a>) {
00327     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a68">IP_DEBUG</a>, (<span class="stringliteral">"ip_output: No route to 0x%lx\n"</span>, dest-&gt;<a class="code" href="structip__addr.html#o0">addr</a>));
00328 <span class="preprocessor">#ifdef IP_STATS</span>
00329 <span class="preprocessor"></span>    ++lwip_stats.ip.rterr;
00330 <span class="preprocessor">#endif </span><span class="comment">/* IP_STATS */</span>
00331     <span class="keywordflow">return</span> <a class="code" href="err_8h.html#a9">ERR_RTE</a>;
00332   }
00333 
00334   <span class="keywordflow">return</span> <a class="code" href="ipv6_2lwip_2ip_8h.html#a10">ip_output_if</a> (p, src, dest, ttl, proto, <a class="code" href="structnetif.html">netif</a>);
00335 }
00336 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00337 <span class="preprocessor">#if IP_DEBUG</span>
00338 <span class="preprocessor"></span><span class="keywordtype">void</span>
00339 ip_debug_print(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p)
00340 {
00341   <span class="keyword">struct </span><a class="code" href="structip__hdr.html">ip_hdr</a> *iphdr = p-&gt;<a class="code" href="structpbuf.html#o1">payload</a>;
00342   <span class="keywordtype">char</span> *payload;
00343 
00344   payload = (<span class="keywordtype">char</span> *)iphdr + <a class="code" href="ipv4_2lwip_2ip_8h.html#a0">IP_HLEN</a>;
00345 
00346   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"IP header:\n"</span>));
00347   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00348   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|%2d |  %x%x  |      %x%x           | (v, traffic class, flow label)\n"</span>,
00349         iphdr-&gt;v,
00350         iphdr-&gt;tclass1, iphdr-&gt;tclass2,
00351         iphdr-&gt;flow1, iphdr-&gt;flow2));
00352   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00353   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|    %5u      | %2u  |  %2u   | (len, nexthdr, hoplim)\n"</span>,
00354         <a class="code" href="ipv4_2lwip_2inet_8h.html#a1">ntohs</a>(iphdr-&gt;len),
00355         iphdr-&gt;nexthdr,
00356         iphdr-&gt;hoplim));
00357   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00358   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (src)\n"</span>,
00359         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[0]) &gt;&gt; 16 &amp; 0xffff,
00360         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[0]) &amp; 0xffff));
00361   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (src)\n"</span>,
00362         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[1]) &gt;&gt; 16 &amp; 0xffff,
00363         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[1]) &amp; 0xffff));
00364   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (src)\n"</span>,
00365         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[2]) &gt;&gt; 16 &amp; 0xffff,
00366         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[2]) &amp; 0xffff));
00367   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (src)\n"</span>,
00368         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[3]) &gt;&gt; 16 &amp; 0xffff,
00369         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;src.addr[3]) &amp; 0xffff));
00370   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00371   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (dest)\n"</span>,
00372         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[0]) &gt;&gt; 16 &amp; 0xffff,
00373         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[0]) &amp; 0xffff));
00374   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (dest)\n"</span>,
00375         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[1]) &gt;&gt; 16 &amp; 0xffff,
00376         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[1]) &amp; 0xffff));
00377   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (dest)\n"</span>,
00378         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[2]) &gt;&gt; 16 &amp; 0xffff,
00379         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[2]) &amp; 0xffff));
00380   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"|       %4lx      |       %4lx     | (dest)\n"</span>,
00381         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[3]) &gt;&gt; 16 &amp; 0xffff,
00382         <a class="code" href="ipv4_2lwip_2inet_8h.html#a3">ntohl</a>(iphdr-&gt;dest.addr[3]) &amp; 0xffff));
00383   <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(IP_DEBUG, (<span class="stringliteral">"+-------------------------------+\n"</span>));
00384 }
00385 <span class="preprocessor">#endif </span><span class="comment">/* IP_DEBUG */</span>
00386 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
