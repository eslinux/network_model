
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>chap.c</h1><a href="chap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*** WARNING - THIS HAS NEVER BEEN FINISHED ***/</span>
00002 <span class="comment">/*****************************************************************************</span>
00003 <span class="comment">* chap.c - Network Challenge Handshake Authentication Protocol program file.</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 2003 by Marc Boucher, Services Informatiques (MBSI) inc.</span>
00006 <span class="comment">* portions Copyright (c) 1997 by Global Election Systems Inc.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* The authors hereby grant permission to use, copy, modify, distribute,</span>
00009 <span class="comment">* and license this software and its documentation for any purpose, provided</span>
00010 <span class="comment">* that existing copyright notices are retained in all copies and that this</span>
00011 <span class="comment">* notice and the following disclaimer are included verbatim in any </span>
00012 <span class="comment">* distributions. No written agreement, license, or royalty fee is required</span>
00013 <span class="comment">* for any of the authorized uses.</span>
00014 <span class="comment">*</span>
00015 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS *AS IS* AND ANY EXPRESS OR</span>
00016 <span class="comment">* IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00017 <span class="comment">* OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00018 <span class="comment">* IN NO EVENT SHALL THE CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
00019 <span class="comment">* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
00020 <span class="comment">* NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
00021 <span class="comment">* DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
00022 <span class="comment">* THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
00023 <span class="comment">* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
00024 <span class="comment">* THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00025 <span class="comment">*</span>
00026 <span class="comment">******************************************************************************</span>
00027 <span class="comment">* REVISION HISTORY</span>
00028 <span class="comment">*</span>
00029 <span class="comment">* 03-01-01 Marc Boucher &lt;marc@mbsi.ca&gt;</span>
00030 <span class="comment">*   Ported to lwIP.</span>
00031 <span class="comment">* 97-12-04 Guy Lancaster &lt;lancasterg@acm.org&gt;, Global Election Systems Inc.</span>
00032 <span class="comment">*       Original based on BSD chap.c.</span>
00033 <span class="comment">*****************************************************************************/</span>
00034 <span class="comment">/*</span>
00035 <span class="comment"> * chap.c - Challenge Handshake Authentication Protocol.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * Copyright (c) 1993 The Australian National University.</span>
00038 <span class="comment"> * All rights reserved.</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Redistribution and use in source and binary forms are permitted</span>
00041 <span class="comment"> * provided that the above copyright notice and this paragraph are</span>
00042 <span class="comment"> * duplicated in all such forms and that any documentation,</span>
00043 <span class="comment"> * advertising materials, and other materials related to such</span>
00044 <span class="comment"> * distribution and use acknowledge that the software was developed</span>
00045 <span class="comment"> * by the Australian National University.  The name of the University</span>
00046 <span class="comment"> * may not be used to endorse or promote products derived from this</span>
00047 <span class="comment"> * software without specific prior written permission.</span>
00048 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR</span>
00049 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
00050 <span class="comment"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00051 <span class="comment"> *</span>
00052 <span class="comment"> * Copyright (c) 1991 Gregory M. Christy.</span>
00053 <span class="comment"> * All rights reserved.</span>
00054 <span class="comment"> *</span>
00055 <span class="comment"> * Redistribution and use in source and binary forms are permitted</span>
00056 <span class="comment"> * provided that the above copyright notice and this paragraph are</span>
00057 <span class="comment"> * duplicated in all such forms and that any documentation,</span>
00058 <span class="comment"> * advertising materials, and other materials related to such</span>
00059 <span class="comment"> * distribution and use acknowledge that the software was developed</span>
00060 <span class="comment"> * by Gregory M. Christy.  The name of the author may not be used to</span>
00061 <span class="comment"> * endorse or promote products derived from this software without</span>
00062 <span class="comment"> * specific prior written permission.</span>
00063 <span class="comment"> *</span>
00064 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR</span>
00065 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
00066 <span class="comment"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00067 <span class="comment"> */</span>
00068 
00069 <span class="preprocessor">#include "<a class="code" href="ppp_8h.html">ppp.h</a>"</span>
00070 <span class="preprocessor">#if PPP_SUPPORT &gt; 0</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="magic_8h.html">magic.h</a>"</span>
00072 
00073 <span class="preprocessor">#if CHAP_SUPPORT &gt; 0</span>
00074 <span class="preprocessor"></span>
00075 <span class="preprocessor">#include "<a class="code" href="randm_8h.html">randm.h</a>"</span>
00076 <span class="preprocessor">#include "<a class="code" href="auth_8h.html">auth.h</a>"</span>
00077 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">md5.h</a>"</span>
00078 <span class="preprocessor">#include "<a class="code" href="chap_8h.html">chap.h</a>"</span>
00079 <span class="preprocessor">#include "<a class="code" href="chpms_8h.html">chpms.h</a>"</span>
00080 <span class="preprocessor">#include "<a class="code" href="pppdebug_8h.html">pppdebug.h</a>"</span>
00081 
00082 
00083 <span class="comment">/*************************/</span>
00084 <span class="comment">/*** LOCAL DEFINITIONS ***/</span>
00085 <span class="comment">/*************************/</span>
00086 
00087 
00088 <span class="comment">/************************/</span>
00089 <span class="comment">/*** LOCAL DATA TYPES ***/</span>
00090 <span class="comment">/************************/</span>
00091 
00092 
00093 <span class="comment">/***********************************/</span>
00094 <span class="comment">/*** LOCAL FUNCTION DECLARATIONS ***/</span>
00095 <span class="comment">/***********************************/</span>
00096 <span class="comment">/*</span>
00097 <span class="comment"> * Protocol entry points.</span>
00098 <span class="comment"> */</span>
00099 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapInit (<span class="keywordtype">int</span>);
00100 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapLowerUp (<span class="keywordtype">int</span>);
00101 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapLowerDown (<span class="keywordtype">int</span>);
00102 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapInput (<span class="keywordtype">int</span>, u_char *, <span class="keywordtype">int</span>);
00103 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapProtocolReject (<span class="keywordtype">int</span>);
00104 <span class="keyword">static</span> <span class="keywordtype">int</span>  ChapPrintPkt (u_char *, <span class="keywordtype">int</span>,
00105                               <span class="keywordtype">void</span> (*) (<span class="keywordtype">void</span> *, <span class="keywordtype">char</span> *, ...), <span class="keywordtype">void</span> *);
00106 
00107 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapChallengeTimeout (<span class="keywordtype">void</span> *);
00108 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapResponseTimeout (<span class="keywordtype">void</span> *);
00109 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveChallenge (<a class="code" href="structchap__state.html">chap_state</a> *, u_char *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00110 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapRechallenge (<span class="keywordtype">void</span> *);
00111 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveResponse (<a class="code" href="structchap__state.html">chap_state</a> *, u_char *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00112 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveSuccess(<a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a>, u_char *inp, u_char id, <span class="keywordtype">int</span> len);
00113 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveFailure(<a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a>, u_char *inp, u_char id, <span class="keywordtype">int</span> len);
00114 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendStatus (<a class="code" href="structchap__state.html">chap_state</a> *, <span class="keywordtype">int</span>);
00115 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendChallenge (<a class="code" href="structchap__state.html">chap_state</a> *);
00116 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendResponse (<a class="code" href="structchap__state.html">chap_state</a> *);
00117 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapGenChallenge (<a class="code" href="structchap__state.html">chap_state</a> *);
00118 
00119 
00120 <span class="comment">/******************************/</span>
00121 <span class="comment">/*** PUBLIC DATA STRUCTURES ***/</span>
00122 <span class="comment">/******************************/</span>
00123 <a class="code" href="structchap__state.html">chap_state</a> <a class="code" href="chap_8h.html#a26">chap</a>[NUM_PPP];               <span class="comment">/* CHAP state; one for each unit */</span>
00124 
00125 <span class="keyword">struct </span>protent <a class="code" href="chap_8h.html#a27">chap_protent</a> = {
00126     PPP_CHAP,
00127     ChapInit,
00128     ChapInput,
00129     ChapProtocolReject,
00130     ChapLowerUp,
00131     ChapLowerDown,
00132     <a class="code" href="def_8h.html#a2">NULL</a>,
00133     <a class="code" href="def_8h.html#a2">NULL</a>,
00134 <span class="preprocessor">#if 0</span>
00135 <span class="preprocessor"></span>    ChapPrintPkt,
00136     <a class="code" href="def_8h.html#a2">NULL</a>,
00137 <span class="preprocessor">#endif</span>
00138 <span class="preprocessor"></span>    1,
00139     <span class="stringliteral">"CHAP"</span>,
00140 <span class="preprocessor">#if 0</span>
00141 <span class="preprocessor"></span>    <a class="code" href="def_8h.html#a2">NULL</a>,
00142     <a class="code" href="def_8h.html#a2">NULL</a>,
00143     <a class="code" href="def_8h.html#a2">NULL</a>
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>};
00146 
00147 
00148 
00149 <span class="comment">/*****************************/</span>
00150 <span class="comment">/*** LOCAL DATA STRUCTURES ***/</span>
00151 <span class="comment">/*****************************/</span>
00152 <span class="keyword">static</span> <span class="keywordtype">char</span> *ChapCodenames[] = {
00153         <span class="stringliteral">"Challenge"</span>, <span class="stringliteral">"Response"</span>, <span class="stringliteral">"Success"</span>, <span class="stringliteral">"Failure"</span>
00154 };
00155 
00156 
00157 
00158 <span class="comment">/***********************************/</span>
00159 <span class="comment">/*** PUBLIC FUNCTION DEFINITIONS ***/</span>
00160 <span class="comment">/***********************************/</span>
00161 <span class="comment">/*</span>
00162 <span class="comment"> * ChapAuthWithPeer - Authenticate us with our peer (start client).</span>
00163 <span class="comment"> *</span>
00164 <span class="comment"> */</span>
00165 <span class="keywordtype">void</span> <a class="code" href="chap_8h.html#a28">ChapAuthWithPeer</a>(<span class="keywordtype">int</span> unit, <span class="keywordtype">char</span> *our_name, <span class="keywordtype">int</span> digest)
00166 {
00167         <a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a> = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00168         
00169         cstate-&gt;<a class="code" href="structchap__state.html#o18">resp_name</a> = our_name;
00170         cstate-&gt;<a class="code" href="structchap__state.html#o17">resp_type</a> = digest;
00171         
00172         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a12">CHAPCS_INITIAL</a> ||
00173                         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a14">CHAPCS_PENDING</a>) {
00174                 <span class="comment">/* lower layer isn't up - wait until later */</span>
00175                 cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a14">CHAPCS_PENDING</a>;
00176                 <span class="keywordflow">return</span>;
00177         }
00178         
00179         <span class="comment">/*</span>
00180 <span class="comment">         * We get here as a result of LCP coming up.</span>
00181 <span class="comment">         * So even if CHAP was open before, we will </span>
00182 <span class="comment">         * have to re-authenticate ourselves.</span>
00183 <span class="comment">         */</span>
00184         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a15">CHAPCS_LISTEN</a>;
00185 }
00186 
00187 
00188 <span class="comment">/*</span>
00189 <span class="comment"> * ChapAuthPeer - Authenticate our peer (start server).</span>
00190 <span class="comment"> */</span>
00191 <span class="keywordtype">void</span> <a class="code" href="chap_8h.html#a29">ChapAuthPeer</a>(<span class="keywordtype">int</span> unit, <span class="keywordtype">char</span> *our_name, <span class="keywordtype">int</span> digest)
00192 {
00193         <a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a> = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00194         
00195         cstate-&gt;<a class="code" href="structchap__state.html#o8">chal_name</a> = our_name;
00196         cstate-&gt;<a class="code" href="structchap__state.html#o6">chal_type</a> = digest;
00197         
00198         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a18">CHAPSS_INITIAL</a> ||
00199                         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a20">CHAPSS_PENDING</a>) {
00200                 <span class="comment">/* lower layer isn't up - wait until later */</span>
00201                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a20">CHAPSS_PENDING</a>;
00202                 <span class="keywordflow">return</span>;
00203         }
00204         
00205         ChapGenChallenge(cstate);
00206         ChapSendChallenge(cstate);              <span class="comment">/* crank it up dude! */</span>
00207         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a21">CHAPSS_INITIAL_CHAL</a>;
00208 }
00209 
00210 
00211 
00212 
00213 <span class="comment">/**********************************/</span>
00214 <span class="comment">/*** LOCAL FUNCTION DEFINITIONS ***/</span>
00215 <span class="comment">/**********************************/</span>
00216 <span class="comment">/*</span>
00217 <span class="comment"> * ChapInit - Initialize a CHAP unit.</span>
00218 <span class="comment"> */</span>
00219 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapInit(<span class="keywordtype">int</span> unit)
00220 {
00221         <a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a> = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00222         
00223         BZERO(cstate, <span class="keyword">sizeof</span>(*cstate));
00224         cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a> = unit;
00225         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a12">CHAPCS_INITIAL</a>;
00226         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a18">CHAPSS_INITIAL</a>;
00227         cstate-&gt;<a class="code" href="structchap__state.html#o10">timeouttime</a> = CHAP_DEFTIMEOUT;
00228         cstate-&gt;<a class="code" href="structchap__state.html#o11">max_transmits</a> = CHAP_DEFTRANSMITS;
00229         <span class="comment">/* random number generator is initialized in magic_init */</span>
00230 }
00231 
00232 
00233 <span class="comment">/*</span>
00234 <span class="comment"> * ChapChallengeTimeout - Timeout expired on sending challenge.</span>
00235 <span class="comment"> */</span>
00236 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapChallengeTimeout(<span class="keywordtype">void</span> *arg)
00237 {
00238         <a class="code" href="structchap__state.html">chap_state</a> *cstate = (<a class="code" href="structchap__state.html">chap_state</a> *) arg;
00239         
00240         <span class="comment">/* if we aren't sending challenges, don't worry.  then again we */</span>
00241         <span class="comment">/* probably shouldn't be here either */</span>
00242         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> != <a class="code" href="chap_8h.html#a21">CHAPSS_INITIAL_CHAL</a> &amp;&amp;
00243                         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> != <a class="code" href="chap_8h.html#a23">CHAPSS_RECHALLENGE</a>)
00244                 <span class="keywordflow">return</span>;
00245         
00246         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o12">chal_transmits</a> &gt;= cstate-&gt;<a class="code" href="structchap__state.html#o11">max_transmits</a>) {
00247                 <span class="comment">/* give up on peer */</span>
00248                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"Peer failed to respond to CHAP challenge\n"</span>);
00249                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a24">CHAPSS_BADAUTH</a>;
00250                 <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, PPP_CHAP);
00251                 <span class="keywordflow">return</span>;
00252         }
00253         
00254         ChapSendChallenge(cstate);              <span class="comment">/* Re-send challenge */</span>
00255 }
00256 
00257 
00258 <span class="comment">/*</span>
00259 <span class="comment"> * ChapResponseTimeout - Timeout expired on sending response.</span>
00260 <span class="comment"> */</span>
00261 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapResponseTimeout(<span class="keywordtype">void</span> *arg)
00262 {
00263         <a class="code" href="structchap__state.html">chap_state</a> *cstate = (<a class="code" href="structchap__state.html">chap_state</a> *) arg;
00264         
00265         <span class="comment">/* if we aren't sending a response, don't worry. */</span>
00266         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> != <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>)
00267                 <span class="keywordflow">return</span>;
00268         
00269         ChapSendResponse(cstate);               <span class="comment">/* re-send response */</span>
00270 }
00271 
00272 
00273 <span class="comment">/*</span>
00274 <span class="comment"> * ChapRechallenge - Time to challenge the peer again.</span>
00275 <span class="comment"> */</span>
00276 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapRechallenge(<span class="keywordtype">void</span> *arg)
00277 {
00278         <a class="code" href="structchap__state.html">chap_state</a> *cstate = (<a class="code" href="structchap__state.html">chap_state</a> *) arg;
00279         
00280         <span class="comment">/* if we aren't sending a response, don't worry. */</span>
00281         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> != <a class="code" href="chap_8h.html#a22">CHAPSS_OPEN</a>)
00282                 <span class="keywordflow">return</span>;
00283         
00284         ChapGenChallenge(cstate);
00285         ChapSendChallenge(cstate);
00286         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a23">CHAPSS_RECHALLENGE</a>;
00287 }
00288 
00289 
00290 <span class="comment">/*</span>
00291 <span class="comment"> * ChapLowerUp - The lower layer is up.</span>
00292 <span class="comment"> *</span>
00293 <span class="comment"> * Start up if we have pending requests.</span>
00294 <span class="comment"> */</span>
00295 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapLowerUp(<span class="keywordtype">int</span> unit)
00296 {
00297         <a class="code" href="structchap__state.html">chap_state</a> *cstate = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00298         
00299         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a12">CHAPCS_INITIAL</a>)
00300                 cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a13">CHAPCS_CLOSED</a>;
00301         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a14">CHAPCS_PENDING</a>)
00302                 cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a15">CHAPCS_LISTEN</a>;
00303         
00304         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a18">CHAPSS_INITIAL</a>)
00305                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a19">CHAPSS_CLOSED</a>;
00306         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a20">CHAPSS_PENDING</a>) {
00307                 ChapGenChallenge(cstate);
00308                 ChapSendChallenge(cstate);
00309                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a21">CHAPSS_INITIAL_CHAL</a>;
00310         }
00311 }
00312 
00313 
00314 <span class="comment">/*</span>
00315 <span class="comment"> * ChapLowerDown - The lower layer is down.</span>
00316 <span class="comment"> *</span>
00317 <span class="comment"> * Cancel all timeouts.</span>
00318 <span class="comment"> */</span>
00319 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapLowerDown(<span class="keywordtype">int</span> unit)
00320 {
00321         <a class="code" href="structchap__state.html">chap_state</a> *cstate = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00322         
00323         <span class="comment">/* Timeout(s) pending?  Cancel if so. */</span>
00324         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a21">CHAPSS_INITIAL_CHAL</a> ||
00325                         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a23">CHAPSS_RECHALLENGE</a>)
00326                 UNTIMEOUT(ChapChallengeTimeout, cstate);
00327         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a22">CHAPSS_OPEN</a>
00328                         &amp;&amp; cstate-&gt;<a class="code" href="structchap__state.html#o9">chal_interval</a> != 0)
00329                 UNTIMEOUT(ChapRechallenge, cstate);
00330         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>)
00331                 UNTIMEOUT(ChapResponseTimeout, cstate);
00332         
00333         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a12">CHAPCS_INITIAL</a>;
00334         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a18">CHAPSS_INITIAL</a>;
00335 }
00336 
00337 
00338 <span class="comment">/*</span>
00339 <span class="comment"> * ChapProtocolReject - Peer doesn't grok CHAP.</span>
00340 <span class="comment"> */</span>
00341 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapProtocolReject(<span class="keywordtype">int</span> unit)
00342 {
00343         <a class="code" href="structchap__state.html">chap_state</a> *cstate = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00344         
00345         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> != <a class="code" href="chap_8h.html#a18">CHAPSS_INITIAL</a> &amp;&amp;
00346                         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> != <a class="code" href="chap_8h.html#a19">CHAPSS_CLOSED</a>)
00347                 <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(unit, PPP_CHAP);
00348         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> != <a class="code" href="chap_8h.html#a12">CHAPCS_INITIAL</a> &amp;&amp;
00349                         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> != <a class="code" href="chap_8h.html#a13">CHAPCS_CLOSED</a>)
00350                 <a class="code" href="auth_8h.html#a9">auth_withpeer_fail</a>(unit, PPP_CHAP);
00351         ChapLowerDown(unit);            <span class="comment">/* shutdown chap */</span>
00352 }
00353 
00354 
00355 <span class="comment">/*</span>
00356 <span class="comment"> * ChapInput - Input CHAP packet.</span>
00357 <span class="comment"> */</span>
00358 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapInput(<span class="keywordtype">int</span> unit, u_char *inpacket, <span class="keywordtype">int</span> packet_len)
00359 {
00360         <a class="code" href="structchap__state.html">chap_state</a> *cstate = &amp;<a class="code" href="chap_8h.html#a26">chap</a>[unit];
00361         u_char *inp;
00362         u_char code, id;
00363         <span class="keywordtype">int</span> len;
00364         
00365         <span class="comment">/*</span>
00366 <span class="comment">         * Parse header (code, id and length).</span>
00367 <span class="comment">         * If packet too short, drop it.</span>
00368 <span class="comment">         */</span>
00369         inp = inpacket;
00370         <span class="keywordflow">if</span> (packet_len &lt; <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>) {
00371                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapInput: rcvd short header.\n"</span>));
00372                 <span class="keywordflow">return</span>;
00373         }
00374         GETCHAR(code, inp);
00375         GETCHAR(id, inp);
00376         GETSHORT(len, inp);
00377         <span class="keywordflow">if</span> (len &lt; <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>) {
00378                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapInput: rcvd illegal length.\n"</span>));
00379                 <span class="keywordflow">return</span>;
00380         }
00381         <span class="keywordflow">if</span> (len &gt; packet_len) {
00382                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapInput: rcvd short packet.\n"</span>));
00383                 <span class="keywordflow">return</span>;
00384         }
00385         len -= <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>;
00386         
00387         <span class="comment">/*</span>
00388 <span class="comment">         * Action depends on code (as in fact it usually does :-).</span>
00389 <span class="comment">         */</span>
00390         <span class="keywordflow">switch</span> (code) {
00391         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a5">CHAP_CHALLENGE</a>:
00392                 ChapReceiveChallenge(cstate, inp, id, len);
00393                 <span class="keywordflow">break</span>;
00394         
00395         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a6">CHAP_RESPONSE</a>:
00396                 ChapReceiveResponse(cstate, inp, id, len);
00397                 <span class="keywordflow">break</span>;
00398         
00399         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a8">CHAP_FAILURE</a>:
00400                 ChapReceiveFailure(cstate, inp, id, len);
00401                 <span class="keywordflow">break</span>;
00402         
00403         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a7">CHAP_SUCCESS</a>:
00404                 ChapReceiveSuccess(cstate, inp, id, len);
00405                 <span class="keywordflow">break</span>;
00406         
00407         <span class="keywordflow">default</span>:                                <span class="comment">/* Need code reject? */</span>
00408                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_WARNING, <span class="stringliteral">"Unknown CHAP code (%d) received.\n"</span>, code);
00409                 <span class="keywordflow">break</span>;
00410         }
00411 }
00412 
00413 
00414 <span class="comment">/*</span>
00415 <span class="comment"> * ChapReceiveChallenge - Receive Challenge and send Response.</span>
00416 <span class="comment"> */</span>
00417 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveChallenge(<a class="code" href="structchap__state.html">chap_state</a> *cstate, u_char *inp, <span class="keywordtype">int</span> id, <span class="keywordtype">int</span> len)
00418 {
00419         <span class="keywordtype">int</span> rchallenge_len;
00420         u_char *rchallenge;
00421         <span class="keywordtype">int</span> secret_len;
00422         <span class="keywordtype">char</span> secret[MAXSECRETLEN];
00423         <span class="keywordtype">char</span> rhostname[256];
00424         <a class="code" href="structMD5__CTX.html">MD5_CTX</a> mdContext;
00425         u_char hash[<a class="code" href="chap_8h.html#a2">MD5_SIGNATURE_SIZE</a>];
00426         
00427         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: Rcvd id %d.\n"</span>, id));
00428         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a13">CHAPCS_CLOSED</a> ||
00429                 cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a14">CHAPCS_PENDING</a>) {
00430                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: in state %d\n"</span>,
00431                            cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a>));
00432                 <span class="keywordflow">return</span>;
00433         }
00434         
00435         <span class="keywordflow">if</span> (len &lt; 2) {
00436                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: rcvd short packet.\n"</span>));
00437                 <span class="keywordflow">return</span>;
00438         }
00439         
00440         GETCHAR(rchallenge_len, inp);
00441         len -= <span class="keyword">sizeof</span> (u_char) + rchallenge_len;        <span class="comment">/* now name field length */</span>
00442         <span class="keywordflow">if</span> (len &lt; 0) {
00443                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: rcvd short packet.\n"</span>));
00444                 <span class="keywordflow">return</span>;
00445         }
00446         rchallenge = inp;
00447         INCPTR(rchallenge_len, inp);
00448         
00449         <span class="keywordflow">if</span> (len &gt;= <span class="keyword">sizeof</span>(rhostname))
00450                 len = <span class="keyword">sizeof</span>(rhostname) - 1;
00451         BCOPY(inp, rhostname, len);
00452         rhostname[len] = <span class="charliteral">'\000'</span>;
00453         
00454         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: received name field '%s'\n"</span>,
00455                rhostname));
00456         
00457         <span class="comment">/* Microsoft doesn't send their name back in the PPP packet */</span>
00458         <span class="keywordflow">if</span> (ppp_settings.remote_name[0] != 0 &amp;&amp; (ppp_settings.explicit_remote || rhostname[0] == 0)) {
00459                 strncpy(rhostname, ppp_settings.remote_name, <span class="keyword">sizeof</span>(rhostname));
00460                 rhostname[<span class="keyword">sizeof</span>(rhostname) - 1] = 0;
00461                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveChallenge: using '%s' as remote name\n"</span>,
00462                            rhostname));
00463         }
00464         
00465         <span class="comment">/* get secret for authenticating ourselves with the specified host */</span>
00466         <span class="keywordflow">if</span> (!<a class="code" href="auth_8h.html#a14">get_secret</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, cstate-&gt;<a class="code" href="structchap__state.html#o18">resp_name</a>, rhostname,
00467                             secret, &amp;secret_len, 0)) {
00468                 secret_len = 0;         <span class="comment">/* assume null secret if can't find one */</span>
00469                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_WARNING, <span class="stringliteral">"No CHAP secret found for authenticating us to %s\n"</span>, rhostname);
00470         }
00471         
00472         <span class="comment">/* cancel response send timeout if necessary */</span>
00473         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>)
00474                 UNTIMEOUT(ChapResponseTimeout, cstate);
00475         
00476         cstate-&gt;<a class="code" href="structchap__state.html#o16">resp_id</a> = id;
00477         cstate-&gt;<a class="code" href="structchap__state.html#o13">resp_transmits</a> = 0;
00478         
00479         <span class="comment">/*  generate MD based on negotiated type */</span>
00480         <span class="keywordflow">switch</span> (cstate-&gt;<a class="code" href="structchap__state.html#o17">resp_type</a>) { 
00481         
00482         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a1">CHAP_DIGEST_MD5</a>:
00483                 <a class="code" href="md5_8h.html#a0">MD5Init</a>(&amp;mdContext);
00484                 <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, &amp;cstate-&gt;<a class="code" href="structchap__state.html#o16">resp_id</a>, 1);
00485                 <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, (u_char*)secret, secret_len);
00486                 <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, rchallenge, rchallenge_len);
00487                 <a class="code" href="md5_8h.html#a2">MD5Final</a>(hash, &amp;mdContext);
00488                 BCOPY(hash, cstate-&gt;<a class="code" href="structchap__state.html#o14">response</a>, MD5_SIGNATURE_SIZE);
00489                 cstate-&gt;<a class="code" href="structchap__state.html#o15">resp_length</a> = <a class="code" href="chap_8h.html#a2">MD5_SIGNATURE_SIZE</a>;
00490                 <span class="keywordflow">break</span>;
00491         
00492 <span class="preprocessor">#ifdef CHAPMS</span>
00493 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a3">CHAP_MICROSOFT</a>:
00494                 <a class="code" href="chpms_8h.html#a1">ChapMS</a>(cstate, rchallenge, rchallenge_len, secret, secret_len);
00495                 <span class="keywordflow">break</span>;
00496 <span class="preprocessor">#endif</span>
00497 <span class="preprocessor"></span>        
00498         <span class="keywordflow">default</span>:
00499                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"unknown digest type %d\n"</span>, cstate-&gt;<a class="code" href="structchap__state.html#o17">resp_type</a>));
00500                 <span class="keywordflow">return</span>;
00501         }
00502         
00503         BZERO(secret, <span class="keyword">sizeof</span>(secret));
00504         ChapSendResponse(cstate);
00505 }
00506 
00507 
00508 <span class="comment">/*</span>
00509 <span class="comment"> * ChapReceiveResponse - Receive and process response.</span>
00510 <span class="comment"> */</span>
00511 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveResponse(<a class="code" href="structchap__state.html">chap_state</a> *cstate, u_char *inp, <span class="keywordtype">int</span> id, <span class="keywordtype">int</span> len)
00512 {
00513         u_char *remmd, remmd_len;
00514         <span class="keywordtype">int</span> secret_len, old_state;
00515         <span class="keywordtype">int</span> code;
00516         <span class="keywordtype">char</span> rhostname[256];
00517         <a class="code" href="structMD5__CTX.html">MD5_CTX</a> mdContext;
00518         <span class="keywordtype">char</span> secret[MAXSECRETLEN];
00519         u_char hash[<a class="code" href="chap_8h.html#a2">MD5_SIGNATURE_SIZE</a>];
00520         
00521         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveResponse: Rcvd id %d.\n"</span>, id));
00522         
00523         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a19">CHAPSS_CLOSED</a> ||
00524                         cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a20">CHAPSS_PENDING</a>) {
00525                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveResponse: in state %d\n"</span>,
00526                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a>));
00527                 <span class="keywordflow">return</span>;
00528         }
00529         
00530         <span class="keywordflow">if</span> (id != cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>)
00531                 <span class="keywordflow">return</span>;                 <span class="comment">/* doesn't match ID of last challenge */</span>
00532         
00533         <span class="comment">/*</span>
00534 <span class="comment">        * If we have received a duplicate or bogus Response,</span>
00535 <span class="comment">        * we have to send the same answer (Success/Failure)</span>
00536 <span class="comment">        * as we did for the first Response we saw.</span>
00537 <span class="comment">        */</span>
00538         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a22">CHAPSS_OPEN</a>) {
00539                 ChapSendStatus(cstate, CHAP_SUCCESS);
00540                 <span class="keywordflow">return</span>;
00541         }
00542         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> == <a class="code" href="chap_8h.html#a24">CHAPSS_BADAUTH</a>) {
00543                 ChapSendStatus(cstate, CHAP_FAILURE);
00544                 <span class="keywordflow">return</span>;
00545         }
00546         
00547         <span class="keywordflow">if</span> (len &lt; 2) {
00548                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveResponse: rcvd short packet.\n"</span>));
00549                 <span class="keywordflow">return</span>;
00550         }
00551         GETCHAR(remmd_len, inp);                <span class="comment">/* get length of MD */</span>
00552         remmd = inp;                    <span class="comment">/* get pointer to MD */</span>
00553         INCPTR(remmd_len, inp);
00554         
00555         len -= <span class="keyword">sizeof</span> (u_char) + remmd_len;
00556         <span class="keywordflow">if</span> (len &lt; 0) {
00557                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveResponse: rcvd short packet.\n"</span>));
00558                 <span class="keywordflow">return</span>;
00559         }
00560         
00561         UNTIMEOUT(ChapChallengeTimeout, cstate);
00562         
00563         <span class="keywordflow">if</span> (len &gt;= <span class="keyword">sizeof</span>(rhostname))
00564                 len = <span class="keyword">sizeof</span>(rhostname) - 1;
00565         BCOPY(inp, rhostname, len);
00566         rhostname[len] = <span class="charliteral">'\000'</span>;
00567         
00568         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveResponse: received name field: %s\n"</span>,
00569                                 rhostname));
00570         
00571         <span class="comment">/*</span>
00572 <span class="comment">        * Get secret for authenticating them with us,</span>
00573 <span class="comment">        * do the hash ourselves, and compare the result.</span>
00574 <span class="comment">        */</span>
00575         code = <a class="code" href="chap_8h.html#a8">CHAP_FAILURE</a>;
00576         <span class="keywordflow">if</span> (!<a class="code" href="auth_8h.html#a14">get_secret</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, rhostname, cstate-&gt;<a class="code" href="structchap__state.html#o8">chal_name</a>,
00577         secret, &amp;secret_len, 1)) {
00578 <span class="comment">/*        CHAPDEBUG((LOG_WARNING, TL_CHAP, "No CHAP secret found for authenticating %s\n", rhostname)); */</span>
00579                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_WARNING, <span class="stringliteral">"No CHAP secret found for authenticating %s\n"</span>,
00580                 rhostname);
00581         } <span class="keywordflow">else</span> {
00582         
00583                 <span class="comment">/*  generate MD based on negotiated type */</span>
00584                 <span class="keywordflow">switch</span> (cstate-&gt;<a class="code" href="structchap__state.html#o6">chal_type</a>) { 
00585                 
00586                 <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a1">CHAP_DIGEST_MD5</a>:           <span class="comment">/* only MD5 is defined for now */</span>
00587                         <span class="keywordflow">if</span> (remmd_len != <a class="code" href="chap_8h.html#a2">MD5_SIGNATURE_SIZE</a>)
00588                                 <span class="keywordflow">break</span>;                  <span class="comment">/* it's not even the right length */</span>
00589                         <a class="code" href="md5_8h.html#a0">MD5Init</a>(&amp;mdContext);
00590                         <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, &amp;cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>, 1);
00591                         <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, (u_char*)secret, secret_len);
00592                         <a class="code" href="md5_8h.html#a1">MD5Update</a>(&amp;mdContext, cstate-&gt;<a class="code" href="structchap__state.html#o3">challenge</a>, cstate-&gt;<a class="code" href="structchap__state.html#o4">chal_len</a>);
00593                         <a class="code" href="md5_8h.html#a2">MD5Final</a>(hash, &amp;mdContext); 
00594                         
00595                         <span class="comment">/* compare local and remote MDs and send the appropriate status */</span>
00596                         <span class="keywordflow">if</span> (memcmp (hash, remmd, MD5_SIGNATURE_SIZE) == 0)
00597                                 code = <a class="code" href="chap_8h.html#a7">CHAP_SUCCESS</a>;    <span class="comment">/* they are the same! */</span>
00598                         <span class="keywordflow">break</span>;
00599                 
00600                 <span class="keywordflow">default</span>:
00601                         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"unknown digest type %d\n"</span>, cstate-&gt;<a class="code" href="structchap__state.html#o6">chal_type</a>));
00602                 }
00603         }
00604         
00605         BZERO(secret, <span class="keyword">sizeof</span>(secret));
00606         ChapSendStatus(cstate, code);
00607         
00608         <span class="keywordflow">if</span> (code == <a class="code" href="chap_8h.html#a7">CHAP_SUCCESS</a>) {
00609                 old_state = cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a>;
00610                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a22">CHAPSS_OPEN</a>;
00611                 <span class="keywordflow">if</span> (old_state == <a class="code" href="chap_8h.html#a21">CHAPSS_INITIAL_CHAL</a>) {
00612                         <a class="code" href="auth_8h.html#a8">auth_peer_success</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, PPP_CHAP, rhostname, len);
00613                 }
00614                 <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o9">chal_interval</a> != 0)
00615                         TIMEOUT(ChapRechallenge, cstate, cstate-&gt;<a class="code" href="structchap__state.html#o9">chal_interval</a>);
00616         } <span class="keywordflow">else</span> {
00617                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"CHAP peer authentication failed\n"</span>);
00618                 cstate-&gt;<a class="code" href="structchap__state.html#o2">serverstate</a> = <a class="code" href="chap_8h.html#a24">CHAPSS_BADAUTH</a>;
00619                 <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, PPP_CHAP);
00620         }
00621 }
00622 
00623 <span class="comment">/*</span>
00624 <span class="comment"> * ChapReceiveSuccess - Receive Success</span>
00625 <span class="comment"> */</span>
00626 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveSuccess(<a class="code" href="structchap__state.html">chap_state</a> *cstate, u_char *inp, u_char id, <span class="keywordtype">int</span> len)
00627 {
00628 
00629         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveSuccess: Rcvd id %d.\n"</span>, id));
00630         
00631         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> == <a class="code" href="chap_8h.html#a17">CHAPCS_OPEN</a>)
00632                 <span class="comment">/* presumably an answer to a duplicate response */</span>
00633                 <span class="keywordflow">return</span>;
00634         
00635         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> != <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>) {
00636                 <span class="comment">/* don't know what this is */</span>
00637                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveSuccess: in state %d\n"</span>,
00638                            cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a>));
00639                 <span class="keywordflow">return</span>;
00640         }
00641         
00642         UNTIMEOUT(ChapResponseTimeout, cstate);
00643         
00644         <span class="comment">/*</span>
00645 <span class="comment">         * Print message.</span>
00646 <span class="comment">         */</span>
00647         <span class="keywordflow">if</span> (len &gt; 0)
00648                 PRINTMSG(inp, len);
00649         
00650         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a17">CHAPCS_OPEN</a>;
00651         
00652         <a class="code" href="auth_8h.html#a10">auth_withpeer_success</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, PPP_CHAP);
00653 }
00654 
00655 
00656 <span class="comment">/*</span>
00657 <span class="comment"> * ChapReceiveFailure - Receive failure.</span>
00658 <span class="comment"> */</span>
00659 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapReceiveFailure(<a class="code" href="structchap__state.html">chap_state</a> *cstate, u_char *inp, u_char id, <span class="keywordtype">int</span> len)
00660 {
00661         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveFailure: Rcvd id %d.\n"</span>, id));
00662         
00663         <span class="keywordflow">if</span> (cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> != <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>) {
00664                 <span class="comment">/* don't know what this is */</span>
00665                 <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapReceiveFailure: in state %d\n"</span>,
00666                            cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a>));
00667                 <span class="keywordflow">return</span>;
00668         }
00669         
00670         UNTIMEOUT(ChapResponseTimeout, cstate);
00671         
00672         <span class="comment">/*</span>
00673 <span class="comment">         * Print message.</span>
00674 <span class="comment">         */</span>
00675         <span class="keywordflow">if</span> (len &gt; 0)
00676                 PRINTMSG(inp, len);
00677         
00678         <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"CHAP authentication failed\n"</span>);
00679         <a class="code" href="auth_8h.html#a9">auth_withpeer_fail</a>(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, PPP_CHAP);
00680 }
00681 
00682 
00683 <span class="comment">/*</span>
00684 <span class="comment"> * ChapSendChallenge - Send an Authenticate challenge.</span>
00685 <span class="comment"> */</span>
00686 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendChallenge(<a class="code" href="structchap__state.html">chap_state</a> *cstate)
00687 {
00688         u_char *outp;
00689         <span class="keywordtype">int</span> chal_len, name_len;
00690         <span class="keywordtype">int</span> outlen;
00691         
00692         chal_len = cstate-&gt;<a class="code" href="structchap__state.html#o4">chal_len</a>;
00693         name_len = strlen(cstate-&gt;<a class="code" href="structchap__state.html#o8">chal_name</a>);
00694         outlen = <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a> + <span class="keyword">sizeof</span> (u_char) + chal_len + name_len;
00695         outp = outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>];
00696         
00697         MAKEHEADER(outp, PPP_CHAP);             <span class="comment">/* paste in a CHAP header */</span>
00698         
00699         PUTCHAR(CHAP_CHALLENGE, outp);
00700         PUTCHAR(cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>, outp);
00701         PUTSHORT(outlen, outp);
00702         
00703         PUTCHAR(chal_len, outp);                <span class="comment">/* put length of challenge */</span>
00704         BCOPY(cstate-&gt;<a class="code" href="structchap__state.html#o3">challenge</a>, outp, chal_len);
00705         INCPTR(chal_len, outp);
00706         
00707         BCOPY(cstate-&gt;<a class="code" href="structchap__state.html#o8">chal_name</a>, outp, name_len);       <span class="comment">/* append hostname */</span>
00708         
00709         pppWrite(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>], outlen + PPP_HDRLEN);
00710         
00711         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapSendChallenge: Sent id %d.\n"</span>, cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>));
00712         
00713         TIMEOUT(ChapChallengeTimeout, cstate, cstate-&gt;<a class="code" href="structchap__state.html#o10">timeouttime</a>);
00714         ++cstate-&gt;<a class="code" href="structchap__state.html#o12">chal_transmits</a>;
00715 }
00716 
00717 
00718 <span class="comment">/*</span>
00719 <span class="comment"> * ChapSendStatus - Send a status response (ack or nak).</span>
00720 <span class="comment"> */</span>
00721 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendStatus(<a class="code" href="structchap__state.html">chap_state</a> *cstate, <span class="keywordtype">int</span> code)
00722 {
00723         u_char *outp;
00724         <span class="keywordtype">int</span> outlen, msglen;
00725         <span class="keywordtype">char</span> msg[256];
00726         
00727         <span class="keywordflow">if</span> (code == <a class="code" href="chap_8h.html#a7">CHAP_SUCCESS</a>)
00728                 strcpy(msg, <span class="stringliteral">"Welcome!"</span>);
00729         <span class="keywordflow">else</span>
00730                 strcpy(msg, <span class="stringliteral">"I don't like you.  Go 'way."</span>);
00731         msglen = strlen(msg);
00732         
00733         outlen = <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a> + msglen;
00734         outp = outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>];
00735         
00736         MAKEHEADER(outp, PPP_CHAP);             <span class="comment">/* paste in a header */</span>
00737         
00738         PUTCHAR(code, outp);
00739         PUTCHAR(cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>, outp);
00740         PUTSHORT(outlen, outp);
00741         BCOPY(msg, outp, msglen);
00742         pppWrite(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>], outlen + PPP_HDRLEN);
00743         
00744         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapSendStatus: Sent code %d, id %d.\n"</span>, code,
00745                cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a>));
00746 }
00747 
00748 <span class="comment">/*</span>
00749 <span class="comment"> * ChapGenChallenge is used to generate a pseudo-random challenge string of</span>
00750 <span class="comment"> * a pseudo-random length between min_len and max_len.  The challenge</span>
00751 <span class="comment"> * string and its length are stored in *cstate, and various other fields of</span>
00752 <span class="comment"> * *cstate are initialized.</span>
00753 <span class="comment"> */</span>
00754 
00755 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapGenChallenge(<a class="code" href="structchap__state.html">chap_state</a> *cstate)
00756 {
00757         <span class="keywordtype">int</span> chal_len;
00758         u_char *ptr = cstate-&gt;<a class="code" href="structchap__state.html#o3">challenge</a>;
00759         <span class="keywordtype">int</span> i;
00760         
00761         <span class="comment">/* pick a random challenge length between MIN_CHALLENGE_LENGTH and </span>
00762 <span class="comment">           MAX_CHALLENGE_LENGTH */</span>  
00763         chal_len = (<span class="keywordtype">unsigned</span>)
00764                                 ((((<a class="code" href="magic_8c.html#a1">magic</a>() &gt;&gt; 16) *
00765                                 (<a class="code" href="chap_8h.html#a10">MAX_CHALLENGE_LENGTH</a> - <a class="code" href="chap_8h.html#a9">MIN_CHALLENGE_LENGTH</a>)) &gt;&gt; 16)
00766                              + <a class="code" href="chap_8h.html#a9">MIN_CHALLENGE_LENGTH</a>);
00767         cstate-&gt;<a class="code" href="structchap__state.html#o4">chal_len</a> = chal_len;
00768         cstate-&gt;<a class="code" href="structchap__state.html#o5">chal_id</a> = ++cstate-&gt;<a class="code" href="structchap__state.html#o7">id</a>;
00769         cstate-&gt;<a class="code" href="structchap__state.html#o12">chal_transmits</a> = 0;
00770         
00771         <span class="comment">/* generate a random string */</span>
00772         <span class="keywordflow">for</span> (i = 0; i &lt; chal_len; i++ )
00773                 *ptr++ = (<span class="keywordtype">char</span>) (<a class="code" href="magic_8c.html#a1">magic</a>() &amp; 0xff);
00774 }
00775 
00776 <span class="comment">/*</span>
00777 <span class="comment"> * ChapSendResponse - send a response packet with values as specified</span>
00778 <span class="comment"> * in *cstate.</span>
00779 <span class="comment"> */</span>
00780 <span class="comment">/* ARGSUSED */</span>
00781 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapSendResponse(<a class="code" href="structchap__state.html">chap_state</a> *cstate)
00782 {
00783         u_char *outp;
00784         <span class="keywordtype">int</span> outlen, md_len, name_len;
00785         
00786         md_len = cstate-&gt;<a class="code" href="structchap__state.html#o15">resp_length</a>;
00787         name_len = strlen(cstate-&gt;<a class="code" href="structchap__state.html#o18">resp_name</a>);
00788         outlen = <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a> + <span class="keyword">sizeof</span> (u_char) + md_len + name_len;
00789         outp = outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>];
00790         
00791         MAKEHEADER(outp, PPP_CHAP);
00792         
00793         PUTCHAR(CHAP_RESPONSE, outp);   <span class="comment">/* we are a response */</span>
00794         PUTCHAR(cstate-&gt;<a class="code" href="structchap__state.html#o16">resp_id</a>, outp); <span class="comment">/* copy id from challenge packet */</span>
00795         PUTSHORT(outlen, outp);                 <span class="comment">/* packet length */</span>
00796         
00797         PUTCHAR(md_len, outp);                  <span class="comment">/* length of MD */</span>
00798         BCOPY(cstate-&gt;<a class="code" href="structchap__state.html#o14">response</a>, outp, md_len);          <span class="comment">/* copy MD to buffer */</span>
00799         INCPTR(md_len, outp);
00800         
00801         BCOPY(cstate-&gt;<a class="code" href="structchap__state.html#o18">resp_name</a>, outp, name_len);       <span class="comment">/* append our name */</span>
00802         
00803         <span class="comment">/* send the packet */</span>
00804         pppWrite(cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>, outpacket_buf[cstate-&gt;<a class="code" href="structchap__state.html#o0">unit</a>], outlen + PPP_HDRLEN);
00805         
00806         cstate-&gt;<a class="code" href="structchap__state.html#o1">clientstate</a> = <a class="code" href="chap_8h.html#a16">CHAPCS_RESPONSE</a>;
00807         TIMEOUT(ChapResponseTimeout, cstate, cstate-&gt;<a class="code" href="structchap__state.html#o10">timeouttime</a>);
00808         ++cstate-&gt;<a class="code" href="structchap__state.html#o13">resp_transmits</a>;
00809 }
00810 
00811 <span class="comment">/*</span>
00812 <span class="comment"> * ChapPrintPkt - print the contents of a CHAP packet.</span>
00813 <span class="comment"> */</span>
00814 <span class="keyword">static</span> <span class="keywordtype">int</span> ChapPrintPkt(
00815         u_char *p,
00816         <span class="keywordtype">int</span> plen,
00817         <span class="keywordtype">void</span> (*printer) (<span class="keywordtype">void</span> *, <span class="keywordtype">char</span> *, ...),
00818         <span class="keywordtype">void</span> *arg
00819 )
00820 {
00821         <span class="keywordtype">int</span> code, id, len;
00822         <span class="keywordtype">int</span> clen, nlen;
00823         u_char x;
00824         
00825         <span class="keywordflow">if</span> (plen &lt; <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>)
00826                 <span class="keywordflow">return</span> 0;
00827         GETCHAR(code, p);
00828         GETCHAR(id, p);
00829         GETSHORT(len, p);
00830         <span class="keywordflow">if</span> (len &lt; CHAP_HEADERLEN || len &gt; plen)
00831                 <span class="keywordflow">return</span> 0;
00832         
00833         <span class="keywordflow">if</span> (code &gt;= 1 &amp;&amp; code &lt;= <span class="keyword">sizeof</span>(ChapCodenames) / <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *))
00834                 printer(arg, <span class="stringliteral">" %s"</span>, ChapCodenames[code-1]);
00835         <span class="keywordflow">else</span>
00836                 printer(arg, <span class="stringliteral">" code=0x%x"</span>, code);
00837         printer(arg, <span class="stringliteral">" id=0x%x"</span>, id);
00838         len -= <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>;
00839         <span class="keywordflow">switch</span> (code) {
00840         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a5">CHAP_CHALLENGE</a>:
00841         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a6">CHAP_RESPONSE</a>:
00842                 <span class="keywordflow">if</span> (len &lt; 1)
00843                         <span class="keywordflow">break</span>;
00844                 clen = p[0];
00845                 <span class="keywordflow">if</span> (len &lt; clen + 1)
00846                         <span class="keywordflow">break</span>;
00847                 ++p;
00848                 nlen = len - clen - 1;
00849                 printer(arg, <span class="stringliteral">" &lt;"</span>);
00850                 <span class="keywordflow">for</span> (; clen &gt; 0; --clen) {
00851                         GETCHAR(x, p);
00852                         printer(arg, <span class="stringliteral">"%.2x"</span>, x);
00853                 }
00854                 printer(arg, <span class="stringliteral">"&gt;, name = %.*Z"</span>, nlen, p);
00855                 <span class="keywordflow">break</span>;
00856         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a8">CHAP_FAILURE</a>:
00857         <span class="keywordflow">case</span> <a class="code" href="chap_8h.html#a7">CHAP_SUCCESS</a>:
00858                 printer(arg, <span class="stringliteral">" %.*Z"</span>, len, p);
00859                 <span class="keywordflow">break</span>;
00860         <span class="keywordflow">default</span>:
00861                 <span class="keywordflow">for</span> (clen = len; clen &gt; 0; --clen) {
00862                         GETCHAR(x, p);
00863                         printer(arg, <span class="stringliteral">" %.2x"</span>, x);
00864                 }
00865         }
00866         
00867         <span class="keywordflow">return</span> len + <a class="code" href="chap_8h.html#a0">CHAP_HEADERLEN</a>;
00868 }
00869 
00870 <span class="preprocessor">#endif</span>
00871 <span class="preprocessor"></span>
00872 <span class="preprocessor">#endif </span><span class="comment">/* PPP_SUPPORT */</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
