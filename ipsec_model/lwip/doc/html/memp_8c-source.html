
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>memp.c</h1><a href="memp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved. </span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification, </span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission. </span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED </span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT </span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, </span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT </span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING </span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY </span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> * </span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00034 
00035 <span class="preprocessor">#include "<a class="code" href="memp_8h.html">lwip/memp.h</a>"</span>
00036 
00037 <span class="preprocessor">#include "<a class="code" href="pbuf_8h.html">lwip/pbuf.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="udp_8h.html">lwip/udp.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="tcp_8h.html">lwip/tcp.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="api_8h.html">lwip/api.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="api__msg_8h.html">lwip/api_msg.h</a>"</span>
00042 <span class="preprocessor">#include "<a class="code" href="tcpip_8h.html">lwip/tcpip.h</a>"</span>
00043 
00044 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">lwip/sys.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">lwip/stats.h</a>"</span>
00046 
<a name="l00047"></a><a class="code" href="structmemp.html">00047</a> <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> {
<a name="l00048"></a><a class="code" href="structmemp.html#o0">00048</a>   <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *<a class="code" href="structmemp.html#o0">next</a>;
00049 };
00050 
00051 
00052 <span class="preprocessor">#ifdef MEMP_DEBUG</span>
00053 <span class="preprocessor"></span>
00054 <span class="keywordtype">int</span> memptype_stats[] = {        
00055                                                         0, 
00056                                                         0, 
00057                                                         0, 
00058                                                         0, 
00059                                                         0, 
00060                                                         0, 
00061                                                         0, 
00062                                                         0, 
00063                                                         0, 
00064                                                         0, 
00065                                                         0  
00066                                                 };
00067 
00072 <span class="keywordtype">void</span> print_memptype_stats()
00073 {
00074     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">" memp memory type usage stats:\n"</span>) );
00075     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_PBUF           : %d\n"</span>, memptype_stats[0]) );
00076     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_UDP_PCB        : %d\n"</span>, memptype_stats[1]) );
00077     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_TCP_PCB        : %d\n"</span>, memptype_stats[2]) );
00078     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_TCP_PCB_LISTEN : %d\n"</span>, memptype_stats[3]) );
00079     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_TCP_SEG        : %d\n"</span>, memptype_stats[4]) );
00080     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_NETBUF         : %d\n"</span>, memptype_stats[5]) );
00081     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_NETCONN        : %d\n"</span>, memptype_stats[6]) );
00082     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_API_MSG        : %d\n"</span>, memptype_stats[7]) );
00083     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_TCPIP_MSG      : %d\n"</span>, memptype_stats[8]) );
00084     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_SYS_TIMEOUT    : %d\n"</span>, memptype_stats[9]) );
00085     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(MEMP_DEBUG | 2, (<span class="stringliteral">"   MEMP_MAX            : %d\n"</span>, memptype_stats[10]) );
00086 }
00087 
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 
<a name="l00091"></a><a class="code" href="memp_8c.html#a0">00091</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *<a class="code" href="memp_8c.html#a0">memp_tab</a>[<a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>];
00092 
<a name="l00093"></a><a class="code" href="memp_8c.html#a1">00093</a> <span class="keyword">static</span> <span class="keyword">const</span> u16_t <a class="code" href="memp_8c.html#a1">memp_sizes</a>[<a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>] = {
00094   <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a>),
00095   sizeof(struct udp_pcb),
00096   sizeof(struct tcp_pcb),
00097   sizeof(struct tcp_pcb_listen),
00098   sizeof(struct tcp_seg),
00099   sizeof(struct netbuf),
00100   sizeof(struct netconn),
00101   sizeof(struct api_msg),
00102   sizeof(struct tcpip_msg),
00103   sizeof(struct <a class="code" href="sys_8c.html#a2">sys_timeout</a>)
00104 };
00105 
<a name="l00106"></a><a class="code" href="memp_8c.html#a2">00106</a> <span class="keyword">static</span> <span class="keyword">const</span> u16_t <a class="code" href="memp_8c.html#a2">memp_num</a>[<a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>] = {
00107   <a class="code" href="opt_8h.html#a4">MEMP_NUM_PBUF</a>,
00108   <a class="code" href="opt_8h.html#a5">MEMP_NUM_UDP_PCB</a>,
00109   <a class="code" href="opt_8h.html#a6">MEMP_NUM_TCP_PCB</a>,
00110   <a class="code" href="opt_8h.html#a7">MEMP_NUM_TCP_PCB_LISTEN</a>,
00111   <a class="code" href="opt_8h.html#a8">MEMP_NUM_TCP_SEG</a>,
00112   <a class="code" href="opt_8h.html#a10">MEMP_NUM_NETBUF</a>,
00113   <a class="code" href="opt_8h.html#a11">MEMP_NUM_NETCONN</a>,
00114   <a class="code" href="opt_8h.html#a12">MEMP_NUM_API_MSG</a>,
00115   <a class="code" href="opt_8h.html#a13">MEMP_NUM_TCPIP_MSG</a>,
00116   <a class="code" href="opt_8h.html#a9">MEMP_NUM_SYS_TIMEOUT</a>
00117 };
00118 
00119 <span class="keyword">static</span> u8_t <a class="code" href="memp_8c.html#a3">memp_memory</a>[(<a class="code" href="opt_8h.html#a4">MEMP_NUM_PBUF</a> *
00120        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a>) +
00121           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00122       <a class="code" href="opt_8h.html#a5">MEMP_NUM_UDP_PCB</a> *
00123        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> udp_pcb) +
00124           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00125       <a class="code" href="opt_8h.html#a6">MEMP_NUM_TCP_PCB</a> *
00126        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> tcp_pcb) +
00127           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00128       <a class="code" href="opt_8h.html#a7">MEMP_NUM_TCP_PCB_LISTEN</a> *
00129        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> tcp_pcb_listen) +
00130           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00131       <a class="code" href="opt_8h.html#a8">MEMP_NUM_TCP_SEG</a> *
00132        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> tcp_seg) +
00133           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00134       <a class="code" href="opt_8h.html#a10">MEMP_NUM_NETBUF</a> *
00135        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> netbuf) +
00136           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00137       <a class="code" href="opt_8h.html#a11">MEMP_NUM_NETCONN</a> *
00138        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> netconn) +
00139           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00140       <a class="code" href="opt_8h.html#a12">MEMP_NUM_API_MSG</a> *
00141        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> api_msg) +
00142           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00143       <a class="code" href="opt_8h.html#a13">MEMP_NUM_TCPIP_MSG</a> *
00144        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> tcpip_msg) +
00145           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) +
00146       <a class="code" href="opt_8h.html#a9">MEMP_NUM_SYS_TIMEOUT</a> *
00147        <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sys_timeout) +
<a name="l00148"></a><a class="code" href="memp_8c.html#a3">00148</a>           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)))];
00149 
00150 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00151 <span class="preprocessor">#if !SYS_LIGHTWEIGHT_PROT</span>
<a name="l00152"></a><a class="code" href="memp_8c.html#a4">00152</a> <span class="preprocessor"></span><span class="keyword">static</span> sys_sem_t <a class="code" href="memp_8c.html#a4">mutex</a>;
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00155 <span class="preprocessor">#ifdef LWIP_DEBUG</span>
00156 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
00157 memp_sanity(<span class="keywordtype">void</span>)
00158 {
00159   <span class="keywordtype">int</span> i, c;
00160   <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *m, *n;
00161 
00162   <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>; i++) {
00163     <span class="keywordflow">for</span>(m = <a class="code" href="memp_8c.html#a0">memp_tab</a>[i]; m != <a class="code" href="def_8h.html#a2">NULL</a>; m = m-&gt;next) {
00164       c = 1;
00165       <span class="keywordflow">for</span>(n = <a class="code" href="memp_8c.html#a0">memp_tab</a>[i]; n != <a class="code" href="def_8h.html#a2">NULL</a>; n = n-&gt;next) {
00166          <span class="keywordflow">if</span> (n == m) {
00167           --c;
00168         }
00169         <span class="keywordflow">if</span> (c &lt; 0) <span class="keywordflow">return</span> 0; <span class="comment">/* LW was: abort(); */</span>
00170       }
00171     }
00172   }
00173   <span class="keywordflow">return</span> 1;
00174 }
00175 <span class="preprocessor">#endif </span><span class="comment">/* LWIP_DEBUG */</span>
00176 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00177 <span class="keywordtype">void</span>
<a name="l00178"></a><a class="code" href="memp_8c.html#a5">00178</a> <a class="code" href="memp_8c.html#a5">memp_init</a>(<span class="keywordtype">void</span>)
00179 {
00180   <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *m, *<a class="code" href="structmemp.html">memp</a>;
00181   u16_t i, j;
00182   u16_t size;
00183       
00184 <span class="preprocessor">#ifdef MEMP_STATS</span>
00185 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>; ++i) {
00186     lwip_stats.memp[i].used = lwip_stats.memp[i].max =
00187       lwip_stats.memp[i].err = 0;
00188     lwip_stats.memp[i].avail = <a class="code" href="memp_8c.html#a2">memp_num</a>[i];
00189   }
00190 <span class="preprocessor">#endif </span><span class="comment">/* MEMP_STATS */</span>
00191 
00192   memp = (<span class="keyword">struct </span>memp *)&amp;<a class="code" href="memp_8c.html#a3">memp_memory</a>[0];
00193   <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>; ++i) {
00194     size = <a class="code" href="mem_8h.html#a0">MEM_ALIGN_SIZE</a>(<a class="code" href="memp_8c.html#a1">memp_sizes</a>[i] + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> memp));
00195     <span class="keywordflow">if</span> (<a class="code" href="memp_8c.html#a2">memp_num</a>[i] &gt; 0) {
00196       <a class="code" href="memp_8c.html#a0">memp_tab</a>[i] = memp;
00197       m = memp;
00198       
00199       <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="memp_8c.html#a2">memp_num</a>[i]; ++j) {
00200   m-&gt;<a class="code" href="structmemp.html#o0">next</a> = (<span class="keyword">struct </span>memp *)<a class="code" href="mem_8h.html#a1">MEM_ALIGN</a>((u8_t *)m + size);
00201   memp = m;
00202   m = m-&gt;<a class="code" href="structmemp.html#o0">next</a>;
00203       }
00204       memp-&gt;<a class="code" href="structmemp.html#o0">next</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00205       memp = m;
00206     } <span class="keywordflow">else</span> {
00207       <a class="code" href="memp_8c.html#a0">memp_tab</a>[i] = <a class="code" href="def_8h.html#a2">NULL</a>;
00208     }
00209   }
00210 
00211 <span class="preprocessor">#if !SYS_LIGHTWEIGHT_PROT</span>
00212 <span class="preprocessor"></span>  <a class="code" href="memp_8c.html#a4">mutex</a> = <a class="code" href="sys_8h.html#a9">sys_sem_new</a>(1);
00213 <span class="preprocessor">#endif</span>
00214 <span class="preprocessor"></span>
00215   
00216 }
00217 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00218 <span class="keywordtype">void</span> *
<a name="l00219"></a><a class="code" href="memp_8c.html#a6">00219</a> <a class="code" href="memp_8c.html#a6">memp_malloc</a>(memp_t type)
00220 {
00221   <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *<a class="code" href="structmemp.html">memp</a>;
00222   <span class="keywordtype">void</span> *<a class="code" href="structmem.html">mem</a>;
00223  
00224   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"memp_malloc: type &lt; MEMP_MAX"</span>, type &lt; <a class="code" href="memp_8h.html#a17a10">MEMP_MAX</a>);
00225 
00226 <span class="preprocessor">#ifdef MEMP_DEBUG</span>
00227 <span class="preprocessor"></span>        memptype_stats[type]++;
00228         print_memptype_stats();
00229 <span class="preprocessor">#endif</span>
00230 <span class="preprocessor"></span>
00231   <a class="code" href="structmemp.html">memp</a> = <a class="code" href="memp_8c.html#a0">memp_tab</a>[type];
00232   
00233   <span class="keywordflow">if</span> (<a class="code" href="structmemp.html">memp</a> != <a class="code" href="def_8h.html#a2">NULL</a>) {    
00234     <a class="code" href="memp_8c.html#a0">memp_tab</a>[type] = <a class="code" href="structmemp.html">memp</a>-&gt;<a class="code" href="structmemp.html#o0">next</a>;    
00235     <a class="code" href="structmemp.html">memp</a>-&gt;<a class="code" href="structmemp.html#o0">next</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00236 <span class="preprocessor">#ifdef MEMP_STATS</span>
00237 <span class="preprocessor"></span>    ++lwip_stats.memp[type].used;
00238     <span class="keywordflow">if</span> (lwip_stats.memp[type].used &gt; lwip_stats.memp[type].max) {
00239       lwip_stats.memp[type].max = lwip_stats.memp[type].used;
00240     }
00241 <span class="preprocessor">#endif </span><span class="comment">/* MEMP_STATS */</span>
00242     <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"memp_malloc: memp properly aligned"</span>,
00243      ((u32_t)<a class="code" href="mem_8h.html#a1">MEM_ALIGN</a>((u8_t *)<a class="code" href="structmemp.html">memp</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>)) % <a class="code" href="opt_8h.html#a2">MEM_ALIGNMENT</a>) == 0);
00244 
00245     mem = <a class="code" href="mem_8h.html#a1">MEM_ALIGN</a>((u8_t *)<a class="code" href="structmemp.html">memp</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmemp.html">memp</a>));
00246     <span class="comment">/* initialize memp memory with zeroes */</span>
00247     memset(mem, 0, <a class="code" href="memp_8c.html#a1">memp_sizes</a>[type]);  
00248     <span class="keywordflow">return</span> mem;
00249   } <span class="keywordflow">else</span> {
00250     <a class="code" href="debug_8h.html#a12">LWIP_DEBUGF</a>(<a class="code" href="opt_8h.html#a71">MEMP_DEBUG</a> | 2, (<span class="stringliteral">"memp_malloc: out of memory in pool %d\n"</span>, type));
00251 <span class="preprocessor">#ifdef MEMP_STATS</span>
00252 <span class="preprocessor"></span>    ++lwip_stats.memp[type].err;
00253 <span class="preprocessor">#endif </span><span class="comment">/* MEMP_STATS */</span>
00254     <span class="keywordflow">return</span> <a class="code" href="def_8h.html#a2">NULL</a>;
00255   }
00256 }
00257 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00258 <span class="keywordtype">void</span> *
<a name="l00259"></a><a class="code" href="memp_8c.html#a7">00259</a> <a class="code" href="memp_8c.html#a7">memp_mallocp</a>(memp_t type)
00260 {
00261   <span class="keywordtype">void</span> *<a class="code" href="structmem.html">mem</a>;
00262 <span class="preprocessor">#if SYS_LIGHTWEIGHT_PROT</span>
00263 <span class="preprocessor"></span>  <a class="code" href="sys_8h.html#a1">SYS_ARCH_DECL_PROTECT</a>(old_level);
00264   <a class="code" href="sys_8h.html#a2">SYS_ARCH_PROTECT</a>(old_level);
00265 <span class="preprocessor">#else </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00266   <a class="code" href="sys_8c.html#a1">sys_sem_wait</a>(<a class="code" href="memp_8c.html#a4">mutex</a>);
00267 <span class="preprocessor">#endif </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00268 
00269   mem = <a class="code" href="memp_8c.html#a6">memp_malloc</a>(type);
00270 
00271 <span class="preprocessor">#if SYS_LIGHTWEIGHT_PROT</span>
00272 <span class="preprocessor"></span>  <a class="code" href="sys_8h.html#a3">SYS_ARCH_UNPROTECT</a>(old_level);
00273 <span class="preprocessor">#else </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>
00274   <a class="code" href="sys_8h.html#a10">sys_sem_signal</a>(<a class="code" href="memp_8c.html#a4">mutex</a>);
00275 <span class="preprocessor">#endif </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00276   <span class="keywordflow">return</span> mem;
00277 }
00278 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00279 <span class="keywordtype">void</span>
<a name="l00280"></a><a class="code" href="memp_8c.html#a8">00280</a> <a class="code" href="memp_8c.html#a8">memp_free</a>(memp_t type, <span class="keywordtype">void</span> *<a class="code" href="structmem.html">mem</a>)
00281 {
00282   <span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *<a class="code" href="structmemp.html">memp</a>;
00283 
00284 <span class="preprocessor">#ifdef MEMP_DEBUG</span>
00285 <span class="preprocessor"></span>        memptype_stats[type]--;
00286         print_memptype_stats();
00287 <span class="preprocessor">#endif</span>
00288 <span class="preprocessor"></span>
00289   <span class="keywordflow">if</span> (mem == <a class="code" href="def_8h.html#a2">NULL</a>) {
00290     <span class="keywordflow">return</span>;
00291   }
00292   <a class="code" href="structmemp.html">memp</a> = (<span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a> *)((u8_t *)mem - <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structmemp.html">memp</a>));
00293 
00294 <span class="preprocessor">#ifdef MEMP_STATS</span>
00295 <span class="preprocessor"></span>  lwip_stats.memp[type].used--; 
00296 <span class="preprocessor">#endif </span><span class="comment">/* MEMP_STATS */</span>
00297   
00298   <a class="code" href="structmemp.html">memp</a>-&gt;next = <a class="code" href="memp_8c.html#a0">memp_tab</a>[type]; 
00299   <a class="code" href="memp_8c.html#a0">memp_tab</a>[type] = <a class="code" href="structmemp.html">memp</a>;
00300 
00301   <a class="code" href="debug_8h.html#a11">LWIP_ASSERT</a>(<span class="stringliteral">"memp sanity"</span>, memp_sanity());
00302 
00303   <span class="keywordflow">return</span>;
00304 }
00305 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00306 <span class="keywordtype">void</span> 
<a name="l00307"></a><a class="code" href="memp_8c.html#a9">00307</a> <a class="code" href="memp_8c.html#a9">memp_freep</a>(memp_t type, <span class="keywordtype">void</span> *<a class="code" href="structmem.html">mem</a>)
00308 {
00309 <span class="preprocessor">#if SYS_LIGHTWEIGHT_PROT</span>
00310 <span class="preprocessor"></span>    <a class="code" href="sys_8h.html#a1">SYS_ARCH_DECL_PROTECT</a>(old_level);
00311     <a class="code" href="sys_8h.html#a2">SYS_ARCH_PROTECT</a>(old_level);
00312 <span class="preprocessor">#else </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00313   <a class="code" href="sys_8c.html#a1">sys_sem_wait</a>(<a class="code" href="memp_8c.html#a4">mutex</a>);
00314 <span class="preprocessor">#endif </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00315 
00316   <a class="code" href="memp_8c.html#a8">memp_free</a>(type, mem);
00317 
00318 <span class="preprocessor">#if SYS_LIGHTWEIGHT_PROT</span>
00319 <span class="preprocessor"></span>  <a class="code" href="sys_8h.html#a3">SYS_ARCH_UNPROTECT</a>(old_level);
00320 <span class="preprocessor">#else </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>
00321   <a class="code" href="sys_8h.html#a10">sys_sem_signal</a>(<a class="code" href="memp_8c.html#a4">mutex</a>);
00322 <span class="preprocessor">#endif </span><span class="comment">/* SYS_LIGHTWEIGHT_PROT */</span>  
00323 
00324 }
00325 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
