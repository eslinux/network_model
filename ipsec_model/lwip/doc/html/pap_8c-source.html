
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>pap.c</h1><a href="pap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*****************************************************************************</span>
00002 <span class="comment">* pap.c - Network Password Authentication Protocol program file.</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 2003 by Marc Boucher, Services Informatiques (MBSI) inc.</span>
00005 <span class="comment">* portions Copyright (c) 1997 by Global Election Systems Inc.</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* The authors hereby grant permission to use, copy, modify, distribute,</span>
00008 <span class="comment">* and license this software and its documentation for any purpose, provided</span>
00009 <span class="comment">* that existing copyright notices are retained in all copies and that this</span>
00010 <span class="comment">* notice and the following disclaimer are included verbatim in any </span>
00011 <span class="comment">* distributions. No written agreement, license, or royalty fee is required</span>
00012 <span class="comment">* for any of the authorized uses.</span>
00013 <span class="comment">*</span>
00014 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS *AS IS* AND ANY EXPRESS OR</span>
00015 <span class="comment">* IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00016 <span class="comment">* OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00017 <span class="comment">* IN NO EVENT SHALL THE CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
00018 <span class="comment">* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
00019 <span class="comment">* NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
00020 <span class="comment">* DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
00021 <span class="comment">* THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
00022 <span class="comment">* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
00023 <span class="comment">* THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00024 <span class="comment">*</span>
00025 <span class="comment">******************************************************************************</span>
00026 <span class="comment">* REVISION HISTORY</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* 03-01-01 Marc Boucher &lt;marc@mbsi.ca&gt;</span>
00029 <span class="comment">*   Ported to lwIP.</span>
00030 <span class="comment">* 97-12-12 Guy Lancaster &lt;lancasterg@acm.org&gt;, Global Election Systems Inc.</span>
00031 <span class="comment">*       Original.</span>
00032 <span class="comment">*****************************************************************************/</span>
00033 <span class="comment">/*</span>
00034 <span class="comment"> * upap.c - User/Password Authentication Protocol.</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> * Copyright (c) 1989 Carnegie Mellon University.</span>
00037 <span class="comment"> * All rights reserved.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * Redistribution and use in source and binary forms are permitted</span>
00040 <span class="comment"> * provided that the above copyright notice and this paragraph are</span>
00041 <span class="comment"> * duplicated in all such forms and that any documentation,</span>
00042 <span class="comment"> * advertising materials, and other materials related to such</span>
00043 <span class="comment"> * distribution and use acknowledge that the software was developed</span>
00044 <span class="comment"> * by Carnegie Mellon University.  The name of the</span>
00045 <span class="comment"> * University may not be used to endorse or promote products derived</span>
00046 <span class="comment"> * from this software without specific prior written permission.</span>
00047 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR</span>
00048 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
00049 <span class="comment"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00050 <span class="comment"> */</span>
00051 
00052 <span class="preprocessor">#include "<a class="code" href="ppp_8h.html">ppp.h</a>"</span>
00053 <span class="preprocessor">#include "<a class="code" href="auth_8h.html">auth.h</a>"</span>
00054 <span class="preprocessor">#include "<a class="code" href="pap_8h.html">pap.h</a>"</span>
00055 <span class="preprocessor">#include "<a class="code" href="pppdebug_8h.html">pppdebug.h</a>"</span>
00056 
00057 
00058 <span class="preprocessor">#if PAP_SUPPORT &gt; 0</span>
00059 <span class="preprocessor"></span>
00060 <span class="comment">/***********************************/</span>
00061 <span class="comment">/*** LOCAL FUNCTION DECLARATIONS ***/</span>
00062 <span class="comment">/***********************************/</span>
00063 <span class="comment">/*</span>
00064 <span class="comment"> * Protocol entry points.</span>
00065 <span class="comment"> */</span>
00066 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_init (<span class="keywordtype">int</span>);
00067 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_lowerup (<span class="keywordtype">int</span>);
00068 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_lowerdown (<span class="keywordtype">int</span>);
00069 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_input (<span class="keywordtype">int</span>, u_char *, <span class="keywordtype">int</span>);
00070 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_protrej (<span class="keywordtype">int</span>);
00071 
00072 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_timeout (<span class="keywordtype">void</span> *);
00073 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_reqtimeout (<span class="keywordtype">void</span> *);
00074 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthreq (<a class="code" href="structupap__state.html">upap_state</a> *, u_char *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00075 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthack (<a class="code" href="structupap__state.html">upap_state</a> *, u_char *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00076 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthnak (<a class="code" href="structupap__state.html">upap_state</a> *, u_char *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00077 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_sauthreq (<a class="code" href="structupap__state.html">upap_state</a> *);
00078 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_sresp (<a class="code" href="structupap__state.html">upap_state</a> *, u_char, u_char, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00079 
00080 
00081 
00082 
00083 <span class="comment">/******************************/</span>
00084 <span class="comment">/*** PUBLIC DATA STRUCTURES ***/</span>
00085 <span class="comment">/******************************/</span>
00086 <span class="keyword">struct </span>protent <a class="code" href="pap_8h.html#a18">pap_protent</a> = {
00087     PPP_PAP,
00088     upap_init,
00089     upap_input,
00090     upap_protrej,
00091     upap_lowerup,
00092     upap_lowerdown,
00093     <a class="code" href="def_8h.html#a2">NULL</a>,
00094     <a class="code" href="def_8h.html#a2">NULL</a>,
00095 <span class="preprocessor">#if 0</span>
00096 <span class="preprocessor"></span>    upap_printpkt,
00097     <a class="code" href="def_8h.html#a2">NULL</a>,
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>    1,
00100     <span class="stringliteral">"PAP"</span>,
00101 <span class="preprocessor">#if 0</span>
00102 <span class="preprocessor"></span>    <a class="code" href="def_8h.html#a2">NULL</a>,
00103     <a class="code" href="def_8h.html#a2">NULL</a>,
00104     <a class="code" href="def_8h.html#a2">NULL</a>
00105 <span class="preprocessor">#endif</span>
00106 <span class="preprocessor"></span>};
00107 
00108 <a class="code" href="structupap__state.html">upap_state</a> <a class="code" href="pap_8h.html#a17">upap</a>[NUM_PPP];               <span class="comment">/* UPAP state; one for each unit */</span>
00109 
00110 
00111 
00112 <span class="comment">/***********************************/</span>
00113 <span class="comment">/*** PUBLIC FUNCTION DEFINITIONS ***/</span>
00114 <span class="comment">/***********************************/</span>
00115 <span class="comment">/*</span>
00116 <span class="comment"> *  Set the default login name and password for the pap sessions</span>
00117 <span class="comment"> */</span>
00118 <span class="keywordtype">void</span> <a class="code" href="pap_8h.html#a19">upap_setloginpasswd</a>(<span class="keywordtype">int</span> unit, <span class="keyword">const</span> <span class="keywordtype">char</span> *luser, <span class="keyword">const</span> <span class="keywordtype">char</span> *lpassword)
00119 {
00120         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00121         
00122         <span class="comment">/* Save the username and password we're given */</span>
00123         u-&gt;<a class="code" href="structupap__state.html#o1">us_user</a> = luser;
00124         u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a> = strlen(luser);
00125         u-&gt;<a class="code" href="structupap__state.html#o3">us_passwd</a> = lpassword;
00126         u-&gt;<a class="code" href="structupap__state.html#o4">us_passwdlen</a> = strlen(lpassword);
00127 }
00128 
00129 
00130 <span class="comment">/*</span>
00131 <span class="comment"> * upap_authwithpeer - Authenticate us with our peer (start client).</span>
00132 <span class="comment"> *</span>
00133 <span class="comment"> * Set new state and send authenticate's.</span>
00134 <span class="comment"> */</span>
00135 <span class="keywordtype">void</span> <a class="code" href="pap_8h.html#a20">upap_authwithpeer</a>(<span class="keywordtype">int</span> unit, <span class="keywordtype">char</span> *user, <span class="keywordtype">char</span> *password)
00136 {
00137         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00138         
00139         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"upap_authwithpeer: %d user=%s password=%s s=%d\n"</span>,
00140                                 unit, user, password, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00141         
00142         <a class="code" href="pap_8h.html#a19">upap_setloginpasswd</a>(unit, user, password);
00143 
00144         u-&gt;<a class="code" href="structupap__state.html#o9">us_transmits</a> = 0;
00145         
00146         <span class="comment">/* Lower layer up yet? */</span>
00147         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a4">UPAPCS_INITIAL</a> ||
00148                         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a6">UPAPCS_PENDING</a>) {
00149                 u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a6">UPAPCS_PENDING</a>;
00150                 <span class="keywordflow">return</span>;
00151         }
00152         
00153         upap_sauthreq(u);                       <span class="comment">/* Start protocol */</span>
00154 }
00155 
00156 
00157 <span class="comment">/*</span>
00158 <span class="comment"> * upap_authpeer - Authenticate our peer (start server).</span>
00159 <span class="comment"> *</span>
00160 <span class="comment"> * Set new state.</span>
00161 <span class="comment"> */</span>
00162 <span class="keywordtype">void</span> <a class="code" href="pap_8h.html#a21">upap_authpeer</a>(<span class="keywordtype">int</span> unit)
00163 {
00164         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00165         
00166         <span class="comment">/* Lower layer up yet? */</span>
00167         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a10">UPAPSS_INITIAL</a> ||
00168                         u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a12">UPAPSS_PENDING</a>) {
00169                 u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a12">UPAPSS_PENDING</a>;
00170                 <span class="keywordflow">return</span>;
00171         }
00172         
00173         u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a>;
00174         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a> &gt; 0)
00175                 TIMEOUT(upap_reqtimeout, u, u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a>);
00176 }
00177 
00178 
00179 
00180 <span class="comment">/**********************************/</span>
00181 <span class="comment">/*** LOCAL FUNCTION DEFINITIONS ***/</span>
00182 <span class="comment">/**********************************/</span>
00183 <span class="comment">/*</span>
00184 <span class="comment"> * upap_init - Initialize a UPAP unit.</span>
00185 <span class="comment"> */</span>
00186 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_init(<span class="keywordtype">int</span> unit)
00187 {
00188         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00189 
00190         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"upap_init: %d\n"</span>, unit)); 
00191         u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a> = unit;
00192         u-&gt;<a class="code" href="structupap__state.html#o1">us_user</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00193         u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a> = 0;
00194         u-&gt;<a class="code" href="structupap__state.html#o3">us_passwd</a> = <a class="code" href="def_8h.html#a2">NULL</a>;
00195         u-&gt;<a class="code" href="structupap__state.html#o4">us_passwdlen</a> = 0;
00196         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a4">UPAPCS_INITIAL</a>;
00197         u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a10">UPAPSS_INITIAL</a>;
00198         u-&gt;<a class="code" href="structupap__state.html#o7">us_id</a> = 0;
00199         u-&gt;<a class="code" href="structupap__state.html#o8">us_timeouttime</a> = UPAP_DEFTIMEOUT;
00200         u-&gt;<a class="code" href="structupap__state.html#o10">us_maxtransmits</a> = 10;
00201         u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a> = UPAP_DEFREQTIME;
00202 }
00203 
00204 <span class="comment">/*</span>
00205 <span class="comment"> * upap_timeout - Retransmission timer for sending auth-reqs expired.</span>
00206 <span class="comment"> */</span>
00207 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_timeout(<span class="keywordtype">void</span> *arg)
00208 {
00209         <a class="code" href="structupap__state.html">upap_state</a> *u = (<a class="code" href="structupap__state.html">upap_state</a> *) arg;
00210         
00211         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"upap_timeout: %d timeout %d expired s=%d\n"</span>, 
00212                                 u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, u-&gt;<a class="code" href="structupap__state.html#o8">us_timeouttime</a>, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00213         
00214         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> != <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>)
00215                 <span class="keywordflow">return</span>;
00216         
00217         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o9">us_transmits</a> &gt;= u-&gt;<a class="code" href="structupap__state.html#o10">us_maxtransmits</a>) {
00218                 <span class="comment">/* give up in disgust */</span>
00219                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"No response to PAP authenticate-requests\n"</span>);
00220                 u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a9">UPAPCS_BADAUTH</a>;
00221                 <a class="code" href="auth_8h.html#a9">auth_withpeer_fail</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP);
00222                 <span class="keywordflow">return</span>;
00223         }
00224         
00225         upap_sauthreq(u);               <span class="comment">/* Send Authenticate-Request */</span>
00226 }
00227 
00228 
00229 <span class="comment">/*</span>
00230 <span class="comment"> * upap_reqtimeout - Give up waiting for the peer to send an auth-req.</span>
00231 <span class="comment"> */</span>
00232 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_reqtimeout(<span class="keywordtype">void</span> *arg)
00233 {
00234         <a class="code" href="structupap__state.html">upap_state</a> *u = (<a class="code" href="structupap__state.html">upap_state</a> *) arg;
00235         
00236         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> != <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a>)
00237                 <span class="keywordflow">return</span>;                 <span class="comment">/* huh?? */</span>
00238         
00239         <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP);
00240         u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a15">UPAPSS_BADAUTH</a>;
00241 }
00242 
00243 
00244 <span class="comment">/*</span>
00245 <span class="comment"> * upap_lowerup - The lower layer is up.</span>
00246 <span class="comment"> *</span>
00247 <span class="comment"> * Start authenticating if pending.</span>
00248 <span class="comment"> */</span>
00249 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_lowerup(<span class="keywordtype">int</span> unit)
00250 {
00251         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00252         
00253         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"upap_lowerup: %d s=%d\n"</span>, unit, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00254         
00255         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a4">UPAPCS_INITIAL</a>)
00256                 u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a5">UPAPCS_CLOSED</a>;
00257         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a6">UPAPCS_PENDING</a>) {
00258                 upap_sauthreq(u);       <span class="comment">/* send an auth-request */</span>
00259         }
00260         
00261         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a10">UPAPSS_INITIAL</a>)
00262                 u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a11">UPAPSS_CLOSED</a>;
00263         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a12">UPAPSS_PENDING</a>) {
00264                 u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a>;
00265                 <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a> &gt; 0)
00266                         TIMEOUT(upap_reqtimeout, u, u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a>);
00267         }
00268 }
00269 
00270 
00271 <span class="comment">/*</span>
00272 <span class="comment"> * upap_lowerdown - The lower layer is down.</span>
00273 <span class="comment"> *</span>
00274 <span class="comment"> * Cancel all timeouts.</span>
00275 <span class="comment"> */</span>
00276 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_lowerdown(<span class="keywordtype">int</span> unit)
00277 {
00278         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00279         
00280         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"upap_lowerdown: %d s=%d\n"</span>, unit, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00281         
00282         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>)        <span class="comment">/* Timeout pending? */</span>
00283                 UNTIMEOUT(upap_timeout, u);             <span class="comment">/* Cancel timeout */</span>
00284         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a> &amp;&amp; u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a> &gt; 0)
00285                 UNTIMEOUT(upap_reqtimeout, u);
00286         
00287         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a4">UPAPCS_INITIAL</a>;
00288         u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a10">UPAPSS_INITIAL</a>;
00289 }
00290 
00291 
00292 <span class="comment">/*</span>
00293 <span class="comment"> * upap_protrej - Peer doesn't speak this protocol.</span>
00294 <span class="comment"> *</span>
00295 <span class="comment"> * This shouldn't happen.  In any case, pretend lower layer went down.</span>
00296 <span class="comment"> */</span>
00297 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_protrej(<span class="keywordtype">int</span> unit)
00298 {
00299         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00300         
00301         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> == <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>) {
00302                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"PAP authentication failed due to protocol-reject\n"</span>);
00303                 <a class="code" href="auth_8h.html#a9">auth_withpeer_fail</a>(unit, PPP_PAP);
00304         }
00305         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a>) {
00306                 <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"PAP authentication of peer failed (protocol-reject)\n"</span>);
00307                 <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(unit, PPP_PAP);
00308         }
00309         upap_lowerdown(unit);
00310 }
00311 
00312 
00313 <span class="comment">/*</span>
00314 <span class="comment"> * upap_input - Input UPAP packet.</span>
00315 <span class="comment"> */</span>
00316 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_input(<span class="keywordtype">int</span> unit, u_char *inpacket, <span class="keywordtype">int</span> l)
00317 {
00318         <a class="code" href="structupap__state.html">upap_state</a> *u = &amp;<a class="code" href="pap_8h.html#a17">upap</a>[unit];
00319         u_char *inp;
00320         u_char code, id;
00321         <span class="keywordtype">int</span> len;
00322         
00323         <span class="comment">/*</span>
00324 <span class="comment">         * Parse header (code, id and length).</span>
00325 <span class="comment">         * If packet too short, drop it.</span>
00326 <span class="comment">         */</span>
00327         inp = inpacket;
00328         <span class="keywordflow">if</span> (l &lt; <a class="code" href="pap_8h.html#a0">UPAP_HEADERLEN</a>) {
00329                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_input: rcvd short header.\n"</span>));
00330                 <span class="keywordflow">return</span>;
00331         }
00332         GETCHAR(code, inp);
00333         GETCHAR(id, inp);
00334         GETSHORT(len, inp);
00335         <span class="keywordflow">if</span> (len &lt; <a class="code" href="pap_8h.html#a0">UPAP_HEADERLEN</a>) {
00336                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_input: rcvd illegal length.\n"</span>));
00337                 <span class="keywordflow">return</span>;
00338         }
00339         <span class="keywordflow">if</span> (len &gt; l) {
00340                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_input: rcvd short packet.\n"</span>));
00341                 <span class="keywordflow">return</span>;
00342         }
00343         len -= <a class="code" href="pap_8h.html#a0">UPAP_HEADERLEN</a>;
00344         
00345         <span class="comment">/*</span>
00346 <span class="comment">         * Action depends on code.</span>
00347 <span class="comment">         */</span>
00348         <span class="keywordflow">switch</span> (code) {
00349         <span class="keywordflow">case</span> <a class="code" href="pap_8h.html#a1">UPAP_AUTHREQ</a>:
00350                 upap_rauthreq(u, inp, id, len);
00351                 <span class="keywordflow">break</span>;
00352         
00353         <span class="keywordflow">case</span> <a class="code" href="pap_8h.html#a2">UPAP_AUTHACK</a>:
00354                 upap_rauthack(u, inp, id, len);
00355                 <span class="keywordflow">break</span>;
00356         
00357         <span class="keywordflow">case</span> <a class="code" href="pap_8h.html#a3">UPAP_AUTHNAK</a>:
00358                 upap_rauthnak(u, inp, id, len);
00359                 <span class="keywordflow">break</span>;
00360         
00361         <span class="keywordflow">default</span>:                                <span class="comment">/* XXX Need code reject */</span>
00362                 <span class="keywordflow">break</span>;
00363         }
00364 }
00365 
00366 
00367 <span class="comment">/*</span>
00368 <span class="comment"> * upap_rauth - Receive Authenticate.</span>
00369 <span class="comment"> */</span>
00370 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthreq(
00371         <a class="code" href="structupap__state.html">upap_state</a> *u, 
00372         u_char *inp, 
00373         <span class="keywordtype">int</span> id,
00374         <span class="keywordtype">int</span> len
00375 )
00376 {
00377         u_char ruserlen, rpasswdlen;
00378         <span class="keywordtype">char</span> *ruser, *rpasswd;
00379         <span class="keywordtype">int</span> retcode;
00380         <span class="keywordtype">char</span> *msg;
00381         <span class="keywordtype">int</span> msglen;
00382         
00383         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauth: Rcvd id %d.\n"</span>, id));
00384         
00385         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> &lt; <a class="code" href="pap_8h.html#a13">UPAPSS_LISTEN</a>)
00386                 <span class="keywordflow">return</span>;
00387         
00388         <span class="comment">/*</span>
00389 <span class="comment">         * If we receive a duplicate authenticate-request, we are</span>
00390 <span class="comment">         * supposed to return the same status as for the first request.</span>
00391 <span class="comment">         */</span>
00392         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a14">UPAPSS_OPEN</a>) {
00393                 upap_sresp(u, UPAP_AUTHACK, id, <span class="stringliteral">""</span>, 0); <span class="comment">/* return auth-ack */</span>
00394                 <span class="keywordflow">return</span>;
00395         }
00396         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> == <a class="code" href="pap_8h.html#a15">UPAPSS_BADAUTH</a>) {
00397                 upap_sresp(u, UPAP_AUTHNAK, id, <span class="stringliteral">""</span>, 0); <span class="comment">/* return auth-nak */</span>
00398                 <span class="keywordflow">return</span>;
00399         }
00400         
00401         <span class="comment">/*</span>
00402 <span class="comment">         * Parse user/passwd.</span>
00403 <span class="comment">         */</span>
00404         <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span> (u_char)) {
00405                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauth: rcvd short packet.\n"</span>));
00406                 <span class="keywordflow">return</span>;
00407         }
00408         GETCHAR(ruserlen, inp);
00409         len -= <span class="keyword">sizeof</span> (u_char) + ruserlen + <span class="keyword">sizeof</span> (u_char);
00410         <span class="keywordflow">if</span> (len &lt; 0) {
00411                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauth: rcvd short packet.\n"</span>));
00412                 <span class="keywordflow">return</span>;
00413         }
00414         ruser = (<span class="keywordtype">char</span> *) inp;
00415         INCPTR(ruserlen, inp);
00416         GETCHAR(rpasswdlen, inp);
00417         <span class="keywordflow">if</span> (len &lt; rpasswdlen) {
00418                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauth: rcvd short packet.\n"</span>));
00419                 <span class="keywordflow">return</span>;
00420         }
00421         rpasswd = (<span class="keywordtype">char</span> *) inp;
00422         
00423         <span class="comment">/*</span>
00424 <span class="comment">         * Check the username and password given.</span>
00425 <span class="comment">         */</span>
00426         retcode = <a class="code" href="auth_8h.html#a13">check_passwd</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, ruser, ruserlen, rpasswd,
00427                            rpasswdlen, &amp;msg, &amp;msglen);
00428         BZERO(rpasswd, rpasswdlen);
00429         
00430         upap_sresp(u, retcode, id, msg, msglen);
00431         
00432         <span class="keywordflow">if</span> (retcode == <a class="code" href="pap_8h.html#a2">UPAP_AUTHACK</a>) {
00433                 u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a14">UPAPSS_OPEN</a>;
00434                 <a class="code" href="auth_8h.html#a8">auth_peer_success</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP, ruser, ruserlen);
00435         } <span class="keywordflow">else</span> {
00436                 u-&gt;<a class="code" href="structupap__state.html#o6">us_serverstate</a> = <a class="code" href="pap_8h.html#a15">UPAPSS_BADAUTH</a>;
00437                 <a class="code" href="auth_8h.html#a7">auth_peer_fail</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP);
00438         }
00439         
00440         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o11">us_reqtimeout</a> &gt; 0)
00441                 UNTIMEOUT(upap_reqtimeout, u);
00442 }
00443 
00444 
00445 <span class="comment">/*</span>
00446 <span class="comment"> * upap_rauthack - Receive Authenticate-Ack.</span>
00447 <span class="comment"> */</span>
00448 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthack(
00449         <a class="code" href="structupap__state.html">upap_state</a> *u,
00450         u_char *inp,
00451         <span class="keywordtype">int</span> id,
00452         <span class="keywordtype">int</span> len
00453 )
00454 {
00455         u_char msglen;
00456         <span class="keywordtype">char</span> *msg;
00457         
00458         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthack: Rcvd id %d s=%d\n"</span>, id, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00459         
00460         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> != <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>) <span class="comment">/* XXX */</span>
00461                 <span class="keywordflow">return</span>;
00462         
00463         <span class="comment">/*</span>
00464 <span class="comment">         * Parse message.</span>
00465 <span class="comment">         */</span>
00466         <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span> (u_char)) {
00467                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthack: rcvd short packet.\n"</span>));
00468                 <span class="keywordflow">return</span>;
00469         }
00470         GETCHAR(msglen, inp);
00471         len -= <span class="keyword">sizeof</span> (u_char);
00472         <span class="keywordflow">if</span> (len &lt; msglen) {
00473                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthack: rcvd short packet.\n"</span>));
00474                 <span class="keywordflow">return</span>;
00475         }
00476         msg = (<span class="keywordtype">char</span> *) inp;
00477         PRINTMSG(msg, msglen);
00478         
00479         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a8">UPAPCS_OPEN</a>;
00480         
00481         <a class="code" href="auth_8h.html#a10">auth_withpeer_success</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP);
00482 }
00483 
00484 
00485 <span class="comment">/*</span>
00486 <span class="comment"> * upap_rauthnak - Receive Authenticate-Nakk.</span>
00487 <span class="comment"> */</span>
00488 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_rauthnak(
00489         <a class="code" href="structupap__state.html">upap_state</a> *u,
00490         u_char *inp,
00491         <span class="keywordtype">int</span> id,
00492         <span class="keywordtype">int</span> len
00493 )
00494 {
00495         u_char msglen;
00496         <span class="keywordtype">char</span> *msg;
00497         
00498         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthnak: Rcvd id %d s=%d\n"</span>, id, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00499         
00500         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> != <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>) <span class="comment">/* XXX */</span>
00501                 <span class="keywordflow">return</span>;
00502         
00503         <span class="comment">/*</span>
00504 <span class="comment">         * Parse message.</span>
00505 <span class="comment">         */</span>
00506         <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span> (u_char)) {
00507                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthnak: rcvd short packet.\n"</span>));
00508                 <span class="keywordflow">return</span>;
00509         }
00510         GETCHAR(msglen, inp);
00511         len -= <span class="keyword">sizeof</span> (u_char);
00512         <span class="keywordflow">if</span> (len &lt; msglen) {
00513                 <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_rauthnak: rcvd short packet.\n"</span>));
00514                 <span class="keywordflow">return</span>;
00515         }
00516         msg = (<span class="keywordtype">char</span> *) inp;
00517         PRINTMSG(msg, msglen);
00518         
00519         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a9">UPAPCS_BADAUTH</a>;
00520         
00521         <a class="code" href="pppdebug_8h.html#a15">ppp_trace</a>(LOG_ERR, <span class="stringliteral">"PAP authentication failed\n"</span>);
00522         <a class="code" href="auth_8h.html#a9">auth_withpeer_fail</a>(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, PPP_PAP);
00523 }
00524 
00525 
00526 <span class="comment">/*</span>
00527 <span class="comment"> * upap_sauthreq - Send an Authenticate-Request.</span>
00528 <span class="comment"> */</span>
00529 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_sauthreq(<a class="code" href="structupap__state.html">upap_state</a> *u)
00530 {
00531         u_char *outp;
00532         <span class="keywordtype">int</span> outlen;
00533         
00534         outlen = <a class="code" href="pap_8h.html#a0">UPAP_HEADERLEN</a> + 2 * <span class="keyword">sizeof</span> (u_char) 
00535                         + u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a> + u-&gt;<a class="code" href="structupap__state.html#o4">us_passwdlen</a>;
00536         outp = outpacket_buf[u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>];
00537         
00538         MAKEHEADER(outp, PPP_PAP);
00539         
00540         PUTCHAR(UPAP_AUTHREQ, outp);
00541         PUTCHAR(++u-&gt;<a class="code" href="structupap__state.html#o7">us_id</a>, outp);
00542         PUTSHORT(outlen, outp);
00543         PUTCHAR(u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a>, outp);
00544         BCOPY(u-&gt;<a class="code" href="structupap__state.html#o1">us_user</a>, outp, u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a>);
00545         INCPTR(u-&gt;<a class="code" href="structupap__state.html#o2">us_userlen</a>, outp);
00546         PUTCHAR(u-&gt;<a class="code" href="structupap__state.html#o4">us_passwdlen</a>, outp);
00547         BCOPY(u-&gt;<a class="code" href="structupap__state.html#o3">us_passwd</a>, outp, u-&gt;<a class="code" href="structupap__state.html#o4">us_passwdlen</a>);
00548         
00549         pppWrite(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, outpacket_buf[u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>], outlen + PPP_HDRLEN);
00550         
00551         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_sauth: Sent id %d\n"</span>, u-&gt;<a class="code" href="structupap__state.html#o7">us_id</a>));
00552         
00553         TIMEOUT(upap_timeout, u, u-&gt;<a class="code" href="structupap__state.html#o8">us_timeouttime</a>);
00554         ++u-&gt;<a class="code" href="structupap__state.html#o9">us_transmits</a>;
00555         u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a> = <a class="code" href="pap_8h.html#a7">UPAPCS_AUTHREQ</a>;
00556 }
00557 
00558 
00559 <span class="comment">/*</span>
00560 <span class="comment"> * upap_sresp - Send a response (ack or nak).</span>
00561 <span class="comment"> */</span>
00562 <span class="keyword">static</span> <span class="keywordtype">void</span> upap_sresp(
00563         <a class="code" href="structupap__state.html">upap_state</a> *u,
00564         u_char code, 
00565         u_char id,
00566         <span class="keywordtype">char</span> *msg,
00567         <span class="keywordtype">int</span> msglen
00568 )
00569 {
00570         u_char *outp;
00571         <span class="keywordtype">int</span> outlen;
00572         
00573         outlen = <a class="code" href="pap_8h.html#a0">UPAP_HEADERLEN</a> + <span class="keyword">sizeof</span> (u_char) + msglen;
00574         outp = outpacket_buf[u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>];
00575         MAKEHEADER(outp, PPP_PAP);
00576         
00577         PUTCHAR(code, outp);
00578         PUTCHAR(id, outp);
00579         PUTSHORT(outlen, outp);
00580         PUTCHAR(msglen, outp);
00581         BCOPY(msg, outp, msglen);
00582         pppWrite(u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>, outpacket_buf[u-&gt;<a class="code" href="structupap__state.html#o0">us_unit</a>], outlen + PPP_HDRLEN);
00583         
00584         <a class="code" href="pppdebug_8h.html#a2">UPAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"pap_sresp: Sent code %d, id %d s=%d\n"</span>, 
00585                                 code, id, u-&gt;<a class="code" href="structupap__state.html#o5">us_clientstate</a>));
00586 }
00587 
00588 <span class="preprocessor">#if 0</span>
00589 <span class="preprocessor"></span><span class="comment">/*</span>
00590 <span class="comment"> * upap_printpkt - print the contents of a PAP packet.</span>
00591 <span class="comment"> */</span>
00592 <span class="keyword">static</span> <span class="keywordtype">int</span> upap_printpkt(
00593         u_char *p,
00594         <span class="keywordtype">int</span> plen,
00595         <span class="keywordtype">void</span> (*printer) (<span class="keywordtype">void</span> *, <span class="keywordtype">char</span> *, ...),
00596         <span class="keywordtype">void</span> *arg
00597 )
00598 {
00599         (<span class="keywordtype">void</span>)p;
00600         (<span class="keywordtype">void</span>)plen;
00601         (<span class="keywordtype">void</span>)printer;
00602         (<span class="keywordtype">void</span>)arg;
00603         <span class="keywordflow">return</span> 0;
00604 }
00605 <span class="preprocessor">#endif</span>
00606 <span class="preprocessor"></span>
00607 <span class="preprocessor">#endif </span><span class="comment">/* PAP_SUPPORT */</span>
00608 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
