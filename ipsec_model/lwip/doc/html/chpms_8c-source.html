
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>chpms.c</h1><a href="chpms_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*** WARNING - THIS CODE HAS NOT BEEN FINISHED! ***/</span>
00002 <span class="comment">/*****************************************************************************</span>
00003 <span class="comment">* chpms.c - Network MicroSoft Challenge Handshake Authentication Protocol program file.</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 2003 by Marc Boucher, Services Informatiques (MBSI) inc.</span>
00006 <span class="comment">* Copyright (c) 1997 by Global Election Systems Inc.  All rights reserved.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* The authors hereby grant permission to use, copy, modify, distribute,</span>
00009 <span class="comment">* and license this software and its documentation for any purpose, provided</span>
00010 <span class="comment">* that existing copyright notices are retained in all copies and that this</span>
00011 <span class="comment">* notice and the following disclaimer are included verbatim in any </span>
00012 <span class="comment">* distributions. No written agreement, license, or royalty fee is required</span>
00013 <span class="comment">* for any of the authorized uses.</span>
00014 <span class="comment">*</span>
00015 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS *AS IS* AND ANY EXPRESS OR</span>
00016 <span class="comment">* IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00017 <span class="comment">* OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00018 <span class="comment">* IN NO EVENT SHALL THE CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
00019 <span class="comment">* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
00020 <span class="comment">* NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
00021 <span class="comment">* DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
00022 <span class="comment">* THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
00023 <span class="comment">* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
00024 <span class="comment">* THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00025 <span class="comment">*</span>
00026 <span class="comment">******************************************************************************</span>
00027 <span class="comment">* REVISION HISTORY</span>
00028 <span class="comment">*</span>
00029 <span class="comment">* 03-01-01 Marc Boucher &lt;marc@mbsi.ca&gt;</span>
00030 <span class="comment">*   Ported to lwIP.</span>
00031 <span class="comment">* 97-12-08 Guy Lancaster &lt;lancasterg@acm.org&gt;, Global Election Systems Inc.</span>
00032 <span class="comment">*       Original based on BSD chap_ms.c.</span>
00033 <span class="comment">*****************************************************************************/</span>
00034 <span class="comment">/*</span>
00035 <span class="comment"> * chap_ms.c - Microsoft MS-CHAP compatible implementation.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * Copyright (c) 1995 Eric Rosenquist, Strata Software Limited.</span>
00038 <span class="comment"> * http://www.strataware.com/</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * All rights reserved.</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> * Redistribution and use in source and binary forms are permitted</span>
00043 <span class="comment"> * provided that the above copyright notice and this paragraph are</span>
00044 <span class="comment"> * duplicated in all such forms and that any documentation,</span>
00045 <span class="comment"> * advertising materials, and other materials related to such</span>
00046 <span class="comment"> * distribution and use acknowledge that the software was developed</span>
00047 <span class="comment"> * by Eric Rosenquist.  The name of the author may not be used to</span>
00048 <span class="comment"> * endorse or promote products derived from this software without</span>
00049 <span class="comment"> * specific prior written permission.</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR</span>
00052 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
00053 <span class="comment"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00054 <span class="comment"> */</span>
00055 
00056 <span class="comment">/*</span>
00057 <span class="comment"> * Modifications by Lauri Pesonen / lpesonen@clinet.fi, april 1997</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> *   Implemented LANManager type password response to MS-CHAP challenges.</span>
00060 <span class="comment"> *   Now pppd provides both NT style and LANMan style blocks, and the</span>
00061 <span class="comment"> *   prefered is set by option "ms-lanman". Default is to use NT.</span>
00062 <span class="comment"> *   The hash text (StdText) was taken from Win95 RASAPI32.DLL.</span>
00063 <span class="comment"> *</span>
00064 <span class="comment"> *   You should also use DOMAIN\\USERNAME as described in README.MSCHAP80</span>
00065 <span class="comment"> */</span>
00066 
<a name="l00067"></a><a class="code" href="chpms_8c.html#a0">00067</a> <span class="preprocessor">#define USE_CRYPT</span>
00068 <span class="preprocessor"></span>
00069 
00070 <span class="preprocessor">#include "<a class="code" href="ppp_8h.html">ppp.h</a>"</span>
00071 
00072 <span class="preprocessor">#if MSCHAP_SUPPORT &gt; 0</span>
00073 <span class="preprocessor"></span>
00074 <span class="preprocessor">#include "md4.h"</span>
00075 <span class="preprocessor">#ifndef USE_CRYPT</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#include "des.h"</span>
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="chap_8h.html">chap.h</a>"</span>
00079 <span class="preprocessor">#include "<a class="code" href="chpms_8h.html">chpms.h</a>"</span>
00080 <span class="preprocessor">#include "<a class="code" href="pppdebug_8h.html">pppdebug.h</a>"</span>
00081 
00082 
00083 <span class="comment">/*************************/</span>
00084 <span class="comment">/*** LOCAL DEFINITIONS ***/</span>
00085 <span class="comment">/*************************/</span>
00086 
00087 
00088 <span class="comment">/************************/</span>
00089 <span class="comment">/*** LOCAL DATA TYPES ***/</span>
00090 <span class="comment">/************************/</span>
00091 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00092     u_char LANManResp[24];
00093     u_char NTResp[24];
00094     u_char UseNT;               <span class="comment">/* If 1, ignore the LANMan response field */</span>
00095 } MS_ChapResponse;
00096 <span class="comment">/* We use MS_CHAP_RESPONSE_LEN, rather than sizeof(MS_ChapResponse),</span>
00097 <span class="comment">   in case this struct gets padded. */</span>
00098 
00099 
00100 
00101 <span class="comment">/***********************************/</span>
00102 <span class="comment">/*** LOCAL FUNCTION DECLARATIONS ***/</span>
00103 <span class="comment">/***********************************/</span>
00104 
00105 <span class="comment">/* XXX Don't know what to do with these. */</span>
00106 <span class="keyword">extern</span> <span class="keywordtype">void</span> setkey(<span class="keyword">const</span> <span class="keywordtype">char</span> *);
00107 <span class="keyword">extern</span> <span class="keywordtype">void</span> encrypt(<span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00108 
00109 <span class="keyword">static</span> <span class="keywordtype">void</span>     DesEncrypt (u_char *, u_char *, u_char *);
00110 <span class="keyword">static</span> <span class="keywordtype">void</span>     MakeKey (u_char *, u_char *);
00111 
00112 <span class="preprocessor">#ifdef USE_CRYPT</span>
00113 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>     Expand (u_char *, u_char *);
00114 <span class="keyword">static</span> <span class="keywordtype">void</span>     Collapse (u_char *, u_char *);
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117 <span class="keyword">static</span> <span class="keywordtype">void</span> ChallengeResponse(
00118         u_char *challenge,      <span class="comment">/* IN   8 octets */</span>
00119         u_char *pwHash,         <span class="comment">/* IN  16 octets */</span>
00120         u_char *response        <span class="comment">/* OUT 24 octets */</span>
00121 );
00122 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapMS_NT(
00123         <span class="keywordtype">char</span> *rchallenge,
00124         <span class="keywordtype">int</span> rchallenge_len,
00125         <span class="keywordtype">char</span> *secret,
00126         <span class="keywordtype">int</span> secret_len,
00127         MS_ChapResponse *response
00128 );
00129 <span class="keyword">static</span> u_char Get7Bits(
00130         u_char *input,
00131         <span class="keywordtype">int</span> startBit
00132 );
00133 
00134 
00135 <span class="comment">/***********************************/</span>
00136 <span class="comment">/*** PUBLIC FUNCTION DEFINITIONS ***/</span>
00137 <span class="comment">/***********************************/</span>
00138 <span class="keywordtype">void</span> <a class="code" href="chpms_8h.html#a1">ChapMS</a>(
00139         <a class="code" href="structchap__state.html">chap_state</a> *<a class="code" href="structcstate.html">cstate</a>,
00140         <span class="keywordtype">char</span> *rchallenge,
00141         <span class="keywordtype">int</span> rchallenge_len,
00142         <span class="keywordtype">char</span> *secret,
00143         <span class="keywordtype">int</span> secret_len
00144 )
00145 {
00146         MS_ChapResponse response;
00147 <span class="preprocessor">#ifdef MSLANMAN</span>
00148 <span class="preprocessor"></span>        <span class="keyword">extern</span> <span class="keywordtype">int</span> ms_lanman;
00149 <span class="preprocessor">#endif</span>
00150 <span class="preprocessor"></span>        
00151 <span class="preprocessor">#if 0</span>
00152 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"ChapMS: secret is '%.*s'\n"</span>, secret_len, secret));
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span>        BZERO(&amp;response, <span class="keyword">sizeof</span>(response));
00155         
00156         <span class="comment">/* Calculate both always */</span>
00157         ChapMS_NT(rchallenge, rchallenge_len, secret, secret_len, &amp;response);
00158         
00159 <span class="preprocessor">#ifdef MSLANMAN</span>
00160 <span class="preprocessor"></span>        ChapMS_LANMan(rchallenge, rchallenge_len, secret, secret_len, &amp;response);
00161         
00162         <span class="comment">/* prefered method is set by option  */</span>
00163         response.UseNT = !ms_lanman;
00164 <span class="preprocessor">#else</span>
00165 <span class="preprocessor"></span>        response.UseNT = 1;
00166 <span class="preprocessor">#endif</span>
00167 <span class="preprocessor"></span>        
00168         BCOPY(&amp;response, cstate-&gt;<a class="code" href="structchap__state.html#o14">response</a>, MS_CHAP_RESPONSE_LEN);
00169         cstate-&gt;<a class="code" href="structchap__state.html#o15">resp_length</a> = <a class="code" href="chap_8h.html#a4">MS_CHAP_RESPONSE_LEN</a>;
00170 }
00171 
00172 
00173 <span class="comment">/**********************************/</span>
00174 <span class="comment">/*** LOCAL FUNCTION DEFINITIONS ***/</span>
00175 <span class="comment">/**********************************/</span>
00176 <span class="keyword">static</span> <span class="keywordtype">void</span> ChallengeResponse(
00177         u_char *challenge,      <span class="comment">/* IN   8 octets */</span>
00178         u_char *pwHash,         <span class="comment">/* IN  16 octets */</span>
00179         u_char *response        <span class="comment">/* OUT 24 octets */</span>
00180 )
00181 {
00182         <span class="keywordtype">char</span>    ZPasswordHash[21];
00183         
00184         BZERO(ZPasswordHash, <span class="keyword">sizeof</span>(ZPasswordHash));
00185         BCOPY(pwHash, ZPasswordHash, 16);
00186         
00187 <span class="preprocessor">#if 0</span>
00188 <span class="preprocessor"></span>        log_packet(ZPasswordHash, <span class="keyword">sizeof</span>(ZPasswordHash), <span class="stringliteral">"ChallengeResponse - ZPasswordHash"</span>, LOG_DEBUG);
00189 <span class="preprocessor">#endif</span>
00190 <span class="preprocessor"></span>        
00191         DesEncrypt(challenge, ZPasswordHash +  0, response + 0);
00192         DesEncrypt(challenge, ZPasswordHash +  7, response + 8);
00193         DesEncrypt(challenge, ZPasswordHash + 14, response + 16);
00194         
00195 <span class="preprocessor">#if 0</span>
00196 <span class="preprocessor"></span>        log_packet(response, 24, <span class="stringliteral">"ChallengeResponse - response"</span>, LOG_DEBUG);
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>}
00199 
00200 
00201 <span class="preprocessor">#ifdef USE_CRYPT</span>
00202 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> DesEncrypt(
00203         u_char *clear,  <span class="comment">/* IN  8 octets */</span>
00204         u_char *key,    <span class="comment">/* IN  7 octets */</span>
00205         u_char *cipher  <span class="comment">/* OUT 8 octets */</span>
00206 )
00207 {
00208         u_char des_key[8];
00209         u_char crypt_key[66];
00210         u_char des_input[66];
00211         
00212         MakeKey(key, des_key);
00213         
00214         Expand(des_key, crypt_key);
00215         setkey(crypt_key);
00216         
00217 <span class="preprocessor">#if 0</span>
00218 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"DesEncrypt: 8 octet input : %02X%02X%02X%02X%02X%02X%02X%02X\n"</span>,
00219                clear[0], clear[1], clear[2], clear[3], clear[4], clear[5], clear[6], clear[7]));
00220 <span class="preprocessor">#endif</span>
00221 <span class="preprocessor"></span>        
00222         Expand(clear, des_input);
00223         encrypt(des_input, 0);
00224         Collapse(des_input, cipher);
00225         
00226 <span class="preprocessor">#if 0</span>
00227 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"DesEncrypt: 8 octet output: %02X%02X%02X%02X%02X%02X%02X%02X\n"</span>,
00228                cipher[0], cipher[1], cipher[2], cipher[3], cipher[4], cipher[5], cipher[6], cipher[7]));
00229 <span class="preprocessor">#endif</span>
00230 <span class="preprocessor"></span>}
00231 
00232 <span class="preprocessor">#else </span><span class="comment">/* USE_CRYPT */</span>
00233 
00234 <span class="keyword">static</span> <span class="keywordtype">void</span> DesEncrypt(
00235         u_char *clear,  <span class="comment">/* IN  8 octets */</span>
00236         u_char *key,    <span class="comment">/* IN  7 octets */</span>
00237         u_char *cipher  <span class="comment">/* OUT 8 octets */</span>
00238 )
00239 {
00240         des_cblock              des_key;
00241         des_key_schedule        key_schedule;
00242         
00243         MakeKey(key, des_key);
00244         
00245         des_set_key(&amp;des_key, key_schedule);
00246         
00247 <span class="preprocessor">#if 0</span>
00248 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"DesEncrypt: 8 octet input : %02X%02X%02X%02X%02X%02X%02X%02X\n"</span>,
00249                clear[0], clear[1], clear[2], clear[3], clear[4], clear[5], clear[6], clear[7]));
00250 <span class="preprocessor">#endif</span>
00251 <span class="preprocessor"></span>        
00252         des_ecb_encrypt((des_cblock *)clear, (des_cblock *)cipher, key_schedule, 1);
00253         
00254 <span class="preprocessor">#if 0</span>
00255 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"DesEncrypt: 8 octet output: %02X%02X%02X%02X%02X%02X%02X%02X\n"</span>,
00256                cipher[0], cipher[1], cipher[2], cipher[3], cipher[4], cipher[5], cipher[6], cipher[7]));
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>}
00259 
00260 <span class="preprocessor">#endif </span><span class="comment">/* USE_CRYPT */</span>
00261 
00262 
00263 <span class="keyword">static</span> u_char Get7Bits(
00264         u_char *input,
00265         <span class="keywordtype">int</span> startBit
00266 )
00267 {
00268         <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   word;
00269         
00270         word  = (<span class="keywordtype">unsigned</span>)input[startBit / 8] &lt;&lt; 8;
00271         word |= (<span class="keywordtype">unsigned</span>)input[startBit / 8 + 1];
00272         
00273         word &gt;&gt;= 15 - (startBit % 8 + 7);
00274         
00275         <span class="keywordflow">return</span> word &amp; 0xFE;
00276 }
00277 
00278 <span class="preprocessor">#ifdef USE_CRYPT</span>
00279 <span class="preprocessor"></span>
00280 <span class="comment">/* in == 8-byte string (expanded version of the 56-bit key)</span>
00281 <span class="comment"> * out == 64-byte string where each byte is either 1 or 0</span>
00282 <span class="comment"> * Note that the low-order "bit" is always ignored by by setkey()</span>
00283 <span class="comment"> */</span>
00284 <span class="keyword">static</span> <span class="keywordtype">void</span> Expand(u_char *in, u_char *out)
00285 {
00286         <span class="keywordtype">int</span> j, c;
00287         <span class="keywordtype">int</span> i;
00288         
00289         <span class="keywordflow">for</span>(i = 0; i &lt; 64; in++){
00290                 c = *in;
00291                 <span class="keywordflow">for</span>(j = 7; j &gt;= 0; j--)
00292                         *out++ = (c &gt;&gt; j) &amp; 01;
00293                 i += 8;
00294         }
00295 }
00296 
00297 <span class="comment">/* The inverse of Expand</span>
00298 <span class="comment"> */</span>
00299 <span class="keyword">static</span> <span class="keywordtype">void</span> Collapse(u_char *in, u_char *out)
00300 {
00301         <span class="keywordtype">int</span> j;
00302         <span class="keywordtype">int</span> i;
00303         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c;
00304         
00305         <span class="keywordflow">for</span> (i = 0; i &lt; 64; i += 8, out++) {
00306                 c = 0;
00307                 <span class="keywordflow">for</span> (j = 7; j &gt;= 0; j--, in++)
00308                         c |= *in &lt;&lt; j;
00309                 *out = c &amp; 0xff;
00310         }
00311 }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314 <span class="keyword">static</span> <span class="keywordtype">void</span> MakeKey(
00315         u_char *key,            <span class="comment">/* IN  56 bit DES key missing parity bits */</span>
00316         u_char *des_key         <span class="comment">/* OUT 64 bit DES key with parity bits added */</span>
00317 )
00318 {
00319         des_key[0] = Get7Bits(key,  0);
00320         des_key[1] = Get7Bits(key,  7);
00321         des_key[2] = Get7Bits(key, 14);
00322         des_key[3] = Get7Bits(key, 21);
00323         des_key[4] = Get7Bits(key, 28);
00324         des_key[5] = Get7Bits(key, 35);
00325         des_key[6] = Get7Bits(key, 42);
00326         des_key[7] = Get7Bits(key, 49);
00327         
00328 <span class="preprocessor">#ifndef USE_CRYPT</span>
00329 <span class="preprocessor"></span>        des_set_odd_parity((des_cblock *)des_key);
00330 <span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>        
00332 <span class="preprocessor">#if 0</span>
00333 <span class="preprocessor"></span>        <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"MakeKey: 56-bit input : %02X%02X%02X%02X%02X%02X%02X\n"</span>,
00334                key[0], key[1], key[2], key[3], key[4], key[5], key[6]));
00335         <a class="code" href="pppdebug_8h.html#a5">CHAPDEBUG</a>((LOG_INFO, <span class="stringliteral">"MakeKey: 64-bit output: %02X%02X%02X%02X%02X%02X%02X%02X\n"</span>,
00336                des_key[0], des_key[1], des_key[2], des_key[3], des_key[4], des_key[5], des_key[6], des_key[7]));
00337 <span class="preprocessor">#endif</span>
00338 <span class="preprocessor"></span>}
00339 
00340 <span class="keyword">static</span> <span class="keywordtype">void</span> ChapMS_NT(
00341         <span class="keywordtype">char</span> *rchallenge,
00342         <span class="keywordtype">int</span> rchallenge_len,
00343         <span class="keywordtype">char</span> *secret,
00344         <span class="keywordtype">int</span> secret_len,
00345         MS_ChapResponse *response
00346 )
00347 {
00348         <span class="keywordtype">int</span>                     i;
00349         MDstruct        md4Context;
00350         u_char          unicodePassword[<a class="code" href="chpms_8h.html#a0">MAX_NT_PASSWORD</a> * 2];
00351         <span class="keyword">static</span> <span class="keywordtype">int</span>      low_byte_first = -1;
00352         
00353         <span class="comment">/* Initialize the Unicode version of the secret (== password). */</span>
00354         <span class="comment">/* This implicitly supports 8-bit ISO8859/1 characters. */</span>
00355         BZERO(unicodePassword, <span class="keyword">sizeof</span>(unicodePassword));
00356         <span class="keywordflow">for</span> (i = 0; i &lt; secret_len; i++)
00357                 unicodePassword[i * 2] = (u_char)secret[i];
00358         
00359         MDbegin(&amp;md4Context);
00360         MDupdate(&amp;md4Context, unicodePassword, secret_len * 2 * 8);     <span class="comment">/* Unicode is 2 bytes/char, *8 for bit count */</span>
00361         
00362         <span class="keywordflow">if</span> (low_byte_first == -1)
00363                 low_byte_first = (<a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>)1) != 1);
00364         <span class="keywordflow">if</span> (low_byte_first == 0)
00365                 MDreverse((u_long *)&amp;md4Context);  <span class="comment">/*  sfb 961105 */</span>
00366         
00367         MDupdate(&amp;md4Context, NULL, 0); <span class="comment">/* Tell MD4 we're done */</span>
00368         
00369         ChallengeResponse(rchallenge, (<span class="keywordtype">char</span> *)md4Context.buffer, response-&gt;NTResp);
00370 }
00371 
00372 <span class="preprocessor">#ifdef MSLANMAN</span>
00373 <span class="preprocessor"></span><span class="keyword">static</span> u_char *StdText = (u_char *)<span class="stringliteral">"KGS!@#$%"</span>; <span class="comment">/* key from rasapi32.dll */</span>
00374 
00375 <span class="keyword">static</span> ChapMS_LANMan(
00376         <span class="keywordtype">char</span> *rchallenge,
00377         <span class="keywordtype">int</span> rchallenge_len,
00378         <span class="keywordtype">char</span> *secret,
00379         <span class="keywordtype">int</span> secret_len,
00380         MS_ChapResponse *response
00381 )
00382 {
00383         <span class="keywordtype">int</span>                     i;
00384         u_char          UcasePassword[<a class="code" href="chpms_8h.html#a0">MAX_NT_PASSWORD</a>]; <span class="comment">/* max is actually 14 */</span>
00385         u_char          PasswordHash[16];
00386         
00387         <span class="comment">/* LANMan password is case insensitive */</span>
00388         BZERO(UcasePassword, <span class="keyword">sizeof</span>(UcasePassword));
00389         <span class="keywordflow">for</span> (i = 0; i &lt; secret_len; i++)
00390                 UcasePassword[i] = (u_char)toupper(secret[i]);
00391         DesEncrypt( StdText, UcasePassword + 0, PasswordHash + 0 );
00392         DesEncrypt( StdText, UcasePassword + 7, PasswordHash + 8 );
00393         ChallengeResponse(rchallenge, PasswordHash, response-&gt;LANManResp);
00394 }
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
00397 <span class="preprocessor">#endif </span><span class="comment">/* MSCHAP_SUPPORT */</span>
00398 
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
