
<html>
<head>
<title>lwIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="doxygen.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<table width="98%" border="0" align="center">
  <tr>
    <td>
      <h2>lwIP code documentation</h2>
<hr>

<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>inet6.c</h1><a href="inet6_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2001-2003 Swedish Institute of Computer Science.</span>
00003 <span class="comment"> * All rights reserved. </span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without modification, </span>
00006 <span class="comment"> * are permitted provided that the following conditions are met:</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
00009 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
00011 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation</span>
00012 <span class="comment"> *    and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. The name of the author may not be used to endorse or promote products</span>
00014 <span class="comment"> *    derived from this software without specific prior written permission. </span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED </span>
00017 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00018 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT </span>
00019 <span class="comment"> * SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, </span>
00020 <span class="comment"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT </span>
00021 <span class="comment"> * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
00022 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
00023 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING </span>
00024 <span class="comment"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY </span>
00025 <span class="comment"> * OF SUCH DAMAGE.</span>
00026 <span class="comment"> *</span>
00027 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
00028 <span class="comment"> * </span>
00029 <span class="comment"> * Author: Adam Dunkels &lt;adam@sics.se&gt;</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00034 <span class="comment">/* inet6.c</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> * Functions common to all TCP/IP modules, such as the Internet checksum and the</span>
00037 <span class="comment"> * byte order functions.</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> */</span>
00040 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00041 
00042 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">lwip/opt.h</a>"</span>
00043 
00044 <span class="preprocessor">#include "<a class="code" href="def_8h.html">lwip/def.h</a>"</span>
00045 <span class="preprocessor">#include "lwip/inet.h"</span>
00046 
00047 
00048 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00049 <span class="comment">/* chksum:</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> * Sums up all 16 bit words in a memory portion. Also includes any odd byte.</span>
00052 <span class="comment"> * This function is used by the other checksum functions.</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * For now, this is not optimized. Must be optimized for the particular processor</span>
00055 <span class="comment"> * arcitecture on which it is to run. Preferebly coded in assembler.</span>
00056 <span class="comment"> */</span>
00057 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00058 <span class="keyword">static</span> u32_t
<a name="l00059"></a><a class="code" href="inet6_8c.html#a0">00059</a> <a class="code" href="inet6_8c.html#a0">chksum</a>(<span class="keywordtype">void</span> *dataptr, u16_t len)
00060 {
00061   u16_t *sdataptr = dataptr;
00062   u32_t acc;
00063   
00064   
00065   <span class="keywordflow">for</span>(acc = 0; len &gt; 1; len -= 2) {
00066     acc += *sdataptr++;
00067   }
00068 
00069   <span class="comment">/* add up any odd byte */</span>
00070   <span class="keywordflow">if</span> (len == 1) {
00071     acc += <a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>((u16_t)(*(u8_t *)dataptr) &lt;&lt; 8);
00072   }
00073 
00074   <span class="keywordflow">return</span> acc;
00075 
00076 }
00077 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00078 <span class="comment">/* inet_chksum_pseudo:</span>
00079 <span class="comment"> *</span>
00080 <span class="comment"> * Calculates the pseudo Internet checksum used by TCP and UDP for a pbuf chain.</span>
00081 <span class="comment"> */</span>
00082 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00083 u16_t
<a name="l00084"></a><a class="code" href="inet6_8c.html#a1">00084</a> <a class="code" href="inet6_8c.html#a1">inet_chksum_pseudo</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p,
00085        <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *src, <span class="keyword">struct</span> <a class="code" href="structip__addr.html">ip_addr</a> *dest,
00086        u8_t proto, u32_t proto_len)
00087 {
00088   u32_t acc;
00089   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *q;
00090   u8_t swapped, i;
00091 
00092   acc = 0;
00093   swapped = 0;
00094   <span class="keywordflow">for</span>(q = p; q != <a class="code" href="def_8h.html#a2">NULL</a>; q = q-&gt;next) {    
00095     acc += <a class="code" href="inet6_8c.html#a0">chksum</a>(q-&gt;payload, q-&gt;len);
00096     <span class="keywordflow">while</span> (acc &gt;&gt; 16) {
00097       acc = (acc &amp; 0xffff) + (acc &gt;&gt; 16);
00098     }
00099     <span class="keywordflow">if</span> (q-&gt;len % 2 != 0) {
00100       swapped = 1 - swapped;
00101       acc = ((acc &amp; 0xff) &lt;&lt; 8) | ((acc &amp; 0xff00) &gt;&gt; 8);
00102     }
00103   }
00104 
00105   <span class="keywordflow">if</span> (swapped) {
00106     acc = ((acc &amp; 0xff) &lt;&lt; 8) | ((acc &amp; 0xff00) &gt;&gt; 8);
00107   }
00108   
00109   <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++) {
00110     acc += ((u16_t *)src-&gt;<a class="code" href="structip__addr.html#o0">addr</a>)[i] &amp; 0xffff;
00111     acc += ((u16_t *)dest-&gt;<a class="code" href="structip__addr.html#o0">addr</a>)[i] &amp; 0xffff;
00112     <span class="keywordflow">while</span> (acc &gt;&gt; 16) {
00113       acc = (acc &amp; 0xffff) + (acc &gt;&gt; 16);
00114     }
00115   }
00116   acc += (u16_t)<a class="code" href="ipv4_2lwip_2inet_8h.html#a0">htons</a>((u16_t)proto);
00117   acc += ((u16_t *)&amp;proto_len)[0] &amp; 0xffff;
00118   acc += ((u16_t *)&amp;proto_len)[1] &amp; 0xffff;
00119 
00120   <span class="keywordflow">while</span> (acc &gt;&gt; 16) {
00121     acc = (acc &amp; 0xffff) + (acc &gt;&gt; 16);
00122   }
00123   <span class="keywordflow">return</span> ~(acc &amp; 0xffff);
00124 }
00125 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00126 <span class="comment">/* inet_chksum:</span>
00127 <span class="comment"> *</span>
00128 <span class="comment"> * Calculates the Internet checksum over a portion of memory. Used primarely for IP</span>
00129 <span class="comment"> * and ICMP.</span>
00130 <span class="comment"> */</span>
00131 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00132 u16_t
<a name="l00133"></a><a class="code" href="inet6_8c.html#a2">00133</a> <a class="code" href="inet_8c.html#a2">inet_chksum</a>(<span class="keywordtype">void</span> *dataptr, u16_t len)
00134 {
00135   u32_t acc, sum;
00136 
00137   acc = <a class="code" href="inet6_8c.html#a0">chksum</a>(dataptr, len);
00138   sum = (acc &amp; 0xffff) + (acc &gt;&gt; 16);
00139   sum += (sum &gt;&gt; 16);
00140   <span class="keywordflow">return</span> ~(sum &amp; 0xffff);
00141 }
00142 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
00143 u16_t
<a name="l00144"></a><a class="code" href="inet6_8c.html#a3">00144</a> <a class="code" href="inet_8c.html#a3">inet_chksum_pbuf</a>(<span class="keyword">struct</span> <a class="code" href="structpbuf.html">pbuf</a> *p)
00145 {
00146   u32_t acc;
00147   <span class="keyword">struct </span><a class="code" href="structpbuf.html">pbuf</a> *q;
00148   u8_t swapped;
00149   
00150   acc = 0;
00151   swapped = 0;
00152   <span class="keywordflow">for</span>(q = p; q != <a class="code" href="def_8h.html#a2">NULL</a>; q = q-&gt;next) {
00153     acc += <a class="code" href="inet6_8c.html#a0">chksum</a>(q-&gt;payload, q-&gt;len);
00154     <span class="keywordflow">while</span> (acc &gt;&gt; 16) {
00155       acc = (acc &amp; 0xffff) + (acc &gt;&gt; 16);
00156     }    
00157     <span class="keywordflow">if</span> (q-&gt;len % 2 != 0) {
00158       swapped = 1 - swapped;
00159       acc = (acc &amp; 0xff &lt;&lt; 8) | (acc &amp; 0xff00 &gt;&gt; 8);
00160     }
00161   }
00162  
00163   <span class="keywordflow">if</span> (swapped) {
00164     acc = ((acc &amp; 0xff) &lt;&lt; 8) | ((acc &amp; 0xff00) &gt;&gt; 8);
00165   }
00166   <span class="keywordflow">return</span> ~(acc &amp; 0xffff);
00167 }
00168 <span class="comment">/*-----------------------------------------------------------------------------------*/</span>
</pre></div>	</td>
  </tr>
</table>
<hr>
<div align="center">Copyright (c) 2001-2003 Swedish Institute of Computer Science</div>
</html>
